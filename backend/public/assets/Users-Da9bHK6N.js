import{c as as,r as m,j as e,X as Fe,b as gt,u as rs,g as ls,e as ns}from"./index-4Z_ADcz-.js";import{u as be}from"./useMutation-hs9vH3uM.js";import{u as ue,g as Me}from"./users-Be35gZk0.js";import{B as j}from"./Button-O3SqeR70.js";import{u as ht,C as pe}from"./useToast-CdNAe9X_.js";import{u as yt}from"./index.esm-DeTgqkeM.js";import{u as is,a as os}from"./useGroups-DQ1RQ18m.js";import{u as us,a as ds,b as cs,c as ms,d as fs,e as xs,f as ps,g as bs,h as gs,i as hs,j as ys,k as vs,l as ws,m as js}from"./useUsers-DLW3FWGw.js";import{I as X}from"./Input-DUHma6SA.js";import{u as Ce,R as Vs}from"./useTranslation-GDJgXote.js";import{D as vt}from"./download-KXj8IBPk.js";import{u as wt}from"./useQuery-gRsyD88e.js";import{Q as ks}from"./index-CRt7-nX-.js";import{C as Ns,U as Cs,M as nt}from"./MyanmarPriorityPreviewModal-BuK7Kqrr.js";import{C as Ss}from"./copy-vLPk0au-.js";import{E as Ls}from"./external-link-Bos5Xh-m.js";import{B as Ds}from"./Badge-CrCszQn7.js";import{C as jt}from"./ConfirmDialog-CalzctL4.js";import{apiClient as it}from"./client-CSi9HbAr.js";import{g as ot,f as Ie,a as Rs}from"./formatters-CEEtD2TU.js";import{C as ut}from"./chevron-up-BhGpwuhi.js";import{C as Te}from"./chevron-down-B4xFnGu_.js";import{M as Vt}from"./more-vertical-CBWzsMev.js";import{u as Us}from"./useDebouncedValue-DatrE2cU.js";import{u as Es,a as As,b as Ms}from"./useSmartAutoRefresh-Bws830CR.js";import{S as ve}from"./Skeleton-TNJsV4PN.js";import{p as dt}from"./routePrefetch-CoUYSpAa.js";import{U as ct}from"./users-BjNvYrsM.js";import{P as mt}from"./plus-DVnLX_9u.js";import{S as Is}from"./search-xHQPHtMA.js";import"./cn-BLSKlp9E.js";import"./inbounds-BCv4m568.js";import"./xray-Bxt9moIC.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=as("MessageSquareText",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M13 8H7",key:"14i4kc"}],["path",{d:"M17 12H7",key:"16if0g"}]]);function ft(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function Fs(o){if(!Array.isArray(o.users)||o.users.length===0)return;const v=[["Email","UUID","Password","Subscription Token","Expire Date","Status"].map(ft).join(","),...o.users.map(f=>[f.email,f.uuid,f.password,f.subscriptionToken,f.expireDate,f.status].map(ft).join(","))].join(`
`),i=new Blob([v],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.setAttribute("download",`bulk-users-${new Date().toISOString().replace(/[:.]/g,"-")}.csv`),l.click(),window.URL.revokeObjectURL(s)}function Ps(o,c,v,i,s){const l=o.trim(),f=c.trim().replace(/^@+/,""),g=Number.isInteger(v)?Math.max(0,Math.min(v,5)):0,L=Number.isInteger(i)?Math.max(1,i):1,p=Number.isInteger(s)?Math.max(0,s):0;return!l||!f||g===0?[]:Array.from({length:g},(w,B)=>{const V=L+B,E=p>0?String(V).padStart(p,"0"):String(V);return`${l}${E}@${f}`})}const qs=({onClose:o,onSuccess:c})=>{var k,O,n,$,J,we,W,ge;const v=ht(),{t:i}=Ce(),{data:s}=is(),l=us(),f=(s||[]).filter(N=>N.enabled!==!1),{register:g,handleSubmit:L,watch:p,formState:{errors:w}}=yt({defaultValues:{prefix:"user",domain:"example.com",count:10,startIndex:1,padding:2,dataLimit:50,expiryDays:30,inboundIds:[],ipLimit:0,status:"ACTIVE"}}),B=p("prefix"),V=p("domain"),E=Number(p("count")),C=Number(p("startIndex")),z=Number(p("padding")),P=m.useMemo(()=>Ps(B||"",V||"",E,C,z),[B,V,E,C,z]),A=async N=>{try{const ae={...N,inboundIds:(N.inboundIds||[]).map(D=>Number(D)).filter(D=>Number.isInteger(D)&&D>0),count:Number(N.count),startIndex:Number(N.startIndex),padding:Number(N.padding),dataLimit:Number(N.dataLimit),expiryDays:Number(N.expiryDays),ipLimit:Number(N.ipLimit)},_=await l.mutateAsync(ae);Fs(_);const de=(_.failed||[]).slice(0,5).map(D=>`${D.email}: ${D.reason}`).join(`
`),ce=[i("users.bulkCreate.toast.requested",{defaultValue:"Requested: {{count}}",count:_.requestedCount}),i("users.bulkCreate.toast.created",{defaultValue:"Created: {{count}}",count:_.createdCount}),i("users.bulkCreate.toast.failed",{defaultValue:"Failed: {{count}}",count:_.failedCount}),_.createdCount>0?i("users.bulkCreate.toast.csvDownloaded",{defaultValue:"Credentials CSV downloaded."}):void 0].filter(Boolean);v.success(i("common.success",{defaultValue:"Success"}),ce.join(" • ")),de&&v.warning(i("common.warning",{defaultValue:"Warning"}),de),_.createdCount>0&&c()}catch(ae){v.error(i("common.error",{defaultValue:"Error"}),(ae==null?void 0:ae.message)||i("users.bulkCreate.toast.failedBody",{defaultValue:"Failed to create users in bulk"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"my-6 w-full max-w-3xl overflow-hidden rounded-2xl border border-line/80 bg-card/95 shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-line/80 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i("users.bulkCreate.title",{defaultValue:"Bulk User Provisioning"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:i("users.bulkCreate.subtitle",{defaultValue:"Create multiple users with consistent limits and inbound assignments."})})]}),e.jsx("button",{onClick:o,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":i("common.close",{defaultValue:"Close"}),children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:L(A),className:"space-y-6 p-5 sm:p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(X,{label:`${i("users.bulkCreate.prefixLabel",{defaultValue:"Email Prefix"})} *`,...g("prefix",{required:i("users.bulkCreate.validation.prefixRequired",{defaultValue:"Prefix is required"})}),error:(k=w.prefix)==null?void 0:k.message,placeholder:"user"}),e.jsx(X,{label:`${i("users.bulkCreate.domainLabel",{defaultValue:"Domain"})} *`,...g("domain",{required:i("users.bulkCreate.validation.domainRequired",{defaultValue:"Domain is required"})}),error:(O=w.domain)==null?void 0:O.message,placeholder:"example.com"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(X,{label:`${i("users.bulkCreate.countLabel",{defaultValue:"Count"})} *`,type:"number",...g("count",{valueAsNumber:!0,required:i("users.bulkCreate.validation.countRequired",{defaultValue:"Count is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})},max:{value:200,message:i("users.bulkCreate.validation.countMax",{defaultValue:"Maximum 200"})}}),error:(n=w.count)==null?void 0:n.message}),e.jsx(X,{label:`${i("users.bulkCreate.startIndexLabel",{defaultValue:"Start Index"})} *`,type:"number",...g("startIndex",{valueAsNumber:!0,required:i("users.bulkCreate.validation.startIndexRequired",{defaultValue:"Start index is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})}}),error:($=w.startIndex)==null?void 0:$.message}),e.jsx(X,{label:i("users.bulkCreate.paddingLabel",{defaultValue:"Padding"}),type:"number",...g("padding",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})},max:{value:8,message:i("users.bulkCreate.validation.paddingMax",{defaultValue:"Maximum 8"})}}),error:(J=w.padding)==null?void 0:J.message})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:i("users.bulkCreate.previewTitle",{defaultValue:"Email Preview"})}),P.length===0?e.jsx("p",{className:"mt-1 text-xs text-muted",children:i("users.bulkCreate.previewEmpty",{defaultValue:"Enter prefix/domain to preview generated emails."})}):e.jsxs("ul",{className:"mt-2 space-y-1 text-xs text-muted",children:[P.map(N=>e.jsx("li",{children:N},N)),E>P.length?e.jsx("li",{children:"..."}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(X,{label:`${i("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...g("dataLimit",{valueAsNumber:!0,required:i("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(we=w.dataLimit)==null?void 0:we.message}),e.jsx(X,{label:`${i("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...g("expiryDays",{valueAsNumber:!0,required:i("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:i("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(W=w.expiryDays)==null?void 0:W.message}),e.jsx(X,{label:i("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...g("ipLimit",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(ge=w.ipLimit)==null?void 0:ge.message,placeholder:i("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-muted",children:i("common.status",{defaultValue:"Status"})}),e.jsxs("select",{...g("status"),className:"w-full rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",children:[e.jsx("option",{value:"ACTIVE",children:i("status.active",{defaultValue:"Active"})}),e.jsx("option",{value:"LIMITED",children:i("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:i("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:i("status.expired",{defaultValue:"Expired"})})]})]}),e.jsx(X,{label:i("users.note",{defaultValue:"Note"}),...g("note"),placeholder:i("users.bulkCreate.notePlaceholder",{defaultValue:"Optional note applied to all created users"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[i("users.bulkCreate.assignInboundsLabel",{defaultValue:"Assign Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-card/65 p-3",children:f.length===0?e.jsx("p",{className:"text-sm text-muted",children:i("users.bulkCreate.noActiveInbounds",{defaultValue:"No active inbounds available."})}):f.map(N=>e.jsxs("label",{className:"flex items-center gap-3 rounded-lg p-2 hover:bg-card/80",children:[e.jsx("input",{type:"checkbox",value:N.id,...g("inboundIds",{required:i("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line bg-card"}),e.jsxs("span",{className:"text-sm text-foreground",children:[N.protocol," - ",N.remark||`Port ${N.port}`]})]},N.id))}),w.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500",children:w.inboundIds.message}):null]}),e.jsxs("div",{className:"flex flex-col gap-2 border-t border-line/70 pt-4 sm:flex-row",children:[e.jsxs(j,{type:"submit",className:"flex-1",loading:l.isPending,children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),i("users.bulkCreate.submit",{defaultValue:"Create Users & Download Credentials"})]}),e.jsx(j,{type:"button",variant:"secondary",className:"flex-1",onClick:o,children:i("common.cancel",{defaultValue:"Cancel"})})]})]})]})})};function xt(o){const c=new Date(o),v=c.getFullYear(),i=String(c.getMonth()+1).padStart(2,"0"),s=String(c.getDate()).padStart(2,"0");return`${v}-${i}-${s}`}function Bs({user:o,onClose:c,onSuccess:v}){var V,E,C,z;const[i,s]=m.useState(""),l=ds(),{t:f}=Ce(),{register:g,handleSubmit:L,reset:p,formState:{errors:w}}=yt({defaultValues:{dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:xt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))}});m.useEffect(()=>{p({dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:xt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))})},[p,o.dataLimit,o.deviceLimit,o.expireDate,o.ipLimit]);const B=async P=>{s("");const A=new Date,O=new Date(`${P.expireDate}T23:59:59`).getTime()-A.getTime(),n=Math.max(1,Math.ceil(O/(1e3*60*60*24)));try{await l.mutateAsync({id:o.id,data:{dataLimit:Number(P.dataLimitGb),expiryDays:n,ipLimit:Number(P.ipLimit),deviceLimit:Number(P.deviceLimit)}}),v()}catch($){s(($==null?void 0:$.message)||f("users.quickEdit.saveFailed",{defaultValue:"Failed to update user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-md overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:f("users.quickEdit.title",{defaultValue:"Quick Edit"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:c,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":f("common.close",{defaultValue:"Close"}),children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:L(B),className:"space-y-5 p-5 sm:p-6",children:[i?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:i}):null,e.jsx(X,{label:f("users.quickEdit.dataLimitLabel",{defaultValue:"Data Limit (GB)"}),type:"number",...g("dataLimitGb",{valueAsNumber:!0,required:f("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:f("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(V=w.dataLimitGb)==null?void 0:V.message}),e.jsx(X,{label:f("users.quickEdit.expiryDateLabel",{defaultValue:"Expiry Date"}),type:"date",...g("expireDate",{required:f("users.quickEdit.validation.expiryDateRequired",{defaultValue:"Expiry date is required"})}),error:(E=w.expireDate)==null?void 0:E.message}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(X,{label:f("users.quickEdit.ipLimitLabel",{defaultValue:"IP Limit (0 = unlimited)"}),type:"number",...g("ipLimit",{valueAsNumber:!0,min:{value:0,message:f("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(C=w.ipLimit)==null?void 0:C.message}),e.jsx(X,{label:f("users.quickEdit.deviceLimitLabel",{defaultValue:"Device Limit (0 = unlimited)"}),type:"number",...g("deviceLimit",{valueAsNumber:!0,min:{value:0,message:f("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(z=w.deviceLimit)==null?void 0:z.message})]}),e.jsx("p",{className:"rounded-lg border border-line/70 bg-panel/60 px-3 py-2 text-xs text-muted",children:f("users.quickEdit.helper",{defaultValue:"Expiry is stored as days from now. We convert this date automatically when saving."})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",className:"flex-1",loading:l.isPending,children:f("users.quickEdit.saveChanges",{defaultValue:"Save Changes"})}),e.jsx(j,{type:"button",variant:"secondary",className:"flex-1",onClick:c,children:f("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}const $s=[{key:"v2ray",label:"V2Ray"},{key:"clash",label:"Clash"},{key:"singbox",label:"Sing-box"},{key:"wireguard",label:"WireGuard"}];function Ks({user:o,onClose:c}){var z,P,A,k,O;const{t:v}=Ce(),[i,s]=m.useState("v2ray"),[l,f]=m.useState(!1),g=wt({queryKey:["subscription-info",o.id],queryFn:()=>ue.getSubscriptionInfo(o.id)}),L=m.useMemo(()=>{var n,$;return(($=(n=g.data)==null?void 0:n.data)==null?void 0:$.urls)??{}},[(P=(z=g.data)==null?void 0:z.data)==null?void 0:P.urls]),p=m.useMemo(()=>{var n,$;return(($=(n=g.data)==null?void 0:n.data)==null?void 0:$.qrCodes)??{}},[(k=(A=g.data)==null?void 0:A.data)==null?void 0:k.qrCodes]),w=m.useMemo(()=>$s.filter(n=>!!L[n.key]),[L]),B=w.some(n=>n.key===i)?i:((O=w[0])==null?void 0:O.key)??"v2ray",V=L[B]||"",E=p[B],C=async()=>{V&&(await navigator.clipboard.writeText(V),f(!0),window.setTimeout(()=>f(!1),1200))};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:v("users.qrModal.title",{defaultValue:"Quick QR"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:c,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":v("common.close",{defaultValue:"Close"}),children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"space-y-5 p-5 sm:p-6",children:g.isLoading?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})}):g.isError?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:v("users.qrModal.loadFailed",{defaultValue:"Failed to load subscription QR."})}):w.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/60 px-4 py-6 text-center text-sm text-muted",children:v("users.qrModal.noFormats",{defaultValue:"No subscription formats available for this user."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:w.map(n=>e.jsx("button",{type:"button",onClick:()=>s(n.key),className:`rounded-lg px-3 py-2 text-xs font-medium transition ${B===n.key?"bg-brand-500 text-white":"border border-line/70 bg-card/80 text-muted hover:text-foreground"}`,children:n.label},n.key))}),e.jsxs("div",{className:"flex flex-col items-center gap-4 rounded-2xl border border-line/70 bg-panel/60 p-4",children:[e.jsx("div",{className:"rounded-xl border border-line/70 bg-white p-3",children:E?e.jsx("img",{src:E,alt:v("users.qrModal.alt",{defaultValue:"Subscription QR"}),className:"h-[220px] w-[220px]"}):e.jsx(ks,{value:V,size:220})}),e.jsx("p",{className:"w-full break-all rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground",children:V})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsxs(j,{type:"button",className:"flex-1",onClick:()=>void C(),children:[l?e.jsx(Ns,{className:"mr-2 h-4 w-4"}):e.jsx(Ss,{className:"mr-2 h-4 w-4"}),l?v("common.copied",{defaultValue:"Copied"}):v("users.copyLink",{defaultValue:"Copy Link"})]}),e.jsxs(j,{type:"button",variant:"secondary",className:"flex-1",onClick:()=>window.open(V,"_blank","noopener,noreferrer"),children:[e.jsx(Ls,{className:"mr-2 h-4 w-4"}),v("common.open",{defaultValue:"Open"})]})]})]})})]})})}const pt=({userId:o})=>{var L;const{t:c}=Ce(),v=gt(),[i,s]=m.useState(null),l=wt({queryKey:["user-devices",o,60],queryFn:async()=>(await it.get(`/users/${o}/devices`,{params:{windowMinutes:60}})).data,staleTime:1e4}),f=be({mutationFn:async p=>{await it.delete(`/users/${o}/devices/${encodeURIComponent(p)}`)},onSuccess:async()=>{await v.invalidateQueries({queryKey:["user-devices",o,60]}),await v.invalidateQueries({queryKey:["user-sessions"]})}}),g=((L=l.data)==null?void 0:L.devices)||[];return l.isLoading?e.jsx("p",{className:"text-xs text-muted",children:c("users.devices.loading",{defaultValue:"Loading active devices..."})}):g.length===0?e.jsx("p",{className:"text-xs text-muted",children:c("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsxs("div",{className:"space-y-2",children:[g.slice(0,6).map(p=>e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-lg border border-line/60 bg-card/70 px-3 py-2 text-xs",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-mono text-foreground",children:p.shortFingerprint||p.fingerprint.slice(0,10)}),e.jsxs("p",{className:"text-muted",children:[p.clientIp||c("users.devices.unknownIp",{defaultValue:"unknown IP"})," •"," ",p.online?c("common.online",{defaultValue:"Online"}):c("users.devices.lastSeen",{defaultValue:"Last {{time}}",time:Rs(p.lastSeenAt)})]})]}),e.jsx(j,{size:"sm",variant:"ghost",loading:f.isPending,onClick:()=>{s(p.fingerprint)},children:c("common.revoke",{defaultValue:"Revoke"})})]},p.fingerprint)),e.jsx(jt,{open:!!i,title:c("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}),description:c("users.devices.revokeDescription",{defaultValue:"This device will be disconnected and must refresh subscription before reconnecting."}),confirmLabel:c("common.revoke",{defaultValue:"Revoke"}),tone:"danger",loading:f.isPending,onCancel:()=>{f.isPending||s(null)},onConfirm:()=>{i&&f.mutateAsync(i).finally(()=>{s(null)})}})]})},Qs=({users:o,viewMode:c="auto",onlineUuidSet:v=new Set,onView:i,onPrefetch:s,onDelete:l,onQuickQr:f,onQuickEdit:g,onRotateKeys:L,onRevokeKeys:p,onDisconnectSessions:w,onRegenerateSubscription:B,onResetTraffic:V,onExtendExpiry:E,onDisableUser:C,onCopySubscription:z,onUpdateLimits:P,selectedUserIds:A=[],onSelectionChange:k,sessionsByUserId:O={}})=>{const{t:n}=Ce(),$=80,[J,we]=m.useState([]),[W,ge]=m.useState(()=>Math.min(o.length,$)),N=o.length>0&&A.length===o.length,ae=A.length>0&&A.length<o.length;m.useEffect(()=>{ge(Math.min(o.length,$))},[o.length]),m.useEffect(()=>{if(W>=o.length)return;const r=window.setTimeout(()=>{ge(y=>Math.min(o.length,y+$))},32);return()=>{window.clearTimeout(r)}},[W,o.length]);const _=o.slice(0,W),de=()=>{k&&k(N?[]:o.map(r=>r.id))},ce=r=>{k&&(A.includes(r)?k(A.filter(y=>y!==r)):k([...A,r]))},D=r=>{we(y=>y.includes(r)?y.filter(x=>x!==r):[...y,r])},Ee=c==="auto"?"space-y-3 md:hidden":c==="cards"?"space-y-3":"hidden",R=c==="auto"?"hidden overflow-x-auto md:block":c==="table"?"overflow-x-auto":"hidden",Se=r=>{const y={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"},x={ACTIVE:"status.active",EXPIRED:"status.expired",DISABLED:"status.disabled",LIMITED:"status.limited"}[r];return e.jsx(Ds,{variant:y[r]||"info",children:x?n(x,{defaultValue:r}):r})},M=r=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${r?"bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[r?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${r?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),r?n("common.online",{defaultValue:"Online"}):n("common.offline",{defaultValue:"Offline"})]}),je=r=>{if(!(r!=null&&r.lastSeenAt))return n("users.sessions.noActivity",{defaultValue:"No activity"});const y=new Date(r.lastSeenAt).getTime();if(Number.isNaN(y))return n("users.sessions.noActivity",{defaultValue:"No activity"});const x=Math.floor((Date.now()-y)/6e4);if(x<1)return n("users.sessions.justNow",{defaultValue:"just now"});if(x<60)return n("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:x});const T=Math.floor(x/60);if(T<24)return n("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:T});const ee=Math.floor(T/24);return n("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:ee})},I=r=>{var T;if(!r)return"";const y=((T=r.currentInbound)==null?void 0:T.tag)||"",x=r.currentIp||"";return y&&x?`${y} • ${x}`:y||x||""},Le=r=>{const y=r,x=y==null?void 0:y.closest("details");x&&(x.open=!1)},d=(r,y)=>{r.preventDefault(),y&&y(),Le(r.currentTarget)},Ve=(r,y=!1)=>{const x=[];return f&&x.push({key:"qr",label:n("users.actions.showQr",{defaultValue:"Show QR"}),onClick:()=>f(r)}),g&&x.push({key:"edit",label:n("users.actions.quickEdit",{defaultValue:"Quick Edit"}),onClick:()=>g(r)}),!g&&P&&x.push({key:"limits",label:n("users.actions.increaseLimits",{defaultValue:"Increase limits"}),onClick:()=>P(r,{ipLimit:Number(r.ipLimit||0)+1,deviceLimit:Number(r.deviceLimit||0)+1})}),z&&x.push({key:"copy-sub",label:n("users.actions.copySubscription",{defaultValue:"Copy Subscription"}),onClick:()=>z(r)}),B&&x.push({key:"regen-token",label:n("users.actions.regenerateToken",{defaultValue:"Regenerate Token"}),onClick:()=>B(r)}),E&&(x.push({key:"extend7",label:n("users.actions.extend7",{defaultValue:"Extend +7 Days"}),onClick:()=>E(r,7)}),x.push({key:"extend30",label:n("users.actions.extend30",{defaultValue:"Extend +30 Days"}),onClick:()=>E(r,30)})),V&&x.push({key:"reset-traffic",label:n("users.actions.resetTraffic",{defaultValue:"Reset Traffic"}),onClick:()=>V(r)}),w&&x.push({key:"disconnect",label:n("users.actions.disconnectSessions",{defaultValue:"Disconnect Sessions"}),onClick:()=>w(r)}),L&&x.push({key:"rotate",label:n("users.actions.rotateCredentials",{defaultValue:"Rotate Credentials"}),onClick:()=>L(r)}),p&&x.push({key:"revoke",label:n("users.actions.revokeAccess",{defaultValue:"Revoke Access"}),onClick:()=>p(r)}),C&&x.push({key:"disable",label:n("users.actions.disableUser",{defaultValue:"Disable User"}),onClick:()=>C(r)}),l&&x.push({key:"delete",label:n("users.actions.deleteUser",{defaultValue:"Delete User"}),tone:"danger",onClick:()=>l(r.id)}),x.length===0?null:e.jsxs("details",{className:"relative",children:[e.jsx("summary",{className:`list-none cursor-pointer rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 [&::-webkit-details-marker]:hidden ${y?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,"aria-label":n("common.moreActions",{defaultValue:"More actions"}),title:n("common.moreActions",{defaultValue:"More actions"}),children:e.jsx("span",{className:"inline-flex items-center",children:e.jsx(Vt,{className:"h-4 w-4"})})}),e.jsx("div",{className:`absolute right-0 z-20 mt-2 w-56 rounded-xl border border-line/70 bg-card/95 p-1 shadow-lg shadow-black/10 backdrop-blur-sm ${y?"":"origin-top-right"}`,children:x.map(T=>e.jsx("button",{type:"button",className:`flex w-full items-center justify-start rounded-lg px-3 py-2 text-left text-sm transition-colors ${T.tone==="danger"?"text-red-500 hover:bg-red-500/10":"text-foreground hover:bg-panel/70"}`,onClick:ee=>d(ee,T.onClick),children:T.label},T.key))})]})};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:Ee,children:[k?e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-line/70 bg-card/75 px-4 py-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-foreground",children:[e.jsx("input",{type:"checkbox",checked:N,ref:r=>{r&&(r.indeterminate=ae)},onChange:de,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),n("common.selectAll",{defaultValue:"Select All"})]}),e.jsx("span",{className:"text-xs text-muted",children:n("users.selectedCount",{defaultValue:"{{count}} selected",count:A.length})})]}):null,_.map(r=>{var me;const y=Number(r.uploadUsed||0),x=Number(r.downloadUsed||0),T=Number(r.dataLimit||0),ee=y+x,te=T>0?(ee/T*100).toFixed(1):"0.0",se=!!r.startOnFirstUse&&!r.firstUsedAt,le=se?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,Q=se?le||0:ot(r.expireDate),b=O[r.id],ne=(b==null?void 0:b.online)??v.has(r.uuid),he=Number.isFinite(b==null?void 0:b.activeKeyCount)?Number(b==null?void 0:b.activeKeyCount):Number(((me=r.inbounds)==null?void 0:me.length)||0),De=Number.isFinite(b==null?void 0:b.onlineKeyCount)?Number(b==null?void 0:b.onlineKeyCount):ne?Math.min(1,he||1):0,ye=I(b),ke=je(b);return e.jsxs("div",{className:"rounded-xl border border-line/70 bg-card/80 p-4",onMouseEnter:()=>s==null?void 0:s(r),onFocus:()=>s==null?void 0:s(r),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("button",{type:"button",className:"truncate text-left text-sm font-medium text-foreground transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40",onClick:()=>i(r),children:r.email}),e.jsxs("p",{className:"font-mono text-xs text-muted",children:[r.uuid.substring(0,8),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k?e.jsx("input",{type:"checkbox",checked:A.includes(r.id),onChange:()=>ce(r.id),className:"mt-0.5 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}):null,Ve(r,!0)]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[Se(r.status),M(ne),e.jsx("span",{className:"text-xs text-muted",children:n("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:De,total:he||0})}),e.jsx("span",{className:"text-xs text-muted",children:n("users.limitIpShort",{defaultValue:"IP {{count}}",count:Number(r.ipLimit||0)})}),e.jsx("span",{className:"text-xs text-muted",children:n("users.limitDeviceShort",{defaultValue:"DEV {{count}}",count:Number(r.deviceLimit||0)})}),ye?e.jsx("span",{className:"text-xs text-muted",children:ye}):null,ne?null:e.jsx("span",{className:"text-xs text-muted",children:n("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:ke})})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-xs text-foreground",children:[Ie(ee)," / ",Ie(T)]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(te)>90?"bg-red-600":Number.parseFloat(te)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(te),100)}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted",children:[e.jsx("span",{children:n("users.usagePercent",{defaultValue:"{{percent}}% used",percent:te})}),se?e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:n("users.startOnFirstConnectBadge",{defaultValue:"Starts on first connect (+{{days}}d)",days:le})}):e.jsx("span",{className:Q<7?"text-red-600 dark:text-red-400":"",children:Q>0?n("common.daysLeft",{defaultValue:"{{count}} days left",count:Q}):n("common.expired",{defaultValue:"Expired"})})]})]}),e.jsxs("button",{type:"button",onClick:()=>D(r.id),className:"mt-3 flex w-full items-center justify-between rounded-xl border border-line/60 bg-panel/35 px-4 py-3 text-left text-sm text-foreground transition hover:bg-panel/55","aria-label":J.includes(r.id)?n("users.devices.hide",{defaultValue:"Hide devices"}):n("users.devices.show",{defaultValue:"Show devices"}),children:[e.jsx("span",{className:"font-medium",children:n("users.devices.title",{defaultValue:"Devices"})}),J.includes(r.id)?e.jsx(ut,{className:"h-4 w-4 text-brand-500"}):e.jsx(Te,{className:"h-4 w-4 text-brand-500"})]}),J.includes(r.id)?e.jsx("div",{className:"mt-3 rounded-lg border border-line/60 bg-panel/50 p-3",children:e.jsx(pt,{userId:r.id})}):null]},`mobile-${r.id}`)})]}),e.jsx("div",{className:R,children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800/50",children:e.jsxs("tr",{children:[k&&e.jsx("th",{className:"w-12 px-6 py-3",children:e.jsx("input",{type:"checkbox",checked:N,ref:r=>{r&&(r.indeterminate=ae)},onChange:de,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.user",{defaultValue:"User"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.online",{defaultValue:"Online"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.dataUsage",{defaultValue:"Data Usage"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.limits",{defaultValue:"Limits"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.expiry",{defaultValue:"Expiry"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.devices.title",{defaultValue:"Devices"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.actions",{defaultValue:"Actions"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-800",children:_.map(r=>{var me;const y=Number(r.uploadUsed||0),x=Number(r.downloadUsed||0),T=Number(r.dataLimit||0),ee=y+x,te=T>0?(ee/T*100).toFixed(1):"0.0",se=!!r.startOnFirstUse&&!r.firstUsedAt,le=se?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,Q=se?le||0:ot(r.expireDate),b=O[r.id],ne=(b==null?void 0:b.online)??v.has(r.uuid),he=Number.isFinite(b==null?void 0:b.activeKeyCount)?Number(b==null?void 0:b.activeKeyCount):Number(((me=r.inbounds)==null?void 0:me.length)||0),De=Number.isFinite(b==null?void 0:b.onlineKeyCount)?Number(b==null?void 0:b.onlineKeyCount):ne?Math.min(1,he||1):0,ye=I(b),ke=je(b);return e.jsxs(m.Fragment,{children:[e.jsxs("tr",{className:"transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50",onMouseEnter:()=>s==null?void 0:s(r),children:[k&&e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"checkbox",checked:A.includes(r.id),onChange:()=>ce(r.id),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{type:"button",className:"text-left text-sm font-medium text-gray-900 transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:text-white",onClick:()=>i(r),children:r.email}),e.jsxs("span",{className:"font-mono text-xs text-gray-500 dark:text-gray-400",children:[r.uuid.substring(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4",children:Se(r.status)}),e.jsxs("td",{className:"px-6 py-4",children:[M(ne),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:De,total:he||0})}),ye?e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:ye}):null,ne?null:e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:ke})})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:[Ie(ee)," / ",Ie(T)]}),e.jsx("div",{className:"mt-1 h-2 w-32 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(te)>90?"bg-red-600":Number.parseFloat(te)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(te),100)}%`}})}),e.jsx("span",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.usagePercent",{defaultValue:"{{percent}}% used",percent:te})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:n("users.limitIpAbbrev",{defaultValue:"IP"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.ipLimit||0)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:n("users.limitDeviceAbbrev",{defaultValue:"DEV"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.deviceLimit||0)})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:se?n("users.startOnFirstConnect",{defaultValue:"Starts on first connect"}):new Date(r.expireDate).toLocaleDateString()}),se?e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400",children:n("users.startOnFirstConnectAfter",{defaultValue:"{{count}} days after first connect",count:le})}):e.jsx("span",{className:`text-xs ${Q<7?"text-red-600 dark:text-red-400":Q<30?"text-yellow-600 dark:text-yellow-400":"text-gray-500 dark:text-gray-400"}`,children:Q>0?n("common.daysLeft",{defaultValue:"{{count}} days left",count:Q}):n("common.expired",{defaultValue:"Expired"})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>D(r.id),"aria-label":J.includes(r.id)?n("users.devices.hide",{defaultValue:"Hide devices"}):n("users.devices.show",{defaultValue:"Show devices"}),children:J.includes(r.id)?e.jsx(ut,{className:"h-4 w-4 text-brand-500"}):e.jsx(Te,{className:"h-4 w-4 text-brand-500"})})}),e.jsx("td",{className:"px-6 py-4",children:Ve(r)})]}),J.includes(r.id)?e.jsx("tr",{className:"bg-panel/45",children:e.jsx("td",{colSpan:(k?1:0)+8,className:"px-6 py-4",children:e.jsx(pt,{userId:r.id})})}):null]},r.id)})})]})}),W<o.length?e.jsx("div",{className:"flex items-center justify-center rounded-xl border border-line/60 bg-card/60 px-3 py-2 text-xs text-muted",children:n("users.rendering",{defaultValue:"Rendering {{count}} of {{total}} users...",count:W,total:o.length})}):null]})};function Gs({open:o,title:c,description:v,label:i="Value",placeholder:s,defaultValue:l="",inputType:f="text",confirmLabel:g="Save",cancelLabel:L="Cancel",loading:p=!1,onCancel:w,onConfirm:B}){const[V,E]=m.useState(l);return m.useEffect(()=>{o&&E(l)},[l,o]),o?e.jsx("div",{className:"fixed inset-0 z-[110] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:C=>{C.target===C.currentTarget&&!p&&w()},children:e.jsxs("div",{className:"w-full max-w-md overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/20",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-5",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"mt-0.5 rounded-full bg-brand-500/15 p-1 text-brand-400",children:e.jsx(Ts,{className:"h-4 w-4"})}),e.jsx("h3",{className:"text-base font-semibold text-foreground",children:c})]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:w,disabled:p,"aria-label":"Close dialog",children:e.jsx(Fe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 px-4 py-4 sm:px-5",children:[v?e.jsx("p",{className:"whitespace-pre-wrap text-sm text-muted",children:v}):null,e.jsxs("label",{className:"space-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-foreground",children:i}),e.jsx("input",{autoFocus:!0,type:f,className:"w-full rounded-xl border border-line/80 bg-card/80 px-3 py-2 text-sm text-foreground outline-none transition focus:border-brand-500/70 focus:ring-2 focus:ring-brand-500/35",placeholder:s,value:V,disabled:p,onChange:C=>{E(C.target.value)},onKeyDown:C=>{C.key==="Enter"&&!p&&(C.preventDefault(),B(V)),C.key==="Escape"&&!p&&(C.preventDefault(),w())}})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-5",children:[e.jsx(j,{type:"button",variant:"secondary",onClick:w,disabled:p,children:L}),e.jsx(j,{type:"button",variant:"primary",onClick:()=>B(V),loading:p,disabled:p,children:g})]})]})}):null}function zs(o){if(!o||typeof o!="object")return;const c=o.meta||o.pagination;if(c)return c}function bt(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function Os(){var at,rt;const o=rs(),c=gt(),[v,i]=ls(),{t:s}=Ce(),l=ht(),f=ns(t=>t.admin),g=(f==null?void 0:f.role)==="SUPER_ADMIN",L=Es("one-ui/users-filters",{page:1,search:"",status:"",viewMode:"auto"}),{views:p,saveView:w,deleteView:B}=As("one-ui/users-saved-views"),[V,E]=m.useState(""),C=L.value.page,z=L.value.search,P=L.value.status,A=L.value.viewMode,k=L.setValue,O=m.useCallback(t=>{k(a=>{const u=typeof t=="function"?t(a.page):t;return{...a,page:Math.max(1,u)}})},[k]),n=m.useCallback(t=>{k(a=>({...a,search:t}))},[k]),$=m.useCallback(t=>{k(a=>({...a,status:t}))},[k]),J=m.useCallback(t=>{k(a=>({...a,viewMode:t}))},[k]),[we,W]=m.useState(!1),[ge,N]=m.useState(!1),[ae,_]=m.useState(null),[de,ce]=m.useState(null),[D,Ee]=m.useState(null),[R,Se]=m.useState(null),[M,je]=m.useState(null),[I,Le]=m.useState(null),[d,Ve]=m.useState([]),[r,y]=m.useState(""),[x,T]=m.useState("DISABLED"),ee=Us(z,320),te=v.get("quick"),se=m.useRef(null),le=m.useRef(null),Q=cs({page:C,limit:50,search:ee,status:P||void 0}),b=os({page:1,limit:100,includeDisabled:!1}),ne=ms(),he=fs(),De=xs(),ye=ps(),ke=bs(),me=gs(),We=hs(),Pe=ys(),_e=vs(),He=ws(),Re=be({mutationFn:({userIds:t,dryRun:a})=>ue.bulkReorderUserInboundsByPattern({userIds:t,pattern:"myanmar",dryRun:a})}),Ue=be({mutationFn:({userIds:t,dryRun:a,windowMinutes:u})=>ue.bulkReorderUserInboundsByQuality({userIds:t,windowMinutes:u,dryRun:a})}),qe=be({mutationFn:({groupId:t,userIds:a})=>Me.addUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([c.invalidateQueries({queryKey:["groups"]}),c.invalidateQueries({queryKey:["group",a.groupId]}),c.invalidateQueries({queryKey:["users"]})])}}),Be=be({mutationFn:({groupId:t,userIds:a})=>Me.removeUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([c.invalidateQueries({queryKey:["groups"]}),c.invalidateQueries({queryKey:["group",a.groupId]}),c.invalidateQueries({queryKey:["users"]})])}}),$e=be({mutationFn:({groupId:t,userIds:a})=>Me.moveUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([c.invalidateQueries({queryKey:["groups"]}),c.invalidateQueries({queryKey:["group",a.groupId]}),c.invalidateQueries({queryKey:["users"]})])}}),Ae=be({mutationFn:({groupId:t,payload:a})=>Me.applyPolicy(t,a),onSuccess:async(t,a)=>{await Promise.all([c.invalidateQueries({queryKey:["groups"]}),c.invalidateQueries({queryKey:["group",a.groupId]}),c.invalidateQueries({queryKey:["users"]}),c.invalidateQueries({queryKey:["user-effective-policy"]})])}}),kt=be({mutationFn:({userId:t,payload:a})=>ue.updateUser(t,a),onSuccess:async(t,a)=>{await Promise.all([c.invalidateQueries({queryKey:["users"]}),c.invalidateQueries({queryKey:["user",a.userId]}),c.invalidateQueries({queryKey:["user-devices",a.userId,60]})])}}),F=m.useMemo(()=>{var t;return((t=Q.data)==null?void 0:t.data)??[]},[Q.data]),re=m.useMemo(()=>{var t;return((t=b.data)==null?void 0:t.data)??[]},[b.data]),fe=m.useMemo(()=>zs(Q.data),[Q.data]),Nt=m.useMemo(()=>F.map(t=>t.id),[F]),q=js(Nt,{includeOffline:!0,refetchInterval:5e3,staleTime:5e3}),Ke=m.useMemo(()=>{var t;return Object.fromEntries((((t=q.data)==null?void 0:t.sessions)||[]).map(a=>[a.userId,a]))},[(at=q.data)==null?void 0:at.sessions]),Qe=m.useMemo(()=>{var t;return new Set((((t=q.data)==null?void 0:t.sessions)||[]).filter(a=>a.online).map(a=>String(a.uuid||"")))},[(rt=q.data)==null?void 0:rt.sessions]),Ct=m.useMemo(()=>F.filter(t=>t.status==="ACTIVE").length,[F]),Ge=m.useMemo(()=>F.filter(t=>{var a;return((a=Ke[t.id])==null?void 0:a.online)||Qe.has(t.uuid)}).length,[Qe,Ke,F]),St=m.useMemo(()=>F.filter(t=>t.status==="LIMITED").length,[F]),Lt=m.useMemo(()=>F.filter(t=>t.status==="EXPIRED").length,[F]),ze=m.useMemo(()=>F.filter(t=>d.includes(t.id)),[F,d]),Xe=g,Oe=g,K=ke.isPending||me.isPending||We.isPending||Pe.isPending||_e.isPending||He.isPending||Re.isPending||Ue.isPending||qe.isPending||Be.isPending||$e.isPending||Ae.isPending,Dt=m.useMemo(()=>q.streamStatus==="connected"?s("users.streamStatus.connected",{defaultValue:"Connected"}):q.streamStatus==="connecting"?q.reconnectAttempts>0?s("users.streamStatus.reconnecting",{defaultValue:"Reconnecting ({{count}})",count:q.reconnectAttempts}):s("users.streamStatus.connecting",{defaultValue:"Connecting"}):q.streamStatus==="error"?s("common.error",{defaultValue:"Error"}):s("users.streamStatus.idle",{defaultValue:"Idle"}),[s,q.reconnectAttempts,q.streamStatus]),Rt=m.useMemo(()=>{if(!q.lastSnapshotAt)return s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"});const t=new Date(q.lastSnapshotAt);return Number.isNaN(t.getTime())?s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"}):s("users.streamSnapshot.lastUpdate",{defaultValue:"Last update {{time}}",time:t.toLocaleTimeString()})},[s,q.lastSnapshotAt]);m.useEffect(()=>{O(1)},[ee,O,P]),m.useEffect(()=>{Ve(t=>t.filter(a=>F.some(u=>u.id===a)))},[F]),m.useEffect(()=>{if(!re.length){r!==""&&y("");return}re.some(a=>String(a.id)===r)||y(String(re[0].id))},[re,r]),m.useEffect(()=>{if(te==="create"){W(!0);const t=new URLSearchParams(v);t.delete("quick"),i(t,{replace:!0})}},[te,v,i]);const G=({title:t,description:a,confirmLabel:u="Confirm",tone:h="danger"})=>new Promise(U=>{se.current=U,Ee({title:t,description:a,confirmLabel:u,tone:h})}),Ze=t=>{const a=se.current;se.current=null,Ee(null),a&&a(t)},Ye=({title:t,description:a,label:u,placeholder:h,defaultValue:U="",inputType:Y="text",confirmLabel:Ne="Save"})=>new Promise(xe=>{le.current=xe,Se({title:t,description:a,label:u,placeholder:h,defaultValue:U,inputType:Y,confirmLabel:Ne})}),Je=t=>{const a=le.current;le.current=null,Se(null),a&&a(t)},Ut=async t=>{if(await G({title:s("users.deleteUser",{defaultValue:"Delete User"}),description:s("users.confirmDelete",{defaultValue:"Are you sure you want to delete this user?"}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await ne.mutateAsync(t),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.userDeleted",{defaultValue:"User deleted successfully"}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.deleteFailed",{defaultValue:"Failed to delete user"}))}},Et=()=>{if(F.length===0)return;const t=[[s("users.email",{defaultValue:"Email"}),s("users.uuid",{defaultValue:"UUID"}),s("common.status",{defaultValue:"Status"}),s("users.dataUsed",{defaultValue:"Data Used"}),s("users.dataLimit",{defaultValue:"Data Limit"}),s("users.expireDate",{defaultValue:"Expire Date"})].map(bt).join(","),...F.map(U=>[U.email,U.uuid,U.status,Number(U.uploadUsed)+Number(U.downloadUsed),U.dataLimit,U.expireDate].map(bt).join(","))].join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),u=window.URL.createObjectURL(a),h=document.createElement("a");h.href=u,h.setAttribute("download",`users-${new Date().toISOString()}.csv`),h.click(),window.URL.revokeObjectURL(u)},Z=()=>{Ve([])},At=t=>{const a=t,u=a==null?void 0:a.closest("details");u&&(u.open=!1)},H=(t,a)=>{t.preventDefault(),t.stopPropagation(),a&&a(),At(t.currentTarget)},S=async(t={})=>{const a=[Q.refetch()];q.streamStatus!=="connected"&&a.push(q.refetch()),t.includeGroups&&a.push(b.refetch()),await Promise.all(a)},ie=Ms(()=>S(),{enabled:!0,intervalMs:5e3}),et=async()=>{const t=await Ye({title:s("common.saveView",{defaultValue:"Save View"}),description:s("users.views.saveDescription",{defaultValue:"Create a reusable filter preset for this Users page."}),label:s("users.views.nameLabel",{defaultValue:"View name"}),placeholder:s("users.views.namePlaceholder",{defaultValue:"My team filter"}),confirmLabel:s("common.saveView",{defaultValue:"Save View"})});if(!(!t||!t.trim()))try{const a=w(t.trim(),{search:z,status:P,viewMode:A});E(a.id),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.savedToast",{defaultValue:'View "{{name}}" saved',name:a.name}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.views.saveFailed",{defaultValue:"Unable to save view"}))}},tt=t=>{E(t);const a=p.find(u=>u.id===t);a&&(L.setValue(u=>({...u,page:1,search:a.filters.search||"",status:a.filters.status||"",viewMode:a.filters.viewMode||"auto"})),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.appliedToast",{defaultValue:'Applied "{{name}}"',name:a.name})))},st=()=>{if(!V)return;const t=p.find(a=>a.id===V);B(V),E(""),l.info(s("common.info",{defaultValue:"Info"}),t?s("users.views.removedToast",{defaultValue:'Removed "{{name}}"',name:t.name}):s("users.views.removedToastGeneric",{defaultValue:"Saved view removed"}))},Mt=async()=>{if(d.length!==0&&await G({title:s("users.bulk.deleteTitle",{defaultValue:"Delete Selected Users"}),description:s("users.bulk.deleteDescription",{defaultValue:"Delete {{count}} selected users? This cannot be undone.",count:d.length}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await ke.mutateAsync(d),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkDeleted",{defaultValue:"{{count}} user(s) deleted.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkDeleteFailed",{defaultValue:"Failed to delete selected users"}))}},It=async()=>{if(d.length!==0&&await G({title:s("users.bulk.resetTrafficTitle",{defaultValue:"Reset Traffic"}),description:s("users.bulk.resetTrafficDescription",{defaultValue:"Reset traffic for {{count}} selected users?",count:d.length}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await me.mutateAsync(d),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkTrafficReset",{defaultValue:"{{count}} user(s) reset.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkResetFailed",{defaultValue:"Failed to reset traffic"}))}},Tt=async()=>{if(d.length===0)return;const t=await Ye({title:s("users.bulk.extendExpiryTitle",{defaultValue:"Extend Expiry"}),description:s("users.bulk.extendExpiryDescription",{defaultValue:"Extend expiry for {{count}} selected users.",count:d.length}),label:s("users.bulk.daysToAdd",{defaultValue:"Days to add"}),defaultValue:"30",inputType:"number",confirmLabel:s("common.extend",{defaultValue:"Extend"})});if(!t||!t.trim())return;const a=Number.parseInt(t,10);if(Number.isNaN(a)||a<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.invalidDays",{defaultValue:"Please enter a valid positive number of days."}));return}try{await We.mutateAsync({userIds:d,days:a}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkExpiryExtended",{defaultValue:"{{count}} user(s) extended by {{days}} day(s).",count:d.length,days:a}))}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.bulkExtendFailed",{defaultValue:"Failed to extend expiry"}))}},Ft=async()=>{if(d.length!==0&&await G({title:s("users.bulk.applyStatusTitle",{defaultValue:"Apply Status"}),description:s("users.bulk.applyStatusDescription",{defaultValue:"Set status to {{status}} for {{count}} selected users?",status:x,count:d.length}),confirmLabel:s("common.apply",{defaultValue:"Apply"}),tone:"primary"}))try{await Pe.mutateAsync({userIds:d,status:x}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkStatusUpdated",{defaultValue:"{{count}} user(s) set to {{status}}.",count:d.length,status:x}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkUpdateFailed",{defaultValue:"Failed to update status"}))}},Pt=async()=>{if(d.length!==0&&await G({title:s("users.bulk.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.bulk.rotateDescription",{defaultValue:"Rotate credentials for {{count}} selected users?",count:d.length}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await _e.mutateAsync({userIds:d,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRotated",{defaultValue:"{{count}} user(s) rotated.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRotateFailed",{defaultValue:"Failed to rotate selected user keys"}))}},qt=async()=>{if(d.length!==0&&await G({title:s("users.bulk.revokeTitle",{defaultValue:"Revoke Access"}),description:s("users.bulk.revokeDescription",{defaultValue:"Revoke access for {{count}} selected users?",count:d.length}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await He.mutateAsync({userIds:d,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRevoked",{defaultValue:"{{count}} user(s) revoked.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRevokeFailed",{defaultValue:"Failed to revoke selected user access"}))}},Bt=async(t,a)=>{try{await kt.mutateAsync({userId:t.id,payload:a}),await S()}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.limitUpdateFailed",{defaultValue:"Failed to update user limits"}))}},$t=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=re.find(h=>h.id===t),u=(a==null?void 0:a.name)||`#${t}`;if(await G({title:s("users.bulk.assignTitle",{defaultValue:"Assign To Group"}),description:s("users.bulk.assignDescription",{defaultValue:'Assign {{count}} selected users to group "{{group}}"?',count:d.length,group:u}),confirmLabel:s("common.assign",{defaultValue:"Assign"}),tone:"primary"}))try{await qe.mutateAsync({groupId:t,userIds:d}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.assignedToGroup",{defaultValue:"{{count}} user(s) assigned to {{group}}.",count:d.length,group:u}))}catch(h){l.error(s("common.error",{defaultValue:"Error"}),(h==null?void 0:h.message)||s("users.toast.assignFailed",{defaultValue:"Failed to assign users to group"}))}},Kt=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=re.find(h=>h.id===t),u=(a==null?void 0:a.name)||`#${t}`;if(await G({title:s("users.bulk.removeTitle",{defaultValue:"Remove From Group"}),description:s("users.bulk.removeDescription",{defaultValue:'Remove {{count}} selected users from group "{{group}}"?',count:d.length,group:u}),confirmLabel:s("common.remove",{defaultValue:"Remove"}),tone:"danger"}))try{await Be.mutateAsync({groupId:t,userIds:d}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.removedFromGroup",{defaultValue:"{{count}} user(s) removed from {{group}}.",count:d.length,group:u}))}catch(h){l.error(s("common.error",{defaultValue:"Error"}),(h==null?void 0:h.message)||s("users.toast.removeFailed",{defaultValue:"Failed to remove users from group"}))}},Qt=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=re.find(h=>h.id===t),u=(a==null?void 0:a.name)||`#${t}`;if(await G({title:s("users.bulk.moveTitle",{defaultValue:"Move To Group"}),description:s("users.bulk.moveDescription",{defaultValue:'Move {{count}} selected users exclusively to group "{{group}}"?',count:d.length,group:u}),confirmLabel:s("common.move",{defaultValue:"Move"}),tone:"primary"}))try{await $e.mutateAsync({groupId:t,userIds:d}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.movedToGroup",{defaultValue:"{{count}} user(s) moved to {{group}}.",count:d.length,group:u}))}catch(h){l.error(s("common.error",{defaultValue:"Error"}),(h==null?void 0:h.message)||s("users.toast.moveFailed",{defaultValue:"Failed to move users to group"}))}},Gt=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=re.find(h=>h.id===t),u=(a==null?void 0:a.name)||`#${t}`;try{const U=(await Ae.mutateAsync({groupId:t,payload:{dryRun:!0,userIds:d}})).data||{},Y=U.summary||{},xe=(Array.isArray(U.preview)?U.preview:[]).slice(0,2).map(lt=>`${lt.email}: ${Object.keys(lt.changes||{}).join(", ")||s("common.noChanges",{defaultValue:"no changes"})}`).join(`
`),oe=[s("users.bulk.policyDryRunTitle",{defaultValue:'Group policy dry-run for "{{group}}":',group:u}),s("users.bulk.policyDryRunTarget",{defaultValue:"- target users: {{count}}",count:Y.targetUsers??d.length}),s("users.bulk.policyDryRunWouldUpdate",{defaultValue:"- would update: {{count}}",count:Y.wouldUpdateUsers??0}),s("users.bulk.policyDryRunSkipped",{defaultValue:"- skipped: {{count}}",count:Y.skippedUsers??0}),xe?`
${s("common.preview",{defaultValue:"Preview"})}:
${xe}`:"",`
${s("users.bulk.applyNow",{defaultValue:"Apply now?"})}`].filter(Boolean).join(`
`);if(!await G({title:s("users.bulk.applyPolicyTitle",{defaultValue:"Apply Group Policy"}),description:oe,confirmLabel:s("users.bulk.applyPolicyConfirm",{defaultValue:"Apply Policy"}),tone:"primary"}))return;await Ae.mutateAsync({groupId:t,payload:{dryRun:!1,userIds:d}}),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.policyApplied",{defaultValue:"{{count}} user(s) updated from {{group}}.",count:d.length,group:u}))}catch(h){l.error(s("common.error",{defaultValue:"Error"}),(h==null?void 0:h.message)||s("users.toast.policyApplyFailed",{defaultValue:"Failed to apply group policy"}))}},zt=async()=>{if(d.length!==0)try{const a=(await Re.mutateAsync({userIds:d,dryRun:!0})).data||{},u=a.summary||{},U=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(Y=>{const Ne=(Y.currentTop3||[]).map(oe=>oe.key).join(" > ")||"none",xe=(Y.newTop3||[]).map(oe=>oe.key).join(" > ")||"none";return`${Y.email}: ${Ne} -> ${xe}`}).filter(Boolean);je({userIds:[...d],targetUsers:u.targetUsers??d.length,wouldUpdateUsers:u.wouldUpdateUsers??0,unchangedUsers:u.unchangedUsers??0,changedKeys:u.changedKeys??0,matchedUsers:u.matchedUsers??0,previewLines:U})}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},Ot=async()=>{if(M)try{await Re.mutateAsync({userIds:M.userIds,dryRun:!1});const t=M.wouldUpdateUsers??0;je(null),Z(),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.myanmarPriorityApplied",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},Wt=async()=>{if(d.length!==0)try{const a=(await Ue.mutateAsync({userIds:d,windowMinutes:60,dryRun:!0})).data||{},u=a.summary||{},U=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(Y=>{const Ne=(Y.currentTop3||[]).map(oe=>oe.key).join(" > ")||"none",xe=(Y.newTop3||[]).map(oe=>oe.key).join(" > ")||"none";return`${Y.email}: ${Ne} -> ${xe}`}).filter(Boolean);Le({userIds:[...d],targetUsers:u.targetUsers??d.length,wouldUpdateUsers:u.wouldUpdateUsers??0,unchangedUsers:u.unchangedUsers??0,changedKeys:u.changedKeys??0,scoredKeys:u.scoredKeys??0,previewLines:U})}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},_t=async()=>{if(I)try{await Ue.mutateAsync({userIds:I.userIds,windowMinutes:60,dryRun:!1});const t=I.wouldUpdateUsers??0;Le(null),Z(),await S(),l.success(s("users.autoTuneAppliedTitle",{defaultValue:"Auto-tune applied"}),s("users.autoTuneAppliedBody",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},Ht=async t=>{if(await G({title:s("users.actions.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.actions.rotateDescription",{defaultValue:"Rotate all credentials for {{email}}?",email:t.email}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await he.mutateAsync({id:t.id,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.rotated",{defaultValue:"Updated {{email}}.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.rotateFailed",{defaultValue:"Failed to rotate user keys"}))}},Xt=async t=>{if(await G({title:s("users.actions.revokeTitle",{defaultValue:"Revoke User Access"}),description:s("users.actions.revokeDescription",{defaultValue:"Revoke all access for {{email}}? This will disable the user.",email:t.email}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await De.mutateAsync({id:t.id,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.accessRevoked",{defaultValue:"{{email}} was disabled.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.revokeFailed",{defaultValue:"Failed to revoke user access"}))}},Zt=async t=>{var a;if(await G({title:s("users.actions.regenerateTitle",{defaultValue:"Regenerate Subscription Token"}),description:s("users.actions.regenerateDescription",{defaultValue:"Regenerate subscription token for {{email}}?",email:t.email}),confirmLabel:s("common.regenerate",{defaultValue:"Regenerate"}),tone:"primary"}))try{const u=await ye.mutateAsync(t.id),h=`${window.location.origin}/sub/${u.subscriptionToken}?target=v2ray`;let U=!1;try{(a=navigator.clipboard)!=null&&a.writeText&&(await navigator.clipboard.writeText(h),U=!0)}catch{U=!1}U?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegeneratedCopied",{defaultValue:"New link for {{email}} was copied.",email:t.email})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegenerated",{defaultValue:"Token updated for {{email}}.",email:t.email})),await S()}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.regenerateFailed",{defaultValue:"Failed to regenerate subscription token"}))}},Yt=async t=>{if(await G({title:s("users.actions.resetTrafficTitle",{defaultValue:"Reset User Traffic"}),description:s("users.actions.resetTrafficDescription",{defaultValue:"Reset traffic for {{email}}?",email:t.email}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await ue.resetTraffic(t.id),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.trafficReset",{defaultValue:"{{email}} counters were reset.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.resetFailed",{defaultValue:"Failed to reset user traffic"}))}},Jt=async(t,a)=>{try{await ue.extendExpiry(t.id,a),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.expiryExtended",{defaultValue:"{{email}} extended by {{days}} day(s).",email:t.email,days:a}))}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.extendFailed",{defaultValue:"Failed to extend user expiry"}))}},es=async t=>{if(await G({title:s("users.actions.disableTitle",{defaultValue:"Disable User"}),description:s("users.actions.disableDescription",{defaultValue:"Disable {{email}}?",email:t.email}),confirmLabel:s("common.disable",{defaultValue:"Disable"}),tone:"danger"}))try{await ue.updateUser(t.id,{status:"DISABLED"}),await ue.disconnectUserSessions(t.id),await S(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userDisabled",{defaultValue:"{{email}} is now disabled and disconnected.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disableFailed",{defaultValue:"Failed to disable user"}))}},ts=async t=>{if(await G({title:s("users.actions.disconnectTitle",{defaultValue:"Disconnect Sessions"}),description:s("users.actions.disconnectDescription",{defaultValue:"Disconnect all active sessions for {{email}}?",email:t.email}),confirmLabel:s("common.disconnect",{defaultValue:"Disconnect"}),tone:"danger"}))try{const a=await ue.disconnectUserSessions(t.id);await S();const u=a!=null&&a.data?`${a.data.disconnectedDevices} device(s), ${a.data.disconnectedIps} IP(s)`:s("users.toast.sessionsDisconnectedFallback",{defaultValue:"Active sessions disconnected."});l.success(s("common.success",{defaultValue:"Success"}),u)}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disconnectFailed",{defaultValue:"Failed to disconnect active sessions"}))}},ss=async t=>{const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;try{await navigator.clipboard.writeText(a),l.success(s("common.copied",{defaultValue:"Copied"}),s("users.toast.subscriptionCopied",{defaultValue:"Subscription link copied to clipboard."}))}catch{l.warning(s("users.toast.clipboardUnavailableTitle",{defaultValue:"Clipboard unavailable"}),s("users.toast.clipboardUnavailableBody",{defaultValue:`Copy failed. Use this link manually:
{{link}}`,link:a}),1e4)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:s("users.title")}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.subtitle",{defaultValue:"Manage your VPN users and subscriptions"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(j,{variant:"secondary",onClick:Et,disabled:F.length===0,children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),s("common.export",{defaultValue:"Export CSV"})]}),e.jsxs(j,{variant:"secondary",onClick:()=>N(!0),children:[e.jsx(ct,{className:"mr-2 h-4 w-4"}),s("users.bulkProvision",{defaultValue:"Bulk Provision"})]}),e.jsxs(j,{onClick:()=>W(!0),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),s("users.addUser")]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.totalUsers")}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(fe==null?void 0:fe.total)||F.length})]}),e.jsx(ct,{className:"h-6 w-6 text-brand-500"})]})}),e.jsxs(pe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.activeUsers")}),e.jsx("p",{className:"text-2xl font-bold text-emerald-500",children:Ct})]}),e.jsxs(pe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"relative inline-flex h-3 w-3",children:[Ge>0?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-3 w-3 rounded-full ${Ge>0?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:Ge})]}),e.jsxs("p",{className:"mt-1 text-xs text-muted",children:[s("users.sessionStream",{defaultValue:"Session stream"}),": ",Dt]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[Rt,q.streamError?` • ${q.streamError}`:""]})]}),e.jsxs(pe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.limited",{defaultValue:"Limited Users"})}),e.jsx("p",{className:"text-2xl font-bold text-amber-500",children:St})]}),e.jsxs(pe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.expiredUsers")}),e.jsx("p",{className:"text-2xl font-bold text-rose-500",children:Lt})]})]}),e.jsx(pe,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Is,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-muted"}),e.jsx(X,{placeholder:s("users.searchPlaceholder",{defaultValue:"Search by email or UUID..."}),value:z,onChange:t=>n(t.target.value),className:"pl-10"})]})}),e.jsxs("select",{className:"rounded-xl border border-line/80 bg-card/75 px-4 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:P,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"",children:s("users.allStatus",{defaultValue:"All Status"})}),e.jsx("option",{value:"ACTIVE",children:s("status.active")}),e.jsx("option",{value:"LIMITED",children:s("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:s("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:s("status.expired",{defaultValue:"Expired"})})]}),e.jsxs(j,{variant:"secondary",onClick:()=>{ie.forceRefresh()},children:[e.jsx(Vs,{className:`mr-2 h-4 w-4 ${Q.isFetching||q.isFetching?"animate-spin":""}`}),s("common.refresh",{defaultValue:"Refresh"})]})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsxs("details",{className:"group lg:hidden",children:[e.jsxs("summary",{className:"flex list-none items-center justify-between gap-3 rounded-xl px-2 py-2 text-left text-sm font-medium text-foreground transition hover:bg-panel/50 [&::-webkit-details-marker]:hidden",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate",children:s("common.advancedControls",{defaultValue:"Advanced controls"})}),e.jsx("p",{className:"mt-0.5 text-xs font-normal text-muted",children:s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:ie.statusLabel,seconds:Math.ceil(ie.nextRunInMs/1e3)})})]}),e.jsx(Te,{className:"h-5 w-5 shrink-0 text-muted transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] flex-1 rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:V,onChange:t=>tt(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),p.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(j,{size:"sm",variant:"secondary",onClick:()=>{et()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(j,{size:"sm",variant:"ghost",onClick:st,disabled:!V,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>J(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${A===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(j,{size:"sm",variant:"ghost",onClick:ie.togglePaused,children:ie.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})})]})]})]}),e.jsxs("div",{className:"hidden items-center justify-between gap-3 lg:flex",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:V,onChange:t=>tt(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),p.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(j,{size:"sm",variant:"secondary",onClick:()=>{et()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(j,{size:"sm",variant:"ghost",onClick:st,disabled:!V,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>J(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${A===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(j,{size:"sm",variant:"ghost",onClick:ie.togglePaused,children:ie.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})}),e.jsx("span",{className:"text-xs text-muted",children:s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:ie.statusLabel,seconds:Math.ceil(ie.nextRunInMs/1e3)})})]})]})]})]})}),e.jsxs(pe,{padding:!1,children:[d.length>0?e.jsx("div",{className:"border-b border-line/70 bg-panel/50 px-4 py-3 sm:px-6",children:e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"text-sm text-foreground",children:[s("users.selectedCount",{defaultValue:"{{count}} selected",count:d.length}),ze.length>0?` (${ze.map(t=>t.email).slice(0,2).join(", ")}${ze.length>2?", ...":""})`:""]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsxs("details",{className:"group relative",children:[e.jsx("summary",{className:"list-none",onClick:t=>{K&&t.preventDefault()},children:e.jsxs(j,{size:"sm",variant:"secondary",disabled:K,children:[e.jsx(Vt,{className:"mr-2 h-4 w-4"}),s("common.bulkActions",{defaultValue:"Bulk actions"}),e.jsx(Te,{className:"ml-2 h-4 w-4 text-muted transition-transform group-open:rotate-180"})]})}),e.jsxs("div",{className:"absolute right-0 z-20 mt-2 w-[min(92vw,22rem)] rounded-2xl border border-line/70 bg-panel/95 p-2 shadow-soft backdrop-blur",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-medium text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,Z),disabled:K,children:s("common.clearSelection",{defaultValue:"Clear selection"})}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void It()),disabled:K,children:"Reset traffic"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void Tt()),disabled:K,children:"Extend expiry"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void Pt()),disabled:K,children:"Rotate keys"}),Oe?e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void qt()),disabled:K,children:"Revoke access"}):null,e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void zt()),disabled:K,children:"Myanmar priority reorder"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void Wt()),disabled:K,children:s("users.bulkQualityAutoTune",{defaultValue:"Quality auto-tune reorder"})})]}),e.jsx("div",{className:"my-2 border-t border-line/60"}),re.length>0?e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Groups"}),e.jsx("select",{value:r,onChange:t=>y(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:K||b.isFetching,children:re.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>H(t,()=>void $t()),loading:qe.isPending,disabled:K||!r,children:"Assign"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>H(t,()=>void Qt()),loading:$e.isPending,disabled:K||!r,children:"Move"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>H(t,()=>void Kt()),loading:Be.isPending,disabled:K||!r,children:"Remove"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>H(t,()=>void Gt()),loading:Ae.isPending,disabled:K||!r,children:"Apply Policy"})]})]}):e.jsx("div",{className:"px-2 pb-1 pt-2",children:e.jsx(j,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>H(t,()=>o("/groups")),disabled:b.isFetching,children:"Create group"})}),e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Status"}),e.jsxs("select",{value:x,onChange:t=>T(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:K,children:[e.jsx("option",{value:"ACTIVE",children:"ACTIVE"}),e.jsx("option",{value:"LIMITED",children:"LIMITED"}),e.jsx("option",{value:"DISABLED",children:"DISABLED"}),e.jsx("option",{value:"EXPIRED",children:"EXPIRED"})]}),e.jsx(j,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>H(t,()=>void Ft()),loading:Pe.isPending,disabled:K,children:"Apply status"})]}),Xe?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10 focus:outline-none focus:ring-2 focus:ring-rose-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>H(t,()=>void Mt()),disabled:K,children:"Delete selected"})]}):null]})]})})]})}):null,Q.isLoading?e.jsx("div",{className:"space-y-4 p-5",children:Array.from({length:6}).map((t,a)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ve,{className:"h-4 w-4 rounded"}),e.jsx(ve,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ve,{className:"h-4 w-1/3"}),e.jsx(ve,{className:"h-3 w-1/4"})]}),e.jsx(ve,{className:"h-6 w-16 rounded-full"}),e.jsx(ve,{className:"h-4 w-24"}),e.jsx(ve,{className:"h-8 w-8 rounded-lg"})]},a))}):F.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.noUsers",{defaultValue:"No users found"})}),e.jsxs(j,{className:"mt-4",onClick:()=>W(!0),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),s("users.addFirst")]})]}):e.jsx(Qs,{users:F,viewMode:A,onlineUuidSet:Qe,sessionsByUserId:Ke,onQuickQr:t=>_(t),onQuickEdit:t=>ce(t),onRotateKeys:t=>{Ht(t)},onRevokeKeys:Oe?t=>{Xt(t)}:void 0,onDisconnectSessions:t=>{ts(t)},onRegenerateSubscription:t=>{Zt(t)},onResetTraffic:t=>{Yt(t)},onExtendExpiry:(t,a)=>{Jt(t,a)},onDisableUser:Oe?t=>{es(t)}:void 0,onCopySubscription:t=>{ss(t)},onUpdateLimits:(t,a)=>{Bt(t,a)},selectedUserIds:d,onSelectionChange:Ve,onPrefetch:t=>{dt(`/users/${t.id}`)},onView:t=>{dt(`/users/${t.id}`),o(`/users/${t.id}`)},onDelete:Xe?t=>{Ut(t)}:void 0})]}),fe&&fe.totalPages>1?e.jsxs(pe,{className:"flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center",children:[e.jsx("div",{className:"text-sm text-muted",children:s("common.showing",{count:F.length,total:fe.total})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"secondary",size:"sm",disabled:C<=1,onClick:()=>O(t=>t-1),children:s("common.previous")}),e.jsx("span",{className:"px-3 text-sm text-foreground/85",children:s("common.page",{current:C,total:fe.totalPages})}),e.jsx(j,{variant:"secondary",size:"sm",disabled:C>=fe.totalPages,onClick:()=>O(t=>t+1),children:s("common.next")})]})]}):null,we?e.jsx(Cs,{onClose:()=>W(!1),onSuccess:t=>{if(W(!1),S(),t!=null&&t.subscriptionToken){const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;try{navigator.clipboard.writeText(a).then(()=>{l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreatedCopied",{defaultValue:"User created. Subscription link copied to clipboard."}))})}catch{l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreated",{defaultValue:"User created successfully."}))}_(t)}}}):null,ge?e.jsx(qs,{onClose:()=>N(!1),onSuccess:()=>{N(!1),S()}}):null,ae?e.jsx(Ks,{user:ae,onClose:()=>_(null)}):null,de?e.jsx(Bs,{user:de,onClose:()=>ce(null),onSuccess:()=>{ce(null),S()}}):null,e.jsx(nt,{open:!!M,title:"Bulk Myanmar Priority Preview",description:"Review the dry-run summary before applying reorder to selected users.",summaryRows:[{label:"Target Users",value:(M==null?void 0:M.targetUsers)??0},{label:"Would Reorder",value:(M==null?void 0:M.wouldUpdateUsers)??0},{label:"Unchanged",value:(M==null?void 0:M.unchangedUsers)??0}],previewLines:(M==null?void 0:M.previewLines)||[],confirmLabel:"Apply Bulk Priority",loading:Re.isPending,disableConfirm:!M||M.wouldUpdateUsers===0,onClose:()=>{Re.isPending||je(null)},onConfirm:()=>{Ot()}}),e.jsx(nt,{open:!!I,title:s("users.bulkQualityPreviewTitle",{defaultValue:"Bulk Quality Auto-tune Preview"}),description:s("users.bulkQualityPreviewBody",{defaultValue:"Reorder selected users by recent connect success, rejects, and reconnects."}),summaryRows:[{label:"Target Users",value:(I==null?void 0:I.targetUsers)??0},{label:"Would Reorder",value:(I==null?void 0:I.wouldUpdateUsers)??0},{label:"Telemetry Keys",value:(I==null?void 0:I.scoredKeys)??0}],previewLines:(I==null?void 0:I.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:Ue.isPending,disableConfirm:!I||I.wouldUpdateUsers===0,onClose:()=>{Ue.isPending||Le(null)},onConfirm:()=>{_t()}}),e.jsx(jt,{open:!!D,title:(D==null?void 0:D.title)||"Confirm",description:D==null?void 0:D.description,confirmLabel:(D==null?void 0:D.confirmLabel)||"Confirm",tone:(D==null?void 0:D.tone)||"danger",onCancel:()=>Ze(!1),onConfirm:()=>Ze(!0)}),e.jsx(Gs,{open:!!R,title:(R==null?void 0:R.title)||"Enter value",description:R==null?void 0:R.description,label:R==null?void 0:R.label,placeholder:R==null?void 0:R.placeholder,defaultValue:R==null?void 0:R.defaultValue,inputType:R==null?void 0:R.inputType,confirmLabel:(R==null?void 0:R.confirmLabel)||"Save",onCancel:()=>Je(null),onConfirm:t=>Je(t)})]})}const Ca=Os;export{Os as Users,Ca as UsersPage};
