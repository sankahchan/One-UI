import{c as _,r as y,u as H,j as e,X as O}from"./index-CG9kpP9Y.js";import{u as X}from"./index.esm-C0GmNgaO.js";import{u as J}from"./useGroups-B1L4fEZz.js";import{z as K,a as Q}from"./useUsers-BPTWPe_a.js";import{B as V}from"./Button-B80QVKRC.js";import{I as j}from"./Input-vpwyIRrG.js";import{u as W,R}from"./useTranslation-DQjABgHn.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=_("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function ne({user:s,onClose:b,onSuccess:f}){var S,A,P,F;const i=!!s,[h,u]=y.useState(""),[o,g]=y.useState("name"),{t}=W(),k=H(),x="one-ui.local",{data:N}=J(),r=y.useMemo(()=>Array.isArray(N)?N:[],[N]),d=y.useMemo(()=>r.filter(a=>a.enabled),[r]),U=K(),$=Q(),{register:c,handleSubmit:T,reset:D,setValue:w,watch:B,clearErrors:E,formState:{errors:m}}=X({defaultValues:{email:"",name:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""}});y.useEffect(()=>{var a;if(s){g("email");const l=1e3*60*60*24,L=!!s.startOnFirstUse&&!s.firstUsedAt?Math.max(1,Math.ceil((new Date(s.expireDate).getTime()-new Date(s.createdAt).getTime())/l)):Math.max(1,Math.ceil((new Date(s.expireDate).getTime()-Date.now())/l));D({email:s.email,name:"",dataLimit:Number(s.dataLimit)/1024**3,expiryDays:L,startOnFirstUse:!!s.startOnFirstUse,ipLimit:s.ipLimit??0,deviceLimit:s.deviceLimit??0,inboundIds:((a=s.inbounds)==null?void 0:a.filter(p=>{var n;return((n=p.inbound)==null?void 0:n.enabled)!==!1}).map(p=>String(p.inboundId)))||[],note:s.note||""});return}g("name"),D({email:"",name:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""})},[s,D]);const C=()=>{const a="abcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let v=0;v<8;v+=1)l+=a[Math.floor(Math.random()*a.length)];return l};y.useEffect(()=>{i||w("name",C(),{shouldDirty:!1,shouldTouch:!1,shouldValidate:!1})},[i,w]);const I=a=>String(a||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9._-]/g,"").replace(/[-._]{2,}/g,"-").replace(/^[-._]+|[-._]+$/g,"").slice(0,32),M=()=>{const a=C();if(o==="name"){w("name",a,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),E("name");return}w("email",`${a}@${x}`,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),E("email")},q=B("name"),G=I(q)?`${I(q)}@${x}`:"",Z=async a=>{u("");const l=(a.inboundIds||[]).map(n=>Number.parseInt(String(n),10)).filter(n=>Number.isInteger(n)&&n>0),v=I(a.name),L=!i&&o==="name"?v?`${v}@${x}`:"":String(a.email||"").trim();if(!L){u(o==="name"?t("users.form.validation.nameRequired",{defaultValue:"Name is required"}):t("users.form.validation.emailRequired",{defaultValue:"Email is required"}));return}if(!i&&d.length===0){u(t("users.form.validation.enabledInboundRequired",{defaultValue:"No enabled inbounds available. Enable or create one first."}));return}if(l.length===0){u(t("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"}));return}const p={email:L,dataLimit:Number(a.dataLimit),expiryDays:Number(a.expiryDays),ipLimit:Number(a.ipLimit),deviceLimit:Number(a.deviceLimit),inboundIds:l,note:a.note||void 0};i||(p.startOnFirstUse=!!a.startOnFirstUse);try{if(i&&s)await $.mutateAsync({id:s.id,data:p}),f();else{const n=await U.mutateAsync(p);f(n.data)}}catch(n){u((n==null?void 0:n.message)||t("users.form.saveFailed",{defaultValue:"Failed to save user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-2xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i?t("users.editUser",{defaultValue:"Edit User"}):t("users.addUser",{defaultValue:"Add User"})}),e.jsx("button",{onClick:b,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":t("common.close",{defaultValue:"Close"}),children:e.jsx(O,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:T(Z),className:"space-y-6 p-5 sm:p-6",children:[h?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:h}):null,i?null:e.jsxs("div",{className:"space-y-2 rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-[0.14em] text-muted",children:t("users.form.identityMode",{defaultValue:"Identity input"})}),e.jsxs("div",{className:"inline-flex rounded-lg border border-line/70 bg-card/70 p-1",children:[e.jsx("button",{type:"button",onClick:()=>g("name"),className:`rounded-md px-3 py-1.5 text-sm font-medium transition ${o==="name"?"bg-brand-500 text-white":"text-muted hover:bg-card hover:text-foreground"}`,children:t("users.form.useName",{defaultValue:"Name"})}),e.jsx("button",{type:"button",onClick:()=>g("email"),className:`rounded-md px-3 py-1.5 text-sm font-medium transition ${o==="email"?"bg-brand-500 text-white":"text-muted hover:bg-card hover:text-foreground"}`,children:t("users.form.useEmail",{defaultValue:"Email"})})]})]}),!i&&o==="name"?e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"ml-1 block text-sm font-medium text-muted",children:`${t("users.form.nameLabel",{defaultValue:"Name"})} *`}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"w-full rounded-xl border border-line/80 bg-card/75 px-4 py-2.5 pr-24 text-sm text-foreground outline-none transition-all duration-200 placeholder:text-muted focus-visible:border-brand-500/50 focus-visible:ring-2 focus-visible:ring-brand-500/40 focus-visible:ring-offset-2 focus-visible:ring-offset-app sm:text-base",placeholder:t("users.form.namePlaceholder",{defaultValue:"client001"}),...c("name",{validate:a=>i||o!=="name"?!0:String(a||"").trim()?/^[A-Za-z0-9._\-\s]{3,32}$/.test(String(a||""))?!0:t("users.form.validation.nameInvalid",{defaultValue:"Use 3-32 letters, numbers, dots, dashes, or underscores"}):t("users.form.validation.nameRequired",{defaultValue:"Name is required"})})}),e.jsxs("button",{type:"button",onClick:M,className:"absolute right-2 top-1/2 inline-flex -translate-y-1/2 items-center gap-1 rounded-lg border border-line/70 bg-card/90 px-2.5 py-1 text-xs font-medium text-foreground transition hover:bg-panel","aria-label":t("users.form.generateName",{defaultValue:"Generate name"}),children:[e.jsx(R,{className:"h-3.5 w-3.5"}),t("users.form.generate",{defaultValue:"Generate"})]})]}),m.name?e.jsx("p",{className:"ml-1 text-sm text-red-500 dark:text-red-300",children:m.name.message}):null,e.jsx("p",{className:"ml-1 text-xs text-muted",children:t("users.form.generatedEmailPreview",{defaultValue:"Stored email: {{email}}",email:G||`name@${x}`})})]}):e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"ml-1 block text-sm font-medium text-muted",children:`${t("users.email",{defaultValue:"Email"})} *`}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"email",className:"w-full rounded-xl border border-line/80 bg-card/75 px-4 py-2.5 pr-24 text-sm text-foreground outline-none transition-all duration-200 placeholder:text-muted focus-visible:border-brand-500/50 focus-visible:ring-2 focus-visible:ring-brand-500/40 focus-visible:ring-offset-2 focus-visible:ring-offset-app sm:text-base",placeholder:"user@example.com",...c("email",{validate:a=>{if(!i&&o!=="email")return!0;const l=String(a||"").trim();return l?/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(l)?!0:t("users.form.validation.emailInvalid",{defaultValue:"Invalid email address"}):t("users.form.validation.emailRequired",{defaultValue:"Email is required"})}})}),i?null:e.jsxs("button",{type:"button",onClick:M,className:"absolute right-2 top-1/2 inline-flex -translate-y-1/2 items-center gap-1 rounded-lg border border-line/70 bg-card/90 px-2.5 py-1 text-xs font-medium text-foreground transition hover:bg-panel","aria-label":t("users.form.generateEmail",{defaultValue:"Generate email"}),children:[e.jsx(R,{className:"h-3.5 w-3.5"}),t("users.form.generate",{defaultValue:"Generate"})]})]}),m.email?e.jsx("p",{className:"ml-1 text-sm text-red-500 dark:text-red-300",children:m.email.message}):null]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(j,{label:`${t("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...c("dataLimit",{valueAsNumber:!0,required:t("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:t("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(S=m.dataLimit)==null?void 0:S.message,placeholder:"50"}),e.jsx(j,{label:`${t("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...c("expiryDays",{valueAsNumber:!0,required:t("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:t("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(A=m.expiryDays)==null?void 0:A.message,placeholder:"30"})]}),i?null:e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx("input",{type:"checkbox",...c("startOnFirstUse"),className:"mt-1 h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t("users.form.startOnFirstUseTitle",{defaultValue:"Start expiry on first connect"})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:t("users.form.startOnFirstUseDescription",{defaultValue:"The expiry timer begins when the user first connects (downloads subscription). Until then, the account stays active."})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(j,{label:t("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...c("ipLimit",{valueAsNumber:!0,min:{value:0,message:t("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(P=m.ipLimit)==null?void 0:P.message,placeholder:t("users.ipLimitHint",{defaultValue:"0 = unlimited"})}),e.jsx(j,{label:t("users.form.deviceLimitLabel",{defaultValue:"Device Limit"}),type:"number",...c("deviceLimit",{valueAsNumber:!0,min:{value:0,message:t("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(F=m.deviceLimit)==null?void 0:F.message,placeholder:t("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[t("inbounds.title",{defaultValue:"Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-panel/55 p-3",children:d.length===0?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted",children:t("users.form.noEnabledInboundsHint",{defaultValue:"No enabled inbounds available. Enable or create one first."})}),e.jsx(V,{type:"button",size:"sm",variant:"secondary",onClick:()=>{b(),k("/inbounds")},children:t("inbounds.addInbound",{defaultValue:"Add Inbound"})})]}):d.map(a=>e.jsxs("label",{className:"flex cursor-pointer items-center space-x-3 rounded-lg p-2.5 transition hover:bg-card",children:[e.jsx("input",{type:"checkbox",value:a.id,...c("inboundIds",{validate:l=>l&&l.length>0||t("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("span",{className:"text-sm text-foreground",children:[a.protocol," - ",a.remark||`Port ${a.port}`]})]},a.id))}),m.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500 dark:text-red-300",children:m.inboundIds.message}):null]}),e.jsx(j,{label:t("users.note",{defaultValue:"Note"}),...c("note"),placeholder:t("users.form.notePlaceholder",{defaultValue:"Optional note about this user"})}),e.jsxs("div",{className:"sticky bottom-0 flex flex-col gap-2 border-t border-line/70 bg-card/95 pt-4 sm:flex-row",children:[e.jsx(V,{type:"submit",className:"flex-1",loading:U.isPending||$.isPending,disabled:!i&&d.length===0,children:i?t("users.form.updateUser",{defaultValue:"Update User"}):t("users.form.createUser",{defaultValue:"Create User"})}),e.jsx(V,{type:"button",variant:"secondary",onClick:b,className:"flex-1",children:t("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}function z(s,b){const f=Number.isInteger(Number(s.toPriority))?` [P${s.toPriority}]`:"";return`${b+1}. ${s.key}${f}`}function de({open:s,title:b="Myanmar Priority Preview",description:f,summaryRows:i,currentTop3:h=[],newTop3:u=[],previewLines:o=[],confirmLabel:g="Apply",loading:t=!1,disableConfirm:k=!1,onClose:x,onConfirm:N}){return s?e.jsx("div",{className:"fixed inset-0 z-[95] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:r=>{r.target===r.currentTarget&&!t&&x()},children:e.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/25",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:b}),f?e.jsx("p",{className:"mt-1 text-sm text-muted",children:f}):null]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:x,disabled:t,"aria-label":"Close preview",children:e.jsx(O,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"max-h-[70vh] space-y-4 overflow-y-auto px-4 py-4 sm:px-6",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-3",children:i.map(r=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/50 p-3",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-muted",children:r.label}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-foreground",children:r.value})]},r.label))}),h.length>0||u.length>0?e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Current Top 3"}),h.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No current entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:h.slice(0,3).map((r,d)=>e.jsx("li",{children:z(r,d)},`before-${r.key}-${d}`))})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"New Top 3"}),u.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No new entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:u.slice(0,3).map((r,d)=>e.jsx("li",{children:z(r,d)},`after-${r.key}-${d}`))})]})]}):null,o.length>0?e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Preview"}),e.jsx("ul",{className:"mt-2 space-y-1 text-xs text-foreground/90",children:o.map((r,d)=>e.jsx("li",{children:r},`${r}-${d}`))})]}):null]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-6",children:[e.jsx(V,{type:"button",variant:"secondary",onClick:x,disabled:t,children:"Cancel"}),e.jsx(V,{type:"button",onClick:N,loading:t,disabled:k||t,children:g})]})]})}):null}export{le as C,de as M,ne as U};
