import{e as r,f as W,r as v,o as G,k as w}from"./index-Mm4FQecB.js";import{u as q}from"./useQuery-Dl3gJxFq.js";import{u as n}from"./useMutation-BqgM2-rT.js";import{u as i,b as X,k as H,a as V,c as Y,d as Z,e as ee,r as se,f as te,h as re,i as ne,j as ie,l as ue,m as ae}from"./users-NDPCx2dd.js";const de=(e={})=>q({queryKey:["users",e],queryFn:()=>i.getUsers(e),placeholderData:w,staleTime:3e4}),ve=e=>q({queryKey:["user",e],queryFn:()=>i.getUserById(e),enabled:!!e,staleTime:3e4}),me=(e,s=60,t={})=>q({queryKey:["user-devices",e,s],queryFn:()=>i.getUserDevices(e,s),enabled:!!e,staleTime:t.staleTime??15e3,refetchInterval:t.refetchInterval}),qe=(e,s={})=>{const t=W(o=>o.token),[f,F]=v.useState(null),[C,u]=v.useState("idle"),[E,a]=v.useState(""),[L,M]=v.useState(null),[O,K]=v.useState(0),b=s.live!==!1,T=s.includeOffline??!0,R=v.useMemo(()=>e.filter(o=>Number.isInteger(o)&&o>0).join(","),[e]),A=Number.isInteger(s.streamInterval)?Math.min(Math.max(s.streamInterval,500),1e4):2e3,h=s.refetchInterval??1e4,D=q({queryKey:["user-sessions",e,s.includeOffline??!0],queryFn:()=>ue(e,{includeOffline:s.includeOffline??!0,limit:Math.max(1,e.length)}),enabled:e.length>0,refetchInterval:b&&C==="connected"?!1:h,staleTime:s.staleTime??5e3});return v.useEffect(()=>{if(!b){u("idle"),a(""),K(0);return}if(e.length===0){u("idle"),a(""),K(0),F(null);return}if(!t){u("error"),a("Missing auth token");return}const o=new AbortController,B=new TextDecoder;let U="",y=!0,S=null,m=0;const x=()=>{S&&(window.clearTimeout(S),S=null)},N=10,Q=d=>{if(!y||o.signal.aborted)return;if(m+=1,K(m),m>N){u("error"),a("Live stream unavailable after multiple retries. Falling back to polling.");return}const c=Math.min(1e3*2**Math.max(0,m-1),15e3);u("connecting"),a(d||`Stream disconnected. Retrying in ${(c/1e3).toFixed(0)}s...`),x(),S=window.setTimeout(()=>{I()},c)},I=async()=>{if(!(!y||o.signal.aborted)){u("connecting"),m===0&&a("");try{const d=new URLSearchParams({userIds:R,includeOffline:String(T),limit:String(e.length||200),interval:String(A)}),c=await fetch(`${G}/users/sessions/stream?${d.toString()}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,Accept:"text/event-stream"},signal:o.signal,cache:"no-store"});if(!c.ok||!c.body)throw new Error(`Live session stream unavailable (${c.status})`);if(!y)return;u("connected"),a(""),m=0,K(0);const P=c.body.getReader();for(;y;){const{done:$,value:j}=await P.read();if($){o.signal.aborted||Q("Live stream ended unexpectedly.");return}U+=B.decode(j,{stream:!0});const _=U.split(`

`);U=_.pop()||"";for(const z of _){const J=z.split(`
`);let k="message";const p=[];for(const l of J)l.startsWith("event:")?k=l.slice(6).trim():l.startsWith("data:")&&p.push(l.slice(5).trim());if(p.length===0)continue;const g=p.join(`
`);if(k==="snapshot")try{const l=JSON.parse(g);y&&(F(l),M(l.generatedAt||new Date().toISOString()),u("connected"),a(""))}catch{}else if(k==="error")try{const l=JSON.parse(g);y&&(a(l.message||"Live stream error"),u("error"),Q(l.message||"Live stream error"))}catch{y&&(a(g||"Live stream error"),u("error"),Q(g||"Live stream error"))}}}}catch(d){if(!o.signal.aborted&&y){u("error");const c=(d==null?void 0:d.message)||"Failed to connect live stream";a(c),Q(c)}}}};return I(),()=>{y=!1,x(),o.abort()}},[h,T,R,b,A,t,e.length]),{...D,data:f||D.data,streamStatus:C,streamError:E,lastSnapshotAt:L,reconnectAttempts:O}},fe=(e={})=>q({queryKey:["users-telemetry-sync-status"],queryFn:()=>i.getTelemetrySyncStatus(),staleTime:e.staleTime??5e3,refetchInterval:e.refetchInterval??5e3}),Ke=()=>{const e=r();return n({mutationFn:()=>i.runFallbackAutotune(),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["users-telemetry-sync-status"]})}})},Se=()=>{const e=r();return n({mutationFn:({id:s,payload:t})=>i.runDiagnostics(s,t||{}),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["users-telemetry-sync-status"]})}})},Qe=()=>{const e=r();return n({mutationFn:i.createUser,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},ge=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>i.updateUser(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]})}})},be=()=>{const e=r();return n({mutationFn:i.deleteUser,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},he=()=>{const e=r();return n({mutationFn:({id:s,fingerprint:t})=>i.revokeUserDevice(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user-devices",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},Ue=()=>{const e=r();return n({mutationFn:s=>H(s),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},ke=()=>{const e=r();return n({mutationFn:i.resetTraffic,onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t]})}})},pe=()=>{const e=r();return n({mutationFn:({id:s,inboundId:t,enabled:f})=>i.toggleUserInbound(s,t,f),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds"]})}})},Fe=()=>{const e=r();return n({mutationFn:({id:s,inboundId:t,priority:f})=>i.updateUserInboundPriority(s,t,f),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds-users-directory"]})}})},Ce=()=>{const e=r();return n({mutationFn:({id:s,assignments:t})=>i.reorderUserInbounds(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds-users-directory"]})}})},Te=(e,s={})=>q({queryKey:["user-activity",e,s],queryFn:()=>ae(e,s),enabled:!!e,placeholderData:w,staleTime:1e4}),Re=()=>{const e=r();return n({mutationFn:s=>V(s),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Ae=()=>{const e=r();return n({mutationFn:X,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},De=()=>{const e=r();return n({mutationFn:s=>Y(s),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},xe=()=>{const e=r();return n({mutationFn:({userIds:s,days:t})=>Z(s,t),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Ie=()=>{const e=r();return n({mutationFn:({userIds:s,status:t})=>ee(s,t),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},_e=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>se(s,t||{}),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["subscription-info",t.id]})}})},we=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>te(s,t||{}),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["subscription-info",t.id]})}})},Ee=()=>{const e=r();return n({mutationFn:s=>re(s),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t]}),e.invalidateQueries({queryKey:["subscription-info",t]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},Le=()=>{const e=r();return n({mutationFn:({userIds:s,data:t})=>ne(s,t||{}),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},Me=()=>{const e=r();return n({mutationFn:({userIds:s,data:t})=>ie(s,t||{}),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user-sessions"]})}})};export{Te as A,ge as a,de as b,be as c,Ue as d,_e as e,we as f,Ee as g,Re as h,De as i,xe as j,Ie as k,Le as l,Me as m,fe as n,Ke as o,Se as p,qe as q,ve as r,me as s,ke as t,Ae as u,he as v,pe as w,Fe as x,Ce as y,Qe as z};
