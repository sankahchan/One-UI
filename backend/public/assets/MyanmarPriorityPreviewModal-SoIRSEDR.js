import{c as $,r as D,j as e,X as I}from"./index-BBbY-zsF.js";import{u as E}from"./index.esm-hHFWIx9Y.js";import{u as F}from"./useGroups-BqQAt5z3.js";import{v as M,a as A}from"./useUsers-BQ5eGp52.js";import{B as v}from"./Button-278k26BX.js";import{I as f}from"./Input-hVY1OOjI.js";import{u as q}from"./useTranslation-6XXcKgY6.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=$("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function H({user:t,onClose:c,onSuccess:o}){var N,L,V,w,k;const m=!!t,[x,p]=D.useState(""),{t:s}=q(),{data:j}=F(),n=j||[],g=M(),b=A(),{register:d,handleSubmit:r,reset:l,formState:{errors:u}}=E({defaultValues:{email:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""}});D.useEffect(()=>{var a;if(t){const i=!!t.startOnFirstUse&&!t.firstUsedAt?Math.max(1,Math.ceil((new Date(t.expireDate).getTime()-new Date(t.createdAt).getTime())/864e5)):Math.max(1,Math.ceil((new Date(t.expireDate).getTime()-Date.now())/864e5));l({email:t.email,dataLimit:Number(t.dataLimit)/1024**3,expiryDays:i,startOnFirstUse:!!t.startOnFirstUse,ipLimit:t.ipLimit??0,deviceLimit:t.deviceLimit??0,inboundIds:((a=t.inbounds)==null?void 0:a.map(P=>String(P.inboundId)))||[],note:t.note||""});return}l({email:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""})},[t,l]);const C=async a=>{p("");const h=(a.inboundIds||[]).map(i=>Number.parseInt(String(i),10)).filter(i=>Number.isInteger(i)&&i>0),y={email:a.email,dataLimit:Number(a.dataLimit),expiryDays:Number(a.expiryDays),ipLimit:Number(a.ipLimit),deviceLimit:Number(a.deviceLimit),inboundIds:h,note:a.note||void 0};m||(y.startOnFirstUse=!!a.startOnFirstUse);try{if(m&&t)await b.mutateAsync({id:t.id,data:y}),o();else{const i=await g.mutateAsync(y);o(i.data)}}catch(i){p((i==null?void 0:i.message)||s("users.form.saveFailed",{defaultValue:"Failed to save user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-2xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:m?s("users.editUser",{defaultValue:"Edit User"}):s("users.addUser",{defaultValue:"Add User"})}),e.jsx("button",{onClick:c,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":s("common.close",{defaultValue:"Close"}),children:e.jsx(I,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:r(C),className:"space-y-6 p-5 sm:p-6",children:[x?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:x}):null,e.jsx(f,{label:`${s("users.email",{defaultValue:"Email"})} *`,type:"email",...d("email",{required:s("users.form.validation.emailRequired",{defaultValue:"Email is required"}),pattern:{value:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,message:s("users.form.validation.emailInvalid",{defaultValue:"Invalid email address"})}}),error:(N=u.email)==null?void 0:N.message,placeholder:"user@example.com"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(f,{label:`${s("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...d("dataLimit",{valueAsNumber:!0,required:s("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:s("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(L=u.dataLimit)==null?void 0:L.message,placeholder:"50"}),e.jsx(f,{label:`${s("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...d("expiryDays",{valueAsNumber:!0,required:s("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:s("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(V=u.expiryDays)==null?void 0:V.message,placeholder:"30"})]}),m?null:e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx("input",{type:"checkbox",...d("startOnFirstUse"),className:"mt-1 h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s("users.form.startOnFirstUseTitle",{defaultValue:"Start expiry on first connect"})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.form.startOnFirstUseDescription",{defaultValue:"The expiry timer begins when the user first connects (downloads subscription). Until then, the account stays active."})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(f,{label:s("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...d("ipLimit",{valueAsNumber:!0,min:{value:0,message:s("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(w=u.ipLimit)==null?void 0:w.message,placeholder:s("users.ipLimitHint",{defaultValue:"0 = unlimited"})}),e.jsx(f,{label:s("users.form.deviceLimitLabel",{defaultValue:"Device Limit"}),type:"number",...d("deviceLimit",{valueAsNumber:!0,min:{value:0,message:s("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(k=u.deviceLimit)==null?void 0:k.message,placeholder:s("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[s("inbounds.title",{defaultValue:"Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-panel/55 p-3",children:n.length===0?e.jsx("p",{className:"text-sm text-muted",children:s("users.form.noInboundsHint",{defaultValue:"No inbounds available. Create one first."})}):n.map(a=>e.jsxs("label",{className:"flex cursor-pointer items-center space-x-3 rounded-lg p-2.5 transition hover:bg-card",children:[e.jsx("input",{type:"checkbox",value:a.id,...d("inboundIds",{validate:h=>h&&h.length>0||s("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("span",{className:"text-sm text-foreground",children:[a.protocol," - ",a.remark||`Port ${a.port}`]})]},a.id))}),u.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500 dark:text-red-300",children:u.inboundIds.message}):null]}),e.jsx(f,{label:s("users.note",{defaultValue:"Note"}),...d("note"),placeholder:s("users.form.notePlaceholder",{defaultValue:"Optional note about this user"})}),e.jsxs("div",{className:"sticky bottom-0 flex flex-col gap-2 border-t border-line/70 bg-card/95 pt-4 sm:flex-row",children:[e.jsx(v,{type:"submit",className:"flex-1",loading:g.isPending||b.isPending,children:m?s("users.form.updateUser",{defaultValue:"Update User"}):s("users.form.createUser",{defaultValue:"Create User"})}),e.jsx(v,{type:"button",variant:"secondary",onClick:c,className:"flex-1",children:s("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}function U(t,c){const o=Number.isInteger(Number(t.toPriority))?` [P${t.toPriority}]`:"";return`${c+1}. ${t.key}${o}`}function X({open:t,title:c="Myanmar Priority Preview",description:o,summaryRows:m,currentTop3:x=[],newTop3:p=[],previewLines:s=[],confirmLabel:j="Apply",loading:n=!1,disableConfirm:g=!1,onClose:b,onConfirm:d}){return t?e.jsx("div",{className:"fixed inset-0 z-[95] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:r=>{r.target===r.currentTarget&&!n&&b()},children:e.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/25",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:c}),o?e.jsx("p",{className:"mt-1 text-sm text-muted",children:o}):null]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:b,disabled:n,"aria-label":"Close preview",children:e.jsx(I,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"max-h-[70vh] space-y-4 overflow-y-auto px-4 py-4 sm:px-6",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-3",children:m.map(r=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/50 p-3",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-muted",children:r.label}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-foreground",children:r.value})]},r.label))}),x.length>0||p.length>0?e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Current Top 3"}),x.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No current entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:x.slice(0,3).map((r,l)=>e.jsx("li",{children:U(r,l)},`before-${r.key}-${l}`))})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"New Top 3"}),p.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No new entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:p.slice(0,3).map((r,l)=>e.jsx("li",{children:U(r,l)},`after-${r.key}-${l}`))})]})]}):null,s.length>0?e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Preview"}),e.jsx("ul",{className:"mt-2 space-y-1 text-xs text-foreground/90",children:s.map((r,l)=>e.jsx("li",{children:r},`${r}-${l}`))})]}):null]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-6",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:b,disabled:n,children:"Cancel"}),e.jsx(v,{type:"button",onClick:d,loading:n,disabled:g||n,children:j})]})]})}):null}export{G as C,X as M,H as U};
