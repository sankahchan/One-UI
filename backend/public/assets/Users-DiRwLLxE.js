import{c as as,r as m,j as e,X as Ie,b as gt,u as rs,g as ls,e as ns}from"./index-31dYUl1e.js";import{u as pe}from"./useMutation-ClUFm1k_.js";import{u as oe,g as Ee}from"./users-bIRiBp0D.js";import{B as v}from"./Button-B1Z0NjYb.js";import{u as ht,C as xe}from"./useToast-DwaWtEZ4.js";import{u as yt}from"./index.esm-DVAEje_9.js";import{u as is,a as os}from"./useGroups-Bh52lXtY.js";import{u as us,a as ds,b as cs,c as ms,d as fs,e as xs,f as ps,g as bs,h as gs,i as hs,j as ys,k as vs,l as ws,m as js}from"./useUsers-BbUnCN1U.js";import{I as H}from"./Input-Djb_DGP2.js";import{u as ke,R as Vs}from"./useTranslation-BcYYym0T.js";import{D as vt}from"./download-BESVSTzz.js";import{u as wt}from"./useQuery-CtMNJR7o.js";import{Q as ks}from"./index-CO-SCVnj.js";import{C as Ns,U as Cs,M as nt}from"./MyanmarPriorityPreviewModal-BFIBNusR.js";import{C as Ss}from"./copy-D6G2TpML.js";import{E as Ls}from"./external-link-Cnnl0xuV.js";import{B as Ds}from"./Badge-CYgjB4Cb.js";import{D as Rs,M as jt}from"./DropdownMenu-DeKmLL9S.js";import{C as Vt}from"./ConfirmDialog-DQoCmtMH.js";import{apiClient as it}from"./client-ZrARDaOq.js";import{g as ot,f as Ae,a as Us}from"./formatters-CEEtD2TU.js";import{C as ut}from"./chevron-up-wrYlX3oU.js";import{C as Me}from"./chevron-down-BRVczzCr.js";import{u as Es}from"./useDebouncedValue-e6-oIhfy.js";import{u as As,a as Ms,b as Is}from"./useSmartAutoRefresh-D96pJdsr.js";import{S as ye}from"./Skeleton-Bgx-f_gz.js";import{p as dt}from"./routePrefetch-DfW4AnWL.js";import{U as ct}from"./users-BgUm0KHW.js";import{P as mt}from"./plus-DaEf3fGG.js";import{S as Ts}from"./search-BuAcAH5F.js";import"./cn-BLSKlp9E.js";import"./inbounds-CjoIMlxx.js";import"./xray-0RSqElo8.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=as("MessageSquareText",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M13 8H7",key:"14i4kc"}],["path",{d:"M17 12H7",key:"16if0g"}]]);function ft(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function Ps(o){if(!Array.isArray(o.users)||o.users.length===0)return;const h=[["Email","UUID","Password","Subscription Token","Expire Date","Status"].map(ft).join(","),...o.users.map(f=>[f.email,f.uuid,f.password,f.subscriptionToken,f.expireDate,f.status].map(ft).join(","))].join(`
`),i=new Blob([h],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.setAttribute("download",`bulk-users-${new Date().toISOString().replace(/[:.]/g,"-")}.csv`),l.click(),window.URL.revokeObjectURL(s)}function qs(o,d,h,i,s){const l=o.trim(),f=d.trim().replace(/^@+/,""),b=Number.isInteger(h)?Math.max(0,Math.min(h,5)):0,S=Number.isInteger(i)?Math.max(1,i):1,x=Number.isInteger(s)?Math.max(0,s):0;return!l||!f||b===0?[]:Array.from({length:b},(y,P)=>{const w=S+P,U=x>0?String(w).padStart(x,"0"):String(w);return`${l}${U}@${f}`})}const Bs=({onClose:o,onSuccess:d})=>{var j,G,n,q,Y,ve,O,be;const h=ht(),{t:i}=ke(),{data:s}=is(),l=us(),f=(s||[]).filter(V=>V.enabled!==!1),{register:b,handleSubmit:S,watch:x,formState:{errors:y}}=yt({defaultValues:{prefix:"user",domain:"example.com",count:10,startIndex:1,padding:2,dataLimit:50,expiryDays:30,inboundIds:[],ipLimit:0,status:"ACTIVE"}}),P=x("prefix"),w=x("domain"),U=Number(x("count")),N=Number(x("startIndex")),Q=Number(x("padding")),T=m.useMemo(()=>qs(P||"",w||"",U,N,Q),[P,w,U,N,Q]),E=async V=>{try{const te={...V,inboundIds:(V.inboundIds||[]).map(L=>Number(L)).filter(L=>Number.isInteger(L)&&L>0),count:Number(V.count),startIndex:Number(V.startIndex),padding:Number(V.padding),dataLimit:Number(V.dataLimit),expiryDays:Number(V.expiryDays),ipLimit:Number(V.ipLimit)},W=await l.mutateAsync(te);Ps(W);const ue=(W.failed||[]).slice(0,5).map(L=>`${L.email}: ${L.reason}`).join(`
`),de=[i("users.bulkCreate.toast.requested",{defaultValue:"Requested: {{count}}",count:W.requestedCount}),i("users.bulkCreate.toast.created",{defaultValue:"Created: {{count}}",count:W.createdCount}),i("users.bulkCreate.toast.failed",{defaultValue:"Failed: {{count}}",count:W.failedCount}),W.createdCount>0?i("users.bulkCreate.toast.csvDownloaded",{defaultValue:"Credentials CSV downloaded."}):void 0].filter(Boolean);h.success(i("common.success",{defaultValue:"Success"}),de.join(" • ")),ue&&h.warning(i("common.warning",{defaultValue:"Warning"}),ue),W.createdCount>0&&d()}catch(te){h.error(i("common.error",{defaultValue:"Error"}),(te==null?void 0:te.message)||i("users.bulkCreate.toast.failedBody",{defaultValue:"Failed to create users in bulk"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"my-6 w-full max-w-3xl overflow-hidden rounded-2xl border border-line/80 bg-card/95 shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-line/80 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i("users.bulkCreate.title",{defaultValue:"Bulk User Provisioning"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:i("users.bulkCreate.subtitle",{defaultValue:"Create multiple users with consistent limits and inbound assignments."})})]}),e.jsx("button",{onClick:o,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":i("common.close",{defaultValue:"Close"}),children:e.jsx(Ie,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:S(E),className:"space-y-6 p-5 sm:p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(H,{label:`${i("users.bulkCreate.prefixLabel",{defaultValue:"Email Prefix"})} *`,...b("prefix",{required:i("users.bulkCreate.validation.prefixRequired",{defaultValue:"Prefix is required"})}),error:(j=y.prefix)==null?void 0:j.message,placeholder:"user"}),e.jsx(H,{label:`${i("users.bulkCreate.domainLabel",{defaultValue:"Domain"})} *`,...b("domain",{required:i("users.bulkCreate.validation.domainRequired",{defaultValue:"Domain is required"})}),error:(G=y.domain)==null?void 0:G.message,placeholder:"example.com"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(H,{label:`${i("users.bulkCreate.countLabel",{defaultValue:"Count"})} *`,type:"number",...b("count",{valueAsNumber:!0,required:i("users.bulkCreate.validation.countRequired",{defaultValue:"Count is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})},max:{value:200,message:i("users.bulkCreate.validation.countMax",{defaultValue:"Maximum 200"})}}),error:(n=y.count)==null?void 0:n.message}),e.jsx(H,{label:`${i("users.bulkCreate.startIndexLabel",{defaultValue:"Start Index"})} *`,type:"number",...b("startIndex",{valueAsNumber:!0,required:i("users.bulkCreate.validation.startIndexRequired",{defaultValue:"Start index is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})}}),error:(q=y.startIndex)==null?void 0:q.message}),e.jsx(H,{label:i("users.bulkCreate.paddingLabel",{defaultValue:"Padding"}),type:"number",...b("padding",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})},max:{value:8,message:i("users.bulkCreate.validation.paddingMax",{defaultValue:"Maximum 8"})}}),error:(Y=y.padding)==null?void 0:Y.message})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:i("users.bulkCreate.previewTitle",{defaultValue:"Email Preview"})}),T.length===0?e.jsx("p",{className:"mt-1 text-xs text-muted",children:i("users.bulkCreate.previewEmpty",{defaultValue:"Enter prefix/domain to preview generated emails."})}):e.jsxs("ul",{className:"mt-2 space-y-1 text-xs text-muted",children:[T.map(V=>e.jsx("li",{children:V},V)),U>T.length?e.jsx("li",{children:"..."}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(H,{label:`${i("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...b("dataLimit",{valueAsNumber:!0,required:i("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(ve=y.dataLimit)==null?void 0:ve.message}),e.jsx(H,{label:`${i("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...b("expiryDays",{valueAsNumber:!0,required:i("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:i("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(O=y.expiryDays)==null?void 0:O.message}),e.jsx(H,{label:i("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...b("ipLimit",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(be=y.ipLimit)==null?void 0:be.message,placeholder:i("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-muted",children:i("common.status",{defaultValue:"Status"})}),e.jsxs("select",{...b("status"),className:"w-full rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",children:[e.jsx("option",{value:"ACTIVE",children:i("status.active",{defaultValue:"Active"})}),e.jsx("option",{value:"LIMITED",children:i("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:i("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:i("status.expired",{defaultValue:"Expired"})})]})]}),e.jsx(H,{label:i("users.note",{defaultValue:"Note"}),...b("note"),placeholder:i("users.bulkCreate.notePlaceholder",{defaultValue:"Optional note applied to all created users"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[i("users.bulkCreate.assignInboundsLabel",{defaultValue:"Assign Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-card/65 p-3",children:f.length===0?e.jsx("p",{className:"text-sm text-muted",children:i("users.bulkCreate.noActiveInbounds",{defaultValue:"No active inbounds available."})}):f.map(V=>e.jsxs("label",{className:"flex items-center gap-3 rounded-lg p-2 hover:bg-card/80",children:[e.jsx("input",{type:"checkbox",value:V.id,...b("inboundIds",{required:i("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line bg-card"}),e.jsxs("span",{className:"text-sm text-foreground",children:[V.protocol," - ",V.remark||`Port ${V.port}`]})]},V.id))}),y.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500",children:y.inboundIds.message}):null]}),e.jsxs("div",{className:"flex flex-col gap-2 border-t border-line/70 pt-4 sm:flex-row",children:[e.jsxs(v,{type:"submit",className:"flex-1",loading:l.isPending,children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),i("users.bulkCreate.submit",{defaultValue:"Create Users & Download Credentials"})]}),e.jsx(v,{type:"button",variant:"secondary",className:"flex-1",onClick:o,children:i("common.cancel",{defaultValue:"Cancel"})})]})]})]})})};function xt(o){const d=new Date(o),h=d.getFullYear(),i=String(d.getMonth()+1).padStart(2,"0"),s=String(d.getDate()).padStart(2,"0");return`${h}-${i}-${s}`}function $s({user:o,onClose:d,onSuccess:h}){var w,U,N,Q;const[i,s]=m.useState(""),l=ds(),{t:f}=ke(),{register:b,handleSubmit:S,reset:x,formState:{errors:y}}=yt({defaultValues:{dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:xt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))}});m.useEffect(()=>{x({dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:xt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))})},[x,o.dataLimit,o.deviceLimit,o.expireDate,o.ipLimit]);const P=async T=>{s("");const E=new Date,G=new Date(`${T.expireDate}T23:59:59`).getTime()-E.getTime(),n=Math.max(1,Math.ceil(G/(1e3*60*60*24)));try{await l.mutateAsync({id:o.id,data:{dataLimit:Number(T.dataLimitGb),expiryDays:n,ipLimit:Number(T.ipLimit),deviceLimit:Number(T.deviceLimit)}}),h()}catch(q){s((q==null?void 0:q.message)||f("users.quickEdit.saveFailed",{defaultValue:"Failed to update user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-md overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:f("users.quickEdit.title",{defaultValue:"Quick Edit"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:d,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":f("common.close",{defaultValue:"Close"}),children:e.jsx(Ie,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:S(P),className:"space-y-5 p-5 sm:p-6",children:[i?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:i}):null,e.jsx(H,{label:f("users.quickEdit.dataLimitLabel",{defaultValue:"Data Limit (GB)"}),type:"number",...b("dataLimitGb",{valueAsNumber:!0,required:f("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:f("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(w=y.dataLimitGb)==null?void 0:w.message}),e.jsx(H,{label:f("users.quickEdit.expiryDateLabel",{defaultValue:"Expiry Date"}),type:"date",...b("expireDate",{required:f("users.quickEdit.validation.expiryDateRequired",{defaultValue:"Expiry date is required"})}),error:(U=y.expireDate)==null?void 0:U.message}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(H,{label:f("users.quickEdit.ipLimitLabel",{defaultValue:"IP Limit (0 = unlimited)"}),type:"number",...b("ipLimit",{valueAsNumber:!0,min:{value:0,message:f("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(N=y.ipLimit)==null?void 0:N.message}),e.jsx(H,{label:f("users.quickEdit.deviceLimitLabel",{defaultValue:"Device Limit (0 = unlimited)"}),type:"number",...b("deviceLimit",{valueAsNumber:!0,min:{value:0,message:f("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(Q=y.deviceLimit)==null?void 0:Q.message})]}),e.jsx("p",{className:"rounded-lg border border-line/70 bg-panel/60 px-3 py-2 text-xs text-muted",children:f("users.quickEdit.helper",{defaultValue:"Expiry is stored as days from now. We convert this date automatically when saving."})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{type:"submit",className:"flex-1",loading:l.isPending,children:f("users.quickEdit.saveChanges",{defaultValue:"Save Changes"})}),e.jsx(v,{type:"button",variant:"secondary",className:"flex-1",onClick:d,children:f("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}const Ks=[{key:"v2ray",label:"V2Ray"},{key:"clash",label:"Clash"},{key:"singbox",label:"Sing-box"},{key:"wireguard",label:"WireGuard"}];function Qs({user:o,onClose:d}){var Q,T,E,j,G;const{t:h}=ke(),[i,s]=m.useState("v2ray"),[l,f]=m.useState(!1),b=wt({queryKey:["subscription-info",o.id],queryFn:()=>oe.getSubscriptionInfo(o.id)}),S=m.useMemo(()=>{var n,q;return((q=(n=b.data)==null?void 0:n.data)==null?void 0:q.urls)??{}},[(T=(Q=b.data)==null?void 0:Q.data)==null?void 0:T.urls]),x=m.useMemo(()=>{var n,q;return((q=(n=b.data)==null?void 0:n.data)==null?void 0:q.qrCodes)??{}},[(j=(E=b.data)==null?void 0:E.data)==null?void 0:j.qrCodes]),y=m.useMemo(()=>Ks.filter(n=>!!S[n.key]),[S]),P=y.some(n=>n.key===i)?i:((G=y[0])==null?void 0:G.key)??"v2ray",w=S[P]||"",U=x[P],N=async()=>{w&&(await navigator.clipboard.writeText(w),f(!0),window.setTimeout(()=>f(!1),1200))};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:h("users.qrModal.title",{defaultValue:"Quick QR"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:d,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":h("common.close",{defaultValue:"Close"}),children:e.jsx(Ie,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"space-y-5 p-5 sm:p-6",children:b.isLoading?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})}):b.isError?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:h("users.qrModal.loadFailed",{defaultValue:"Failed to load subscription QR."})}):y.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/60 px-4 py-6 text-center text-sm text-muted",children:h("users.qrModal.noFormats",{defaultValue:"No subscription formats available for this user."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:y.map(n=>e.jsx("button",{type:"button",onClick:()=>s(n.key),className:`rounded-lg px-3 py-2 text-xs font-medium transition ${P===n.key?"bg-brand-500 text-white":"border border-line/70 bg-card/80 text-muted hover:text-foreground"}`,children:n.label},n.key))}),e.jsxs("div",{className:"flex flex-col items-center gap-4 rounded-2xl border border-line/70 bg-panel/60 p-4",children:[e.jsx("div",{className:"rounded-xl border border-line/70 bg-white p-3",children:U?e.jsx("img",{src:U,alt:h("users.qrModal.alt",{defaultValue:"Subscription QR"}),className:"h-[220px] w-[220px]"}):e.jsx(ks,{value:w,size:220})}),e.jsx("p",{className:"w-full break-all rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground",children:w})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsxs(v,{type:"button",className:"flex-1",onClick:()=>void N(),children:[l?e.jsx(Ns,{className:"mr-2 h-4 w-4"}):e.jsx(Ss,{className:"mr-2 h-4 w-4"}),l?h("common.copied",{defaultValue:"Copied"}):h("users.copyLink",{defaultValue:"Copy Link"})]}),e.jsxs(v,{type:"button",variant:"secondary",className:"flex-1",onClick:()=>window.open(w,"_blank","noopener,noreferrer"),children:[e.jsx(Ls,{className:"mr-2 h-4 w-4"}),h("common.open",{defaultValue:"Open"})]})]})]})})]})})}const pt=({userId:o})=>{var S;const{t:d}=ke(),h=gt(),[i,s]=m.useState(null),l=wt({queryKey:["user-devices",o,60],queryFn:async()=>(await it.get(`/users/${o}/devices`,{params:{windowMinutes:60}})).data,staleTime:1e4}),f=pe({mutationFn:async x=>{await it.delete(`/users/${o}/devices/${encodeURIComponent(x)}`)},onSuccess:async()=>{await h.invalidateQueries({queryKey:["user-devices",o,60]}),await h.invalidateQueries({queryKey:["user-sessions"]})}}),b=((S=l.data)==null?void 0:S.devices)||[];return l.isLoading?e.jsx("p",{className:"text-xs text-muted",children:d("users.devices.loading",{defaultValue:"Loading active devices..."})}):b.length===0?e.jsx("p",{className:"text-xs text-muted",children:d("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsxs("div",{className:"space-y-2",children:[b.slice(0,6).map(x=>e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-lg border border-line/60 bg-card/70 px-3 py-2 text-xs",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-mono text-foreground",children:x.shortFingerprint||x.fingerprint.slice(0,10)}),e.jsxs("p",{className:"text-muted",children:[x.clientIp||d("users.devices.unknownIp",{defaultValue:"unknown IP"})," •"," ",x.online?d("common.online",{defaultValue:"Online"}):d("users.devices.lastSeen",{defaultValue:"Last {{time}}",time:Us(x.lastSeenAt)})]})]}),e.jsx(v,{size:"sm",variant:"ghost",loading:f.isPending,onClick:()=>{s(x.fingerprint)},children:d("common.revoke",{defaultValue:"Revoke"})})]},x.fingerprint)),e.jsx(Vt,{open:!!i,title:d("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}),description:d("users.devices.revokeDescription",{defaultValue:"This device will be disconnected and must refresh subscription before reconnecting."}),confirmLabel:d("common.revoke",{defaultValue:"Revoke"}),tone:"danger",loading:f.isPending,onCancel:()=>{f.isPending||s(null)},onConfirm:()=>{i&&f.mutateAsync(i).finally(()=>{s(null)})}})]})},Gs=({users:o,viewMode:d="auto",onlineUuidSet:h=new Set,onView:i,onPrefetch:s,onDelete:l,onQuickQr:f,onQuickEdit:b,onRotateKeys:S,onRevokeKeys:x,onDisconnectSessions:y,onRegenerateSubscription:P,onResetTraffic:w,onExtendExpiry:U,onDisableUser:N,onCopySubscription:Q,onUpdateLimits:T,selectedUserIds:E=[],onSelectionChange:j,sessionsByUserId:G={}})=>{const{t:n}=ke(),q=80,[Y,ve]=m.useState([]),[O,be]=m.useState(()=>Math.min(o.length,q)),V=o.length>0&&E.length===o.length,te=E.length>0&&E.length<o.length;m.useEffect(()=>{be(Math.min(o.length,q))},[o.length]),m.useEffect(()=>{if(O>=o.length)return;const a=window.setTimeout(()=>{be(k=>Math.min(o.length,k+q))},32);return()=>{window.clearTimeout(a)}},[O,o.length]);const W=o.slice(0,O),ue=()=>{j&&j(V?[]:o.map(a=>a.id))},de=a=>{j&&(E.includes(a)?j(E.filter(k=>k!==a)):j([...E,a]))},L=a=>{ve(k=>k.includes(a)?k.filter(c=>c!==a):[...k,a])},Re=d==="auto"?"space-y-3 md:hidden":d==="cards"?"space-y-3":"hidden",D=d==="auto"?"hidden overflow-x-auto md:block":d==="table"?"overflow-x-auto":"hidden",Ne=a=>{const k={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"},c={ACTIVE:"status.active",EXPIRED:"status.expired",DISABLED:"status.disabled",LIMITED:"status.limited"}[a];return e.jsx(Ds,{variant:k[a]||"info",children:c?n(c,{defaultValue:a}):a})},A=a=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${a?"bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[a?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${a?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),a?n("common.online",{defaultValue:"Online"}):n("common.offline",{defaultValue:"Offline"})]}),we=a=>{if(!(a!=null&&a.lastSeenAt))return n("users.sessions.noActivity",{defaultValue:"No activity"});const k=new Date(a.lastSeenAt).getTime();if(Number.isNaN(k))return n("users.sessions.noActivity",{defaultValue:"No activity"});const c=Math.floor((Date.now()-k)/6e4);if(c<1)return n("users.sessions.justNow",{defaultValue:"just now"});if(c<60)return n("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:c});const B=Math.floor(c/60);if(B<24)return n("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:B});const J=Math.floor(B/24);return n("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:J})},M=a=>{var B;if(!a)return"";const k=((B=a.currentInbound)==null?void 0:B.tag)||"",c=a.currentIp||"";return k&&c?`${k} • ${c}`:k||c||""},je=(a,k=!1)=>{const c=[];return f&&c.push({key:"qr",label:n("users.actions.showQr",{defaultValue:"Show QR"}),onClick:()=>f(a)}),b&&c.push({key:"edit",label:n("users.actions.quickEdit",{defaultValue:"Quick Edit"}),onClick:()=>b(a)}),!b&&T&&c.push({key:"limits",label:n("users.actions.increaseLimits",{defaultValue:"Increase limits"}),onClick:()=>T(a,{ipLimit:Number(a.ipLimit||0)+1,deviceLimit:Number(a.deviceLimit||0)+1})}),Q&&c.push({key:"copy-sub",label:n("users.actions.copySubscription",{defaultValue:"Copy Subscription"}),onClick:()=>Q(a)}),P&&c.push({key:"regen-token",label:n("users.actions.regenerateToken",{defaultValue:"Regenerate Token"}),onClick:()=>P(a)}),U&&(c.push({key:"extend7",label:n("users.actions.extend7",{defaultValue:"Extend +7 Days"}),onClick:()=>U(a,7)}),c.push({key:"extend30",label:n("users.actions.extend30",{defaultValue:"Extend +30 Days"}),onClick:()=>U(a,30)})),w&&c.push({key:"reset-traffic",label:n("users.actions.resetTraffic",{defaultValue:"Reset Traffic"}),onClick:()=>w(a)}),y&&c.push({key:"disconnect",label:n("users.actions.disconnectSessions",{defaultValue:"Disconnect Sessions"}),onClick:()=>y(a)}),S&&c.push({key:"rotate",label:n("users.actions.rotateCredentials",{defaultValue:"Rotate Credentials"}),onClick:()=>S(a)}),x&&c.push({key:"revoke",label:n("users.actions.revokeAccess",{defaultValue:"Revoke Access"}),onClick:()=>x(a)}),N&&c.push({key:"disable",label:n("users.actions.disableUser",{defaultValue:"Disable User"}),onClick:()=>N(a)}),l&&c.push({key:"delete",label:n("users.actions.deleteUser",{defaultValue:"Delete User"}),tone:"danger",onClick:()=>l(a.id)}),c.length===0?null:e.jsx(Rs,{items:c,ariaLabel:n("common.moreActions",{defaultValue:"More actions"}),triggerClassName:`rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${k?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,children:e.jsx(jt,{className:"h-4 w-4"})})};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:Re,children:[j?e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-line/70 bg-card/75 px-4 py-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-foreground",children:[e.jsx("input",{type:"checkbox",checked:V,ref:a=>{a&&(a.indeterminate=te)},onChange:ue,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),n("common.selectAll",{defaultValue:"Select All"})]}),e.jsx("span",{className:"text-xs text-muted",children:n("users.selectedCount",{defaultValue:"{{count}} selected",count:E.length})})]}):null,W.map(a=>{var he;const k=Number(a.uploadUsed||0),c=Number(a.downloadUsed||0),B=Number(a.dataLimit||0),J=k+c,se=B>0?(J/B*100).toFixed(1):"0.0",ae=!!a.startOnFirstUse&&!a.firstUsedAt,ce=ae?Math.max(1,Math.ceil((new Date(a.expireDate).getTime()-new Date(a.createdAt).getTime())/(1e3*60*60*24))):null,ee=ae?ce||0:ot(a.expireDate),p=G[a.id],z=(p==null?void 0:p.online)??h.has(a.uuid),re=Number.isFinite(p==null?void 0:p.activeKeyCount)?Number(p==null?void 0:p.activeKeyCount):Number(((he=a.inbounds)==null?void 0:he.length)||0),Ce=Number.isFinite(p==null?void 0:p.onlineKeyCount)?Number(p==null?void 0:p.onlineKeyCount):z?Math.min(1,re||1):0,ge=M(p),Se=we(p);return e.jsxs("div",{className:"rounded-xl border border-line/70 bg-card/80 p-4",onMouseEnter:()=>s==null?void 0:s(a),onFocus:()=>s==null?void 0:s(a),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("button",{type:"button",className:"truncate text-left text-sm font-medium text-foreground transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40",onClick:()=>i(a),children:a.email}),e.jsxs("p",{className:"font-mono text-xs text-muted",children:[a.uuid.substring(0,8),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[j?e.jsx("input",{type:"checkbox",checked:E.includes(a.id),onChange:()=>de(a.id),className:"mt-0.5 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}):null,je(a,!0)]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[Ne(a.status),A(z),e.jsx("span",{className:"text-xs text-muted",children:n("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:Ce,total:re||0})}),e.jsx("span",{className:"text-xs text-muted",children:n("users.limitIpShort",{defaultValue:"IP {{count}}",count:Number(a.ipLimit||0)})}),e.jsx("span",{className:"text-xs text-muted",children:n("users.limitDeviceShort",{defaultValue:"DEV {{count}}",count:Number(a.deviceLimit||0)})}),ge?e.jsx("span",{className:"text-xs text-muted",children:ge}):null,z?null:e.jsx("span",{className:"text-xs text-muted",children:n("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Se})})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-xs text-foreground",children:[Ae(J)," / ",Ae(B)]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(se)>90?"bg-red-600":Number.parseFloat(se)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(se),100)}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted",children:[e.jsx("span",{children:n("users.usagePercent",{defaultValue:"{{percent}}% used",percent:se})}),ae?e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:n("users.startOnFirstConnectBadge",{defaultValue:"Starts on first connect (+{{days}}d)",days:ce})}):e.jsx("span",{className:ee<7?"text-red-600 dark:text-red-400":"",children:ee>0?n("common.daysLeft",{defaultValue:"{{count}} days left",count:ee}):n("common.expired",{defaultValue:"Expired"})})]})]}),e.jsxs("button",{type:"button",onClick:()=>L(a.id),className:"mt-3 flex w-full items-center justify-between rounded-xl border border-line/60 bg-panel/35 px-4 py-3 text-left text-sm text-foreground transition hover:bg-panel/55","aria-label":Y.includes(a.id)?n("users.devices.hide",{defaultValue:"Hide devices"}):n("users.devices.show",{defaultValue:"Show devices"}),children:[e.jsx("span",{className:"font-medium",children:n("users.devices.title",{defaultValue:"Devices"})}),Y.includes(a.id)?e.jsx(ut,{className:"h-4 w-4 text-brand-500"}):e.jsx(Me,{className:"h-4 w-4 text-brand-500"})]}),Y.includes(a.id)?e.jsx("div",{className:"mt-3 rounded-lg border border-line/60 bg-panel/50 p-3",children:e.jsx(pt,{userId:a.id})}):null]},`mobile-${a.id}`)})]}),e.jsx("div",{className:D,children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800/50",children:e.jsxs("tr",{children:[j&&e.jsx("th",{className:"w-12 px-6 py-3",children:e.jsx("input",{type:"checkbox",checked:V,ref:a=>{a&&(a.indeterminate=te)},onChange:ue,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.user",{defaultValue:"User"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.online",{defaultValue:"Online"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.dataUsage",{defaultValue:"Data Usage"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.table.limits",{defaultValue:"Limits"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.expiry",{defaultValue:"Expiry"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("users.devices.title",{defaultValue:"Devices"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:n("common.actions",{defaultValue:"Actions"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-800",children:W.map(a=>{var he;const k=Number(a.uploadUsed||0),c=Number(a.downloadUsed||0),B=Number(a.dataLimit||0),J=k+c,se=B>0?(J/B*100).toFixed(1):"0.0",ae=!!a.startOnFirstUse&&!a.firstUsedAt,ce=ae?Math.max(1,Math.ceil((new Date(a.expireDate).getTime()-new Date(a.createdAt).getTime())/(1e3*60*60*24))):null,ee=ae?ce||0:ot(a.expireDate),p=G[a.id],z=(p==null?void 0:p.online)??h.has(a.uuid),re=Number.isFinite(p==null?void 0:p.activeKeyCount)?Number(p==null?void 0:p.activeKeyCount):Number(((he=a.inbounds)==null?void 0:he.length)||0),Ce=Number.isFinite(p==null?void 0:p.onlineKeyCount)?Number(p==null?void 0:p.onlineKeyCount):z?Math.min(1,re||1):0,ge=M(p),Se=we(p);return e.jsxs(m.Fragment,{children:[e.jsxs("tr",{className:"transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50",onMouseEnter:()=>s==null?void 0:s(a),children:[j&&e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"checkbox",checked:E.includes(a.id),onChange:()=>de(a.id),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{type:"button",className:"text-left text-sm font-medium text-gray-900 transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:text-white",onClick:()=>i(a),children:a.email}),e.jsxs("span",{className:"font-mono text-xs text-gray-500 dark:text-gray-400",children:[a.uuid.substring(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4",children:Ne(a.status)}),e.jsxs("td",{className:"px-6 py-4",children:[A(z),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:Ce,total:re||0})}),ge?e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:ge}):null,z?null:e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Se})})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:[Ae(J)," / ",Ae(B)]}),e.jsx("div",{className:"mt-1 h-2 w-32 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(se)>90?"bg-red-600":Number.parseFloat(se)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(se),100)}%`}})}),e.jsx("span",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:n("users.usagePercent",{defaultValue:"{{percent}}% used",percent:se})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:n("users.limitIpAbbrev",{defaultValue:"IP"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(a.ipLimit||0)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:n("users.limitDeviceAbbrev",{defaultValue:"DEV"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(a.deviceLimit||0)})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:ae?n("users.startOnFirstConnect",{defaultValue:"Starts on first connect"}):new Date(a.expireDate).toLocaleDateString()}),ae?e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400",children:n("users.startOnFirstConnectAfter",{defaultValue:"{{count}} days after first connect",count:ce})}):e.jsx("span",{className:`text-xs ${ee<7?"text-red-600 dark:text-red-400":ee<30?"text-yellow-600 dark:text-yellow-400":"text-gray-500 dark:text-gray-400"}`,children:ee>0?n("common.daysLeft",{defaultValue:"{{count}} days left",count:ee}):n("common.expired",{defaultValue:"Expired"})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>L(a.id),"aria-label":Y.includes(a.id)?n("users.devices.hide",{defaultValue:"Hide devices"}):n("users.devices.show",{defaultValue:"Show devices"}),children:Y.includes(a.id)?e.jsx(ut,{className:"h-4 w-4 text-brand-500"}):e.jsx(Me,{className:"h-4 w-4 text-brand-500"})})}),e.jsx("td",{className:"px-6 py-4",children:je(a)})]}),Y.includes(a.id)?e.jsx("tr",{className:"bg-panel/45",children:e.jsx("td",{colSpan:(j?1:0)+8,className:"px-6 py-4",children:e.jsx(pt,{userId:a.id})})}):null]},a.id)})})]})}),O<o.length?e.jsx("div",{className:"flex items-center justify-center rounded-xl border border-line/60 bg-card/60 px-3 py-2 text-xs text-muted",children:n("users.rendering",{defaultValue:"Rendering {{count}} of {{total}} users...",count:O,total:o.length})}):null]})};function zs({open:o,title:d,description:h,label:i="Value",placeholder:s,defaultValue:l="",inputType:f="text",confirmLabel:b="Save",cancelLabel:S="Cancel",loading:x=!1,onCancel:y,onConfirm:P}){const[w,U]=m.useState(l);return m.useEffect(()=>{o&&U(l)},[l,o]),o?e.jsx("div",{className:"fixed inset-0 z-[110] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:N=>{N.target===N.currentTarget&&!x&&y()},children:e.jsxs("div",{className:"w-full max-w-md overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/20",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-5",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"mt-0.5 rounded-full bg-brand-500/15 p-1 text-brand-400",children:e.jsx(Fs,{className:"h-4 w-4"})}),e.jsx("h3",{className:"text-base font-semibold text-foreground",children:d})]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:y,disabled:x,"aria-label":"Close dialog",children:e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 px-4 py-4 sm:px-5",children:[h?e.jsx("p",{className:"whitespace-pre-wrap text-sm text-muted",children:h}):null,e.jsxs("label",{className:"space-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-foreground",children:i}),e.jsx("input",{autoFocus:!0,type:f,className:"w-full rounded-xl border border-line/80 bg-card/80 px-3 py-2 text-sm text-foreground outline-none transition focus:border-brand-500/70 focus:ring-2 focus:ring-brand-500/35",placeholder:s,value:w,disabled:x,onChange:N=>{U(N.target.value)},onKeyDown:N=>{N.key==="Enter"&&!x&&(N.preventDefault(),P(w)),N.key==="Escape"&&!x&&(N.preventDefault(),y())}})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-5",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:y,disabled:x,children:S}),e.jsx(v,{type:"button",variant:"primary",onClick:()=>P(w),loading:x,disabled:x,children:b})]})]})}):null}function Os(o){if(!o||typeof o!="object")return;const d=o.meta||o.pagination;if(d)return d}function bt(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function Ws(){var at,rt;const o=rs(),d=gt(),[h,i]=ls(),{t:s}=ke(),l=ht(),f=ns(t=>t.admin),b=(f==null?void 0:f.role)==="SUPER_ADMIN",S=As("one-ui/users-filters",{page:1,search:"",status:"",viewMode:"auto"}),{views:x,saveView:y,deleteView:P}=Ms("one-ui/users-saved-views"),[w,U]=m.useState(""),N=S.value.page,Q=S.value.search,T=S.value.status,E=S.value.viewMode,j=S.setValue,G=m.useCallback(t=>{j(r=>{const u=typeof t=="function"?t(r.page):t;return{...r,page:Math.max(1,u)}})},[j]),n=m.useCallback(t=>{j(r=>({...r,search:t}))},[j]),q=m.useCallback(t=>{j(r=>({...r,status:t}))},[j]),Y=m.useCallback(t=>{j(r=>({...r,viewMode:t}))},[j]),[ve,O]=m.useState(!1),[be,V]=m.useState(!1),[te,W]=m.useState(null),[ue,de]=m.useState(null),[L,Re]=m.useState(null),[D,Ne]=m.useState(null),[A,we]=m.useState(null),[M,je]=m.useState(null),[a,k]=m.useState([]),[c,B]=m.useState(""),[J,se]=m.useState("DISABLED"),ae=Es(Q,320),ce=h.get("quick"),ee=m.useRef(null),p=m.useRef(null),z=cs({page:N,limit:50,search:ae,status:T||void 0}),re=os({page:1,limit:100,includeDisabled:!1}),Ce=ms(),ge=fs(),Se=xs(),he=ps(),ze=bs(),Oe=gs(),We=hs(),Te=ys(),_e=vs(),He=ws(),Le=pe({mutationFn:({userIds:t,dryRun:r})=>oe.bulkReorderUserInboundsByPattern({userIds:t,pattern:"myanmar",dryRun:r})}),De=pe({mutationFn:({userIds:t,dryRun:r,windowMinutes:u})=>oe.bulkReorderUserInboundsByQuality({userIds:t,windowMinutes:u,dryRun:r})}),Fe=pe({mutationFn:({groupId:t,userIds:r})=>Ee.addUsers(t,r),onSuccess:async(t,r)=>{await Promise.all([d.invalidateQueries({queryKey:["groups"]}),d.invalidateQueries({queryKey:["group",r.groupId]}),d.invalidateQueries({queryKey:["users"]})])}}),Pe=pe({mutationFn:({groupId:t,userIds:r})=>Ee.removeUsers(t,r),onSuccess:async(t,r)=>{await Promise.all([d.invalidateQueries({queryKey:["groups"]}),d.invalidateQueries({queryKey:["group",r.groupId]}),d.invalidateQueries({queryKey:["users"]})])}}),qe=pe({mutationFn:({groupId:t,userIds:r})=>Ee.moveUsers(t,r),onSuccess:async(t,r)=>{await Promise.all([d.invalidateQueries({queryKey:["groups"]}),d.invalidateQueries({queryKey:["group",r.groupId]}),d.invalidateQueries({queryKey:["users"]})])}}),Ue=pe({mutationFn:({groupId:t,payload:r})=>Ee.applyPolicy(t,r),onSuccess:async(t,r)=>{await Promise.all([d.invalidateQueries({queryKey:["groups"]}),d.invalidateQueries({queryKey:["group",r.groupId]}),d.invalidateQueries({queryKey:["users"]}),d.invalidateQueries({queryKey:["user-effective-policy"]})])}}),kt=pe({mutationFn:({userId:t,payload:r})=>oe.updateUser(t,r),onSuccess:async(t,r)=>{await Promise.all([d.invalidateQueries({queryKey:["users"]}),d.invalidateQueries({queryKey:["user",r.userId]}),d.invalidateQueries({queryKey:["user-devices",r.userId,60]})])}}),I=m.useMemo(()=>{var t;return((t=z.data)==null?void 0:t.data)??[]},[z.data]),le=m.useMemo(()=>{var t;return((t=re.data)==null?void 0:t.data)??[]},[re.data]),me=m.useMemo(()=>Os(z.data),[z.data]),Nt=m.useMemo(()=>I.map(t=>t.id),[I]),F=js(Nt,{includeOffline:!0,refetchInterval:5e3,staleTime:5e3}),Be=m.useMemo(()=>{var t;return Object.fromEntries((((t=F.data)==null?void 0:t.sessions)||[]).map(r=>[r.userId,r]))},[(at=F.data)==null?void 0:at.sessions]),$e=m.useMemo(()=>{var t;return new Set((((t=F.data)==null?void 0:t.sessions)||[]).filter(r=>r.online).map(r=>String(r.uuid||"")))},[(rt=F.data)==null?void 0:rt.sessions]),Ct=m.useMemo(()=>I.filter(t=>t.status==="ACTIVE").length,[I]),Ke=m.useMemo(()=>I.filter(t=>{var r;return((r=Be[t.id])==null?void 0:r.online)||$e.has(t.uuid)}).length,[$e,Be,I]),St=m.useMemo(()=>I.filter(t=>t.status==="LIMITED").length,[I]),Lt=m.useMemo(()=>I.filter(t=>t.status==="EXPIRED").length,[I]),Qe=m.useMemo(()=>I.filter(t=>a.includes(t.id)),[I,a]),Xe=b,Ge=b,$=ze.isPending||Oe.isPending||We.isPending||Te.isPending||_e.isPending||He.isPending||Le.isPending||De.isPending||Fe.isPending||Pe.isPending||qe.isPending||Ue.isPending,Dt=m.useMemo(()=>F.streamStatus==="connected"?s("users.streamStatus.connected",{defaultValue:"Connected"}):F.streamStatus==="connecting"?F.reconnectAttempts>0?s("users.streamStatus.reconnecting",{defaultValue:"Reconnecting ({{count}})",count:F.reconnectAttempts}):s("users.streamStatus.connecting",{defaultValue:"Connecting"}):F.streamStatus==="error"?s("common.error",{defaultValue:"Error"}):s("users.streamStatus.idle",{defaultValue:"Idle"}),[s,F.reconnectAttempts,F.streamStatus]),Rt=m.useMemo(()=>{if(!F.lastSnapshotAt)return s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"});const t=new Date(F.lastSnapshotAt);return Number.isNaN(t.getTime())?s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"}):s("users.streamSnapshot.lastUpdate",{defaultValue:"Last update {{time}}",time:t.toLocaleTimeString()})},[s,F.lastSnapshotAt]);m.useEffect(()=>{G(1)},[ae,G,T]),m.useEffect(()=>{k(t=>t.filter(r=>I.some(u=>u.id===r)))},[I]),m.useEffect(()=>{if(!le.length){c!==""&&B("");return}le.some(r=>String(r.id)===c)||B(String(le[0].id))},[le,c]),m.useEffect(()=>{if(ce==="create"){O(!0);const t=new URLSearchParams(h);t.delete("quick"),i(t,{replace:!0})}},[ce,h,i]);const K=({title:t,description:r,confirmLabel:u="Confirm",tone:g="danger"})=>new Promise(R=>{ee.current=R,Re({title:t,description:r,confirmLabel:u,tone:g})}),Ze=t=>{const r=ee.current;ee.current=null,Re(null),r&&r(t)},Ye=({title:t,description:r,label:u,placeholder:g,defaultValue:R="",inputType:Z="text",confirmLabel:Ve="Save"})=>new Promise(fe=>{p.current=fe,Ne({title:t,description:r,label:u,placeholder:g,defaultValue:R,inputType:Z,confirmLabel:Ve})}),Je=t=>{const r=p.current;p.current=null,Ne(null),r&&r(t)},Ut=async t=>{if(await K({title:s("users.deleteUser",{defaultValue:"Delete User"}),description:s("users.confirmDelete",{defaultValue:"Are you sure you want to delete this user?"}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await Ce.mutateAsync(t),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.userDeleted",{defaultValue:"User deleted successfully"}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.deleteFailed",{defaultValue:"Failed to delete user"}))}},Et=()=>{if(I.length===0)return;const t=[[s("users.email",{defaultValue:"Email"}),s("users.uuid",{defaultValue:"UUID"}),s("common.status",{defaultValue:"Status"}),s("users.dataUsed",{defaultValue:"Data Used"}),s("users.dataLimit",{defaultValue:"Data Limit"}),s("users.expireDate",{defaultValue:"Expire Date"})].map(bt).join(","),...I.map(R=>[R.email,R.uuid,R.status,Number(R.uploadUsed)+Number(R.downloadUsed),R.dataLimit,R.expireDate].map(bt).join(","))].join(`
`),r=new Blob([t],{type:"text/csv;charset=utf-8;"}),u=window.URL.createObjectURL(r),g=document.createElement("a");g.href=u,g.setAttribute("download",`users-${new Date().toISOString()}.csv`),g.click(),window.URL.revokeObjectURL(u)},X=()=>{k([])},At=t=>{const r=t,u=r==null?void 0:r.closest("details");u&&(u.open=!1)},_=(t,r)=>{t.preventDefault(),t.stopPropagation(),r&&r(),At(t.currentTarget)},C=async(t={})=>{const r=[z.refetch()];F.streamStatus!=="connected"&&r.push(F.refetch()),t.includeGroups&&r.push(re.refetch()),await Promise.all(r)},ne=Is(()=>C(),{enabled:!0,intervalMs:5e3}),et=async()=>{const t=await Ye({title:s("common.saveView",{defaultValue:"Save View"}),description:s("users.views.saveDescription",{defaultValue:"Create a reusable filter preset for this Users page."}),label:s("users.views.nameLabel",{defaultValue:"View name"}),placeholder:s("users.views.namePlaceholder",{defaultValue:"My team filter"}),confirmLabel:s("common.saveView",{defaultValue:"Save View"})});if(!(!t||!t.trim()))try{const r=y(t.trim(),{search:Q,status:T,viewMode:E});U(r.id),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.savedToast",{defaultValue:'View "{{name}}" saved',name:r.name}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.views.saveFailed",{defaultValue:"Unable to save view"}))}},tt=t=>{U(t);const r=x.find(u=>u.id===t);r&&(S.setValue(u=>({...u,page:1,search:r.filters.search||"",status:r.filters.status||"",viewMode:r.filters.viewMode||"auto"})),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.appliedToast",{defaultValue:'Applied "{{name}}"',name:r.name})))},st=()=>{if(!w)return;const t=x.find(r=>r.id===w);P(w),U(""),l.info(s("common.info",{defaultValue:"Info"}),t?s("users.views.removedToast",{defaultValue:'Removed "{{name}}"',name:t.name}):s("users.views.removedToastGeneric",{defaultValue:"Saved view removed"}))},Mt=async()=>{if(a.length!==0&&await K({title:s("users.bulk.deleteTitle",{defaultValue:"Delete Selected Users"}),description:s("users.bulk.deleteDescription",{defaultValue:"Delete {{count}} selected users? This cannot be undone.",count:a.length}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await ze.mutateAsync(a),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkDeleted",{defaultValue:"{{count}} user(s) deleted.",count:a.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkDeleteFailed",{defaultValue:"Failed to delete selected users"}))}},It=async()=>{if(a.length!==0&&await K({title:s("users.bulk.resetTrafficTitle",{defaultValue:"Reset Traffic"}),description:s("users.bulk.resetTrafficDescription",{defaultValue:"Reset traffic for {{count}} selected users?",count:a.length}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await Oe.mutateAsync(a),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkTrafficReset",{defaultValue:"{{count}} user(s) reset.",count:a.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkResetFailed",{defaultValue:"Failed to reset traffic"}))}},Tt=async()=>{if(a.length===0)return;const t=await Ye({title:s("users.bulk.extendExpiryTitle",{defaultValue:"Extend Expiry"}),description:s("users.bulk.extendExpiryDescription",{defaultValue:"Extend expiry for {{count}} selected users.",count:a.length}),label:s("users.bulk.daysToAdd",{defaultValue:"Days to add"}),defaultValue:"30",inputType:"number",confirmLabel:s("common.extend",{defaultValue:"Extend"})});if(!t||!t.trim())return;const r=Number.parseInt(t,10);if(Number.isNaN(r)||r<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.invalidDays",{defaultValue:"Please enter a valid positive number of days."}));return}try{await We.mutateAsync({userIds:a,days:r}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkExpiryExtended",{defaultValue:"{{count}} user(s) extended by {{days}} day(s).",count:a.length,days:r}))}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.bulkExtendFailed",{defaultValue:"Failed to extend expiry"}))}},Ft=async()=>{if(a.length!==0&&await K({title:s("users.bulk.applyStatusTitle",{defaultValue:"Apply Status"}),description:s("users.bulk.applyStatusDescription",{defaultValue:"Set status to {{status}} for {{count}} selected users?",status:J,count:a.length}),confirmLabel:s("common.apply",{defaultValue:"Apply"}),tone:"primary"}))try{await Te.mutateAsync({userIds:a,status:J}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkStatusUpdated",{defaultValue:"{{count}} user(s) set to {{status}}.",count:a.length,status:J}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkUpdateFailed",{defaultValue:"Failed to update status"}))}},Pt=async()=>{if(a.length!==0&&await K({title:s("users.bulk.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.bulk.rotateDescription",{defaultValue:"Rotate credentials for {{count}} selected users?",count:a.length}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await _e.mutateAsync({userIds:a,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRotated",{defaultValue:"{{count}} user(s) rotated.",count:a.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRotateFailed",{defaultValue:"Failed to rotate selected user keys"}))}},qt=async()=>{if(a.length!==0&&await K({title:s("users.bulk.revokeTitle",{defaultValue:"Revoke Access"}),description:s("users.bulk.revokeDescription",{defaultValue:"Revoke access for {{count}} selected users?",count:a.length}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await He.mutateAsync({userIds:a,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRevoked",{defaultValue:"{{count}} user(s) revoked.",count:a.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRevokeFailed",{defaultValue:"Failed to revoke selected user access"}))}},Bt=async(t,r)=>{try{await kt.mutateAsync({userId:t.id,payload:r}),await C()}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.limitUpdateFailed",{defaultValue:"Failed to update user limits"}))}},$t=async()=>{if(a.length===0)return;if(!c){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(c,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const r=le.find(g=>g.id===t),u=(r==null?void 0:r.name)||`#${t}`;if(await K({title:s("users.bulk.assignTitle",{defaultValue:"Assign To Group"}),description:s("users.bulk.assignDescription",{defaultValue:'Assign {{count}} selected users to group "{{group}}"?',count:a.length,group:u}),confirmLabel:s("common.assign",{defaultValue:"Assign"}),tone:"primary"}))try{await Fe.mutateAsync({groupId:t,userIds:a}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.assignedToGroup",{defaultValue:"{{count}} user(s) assigned to {{group}}.",count:a.length,group:u}))}catch(g){l.error(s("common.error",{defaultValue:"Error"}),(g==null?void 0:g.message)||s("users.toast.assignFailed",{defaultValue:"Failed to assign users to group"}))}},Kt=async()=>{if(a.length===0)return;if(!c){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(c,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const r=le.find(g=>g.id===t),u=(r==null?void 0:r.name)||`#${t}`;if(await K({title:s("users.bulk.removeTitle",{defaultValue:"Remove From Group"}),description:s("users.bulk.removeDescription",{defaultValue:'Remove {{count}} selected users from group "{{group}}"?',count:a.length,group:u}),confirmLabel:s("common.remove",{defaultValue:"Remove"}),tone:"danger"}))try{await Pe.mutateAsync({groupId:t,userIds:a}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.removedFromGroup",{defaultValue:"{{count}} user(s) removed from {{group}}.",count:a.length,group:u}))}catch(g){l.error(s("common.error",{defaultValue:"Error"}),(g==null?void 0:g.message)||s("users.toast.removeFailed",{defaultValue:"Failed to remove users from group"}))}},Qt=async()=>{if(a.length===0)return;if(!c){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(c,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const r=le.find(g=>g.id===t),u=(r==null?void 0:r.name)||`#${t}`;if(await K({title:s("users.bulk.moveTitle",{defaultValue:"Move To Group"}),description:s("users.bulk.moveDescription",{defaultValue:'Move {{count}} selected users exclusively to group "{{group}}"?',count:a.length,group:u}),confirmLabel:s("common.move",{defaultValue:"Move"}),tone:"primary"}))try{await qe.mutateAsync({groupId:t,userIds:a}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.movedToGroup",{defaultValue:"{{count}} user(s) moved to {{group}}.",count:a.length,group:u}))}catch(g){l.error(s("common.error",{defaultValue:"Error"}),(g==null?void 0:g.message)||s("users.toast.moveFailed",{defaultValue:"Failed to move users to group"}))}},Gt=async()=>{if(a.length===0)return;if(!c){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(c,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const r=le.find(g=>g.id===t),u=(r==null?void 0:r.name)||`#${t}`;try{const R=(await Ue.mutateAsync({groupId:t,payload:{dryRun:!0,userIds:a}})).data||{},Z=R.summary||{},fe=(Array.isArray(R.preview)?R.preview:[]).slice(0,2).map(lt=>`${lt.email}: ${Object.keys(lt.changes||{}).join(", ")||s("common.noChanges",{defaultValue:"no changes"})}`).join(`
`),ie=[s("users.bulk.policyDryRunTitle",{defaultValue:'Group policy dry-run for "{{group}}":',group:u}),s("users.bulk.policyDryRunTarget",{defaultValue:"- target users: {{count}}",count:Z.targetUsers??a.length}),s("users.bulk.policyDryRunWouldUpdate",{defaultValue:"- would update: {{count}}",count:Z.wouldUpdateUsers??0}),s("users.bulk.policyDryRunSkipped",{defaultValue:"- skipped: {{count}}",count:Z.skippedUsers??0}),fe?`
${s("common.preview",{defaultValue:"Preview"})}:
${fe}`:"",`
${s("users.bulk.applyNow",{defaultValue:"Apply now?"})}`].filter(Boolean).join(`
`);if(!await K({title:s("users.bulk.applyPolicyTitle",{defaultValue:"Apply Group Policy"}),description:ie,confirmLabel:s("users.bulk.applyPolicyConfirm",{defaultValue:"Apply Policy"}),tone:"primary"}))return;await Ue.mutateAsync({groupId:t,payload:{dryRun:!1,userIds:a}}),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.policyApplied",{defaultValue:"{{count}} user(s) updated from {{group}}.",count:a.length,group:u}))}catch(g){l.error(s("common.error",{defaultValue:"Error"}),(g==null?void 0:g.message)||s("users.toast.policyApplyFailed",{defaultValue:"Failed to apply group policy"}))}},zt=async()=>{if(a.length!==0)try{const r=(await Le.mutateAsync({userIds:a,dryRun:!0})).data||{},u=r.summary||{},R=(Array.isArray(r.preview)?r.preview:[]).slice(0,2).map(Z=>{const Ve=(Z.currentTop3||[]).map(ie=>ie.key).join(" > ")||"none",fe=(Z.newTop3||[]).map(ie=>ie.key).join(" > ")||"none";return`${Z.email}: ${Ve} -> ${fe}`}).filter(Boolean);we({userIds:[...a],targetUsers:u.targetUsers??a.length,wouldUpdateUsers:u.wouldUpdateUsers??0,unchangedUsers:u.unchangedUsers??0,changedKeys:u.changedKeys??0,matchedUsers:u.matchedUsers??0,previewLines:R})}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},Ot=async()=>{if(A)try{await Le.mutateAsync({userIds:A.userIds,dryRun:!1});const t=A.wouldUpdateUsers??0;we(null),X(),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.myanmarPriorityApplied",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},Wt=async()=>{if(a.length!==0)try{const r=(await De.mutateAsync({userIds:a,windowMinutes:60,dryRun:!0})).data||{},u=r.summary||{},R=(Array.isArray(r.preview)?r.preview:[]).slice(0,2).map(Z=>{const Ve=(Z.currentTop3||[]).map(ie=>ie.key).join(" > ")||"none",fe=(Z.newTop3||[]).map(ie=>ie.key).join(" > ")||"none";return`${Z.email}: ${Ve} -> ${fe}`}).filter(Boolean);je({userIds:[...a],targetUsers:u.targetUsers??a.length,wouldUpdateUsers:u.wouldUpdateUsers??0,unchangedUsers:u.unchangedUsers??0,changedKeys:u.changedKeys??0,scoredKeys:u.scoredKeys??0,previewLines:R})}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},_t=async()=>{if(M)try{await De.mutateAsync({userIds:M.userIds,windowMinutes:60,dryRun:!1});const t=M.wouldUpdateUsers??0;je(null),X(),await C(),l.success(s("users.autoTuneAppliedTitle",{defaultValue:"Auto-tune applied"}),s("users.autoTuneAppliedBody",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},Ht=async t=>{if(await K({title:s("users.actions.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.actions.rotateDescription",{defaultValue:"Rotate all credentials for {{email}}?",email:t.email}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await ge.mutateAsync({id:t.id,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.rotated",{defaultValue:"Updated {{email}}.",email:t.email}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.rotateFailed",{defaultValue:"Failed to rotate user keys"}))}},Xt=async t=>{if(await K({title:s("users.actions.revokeTitle",{defaultValue:"Revoke User Access"}),description:s("users.actions.revokeDescription",{defaultValue:"Revoke all access for {{email}}? This will disable the user.",email:t.email}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await Se.mutateAsync({id:t.id,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.accessRevoked",{defaultValue:"{{email}} was disabled.",email:t.email}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.revokeFailed",{defaultValue:"Failed to revoke user access"}))}},Zt=async t=>{var r;if(await K({title:s("users.actions.regenerateTitle",{defaultValue:"Regenerate Subscription Token"}),description:s("users.actions.regenerateDescription",{defaultValue:"Regenerate subscription token for {{email}}?",email:t.email}),confirmLabel:s("common.regenerate",{defaultValue:"Regenerate"}),tone:"primary"}))try{const u=await he.mutateAsync(t.id),g=`${window.location.origin}/sub/${u.subscriptionToken}?target=v2ray`;let R=!1;try{(r=navigator.clipboard)!=null&&r.writeText&&(await navigator.clipboard.writeText(g),R=!0)}catch{R=!1}R?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegeneratedCopied",{defaultValue:"New link for {{email}} was copied.",email:t.email})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegenerated",{defaultValue:"Token updated for {{email}}.",email:t.email})),await C()}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.regenerateFailed",{defaultValue:"Failed to regenerate subscription token"}))}},Yt=async t=>{if(await K({title:s("users.actions.resetTrafficTitle",{defaultValue:"Reset User Traffic"}),description:s("users.actions.resetTrafficDescription",{defaultValue:"Reset traffic for {{email}}?",email:t.email}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await oe.resetTraffic(t.id),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.trafficReset",{defaultValue:"{{email}} counters were reset.",email:t.email}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.resetFailed",{defaultValue:"Failed to reset user traffic"}))}},Jt=async(t,r)=>{try{await oe.extendExpiry(t.id,r),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.expiryExtended",{defaultValue:"{{email}} extended by {{days}} day(s).",email:t.email,days:r}))}catch(u){l.error(s("common.error",{defaultValue:"Error"}),(u==null?void 0:u.message)||s("users.toast.extendFailed",{defaultValue:"Failed to extend user expiry"}))}},es=async t=>{if(await K({title:s("users.actions.disableTitle",{defaultValue:"Disable User"}),description:s("users.actions.disableDescription",{defaultValue:"Disable {{email}}?",email:t.email}),confirmLabel:s("common.disable",{defaultValue:"Disable"}),tone:"danger"}))try{await oe.updateUser(t.id,{status:"DISABLED"}),await oe.disconnectUserSessions(t.id),await C(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userDisabled",{defaultValue:"{{email}} is now disabled and disconnected.",email:t.email}))}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.disableFailed",{defaultValue:"Failed to disable user"}))}},ts=async t=>{if(await K({title:s("users.actions.disconnectTitle",{defaultValue:"Disconnect Sessions"}),description:s("users.actions.disconnectDescription",{defaultValue:"Disconnect all active sessions for {{email}}?",email:t.email}),confirmLabel:s("common.disconnect",{defaultValue:"Disconnect"}),tone:"danger"}))try{const r=await oe.disconnectUserSessions(t.id);await C();const u=r!=null&&r.data?`${r.data.disconnectedDevices} device(s), ${r.data.disconnectedIps} IP(s)`:s("users.toast.sessionsDisconnectedFallback",{defaultValue:"Active sessions disconnected."});l.success(s("common.success",{defaultValue:"Success"}),u)}catch(r){l.error(s("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||s("users.toast.disconnectFailed",{defaultValue:"Failed to disconnect active sessions"}))}},ss=async t=>{const r=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;try{await navigator.clipboard.writeText(r),l.success(s("common.copied",{defaultValue:"Copied"}),s("users.toast.subscriptionCopied",{defaultValue:"Subscription link copied to clipboard."}))}catch{l.warning(s("users.toast.clipboardUnavailableTitle",{defaultValue:"Clipboard unavailable"}),s("users.toast.clipboardUnavailableBody",{defaultValue:`Copy failed. Use this link manually:
{{link}}`,link:r}),1e4)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:s("users.title")}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.subtitle",{defaultValue:"Manage your VPN users and subscriptions"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(v,{variant:"secondary",onClick:Et,disabled:I.length===0,children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),s("common.export",{defaultValue:"Export CSV"})]}),e.jsxs(v,{variant:"secondary",onClick:()=>V(!0),children:[e.jsx(ct,{className:"mr-2 h-4 w-4"}),s("users.bulkProvision",{defaultValue:"Bulk Provision"})]}),e.jsxs(v,{onClick:()=>O(!0),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),s("users.addUser")]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(xe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.totalUsers")}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(me==null?void 0:me.total)||I.length})]}),e.jsx(ct,{className:"h-6 w-6 text-brand-500"})]})}),e.jsxs(xe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.activeUsers")}),e.jsx("p",{className:"text-2xl font-bold text-emerald-500",children:Ct})]}),e.jsxs(xe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"relative inline-flex h-3 w-3",children:[Ke>0?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-3 w-3 rounded-full ${Ke>0?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:Ke})]}),e.jsxs("p",{className:"mt-1 text-xs text-muted",children:[s("users.sessionStream",{defaultValue:"Session stream"}),": ",Dt]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[Rt,F.streamError?` • ${F.streamError}`:""]})]}),e.jsxs(xe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.limited",{defaultValue:"Limited Users"})}),e.jsx("p",{className:"text-2xl font-bold text-amber-500",children:St})]}),e.jsxs(xe,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.expiredUsers")}),e.jsx("p",{className:"text-2xl font-bold text-rose-500",children:Lt})]})]}),e.jsx(xe,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ts,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-muted"}),e.jsx(H,{placeholder:s("users.searchPlaceholder",{defaultValue:"Search by email or UUID..."}),value:Q,onChange:t=>n(t.target.value),className:"pl-10"})]})}),e.jsxs("select",{className:"rounded-xl border border-line/80 bg-card/75 px-4 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:T,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"",children:s("users.allStatus",{defaultValue:"All Status"})}),e.jsx("option",{value:"ACTIVE",children:s("status.active")}),e.jsx("option",{value:"LIMITED",children:s("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:s("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:s("status.expired",{defaultValue:"Expired"})})]}),e.jsxs(v,{variant:"secondary",onClick:()=>{ne.forceRefresh()},children:[e.jsx(Vs,{className:`mr-2 h-4 w-4 ${z.isFetching||F.isFetching?"animate-spin":""}`}),s("common.refresh",{defaultValue:"Refresh"})]})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsxs("details",{className:"group lg:hidden",children:[e.jsxs("summary",{className:"flex list-none items-center justify-between gap-3 rounded-xl px-2 py-2 text-left text-sm font-medium text-foreground transition hover:bg-panel/50 [&::-webkit-details-marker]:hidden",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate",children:s("common.advancedControls",{defaultValue:"Advanced controls"})}),e.jsx("p",{className:"mt-0.5 text-xs font-normal text-muted",children:s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:ne.statusLabel,seconds:Math.ceil(ne.nextRunInMs/1e3)})})]}),e.jsx(Me,{className:"h-5 w-5 shrink-0 text-muted transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] flex-1 rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:w,onChange:t=>tt(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(v,{size:"sm",variant:"secondary",onClick:()=>{et()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(v,{size:"sm",variant:"ghost",onClick:st,disabled:!w,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>Y(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${E===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(v,{size:"sm",variant:"ghost",onClick:ne.togglePaused,children:ne.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})})]})]})]}),e.jsxs("div",{className:"hidden items-center justify-between gap-3 lg:flex",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:w,onChange:t=>tt(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(v,{size:"sm",variant:"secondary",onClick:()=>{et()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(v,{size:"sm",variant:"ghost",onClick:st,disabled:!w,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>Y(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${E===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(v,{size:"sm",variant:"ghost",onClick:ne.togglePaused,children:ne.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})}),e.jsx("span",{className:"text-xs text-muted",children:s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:ne.statusLabel,seconds:Math.ceil(ne.nextRunInMs/1e3)})})]})]})]})]})}),e.jsxs(xe,{padding:!1,children:[a.length>0?e.jsx("div",{className:"border-b border-line/70 bg-panel/50 px-4 py-3 sm:px-6",children:e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"text-sm text-foreground",children:[s("users.selectedCount",{defaultValue:"{{count}} selected",count:a.length}),Qe.length>0?` (${Qe.map(t=>t.email).slice(0,2).join(", ")}${Qe.length>2?", ...":""})`:""]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsxs("details",{className:"group relative",children:[e.jsx("summary",{className:"list-none",onClick:t=>{$&&t.preventDefault()},children:e.jsxs(v,{size:"sm",variant:"secondary",disabled:$,children:[e.jsx(jt,{className:"mr-2 h-4 w-4"}),s("common.bulkActions",{defaultValue:"Bulk actions"}),e.jsx(Me,{className:"ml-2 h-4 w-4 text-muted transition-transform group-open:rotate-180"})]})}),e.jsxs("div",{className:"absolute right-0 z-20 mt-2 w-[min(92vw,22rem)] rounded-2xl border border-line/70 bg-panel/95 p-2 shadow-soft backdrop-blur",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-medium text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,X),disabled:$,children:s("common.clearSelection",{defaultValue:"Clear selection"})}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void It()),disabled:$,children:"Reset traffic"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void Tt()),disabled:$,children:"Extend expiry"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void Pt()),disabled:$,children:"Rotate keys"}),Ge?e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void qt()),disabled:$,children:"Revoke access"}):null,e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void zt()),disabled:$,children:"Myanmar priority reorder"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void Wt()),disabled:$,children:s("users.bulkQualityAutoTune",{defaultValue:"Quality auto-tune reorder"})})]}),e.jsx("div",{className:"my-2 border-t border-line/60"}),le.length>0?e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Groups"}),e.jsx("select",{value:c,onChange:t=>B(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:$||re.isFetching,children:le.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(v,{size:"sm",variant:"secondary",onClick:t=>_(t,()=>void $t()),loading:Fe.isPending,disabled:$||!c,children:"Assign"}),e.jsx(v,{size:"sm",variant:"secondary",onClick:t=>_(t,()=>void Qt()),loading:qe.isPending,disabled:$||!c,children:"Move"}),e.jsx(v,{size:"sm",variant:"secondary",onClick:t=>_(t,()=>void Kt()),loading:Pe.isPending,disabled:$||!c,children:"Remove"}),e.jsx(v,{size:"sm",variant:"secondary",onClick:t=>_(t,()=>void Gt()),loading:Ue.isPending,disabled:$||!c,children:"Apply Policy"})]})]}):e.jsx("div",{className:"px-2 pb-1 pt-2",children:e.jsx(v,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>_(t,()=>o("/groups")),disabled:re.isFetching,children:"Create group"})}),e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Status"}),e.jsxs("select",{value:J,onChange:t=>se(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:$,children:[e.jsx("option",{value:"ACTIVE",children:"ACTIVE"}),e.jsx("option",{value:"LIMITED",children:"LIMITED"}),e.jsx("option",{value:"DISABLED",children:"DISABLED"}),e.jsx("option",{value:"EXPIRED",children:"EXPIRED"})]}),e.jsx(v,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>_(t,()=>void Ft()),loading:Te.isPending,disabled:$,children:"Apply status"})]}),Xe?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10 focus:outline-none focus:ring-2 focus:ring-rose-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>_(t,()=>void Mt()),disabled:$,children:"Delete selected"})]}):null]})]})})]})}):null,z.isLoading?e.jsx("div",{className:"space-y-4 p-5",children:Array.from({length:6}).map((t,r)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ye,{className:"h-4 w-4 rounded"}),e.jsx(ye,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ye,{className:"h-4 w-1/3"}),e.jsx(ye,{className:"h-3 w-1/4"})]}),e.jsx(ye,{className:"h-6 w-16 rounded-full"}),e.jsx(ye,{className:"h-4 w-24"}),e.jsx(ye,{className:"h-8 w-8 rounded-lg"})]},r))}):I.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.noUsers",{defaultValue:"No users found"})}),e.jsxs(v,{className:"mt-4",onClick:()=>O(!0),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),s("users.addFirst")]})]}):e.jsx(Gs,{users:I,viewMode:E,onlineUuidSet:$e,sessionsByUserId:Be,onQuickQr:t=>W(t),onQuickEdit:t=>de(t),onRotateKeys:t=>{Ht(t)},onRevokeKeys:Ge?t=>{Xt(t)}:void 0,onDisconnectSessions:t=>{ts(t)},onRegenerateSubscription:t=>{Zt(t)},onResetTraffic:t=>{Yt(t)},onExtendExpiry:(t,r)=>{Jt(t,r)},onDisableUser:Ge?t=>{es(t)}:void 0,onCopySubscription:t=>{ss(t)},onUpdateLimits:(t,r)=>{Bt(t,r)},selectedUserIds:a,onSelectionChange:k,onPrefetch:t=>{dt(`/users/${t.id}`)},onView:t=>{dt(`/users/${t.id}`),o(`/users/${t.id}`)},onDelete:Xe?t=>{Ut(t)}:void 0})]}),me&&me.totalPages>1?e.jsxs(xe,{className:"flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center",children:[e.jsx("div",{className:"text-sm text-muted",children:s("common.showing",{count:I.length,total:me.total})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"secondary",size:"sm",disabled:N<=1,onClick:()=>G(t=>t-1),children:s("common.previous")}),e.jsx("span",{className:"px-3 text-sm text-foreground/85",children:s("common.page",{current:N,total:me.totalPages})}),e.jsx(v,{variant:"secondary",size:"sm",disabled:N>=me.totalPages,onClick:()=>G(t=>t+1),children:s("common.next")})]})]}):null,ve?e.jsx(Cs,{onClose:()=>O(!1),onSuccess:t=>{if(O(!1),C(),t!=null&&t.subscriptionToken){const r=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;try{navigator.clipboard.writeText(r).then(()=>{l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreatedCopied",{defaultValue:"User created. Subscription link copied to clipboard."}))})}catch{l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreated",{defaultValue:"User created successfully."}))}W(t)}}}):null,be?e.jsx(Bs,{onClose:()=>V(!1),onSuccess:()=>{V(!1),C()}}):null,te?e.jsx(Qs,{user:te,onClose:()=>W(null)}):null,ue?e.jsx($s,{user:ue,onClose:()=>de(null),onSuccess:()=>{de(null),C()}}):null,e.jsx(nt,{open:!!A,title:"Bulk Myanmar Priority Preview",description:"Review the dry-run summary before applying reorder to selected users.",summaryRows:[{label:"Target Users",value:(A==null?void 0:A.targetUsers)??0},{label:"Would Reorder",value:(A==null?void 0:A.wouldUpdateUsers)??0},{label:"Unchanged",value:(A==null?void 0:A.unchangedUsers)??0}],previewLines:(A==null?void 0:A.previewLines)||[],confirmLabel:"Apply Bulk Priority",loading:Le.isPending,disableConfirm:!A||A.wouldUpdateUsers===0,onClose:()=>{Le.isPending||we(null)},onConfirm:()=>{Ot()}}),e.jsx(nt,{open:!!M,title:s("users.bulkQualityPreviewTitle",{defaultValue:"Bulk Quality Auto-tune Preview"}),description:s("users.bulkQualityPreviewBody",{defaultValue:"Reorder selected users by recent connect success, rejects, and reconnects."}),summaryRows:[{label:"Target Users",value:(M==null?void 0:M.targetUsers)??0},{label:"Would Reorder",value:(M==null?void 0:M.wouldUpdateUsers)??0},{label:"Telemetry Keys",value:(M==null?void 0:M.scoredKeys)??0}],previewLines:(M==null?void 0:M.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:De.isPending,disableConfirm:!M||M.wouldUpdateUsers===0,onClose:()=>{De.isPending||je(null)},onConfirm:()=>{_t()}}),e.jsx(Vt,{open:!!L,title:(L==null?void 0:L.title)||"Confirm",description:L==null?void 0:L.description,confirmLabel:(L==null?void 0:L.confirmLabel)||"Confirm",tone:(L==null?void 0:L.tone)||"danger",onCancel:()=>Ze(!1),onConfirm:()=>Ze(!0)}),e.jsx(zs,{open:!!D,title:(D==null?void 0:D.title)||"Enter value",description:D==null?void 0:D.description,label:D==null?void 0:D.label,placeholder:D==null?void 0:D.placeholder,defaultValue:D==null?void 0:D.defaultValue,inputType:D==null?void 0:D.inputType,confirmLabel:(D==null?void 0:D.confirmLabel)||"Save",onCancel:()=>Je(null),onConfirm:t=>Je(t)})]})}const Sa=Ws;export{Ws as Users,Sa as UsersPage};
