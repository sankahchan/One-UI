import{c as Ct,r as c,j as e,X as $e,e as St,b as xt,u as vs,h as ws,f as Vs}from"./index-CG9kpP9Y.js";import{u as ve}from"./useMutation-Br-t0osD.js";import{u as fe,g as Fe}from"./users-DYrgyhkk.js";import{B as j}from"./Button-B80QVKRC.js";import{u as Lt,C as ye}from"./useToast-C_OO-2JX.js";import{u as Dt}from"./index.esm-C0GmNgaO.js";import{u as ks,a as js}from"./useGroups-B1L4fEZz.js";import{u as Ns,a as Cs,b as Ss,c as Ls,d as Ds,e as Rs,f as Us,g as Ms,h as As,i as Es,j as Is,k as Ts,l as Fs,m as Ps,n as qs,o as Bs,p as $s,q as Ks}from"./useUsers-BPTWPe_a.js";import{I as ee}from"./Input-vpwyIRrG.js";import{u as Le,R as Qs}from"./useTranslation-DQjABgHn.js";import{D as Rt}from"./download-CX5md0Yg.js";import{u as Ut}from"./useQuery-ClalJbNF.js";import{Q as Gs}from"./index-BaaKCiO9.js";import{C as Os,c as qe}from"./clipboard-D_hUxpVN.js";import{C as zs,U as Ws,M as bt}from"./MyanmarPriorityPreviewModal-gwumv2Y2.js";import{E as Hs}from"./external-link-CxefftMD.js";import{B as _s}from"./Badge-DQo9BAHa.js";import{D as Xs,M as Mt}from"./DropdownMenu-DeZo-vZf.js";import{C as At}from"./ConfirmDialog-BK4iJYOB.js";import{g as gt,f as Pe,a as Zs}from"./formatters-CEEtD2TU.js";import{C as ht}from"./chevron-up-C-Yx4ITY.js";import{C as Be}from"./chevron-down-DRrM9xHJ.js";import{u as Ys}from"./useDebouncedValue-DTyF84Yy.js";import{u as Js,a as ea,b as ta}from"./useSmartAutoRefresh-CWzzeZv1.js";import{S as ke}from"./Skeleton-UQb2SfAS.js";import{p as yt}from"./routePrefetch-DegX9kC9.js";import{U as vt}from"./users--3fvm3B6.js";import{P as wt}from"./plus-CuU2M0FX.js";import{S as sa}from"./search-DPrs-Nlw.js";import"./cn-BLSKlp9E.js";import"./inbounds-BVe_b115.js";import"./xray-BZhXygCD.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const aa=Ct("MessageSquareText",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M13 8H7",key:"14i4kc"}],["path",{d:"M17 12H7",key:"16if0g"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ra=Ct("Wand2",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z",key:"1bcowg"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]);function Vt(u){return`"${(u==null?"":String(u)).replace(/"/g,'""')}"`}function la(u){if(!Array.isArray(u.users)||u.users.length===0)return;const v=[["Email","UUID","Password","Subscription Token","Expire Date","Status"].map(Vt).join(","),...u.users.map(p=>[p.email,p.uuid,p.password,p.subscriptionToken,p.expireDate,p.status].map(Vt).join(","))].join(`
`),i=new Blob([v],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.setAttribute("download",`bulk-users-${new Date().toISOString().replace(/[:.]/g,"-")}.csv`),l.click(),window.URL.revokeObjectURL(s)}function na(u,m,v,i,s){const l=u.trim(),p=m.trim().replace(/^@+/,""),h=Number.isInteger(v)?Math.max(0,Math.min(v,5)):0,R=Number.isInteger(i)?Math.max(1,i):1,b=Number.isInteger(s)?Math.max(0,s):0;return!l||!p||h===0?[]:Array.from({length:h},(V,$)=>{const N=R+$,E=b>0?String(N).padStart(b,"0"):String(N);return`${l}${E}@${p}`})}const ia=({onClose:u,onSuccess:m})=>{var K,M,w,Q,o,pe,H,je;const v=Lt(),{t:i}=Le(),{data:s}=ks(),l=Ns(),p=(s||[]).filter(C=>C.enabled!==!1),{register:h,handleSubmit:R,watch:b,formState:{errors:V}}=Dt({defaultValues:{prefix:"user",domain:"example.com",count:10,startIndex:1,padding:2,dataLimit:50,expiryDays:30,inboundIds:[],ipLimit:0,status:"ACTIVE"}}),$=b("prefix"),N=b("domain"),E=Number(b("count")),S=Number(b("startIndex")),W=Number(b("padding")),P=c.useMemo(()=>na($||"",N||"",E,S,W),[$,N,E,S,W]),Z=async C=>{try{const re={...C,inboundIds:(C.inboundIds||[]).map(U=>Number(U)).filter(U=>Number.isInteger(U)&&U>0),count:Number(C.count),startIndex:Number(C.startIndex),padding:Number(C.padding),dataLimit:Number(C.dataLimit),expiryDays:Number(C.expiryDays),ipLimit:Number(C.ipLimit)},_=await l.mutateAsync(re);la(_);const xe=(_.failed||[]).slice(0,5).map(U=>`${U.email}: ${U.reason}`).join(`
`),be=[i("users.bulkCreate.toast.requested",{defaultValue:"Requested: {{count}}",count:_.requestedCount}),i("users.bulkCreate.toast.created",{defaultValue:"Created: {{count}}",count:_.createdCount}),i("users.bulkCreate.toast.failed",{defaultValue:"Failed: {{count}}",count:_.failedCount}),_.createdCount>0?i("users.bulkCreate.toast.csvDownloaded",{defaultValue:"Credentials CSV downloaded."}):void 0].filter(Boolean);v.success(i("common.success",{defaultValue:"Success"}),be.join(" • ")),xe&&v.warning(i("common.warning",{defaultValue:"Warning"}),xe),_.createdCount>0&&m()}catch(re){v.error(i("common.error",{defaultValue:"Error"}),(re==null?void 0:re.message)||i("users.bulkCreate.toast.failedBody",{defaultValue:"Failed to create users in bulk"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"my-6 w-full max-w-3xl overflow-hidden rounded-2xl border border-line/80 bg-card/95 shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-line/80 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i("users.bulkCreate.title",{defaultValue:"Bulk User Provisioning"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:i("users.bulkCreate.subtitle",{defaultValue:"Create multiple users with consistent limits and inbound assignments."})})]}),e.jsx("button",{onClick:u,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":i("common.close",{defaultValue:"Close"}),children:e.jsx($e,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:R(Z),className:"space-y-6 p-5 sm:p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(ee,{label:`${i("users.bulkCreate.prefixLabel",{defaultValue:"Email Prefix"})} *`,...h("prefix",{required:i("users.bulkCreate.validation.prefixRequired",{defaultValue:"Prefix is required"})}),error:(K=V.prefix)==null?void 0:K.message,placeholder:"user"}),e.jsx(ee,{label:`${i("users.bulkCreate.domainLabel",{defaultValue:"Domain"})} *`,...h("domain",{required:i("users.bulkCreate.validation.domainRequired",{defaultValue:"Domain is required"})}),error:(M=V.domain)==null?void 0:M.message,placeholder:"example.com"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(ee,{label:`${i("users.bulkCreate.countLabel",{defaultValue:"Count"})} *`,type:"number",...h("count",{valueAsNumber:!0,required:i("users.bulkCreate.validation.countRequired",{defaultValue:"Count is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})},max:{value:200,message:i("users.bulkCreate.validation.countMax",{defaultValue:"Maximum 200"})}}),error:(w=V.count)==null?void 0:w.message}),e.jsx(ee,{label:`${i("users.bulkCreate.startIndexLabel",{defaultValue:"Start Index"})} *`,type:"number",...h("startIndex",{valueAsNumber:!0,required:i("users.bulkCreate.validation.startIndexRequired",{defaultValue:"Start index is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})}}),error:(Q=V.startIndex)==null?void 0:Q.message}),e.jsx(ee,{label:i("users.bulkCreate.paddingLabel",{defaultValue:"Padding"}),type:"number",...h("padding",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})},max:{value:8,message:i("users.bulkCreate.validation.paddingMax",{defaultValue:"Maximum 8"})}}),error:(o=V.padding)==null?void 0:o.message})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:i("users.bulkCreate.previewTitle",{defaultValue:"Email Preview"})}),P.length===0?e.jsx("p",{className:"mt-1 text-xs text-muted",children:i("users.bulkCreate.previewEmpty",{defaultValue:"Enter prefix/domain to preview generated emails."})}):e.jsxs("ul",{className:"mt-2 space-y-1 text-xs text-muted",children:[P.map(C=>e.jsx("li",{children:C},C)),E>P.length?e.jsx("li",{children:"..."}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(ee,{label:`${i("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...h("dataLimit",{valueAsNumber:!0,required:i("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(pe=V.dataLimit)==null?void 0:pe.message}),e.jsx(ee,{label:`${i("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...h("expiryDays",{valueAsNumber:!0,required:i("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:i("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(H=V.expiryDays)==null?void 0:H.message}),e.jsx(ee,{label:i("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...h("ipLimit",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(je=V.ipLimit)==null?void 0:je.message,placeholder:i("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-muted",children:i("common.status",{defaultValue:"Status"})}),e.jsxs("select",{...h("status"),className:"w-full rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",children:[e.jsx("option",{value:"ACTIVE",children:i("status.active",{defaultValue:"Active"})}),e.jsx("option",{value:"LIMITED",children:i("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:i("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:i("status.expired",{defaultValue:"Expired"})})]})]}),e.jsx(ee,{label:i("users.note",{defaultValue:"Note"}),...h("note"),placeholder:i("users.bulkCreate.notePlaceholder",{defaultValue:"Optional note applied to all created users"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[i("users.bulkCreate.assignInboundsLabel",{defaultValue:"Assign Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-card/65 p-3",children:p.length===0?e.jsx("p",{className:"text-sm text-muted",children:i("users.bulkCreate.noActiveInbounds",{defaultValue:"No active inbounds available."})}):p.map(C=>e.jsxs("label",{className:"flex items-center gap-3 rounded-lg p-2 hover:bg-card/80",children:[e.jsx("input",{type:"checkbox",value:C.id,...h("inboundIds",{required:i("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line bg-card"}),e.jsxs("span",{className:"text-sm text-foreground",children:[C.protocol," - ",C.remark||`Port ${C.port}`]})]},C.id))}),V.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500",children:V.inboundIds.message}):null]}),e.jsxs("div",{className:"flex flex-col gap-2 border-t border-line/70 pt-4 sm:flex-row",children:[e.jsxs(j,{type:"submit",className:"flex-1",loading:l.isPending,children:[e.jsx(Rt,{className:"mr-2 h-4 w-4"}),i("users.bulkCreate.submit",{defaultValue:"Create Users & Download Credentials"})]}),e.jsx(j,{type:"button",variant:"secondary",className:"flex-1",onClick:u,children:i("common.cancel",{defaultValue:"Cancel"})})]})]})]})})};function kt(u){const m=new Date(u),v=m.getFullYear(),i=String(m.getMonth()+1).padStart(2,"0"),s=String(m.getDate()).padStart(2,"0");return`${v}-${i}-${s}`}function oa({user:u,onClose:m,onSuccess:v}){var N,E,S,W;const[i,s]=c.useState(""),l=Cs(),{t:p}=Le(),{register:h,handleSubmit:R,reset:b,formState:{errors:V}}=Dt({defaultValues:{dataLimitGb:Math.max(1,Math.round(Number(u.dataLimit||0)/1024**3)),expireDate:kt(u.expireDate),ipLimit:Math.max(0,Number(u.ipLimit||0)),deviceLimit:Math.max(0,Number(u.deviceLimit||0))}});c.useEffect(()=>{b({dataLimitGb:Math.max(1,Math.round(Number(u.dataLimit||0)/1024**3)),expireDate:kt(u.expireDate),ipLimit:Math.max(0,Number(u.ipLimit||0)),deviceLimit:Math.max(0,Number(u.deviceLimit||0))})},[b,u.dataLimit,u.deviceLimit,u.expireDate,u.ipLimit]);const $=async P=>{s("");const Z=new Date,M=new Date(`${P.expireDate}T23:59:59`).getTime()-Z.getTime(),w=Math.max(1,Math.ceil(M/(1e3*60*60*24)));try{await l.mutateAsync({id:u.id,data:{dataLimit:Number(P.dataLimitGb),expiryDays:w,ipLimit:Number(P.ipLimit),deviceLimit:Number(P.deviceLimit)}}),v()}catch(Q){s((Q==null?void 0:Q.message)||p("users.quickEdit.saveFailed",{defaultValue:"Failed to update user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-md overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:p("users.quickEdit.title",{defaultValue:"Quick Edit"})}),e.jsx("p",{className:"text-sm text-muted",children:u.email})]}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":p("common.close",{defaultValue:"Close"}),children:e.jsx($e,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:R($),className:"space-y-5 p-5 sm:p-6",children:[i?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:i}):null,e.jsx(ee,{label:p("users.quickEdit.dataLimitLabel",{defaultValue:"Data Limit (GB)"}),type:"number",...h("dataLimitGb",{valueAsNumber:!0,required:p("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:p("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(N=V.dataLimitGb)==null?void 0:N.message}),e.jsx(ee,{label:p("users.quickEdit.expiryDateLabel",{defaultValue:"Expiry Date"}),type:"date",...h("expireDate",{required:p("users.quickEdit.validation.expiryDateRequired",{defaultValue:"Expiry date is required"})}),error:(E=V.expireDate)==null?void 0:E.message}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(ee,{label:p("users.quickEdit.ipLimitLabel",{defaultValue:"IP Limit (0 = unlimited)"}),type:"number",...h("ipLimit",{valueAsNumber:!0,min:{value:0,message:p("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(S=V.ipLimit)==null?void 0:S.message}),e.jsx(ee,{label:p("users.quickEdit.deviceLimitLabel",{defaultValue:"Device Limit (0 = unlimited)"}),type:"number",...h("deviceLimit",{valueAsNumber:!0,min:{value:0,message:p("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(W=V.deviceLimit)==null?void 0:W.message})]}),e.jsx("p",{className:"rounded-lg border border-line/70 bg-panel/60 px-3 py-2 text-xs text-muted",children:p("users.quickEdit.helper",{defaultValue:"Expiry is stored as days from now. We convert this date automatically when saving."})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",className:"flex-1",loading:l.isPending,children:p("users.quickEdit.saveChanges",{defaultValue:"Save Changes"})}),e.jsx(j,{type:"button",variant:"secondary",className:"flex-1",onClick:m,children:p("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}const ua=[{key:"v2ray",label:"V2Ray"},{key:"clash",label:"Clash"},{key:"singbox",label:"Sing-box"},{key:"wireguard",label:"WireGuard"},{key:"mieru",label:"Mieru"}];function da({user:u,onClose:m}){var W,P,Z,K,M;const{t:v}=Le(),[i,s]=c.useState("v2ray"),[l,p]=c.useState(!1),h=Ut({queryKey:["subscription-info",u.id],queryFn:()=>fe.getSubscriptionInfo(u.id)}),R=c.useMemo(()=>{var w,Q;return((Q=(w=h.data)==null?void 0:w.data)==null?void 0:Q.urls)??{}},[(P=(W=h.data)==null?void 0:W.data)==null?void 0:P.urls]),b=c.useMemo(()=>{var w,Q;return((Q=(w=h.data)==null?void 0:w.data)==null?void 0:Q.qrCodes)??{}},[(K=(Z=h.data)==null?void 0:Z.data)==null?void 0:K.qrCodes]),V=c.useMemo(()=>ua.filter(w=>!!R[w.key]),[R]),$=V.some(w=>w.key===i)?i:((M=V[0])==null?void 0:M.key)??"v2ray",N=R[$]||"",E=b[$],S=async()=>{!N||!await qe(N)||(p(!0),window.setTimeout(()=>p(!1),1200))};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:v("users.qrModal.title",{defaultValue:"Quick QR"})}),e.jsx("p",{className:"text-sm text-muted",children:u.email})]}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":v("common.close",{defaultValue:"Close"}),children:e.jsx($e,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"space-y-5 p-5 sm:p-6",children:h.isLoading?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})}):h.isError?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:v("users.qrModal.loadFailed",{defaultValue:"Failed to load subscription QR."})}):V.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/60 px-4 py-6 text-center text-sm text-muted",children:v("users.qrModal.noFormats",{defaultValue:"No subscription formats available for this user."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:V.map(w=>e.jsx("button",{type:"button",onClick:()=>s(w.key),className:`rounded-lg px-3 py-2 text-xs font-medium transition ${$===w.key?"bg-brand-500 text-white":"border border-line/70 bg-card/80 text-muted hover:text-foreground"}`,children:w.label},w.key))}),e.jsxs("div",{className:"flex flex-col items-center gap-4 rounded-2xl border border-line/70 bg-panel/60 p-4",children:[e.jsx("div",{className:"rounded-xl border border-line/70 bg-white p-3",children:E?e.jsx("img",{src:E,alt:v("users.qrModal.alt",{defaultValue:"Subscription QR"}),className:"h-[220px] w-[220px]"}):e.jsx(Gs,{value:N,size:220})}),e.jsx("p",{className:"w-full break-all rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground",children:N})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsxs(j,{type:"button",className:"flex-1",onClick:()=>void S(),children:[l?e.jsx(zs,{className:"mr-2 h-4 w-4"}):e.jsx(Os,{className:"mr-2 h-4 w-4"}),l?v("common.copied",{defaultValue:"Copied"}):v("users.copyLink",{defaultValue:"Copy Link"})]}),e.jsxs(j,{type:"button",variant:"secondary",className:"flex-1",onClick:()=>window.open(N,"_blank","noopener,noreferrer"),children:[e.jsx(Hs,{className:"mr-2 h-4 w-4"}),v("common.open",{defaultValue:"Open"})]})]})]})})]})})}const jt=({userId:u})=>{var R;const{t:m}=Le(),v=St(),[i,s]=c.useState(null),l=Ut({queryKey:["user-devices",u,60],queryFn:async()=>(await xt.get(`/users/${u}/devices`,{params:{windowMinutes:60}})).data,staleTime:1e4}),p=ve({mutationFn:async b=>{await xt.delete(`/users/${u}/devices/${encodeURIComponent(b)}`)},onSuccess:async()=>{await v.invalidateQueries({queryKey:["user-devices",u,60]}),await v.invalidateQueries({queryKey:["user-sessions"]})}}),h=((R=l.data)==null?void 0:R.devices)||[];return l.isLoading?e.jsx("p",{className:"text-xs text-muted",children:m("users.devices.loading",{defaultValue:"Loading active devices..."})}):h.length===0?e.jsx("p",{className:"text-xs text-muted",children:m("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsxs("div",{className:"space-y-2",children:[h.slice(0,6).map(b=>e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-lg border border-line/60 bg-card/70 px-3 py-2 text-xs",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-mono text-foreground",children:b.shortFingerprint||b.fingerprint.slice(0,10)}),e.jsxs("p",{className:"text-muted",children:[b.clientIp||m("users.devices.unknownIp",{defaultValue:"unknown IP"})," •"," ",b.online?m("common.online",{defaultValue:"Online"}):m("users.devices.lastSeen",{defaultValue:"Last {{time}}",time:Zs(b.lastSeenAt)})]})]}),e.jsx(j,{size:"sm",variant:"ghost",loading:p.isPending,onClick:()=>{s(b.fingerprint)},children:m("common.revoke",{defaultValue:"Revoke"})})]},b.fingerprint)),e.jsx(At,{open:!!i,title:m("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}),description:m("users.devices.revokeDescription",{defaultValue:"This device will be disconnected and must refresh subscription before reconnecting."}),confirmLabel:m("common.revoke",{defaultValue:"Revoke"}),tone:"danger",loading:p.isPending,onCancel:()=>{p.isPending||s(null)},onConfirm:()=>{i&&p.mutateAsync(i).finally(()=>{s(null)})}})]})},ca=({users:u,viewMode:m="auto",onlineUuidSet:v=new Set,onView:i,onPrefetch:s,onDelete:l,onQuickQr:p,onQuickEdit:h,onRunDiagnostics:R,onRotateKeys:b,onRevokeKeys:V,onDisconnectSessions:$,onRegenerateSubscription:N,onResetTraffic:E,onExtendExpiry:S,onDisableUser:W,onKillUser:P,onCopySubscription:Z,onUpdateLimits:K,selectedUserIds:M=[],onSelectionChange:w,sessionsByUserId:Q={}})=>{const{t:o}=Le(),pe=80,[H,je]=c.useState([]),[C,re]=c.useState(()=>Math.min(u.length,pe)),_=u.length>0&&M.length===u.length,xe=M.length>0&&M.length<u.length;c.useEffect(()=>{re(Math.min(u.length,pe))},[u.length]),c.useEffect(()=>{if(C>=u.length)return;const r=window.setTimeout(()=>{re(k=>Math.min(u.length,k+pe))},32);return()=>{window.clearTimeout(r)}},[C,u.length]);const be=u.slice(0,C),U=()=>{w&&w(_?[]:u.map(r=>r.id))},De=r=>{w&&(M.includes(r)?w(M.filter(k=>k!==r)):w([...M,r]))},L=r=>{je(k=>k.includes(r)?k.filter(g=>g!==r):[...k,r])},Ie=m==="auto"?"space-y-3 md:hidden":m==="cards"?"space-y-3":"hidden",F=m==="auto"?"hidden overflow-x-auto md:block":m==="table"?"overflow-x-auto":"hidden",Ne=r=>{const k={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"},g={ACTIVE:"status.active",EXPIRED:"status.expired",DISABLED:"status.disabled",LIMITED:"status.limited"}[r];return e.jsx(_s,{variant:k[r]||"info",children:g?o(g,{defaultValue:r}):r})},I=r=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${r?"bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[r?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${r?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),r?o("common.online",{defaultValue:"Online"}):o("common.offline",{defaultValue:"Offline"})]}),Ce=r=>{if(!(r!=null&&r.lastSeenAt))return o("users.sessions.noActivity",{defaultValue:"No activity"});const k=new Date(r.lastSeenAt).getTime();if(Number.isNaN(k))return o("users.sessions.noActivity",{defaultValue:"No activity"});const g=Math.floor((Date.now()-k)/6e4);if(g<1)return o("users.sessions.justNow",{defaultValue:"just now"});if(g<60)return o("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:g});const A=Math.floor(g/60);if(A<24)return o("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:A});const te=Math.floor(A/24);return o("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:te})},d=r=>{const k=(r==null?void 0:r.lastPacketSeenAt)||(r==null?void 0:r.lastSeenAt)||null;if(!k)return o("users.sessions.noActivity",{defaultValue:"No activity"});const g=new Date(k).getTime();if(Number.isNaN(g))return o("users.sessions.noActivity",{defaultValue:"No activity"});const A=Math.floor((Date.now()-g)/6e4);if(A<1)return o("users.sessions.justNow",{defaultValue:"just now"});if(A<60)return o("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:A});const te=Math.floor(A/60);if(te<24)return o("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:te});const Y=Math.floor(te/24);return o("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:Y})},Se=r=>{var A;if(!r)return"";const k=((A=r.currentInbound)==null?void 0:A.tag)||"",g=r.currentIp||"";return k&&g?`${k} • ${g}`:k||g||""},q=(r,k=!1)=>{const g=[];return p&&g.push({key:"qr",label:o("users.actions.showQr",{defaultValue:"Show QR"}),onClick:()=>p(r)}),h&&g.push({key:"edit",label:o("users.actions.quickEdit",{defaultValue:"Quick Edit"}),onClick:()=>h(r)}),R&&g.push({key:"diagnostics",label:o("users.actions.runDiagnostics",{defaultValue:"Run diagnostics"}),onClick:()=>R(r)}),!h&&K&&g.push({key:"limits",label:o("users.actions.increaseLimits",{defaultValue:"Increase limits"}),onClick:()=>K(r,{ipLimit:Number(r.ipLimit||0)+1,deviceLimit:Number(r.deviceLimit||0)+1})}),Z&&g.push({key:"copy-sub",label:o("users.actions.copySubscription",{defaultValue:"Copy Subscription"}),onClick:()=>Z(r)}),N&&g.push({key:"regen-token",label:o("users.actions.regenerateToken",{defaultValue:"Regenerate Token"}),onClick:()=>N(r)}),S&&(g.push({key:"extend7",label:o("users.actions.extend7",{defaultValue:"Extend +7 Days"}),onClick:()=>S(r,7)}),g.push({key:"extend30",label:o("users.actions.extend30",{defaultValue:"Extend +30 Days"}),onClick:()=>S(r,30)})),E&&g.push({key:"reset-traffic",label:o("users.actions.resetTraffic",{defaultValue:"Reset Traffic"}),onClick:()=>E(r)}),$&&g.push({key:"disconnect",label:o("users.actions.disconnectSessions",{defaultValue:"Disconnect Sessions"}),onClick:()=>$(r)}),b&&g.push({key:"rotate",label:o("users.actions.rotateCredentials",{defaultValue:"Rotate Credentials"}),onClick:()=>b(r)}),V&&g.push({key:"revoke",label:o("users.actions.revokeAccess",{defaultValue:"Revoke Access"}),onClick:()=>V(r)}),W&&g.push({key:"disable",label:o("users.actions.disableUser",{defaultValue:"Disable User"}),onClick:()=>W(r)}),P&&g.push({key:"kill",label:"Kill Connection",tone:"danger",onClick:()=>P(r)}),l&&g.push({key:"delete",label:o("users.actions.deleteUser",{defaultValue:"Delete User"}),tone:"danger",onClick:()=>l(r.id)}),g.length===0?null:e.jsx(Xs,{items:g,ariaLabel:o("common.moreActions",{defaultValue:"More actions"}),triggerClassName:`rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${k?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,children:e.jsx(Mt,{className:"h-4 w-4"})})};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:Ie,children:[w?e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-line/70 bg-card/75 px-4 py-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-foreground",children:[e.jsx("input",{type:"checkbox",checked:_,ref:r=>{r&&(r.indeterminate=xe)},onChange:U,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),o("common.selectAll",{defaultValue:"Select All"})]}),e.jsx("span",{className:"text-xs text-muted",children:o("users.selectedCount",{defaultValue:"{{count}} selected",count:M.length})})]}):null,be.map(r=>{var Ve;const k=Number(r.uploadUsed||0),g=Number(r.downloadUsed||0),A=Number(r.dataLimit||0),te=k+g,Y=A>0?(te/A*100).toFixed(1):"0.0",le=!!r.startOnFirstUse&&!r.firstUsedAt,de=le?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,ae=le?de||0:gt(r.expireDate),x=Q[r.id],X=(x==null?void 0:x.online)??v.has(r.uuid),ne=Number.isFinite(x==null?void 0:x.activeKeyCount)?Number(x==null?void 0:x.activeKeyCount):Number(((Ve=r.inbounds)==null?void 0:Ve.length)||0),Re=Number.isFinite(x==null?void 0:x.onlineKeyCount)?Number(x==null?void 0:x.onlineKeyCount):X?Math.min(1,ne||1):0,we=Se(x),Ue=Ce(x),Me=d(x);return e.jsxs("div",{className:"rounded-xl border border-line/70 bg-card/80 p-4",onMouseEnter:()=>s==null?void 0:s(r),onFocus:()=>s==null?void 0:s(r),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("button",{type:"button",className:"truncate text-left text-sm font-medium text-foreground transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40",onClick:()=>i(r),children:r.email}),e.jsxs("p",{className:"font-mono text-xs text-muted",children:[r.uuid.substring(0,8),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[w?e.jsx("input",{type:"checkbox",checked:M.includes(r.id),onChange:()=>De(r.id),className:"mt-0.5 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}):null,q(r,!0)]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[Ne(r.status),I(X),e.jsx("span",{className:"text-xs text-muted",children:o("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:Re,total:ne||0})}),e.jsx("span",{className:"text-xs text-muted",children:o("users.limitIpShort",{defaultValue:"IP {{count}}",count:Number(r.ipLimit||0)})}),e.jsx("span",{className:"text-xs text-muted",children:o("users.limitDeviceShort",{defaultValue:"DEV {{count}}",count:Number(r.deviceLimit||0)})}),we?e.jsx("span",{className:"text-xs text-muted",children:we}):null,e.jsx("span",{className:"text-xs text-muted",children:o("users.sessions.lastPacketPrefix",{defaultValue:"Last packet {{label}}",label:Me})}),X?null:e.jsx("span",{className:"text-xs text-muted",children:o("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Ue})})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-xs text-foreground",children:[Pe(te)," / ",Pe(A)]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(Y)>90?"bg-red-600":Number.parseFloat(Y)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(Y),100)}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted",children:[e.jsx("span",{children:o("users.usagePercent",{defaultValue:"{{percent}}% used",percent:Y})}),le?e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:o("users.startOnFirstConnectBadge",{defaultValue:"Starts on first connect (+{{days}}d)",days:de})}):e.jsx("span",{className:ae<7?"text-red-600 dark:text-red-400":"",children:ae>0?o("common.daysLeft",{defaultValue:"{{count}} days left",count:ae}):o("common.expired",{defaultValue:"Expired"})})]})]}),e.jsxs("button",{type:"button",onClick:()=>L(r.id),className:"mt-3 flex w-full items-center justify-between rounded-xl border border-line/60 bg-panel/35 px-4 py-3 text-left text-sm text-foreground transition hover:bg-panel/55","aria-label":H.includes(r.id)?o("users.devices.hide",{defaultValue:"Hide devices"}):o("users.devices.show",{defaultValue:"Show devices"}),children:[e.jsx("span",{className:"font-medium",children:o("users.devices.title",{defaultValue:"Devices"})}),H.includes(r.id)?e.jsx(ht,{className:"h-4 w-4 text-brand-500"}):e.jsx(Be,{className:"h-4 w-4 text-brand-500"})]}),H.includes(r.id)?e.jsx("div",{className:"mt-3 rounded-lg border border-line/60 bg-panel/50 p-3",children:e.jsx(jt,{userId:r.id})}):null]},`mobile-${r.id}`)})]}),e.jsx("div",{className:F,children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800/50",children:e.jsxs("tr",{children:[w&&e.jsx("th",{className:"w-12 px-6 py-3",children:e.jsx("input",{type:"checkbox",checked:_,ref:r=>{r&&(r.indeterminate=xe)},onChange:U,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("users.table.user",{defaultValue:"User"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("common.online",{defaultValue:"Online"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("users.table.dataUsage",{defaultValue:"Data Usage"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("users.table.limits",{defaultValue:"Limits"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("common.expiry",{defaultValue:"Expiry"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("users.devices.title",{defaultValue:"Devices"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:o("common.actions",{defaultValue:"Actions"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-800",children:be.map(r=>{var Ve;const k=Number(r.uploadUsed||0),g=Number(r.downloadUsed||0),A=Number(r.dataLimit||0),te=k+g,Y=A>0?(te/A*100).toFixed(1):"0.0",le=!!r.startOnFirstUse&&!r.firstUsedAt,de=le?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,ae=le?de||0:gt(r.expireDate),x=Q[r.id],X=(x==null?void 0:x.online)??v.has(r.uuid),ne=Number.isFinite(x==null?void 0:x.activeKeyCount)?Number(x==null?void 0:x.activeKeyCount):Number(((Ve=r.inbounds)==null?void 0:Ve.length)||0),Re=Number.isFinite(x==null?void 0:x.onlineKeyCount)?Number(x==null?void 0:x.onlineKeyCount):X?Math.min(1,ne||1):0,we=Se(x),Ue=Ce(x),Me=d(x);return e.jsxs(c.Fragment,{children:[e.jsxs("tr",{className:"transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50",onMouseEnter:()=>s==null?void 0:s(r),children:[w&&e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"checkbox",checked:M.includes(r.id),onChange:()=>De(r.id),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{type:"button",className:"text-left text-sm font-medium text-gray-900 transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:text-white",onClick:()=>i(r),children:r.email}),e.jsxs("span",{className:"font-mono text-xs text-gray-500 dark:text-gray-400",children:[r.uuid.substring(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4",children:Ne(r.status)}),e.jsxs("td",{className:"px-6 py-4",children:[I(X),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:o("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:Re,total:ne||0})}),we?e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:we}):null,e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:o("users.sessions.lastPacketPrefix",{defaultValue:"Last packet {{label}}",label:Me})}),X?null:e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:o("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Ue})})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:[Pe(te)," / ",Pe(A)]}),e.jsx("div",{className:"mt-1 h-2 w-32 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(Y)>90?"bg-red-600":Number.parseFloat(Y)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(Y),100)}%`}})}),e.jsx("span",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:o("users.usagePercent",{defaultValue:"{{percent}}% used",percent:Y})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:o("users.limitIpAbbrev",{defaultValue:"IP"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.ipLimit||0)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:o("users.limitDeviceAbbrev",{defaultValue:"DEV"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.deviceLimit||0)})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:le?o("users.startOnFirstConnect",{defaultValue:"Starts on first connect"}):new Date(r.expireDate).toLocaleDateString()}),le?e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400",children:o("users.startOnFirstConnectAfter",{defaultValue:"{{count}} days after first connect",count:de||0})}):e.jsx("span",{className:`text-xs ${ae<7?"text-red-600 dark:text-red-400":ae<30?"text-yellow-600 dark:text-yellow-400":"text-gray-500 dark:text-gray-400"}`,children:ae>0?o("common.daysLeft",{defaultValue:"{{count}} days left",count:ae}):o("common.expired",{defaultValue:"Expired"})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>L(r.id),"aria-label":H.includes(r.id)?o("users.devices.hide",{defaultValue:"Hide devices"}):o("users.devices.show",{defaultValue:"Show devices"}),children:H.includes(r.id)?e.jsx(ht,{className:"h-4 w-4 text-brand-500"}):e.jsx(Be,{className:"h-4 w-4 text-brand-500"})})}),e.jsx("td",{className:"px-6 py-4",children:q(r)})]}),H.includes(r.id)?e.jsx("tr",{className:"bg-panel/45",children:e.jsx("td",{colSpan:(w?1:0)+8,className:"px-6 py-4",children:e.jsx(jt,{userId:r.id})})}):null]},r.id)})})]})}),C<u.length?e.jsx("div",{className:"flex items-center justify-center rounded-xl border border-line/60 bg-card/60 px-3 py-2 text-xs text-muted",children:o("users.rendering",{defaultValue:"Rendering {{count}} of {{total}} users...",count:C,total:u.length})}):null]})};function ma({open:u,title:m,description:v,label:i="Value",placeholder:s,defaultValue:l="",inputType:p="text",confirmLabel:h="Save",cancelLabel:R="Cancel",loading:b=!1,onCancel:V,onConfirm:$}){const[N,E]=c.useState(l);return c.useEffect(()=>{u&&E(l)},[l,u]),u?e.jsx("div",{className:"fixed inset-0 z-[110] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:S=>{S.target===S.currentTarget&&!b&&V()},children:e.jsxs("div",{className:"w-full max-w-md overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/20",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-5",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"mt-0.5 rounded-full bg-brand-500/15 p-1 text-brand-400",children:e.jsx(aa,{className:"h-4 w-4"})}),e.jsx("h3",{className:"text-base font-semibold text-foreground",children:m})]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:V,disabled:b,"aria-label":"Close dialog",children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 px-4 py-4 sm:px-5",children:[v?e.jsx("p",{className:"whitespace-pre-wrap text-sm text-muted",children:v}):null,e.jsxs("label",{className:"space-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-foreground",children:i}),e.jsx("input",{autoFocus:!0,type:p,className:"w-full rounded-xl border border-line/80 bg-card/80 px-3 py-2 text-sm text-foreground outline-none transition focus:border-brand-500/70 focus:ring-2 focus:ring-brand-500/35",placeholder:s,value:N,disabled:b,onChange:S=>{E(S.target.value)},onKeyDown:S=>{S.key==="Enter"&&!b&&(S.preventDefault(),$(N)),S.key==="Escape"&&!b&&(S.preventDefault(),V())}})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-5",children:[e.jsx(j,{type:"button",variant:"secondary",onClick:V,disabled:b,children:R}),e.jsx(j,{type:"button",variant:"primary",onClick:()=>$(N),loading:b,disabled:b,children:h})]})]})}):null}function fa(u){if(!u||typeof u!="object")return;const m=u.meta||u.pagination;if(m)return m}function Nt(u){return`"${(u==null?"":String(u)).replace(/"/g,'""')}"`}function pa(){var ct,mt,ft;const u=vs(),m=St(),[v,i]=ws(),{t:s}=Le(),l=Lt(),p=Vs(t=>t.admin),h=(p==null?void 0:p.role)==="SUPER_ADMIN",R=Js("one-ui/users-filters",{page:1,search:"",status:"",viewMode:"auto"}),{views:b,saveView:V,deleteView:$}=ea("one-ui/users-saved-views"),[N,E]=c.useState(""),S=R.value.page,W=R.value.search,P=R.value.status,Z=R.value.viewMode,K=R.setValue,M=c.useCallback(t=>{K(a=>{const n=typeof t=="function"?t(a.page):t;return{...a,page:Math.max(1,n)}})},[K]),w=c.useCallback(t=>{K(a=>({...a,search:t}))},[K]),Q=c.useCallback(t=>{K(a=>({...a,status:t}))},[K]),o=c.useCallback(t=>{K(a=>({...a,viewMode:t}))},[K]),[pe,H]=c.useState(!1),[je,C]=c.useState(!1),[re,_]=c.useState(null),[xe,be]=c.useState(null),[U,De]=c.useState(null),[L,Ie]=c.useState(null),[F,Ne]=c.useState(null),[I,Ce]=c.useState(null),[d,Se]=c.useState([]),[q,r]=c.useState(""),[k,g]=c.useState("DISABLED"),[A,te]=c.useState(()=>typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 1023px), (pointer: coarse)").matches),Y=Ys(W,320),le=v.get("quick"),de=c.useRef(null),ae=c.useRef(null),x=5e3,X=Ss({page:S,limit:50,search:Y,status:P||void 0}),ne=js({page:1,limit:100,includeDisabled:!1}),Re=Ls(),we=Ds(),Ue=Rs(),Me=Us(),Ve=Ms(),Ze=As(),Ye=Es(),Je=Is(),Ke=Ts(),et=Fs(),tt=Ps(),Et=qs({refetchInterval:x,staleTime:x}),st=Bs(),It=$s(),Ae=ve({mutationFn:({userIds:t,dryRun:a})=>fe.bulkReorderUserInboundsByPattern({userIds:t,pattern:"myanmar",dryRun:a})}),Ee=ve({mutationFn:({userIds:t,dryRun:a,windowMinutes:n})=>fe.bulkReorderUserInboundsByQuality({userIds:t,windowMinutes:n,dryRun:a})}),Qe=ve({mutationFn:({groupId:t,userIds:a})=>Fe.addUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Ge=ve({mutationFn:({groupId:t,userIds:a})=>Fe.removeUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Oe=ve({mutationFn:({groupId:t,userIds:a})=>Fe.moveUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Te=ve({mutationFn:({groupId:t,payload:a})=>Fe.applyPolicy(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]}),m.invalidateQueries({queryKey:["user-effective-policy"]})])}}),Tt=ve({mutationFn:({userId:t,payload:a})=>fe.updateUser(t,a),onMutate:async({userId:t,payload:a})=>{const n=m.getQueriesData({queryKey:["users"]});return m.setQueriesData({queryKey:["users"]},f=>!f||!Array.isArray(f.data)?f:{...f,data:f.data.map(y=>y.id===t?{...y,ipLimit:a.ipLimit??y.ipLimit,deviceLimit:a.deviceLimit??y.deviceLimit}:y)}),{previousUsersQueries:n}},onError:(t,a,n)=>{if(n!=null&&n.previousUsersQueries)for(const[f,y]of n.previousUsersQueries)m.setQueryData(f,y)},onSuccess:async(t,a)=>{var n;(n=t==null?void 0:t.data)!=null&&n.id&&m.setQueryData(["user",a.userId],{success:!0,data:t.data}),await Promise.all([m.invalidateQueries({queryKey:["user",a.userId]}),m.invalidateQueries({queryKey:["user-devices",a.userId,60]})])}}),T=c.useMemo(()=>{var t;return((t=X.data)==null?void 0:t.data)??[]},[X.data]),ue=c.useMemo(()=>{var t;return((t=ne.data)==null?void 0:t.data)??[]},[ne.data]),ge=c.useMemo(()=>fa(X.data),[X.data]),Ft=c.useMemo(()=>T.map(t=>t.id),[T]),B=Ks(Ft,{includeOffline:!0,live:!A,refetchInterval:x,staleTime:x}),ze=c.useMemo(()=>{var t;return Object.fromEntries((((t=B.data)==null?void 0:t.sessions)||[]).map(a=>[a.userId,a]))},[(ct=B.data)==null?void 0:ct.sessions]),We=c.useMemo(()=>{var t;return new Set((((t=B.data)==null?void 0:t.sessions)||[]).filter(a=>a.online).map(a=>String(a.uuid||"")))},[(mt=B.data)==null?void 0:mt.sessions]),Pt=c.useMemo(()=>T.filter(t=>t.status==="ACTIVE").length,[T]),He=c.useMemo(()=>T.filter(t=>{var a;return((a=ze[t.id])==null?void 0:a.online)||We.has(t.uuid)}).length,[We,ze,T]),qt=c.useMemo(()=>T.filter(t=>t.status==="LIMITED").length,[T]),Bt=c.useMemo(()=>T.filter(t=>t.status==="EXPIRED").length,[T]),_e=c.useMemo(()=>T.filter(t=>d.includes(t.id)),[T,d]),at=h,Xe=h,G=Ze.isPending||Ye.isPending||Je.isPending||Ke.isPending||et.isPending||tt.isPending||Ae.isPending||Ee.isPending||Qe.isPending||Ge.isPending||Oe.isPending||Te.isPending,$t=c.useMemo(()=>B.streamStatus==="connected"?s("users.streamStatus.connected",{defaultValue:"Connected"}):B.streamStatus==="connecting"?B.reconnectAttempts>0?s("users.streamStatus.reconnecting",{defaultValue:"Reconnecting ({{count}})",count:B.reconnectAttempts}):s("users.streamStatus.connecting",{defaultValue:"Connecting"}):B.streamStatus==="error"?s("common.error",{defaultValue:"Error"}):s("users.streamStatus.idle",{defaultValue:"Idle"}),[s,B.reconnectAttempts,B.streamStatus]),Kt=c.useMemo(()=>{if(!B.lastSnapshotAt)return s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"});const t=new Date(B.lastSnapshotAt);return Number.isNaN(t.getTime())?s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"}):s("users.streamSnapshot.lastUpdate",{defaultValue:"Last update {{time}}",time:t.toLocaleTimeString()})},[s,B.lastSnapshotAt]),ie=(ft=Et.data)==null?void 0:ft.data,Qt=c.useMemo(()=>{const t=(ie==null?void 0:ie.status)||"stopped";return t==="healthy"?s("users.telemetry.healthy",{defaultValue:"Healthy"}):t==="degraded"?s("users.telemetry.degraded",{defaultValue:"Degraded"}):t==="stale"?s("users.telemetry.stale",{defaultValue:"Stale"}):t==="starting"?s("users.telemetry.starting",{defaultValue:"Starting"}):s("users.telemetry.stopped",{defaultValue:"Stopped"})},[s,ie==null?void 0:ie.status]),Gt=c.useMemo(()=>!ie||ie.lagMs===null||ie.lagMs===void 0?s("users.telemetry.noLag",{defaultValue:"No lag data yet"}):s("users.telemetry.lag",{defaultValue:"Lag {{seconds}}s",seconds:Math.max(0,Math.round(ie.lagMs/1e3))}),[s,ie]);c.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const t=window.matchMedia("(max-width: 1023px), (pointer: coarse)"),a=n=>{te(n?n.matches:t.matches)};return a(),typeof t.addEventListener=="function"?(t.addEventListener("change",a),()=>t.removeEventListener("change",a)):(t.addListener(a),()=>t.removeListener(a))},[]),c.useEffect(()=>{M(1)},[Y,M,P]),c.useEffect(()=>{Se(t=>t.filter(a=>T.some(n=>n.id===a)))},[T]),c.useEffect(()=>{if(!ue.length){q!==""&&r("");return}ue.some(a=>String(a.id)===q)||r(String(ue[0].id))},[ue,q]),c.useEffect(()=>{if(le==="create"){H(!0);const t=new URLSearchParams(v);t.delete("quick"),i(t,{replace:!0})}},[le,v,i]);const O=({title:t,description:a,confirmLabel:n="Confirm",tone:f="danger"})=>new Promise(y=>{de.current=y,De({title:t,description:a,confirmLabel:n,tone:f})}),rt=t=>{const a=de.current;de.current=null,De(null),a&&a(t)},lt=({title:t,description:a,label:n,placeholder:f,defaultValue:y="",inputType:z="text",confirmLabel:ce="Save"})=>new Promise(he=>{ae.current=he,Ie({title:t,description:a,label:n,placeholder:f,defaultValue:y,inputType:z,confirmLabel:ce})}),nt=t=>{const a=ae.current;ae.current=null,Ie(null),a&&a(t)},Ot=async t=>{if(await O({title:"Kill Connection",description:"Are you sure you want to instantly drop all active socket connections for this user?",confirmLabel:"Kill Connection",tone:"danger"}))try{await we.mutateAsync(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),"User connection killed successfully")}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||"Failed to kill connection")}},zt=async t=>{if(await O({title:s("users.deleteUser",{defaultValue:"Delete User"}),description:s("users.confirmDelete",{defaultValue:"Are you sure you want to delete this user?"}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await Re.mutateAsync(t),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.userDeleted",{defaultValue:"User deleted successfully"}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.deleteFailed",{defaultValue:"Failed to delete user"}))}},Wt=()=>{if(T.length===0)return;const t=[[s("users.email",{defaultValue:"Email"}),s("users.uuid",{defaultValue:"UUID"}),s("common.status",{defaultValue:"Status"}),s("users.dataUsed",{defaultValue:"Data Used"}),s("users.dataLimit",{defaultValue:"Data Limit"}),s("users.expireDate",{defaultValue:"Expire Date"})].map(Nt).join(","),...T.map(y=>[y.email,y.uuid,y.status,Number(y.uploadUsed)+Number(y.downloadUsed),y.dataLimit,y.expireDate].map(Nt).join(","))].join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=window.URL.createObjectURL(a),f=document.createElement("a");f.href=n,f.setAttribute("download",`users-${new Date().toISOString()}.csv`),f.click(),window.URL.revokeObjectURL(n)},se=()=>{Se([])},Ht=t=>{const a=t,n=a==null?void 0:a.closest("details");n&&(n.open=!1)},J=(t,a)=>{t.preventDefault(),t.stopPropagation(),a&&a(),Ht(t.currentTarget)},D=async(t={})=>{const a=[X.refetch()];B.streamStatus!=="connected"&&a.push(B.refetch()),t.includeGroups&&a.push(ne.refetch()),await Promise.all(a)},oe=ta(()=>D(),{enabled:!A,intervalMs:x}),it=c.useMemo(()=>oe.enabled?s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:oe.statusLabel,seconds:Math.ceil(oe.nextRunInMs/1e3)}):s("autoRefresh.mobileOff",{defaultValue:"Auto refresh: Off on mobile (smooth scrolling mode)"}),[oe.enabled,oe.nextRunInMs,oe.statusLabel,s]),ot=async()=>{const t=await lt({title:s("common.saveView",{defaultValue:"Save View"}),description:s("users.views.saveDescription",{defaultValue:"Create a reusable filter preset for this Users page."}),label:s("users.views.nameLabel",{defaultValue:"View name"}),placeholder:s("users.views.namePlaceholder",{defaultValue:"My team filter"}),confirmLabel:s("common.saveView",{defaultValue:"Save View"})});if(!(!t||!t.trim()))try{const a=V(t.trim(),{search:W,status:P,viewMode:Z});E(a.id),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.savedToast",{defaultValue:'View "{{name}}" saved',name:a.name}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.views.saveFailed",{defaultValue:"Unable to save view"}))}},ut=t=>{E(t);const a=b.find(n=>n.id===t);a&&(R.setValue(n=>({...n,page:1,search:a.filters.search||"",status:a.filters.status||"",viewMode:a.filters.viewMode||"auto"})),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.appliedToast",{defaultValue:'Applied "{{name}}"',name:a.name})))},dt=()=>{if(!N)return;const t=b.find(a=>a.id===N);$(N),E(""),l.info(s("common.info",{defaultValue:"Info"}),t?s("users.views.removedToast",{defaultValue:'Removed "{{name}}"',name:t.name}):s("users.views.removedToastGeneric",{defaultValue:"Saved view removed"}))},_t=async()=>{if(d.length!==0&&await O({title:s("users.bulk.deleteTitle",{defaultValue:"Delete Selected Users"}),description:s("users.bulk.deleteDescription",{defaultValue:"Delete {{count}} selected users? This cannot be undone.",count:d.length}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await Ze.mutateAsync(d),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkDeleted",{defaultValue:"{{count}} user(s) deleted.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkDeleteFailed",{defaultValue:"Failed to delete selected users"}))}},Xt=async()=>{if(d.length!==0&&await O({title:s("users.bulk.resetTrafficTitle",{defaultValue:"Reset Traffic"}),description:s("users.bulk.resetTrafficDescription",{defaultValue:"Reset traffic for {{count}} selected users?",count:d.length}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await Ye.mutateAsync(d),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkTrafficReset",{defaultValue:"{{count}} user(s) reset.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkResetFailed",{defaultValue:"Failed to reset traffic"}))}},Zt=async()=>{if(d.length===0)return;const t=await lt({title:s("users.bulk.extendExpiryTitle",{defaultValue:"Extend Expiry"}),description:s("users.bulk.extendExpiryDescription",{defaultValue:"Extend expiry for {{count}} selected users.",count:d.length}),label:s("users.bulk.daysToAdd",{defaultValue:"Days to add"}),defaultValue:"30",inputType:"number",confirmLabel:s("common.extend",{defaultValue:"Extend"})});if(!t||!t.trim())return;const a=Number.parseInt(t,10);if(Number.isNaN(a)||a<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.invalidDays",{defaultValue:"Please enter a valid positive number of days."}));return}try{await Je.mutateAsync({userIds:d,days:a}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkExpiryExtended",{defaultValue:"{{count}} user(s) extended by {{days}} day(s).",count:d.length,days:a}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.bulkExtendFailed",{defaultValue:"Failed to extend expiry"}))}},Yt=async()=>{if(d.length!==0&&await O({title:s("users.bulk.applyStatusTitle",{defaultValue:"Apply Status"}),description:s("users.bulk.applyStatusDescription",{defaultValue:"Set status to {{status}} for {{count}} selected users?",status:k,count:d.length}),confirmLabel:s("common.apply",{defaultValue:"Apply"}),tone:"primary"}))try{await Ke.mutateAsync({userIds:d,status:k}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkStatusUpdated",{defaultValue:"{{count}} user(s) set to {{status}}.",count:d.length,status:k}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkUpdateFailed",{defaultValue:"Failed to update status"}))}},Jt=async()=>{if(d.length!==0&&await O({title:s("users.bulk.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.bulk.rotateDescription",{defaultValue:"Rotate credentials for {{count}} selected users?",count:d.length}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await et.mutateAsync({userIds:d,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRotated",{defaultValue:"{{count}} user(s) rotated.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRotateFailed",{defaultValue:"Failed to rotate selected user keys"}))}},es=async()=>{if(d.length!==0&&await O({title:s("users.bulk.revokeTitle",{defaultValue:"Revoke Access"}),description:s("users.bulk.revokeDescription",{defaultValue:"Revoke access for {{count}} selected users?",count:d.length}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await tt.mutateAsync({userIds:d,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRevoked",{defaultValue:"{{count}} user(s) revoked.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRevokeFailed",{defaultValue:"Failed to revoke selected user access"}))}},ts=async(t,a)=>{try{await Tt.mutateAsync({userId:t.id,payload:a}),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.limitUpdated",{defaultValue:"User limits updated."}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.limitUpdateFailed",{defaultValue:"Failed to update user limits"}))}},ss=async t=>{var a;try{const n=await It.mutateAsync({id:t.id,payload:{windowMinutes:60,portProbeTimeoutMs:1200}}),f=n==null?void 0:n.data;if(!f){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.diagnosticsEmpty",{defaultValue:"No diagnostics result returned."}));return}const y=f.summary||{pass:0,warn:0,fail:0},z=s("users.toast.diagnosticsSummary",{defaultValue:"PASS {{pass}} • WARN {{warn}} • FAIL {{fail}}",pass:y.pass,warn:y.warn,fail:y.fail});if(y.fail>0||y.warn>0){const ce=(a=f.recommendedActions)==null?void 0:a[0];l.warning(s("users.toast.diagnosticsTitle",{defaultValue:"Diagnostics completed"}),ce?`${z} • ${ce}`:z,12e3)}else l.success(s("users.toast.diagnosticsTitle",{defaultValue:"Diagnostics completed"}),z)}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.diagnosticsFailed",{defaultValue:"Failed to run diagnostics"}))}},as=async()=>{var t;try{const a=await st.mutateAsync(),n=(t=a==null?void 0:a.data)==null?void 0:t.summary,f=Number((n==null?void 0:n.updatedUsers)||0),y=Number((n==null?void 0:n.changedKeys)||0);l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.autotuneSummary",{defaultValue:"Smart fallback completed. Updated users: {{users}}, changed keys: {{keys}}.",users:f,keys:y}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.autotuneFailed",{defaultValue:"Failed to run smart fallback autotune"}))}},rs=async()=>{if(d.length===0)return;if(!q){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(q,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=ue.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await O({title:s("users.bulk.assignTitle",{defaultValue:"Assign To Group"}),description:s("users.bulk.assignDescription",{defaultValue:'Assign {{count}} selected users to group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.assign",{defaultValue:"Assign"}),tone:"primary"}))try{await Qe.mutateAsync({groupId:t,userIds:d}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.assignedToGroup",{defaultValue:"{{count}} user(s) assigned to {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.assignFailed",{defaultValue:"Failed to assign users to group"}))}},ls=async()=>{if(d.length===0)return;if(!q){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(q,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=ue.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await O({title:s("users.bulk.removeTitle",{defaultValue:"Remove From Group"}),description:s("users.bulk.removeDescription",{defaultValue:'Remove {{count}} selected users from group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.remove",{defaultValue:"Remove"}),tone:"danger"}))try{await Ge.mutateAsync({groupId:t,userIds:d}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.removedFromGroup",{defaultValue:"{{count}} user(s) removed from {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.removeFailed",{defaultValue:"Failed to remove users from group"}))}},ns=async()=>{if(d.length===0)return;if(!q){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(q,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=ue.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await O({title:s("users.bulk.moveTitle",{defaultValue:"Move To Group"}),description:s("users.bulk.moveDescription",{defaultValue:'Move {{count}} selected users exclusively to group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.move",{defaultValue:"Move"}),tone:"primary"}))try{await Oe.mutateAsync({groupId:t,userIds:d}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.movedToGroup",{defaultValue:"{{count}} user(s) moved to {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.moveFailed",{defaultValue:"Failed to move users to group"}))}},is=async()=>{if(d.length===0)return;if(!q){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(q,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=ue.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;try{const y=(await Te.mutateAsync({groupId:t,payload:{dryRun:!0,userIds:d}})).data||{},z=y.summary||{},he=(Array.isArray(y.preview)?y.preview:[]).slice(0,2).map(pt=>`${pt.email}: ${Object.keys(pt.changes||{}).join(", ")||s("common.noChanges",{defaultValue:"no changes"})}`).join(`
`),me=[s("users.bulk.policyDryRunTitle",{defaultValue:'Group policy dry-run for "{{group}}":',group:n}),s("users.bulk.policyDryRunTarget",{defaultValue:"- target users: {{count}}",count:z.targetUsers??d.length}),s("users.bulk.policyDryRunWouldUpdate",{defaultValue:"- would update: {{count}}",count:z.wouldUpdateUsers??0}),s("users.bulk.policyDryRunSkipped",{defaultValue:"- skipped: {{count}}",count:z.skippedUsers??0}),he?`
${s("common.preview",{defaultValue:"Preview"})}:
${he}`:"",`
${s("users.bulk.applyNow",{defaultValue:"Apply now?"})}`].filter(Boolean).join(`
`);if(!await O({title:s("users.bulk.applyPolicyTitle",{defaultValue:"Apply Group Policy"}),description:me,confirmLabel:s("users.bulk.applyPolicyConfirm",{defaultValue:"Apply Policy"}),tone:"primary"}))return;await Te.mutateAsync({groupId:t,payload:{dryRun:!1,userIds:d}}),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.policyApplied",{defaultValue:"{{count}} user(s) updated from {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.policyApplyFailed",{defaultValue:"Failed to apply group policy"}))}},os=async()=>{if(d.length!==0)try{const a=(await Ae.mutateAsync({userIds:d,dryRun:!0})).data||{},n=a.summary||{},y=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(z=>{const ce=(z.currentTop3||[]).map(me=>me.key).join(" > ")||"none",he=(z.newTop3||[]).map(me=>me.key).join(" > ")||"none";return`${z.email}: ${ce} -> ${he}`}).filter(Boolean);Ne({userIds:[...d],targetUsers:n.targetUsers??d.length,wouldUpdateUsers:n.wouldUpdateUsers??0,unchangedUsers:n.unchangedUsers??0,changedKeys:n.changedKeys??0,matchedUsers:n.matchedUsers??0,previewLines:y})}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},us=async()=>{if(F)try{await Ae.mutateAsync({userIds:F.userIds,dryRun:!1});const t=F.wouldUpdateUsers??0;Ne(null),se(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.myanmarPriorityApplied",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},ds=async()=>{if(d.length!==0)try{const a=(await Ee.mutateAsync({userIds:d,windowMinutes:60,dryRun:!0})).data||{},n=a.summary||{},y=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(z=>{const ce=(z.currentTop3||[]).map(me=>me.key).join(" > ")||"none",he=(z.newTop3||[]).map(me=>me.key).join(" > ")||"none";return`${z.email}: ${ce} -> ${he}`}).filter(Boolean);Ce({userIds:[...d],targetUsers:n.targetUsers??d.length,wouldUpdateUsers:n.wouldUpdateUsers??0,unchangedUsers:n.unchangedUsers??0,changedKeys:n.changedKeys??0,scoredKeys:n.scoredKeys??0,previewLines:y})}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},cs=async()=>{if(I)try{await Ee.mutateAsync({userIds:I.userIds,windowMinutes:60,dryRun:!1});const t=I.wouldUpdateUsers??0;Ce(null),se(),await D(),l.success(s("users.autoTuneAppliedTitle",{defaultValue:"Auto-tune applied"}),s("users.autoTuneAppliedBody",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},ms=async t=>{if(await O({title:s("users.actions.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.actions.rotateDescription",{defaultValue:"Rotate all credentials for {{email}}?",email:t.email}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await Ue.mutateAsync({id:t.id,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.rotated",{defaultValue:"Updated {{email}}.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.rotateFailed",{defaultValue:"Failed to rotate user keys"}))}},fs=async t=>{if(await O({title:s("users.actions.revokeTitle",{defaultValue:"Revoke User Access"}),description:s("users.actions.revokeDescription",{defaultValue:"Revoke all access for {{email}}? This will disable the user.",email:t.email}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await Me.mutateAsync({id:t.id,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.accessRevoked",{defaultValue:"{{email}} was disabled.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.revokeFailed",{defaultValue:"Failed to revoke user access"}))}},ps=async t=>{if(await O({title:s("users.actions.regenerateTitle",{defaultValue:"Regenerate Subscription Token"}),description:s("users.actions.regenerateDescription",{defaultValue:"Regenerate subscription token for {{email}}?",email:t.email}),confirmLabel:s("common.regenerate",{defaultValue:"Regenerate"}),tone:"primary"}))try{const a=await Ve.mutateAsync(t.id),n=`${window.location.origin}/sub/${a.subscriptionToken}?target=v2ray`;await qe(n)?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegeneratedCopied",{defaultValue:"New link for {{email}} was copied.",email:t.email})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegenerated",{defaultValue:"Token updated for {{email}}.",email:t.email})),await D()}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.regenerateFailed",{defaultValue:"Failed to regenerate subscription token"}))}},xs=async t=>{if(await O({title:s("users.actions.resetTrafficTitle",{defaultValue:"Reset User Traffic"}),description:s("users.actions.resetTrafficDescription",{defaultValue:"Reset traffic for {{email}}?",email:t.email}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await fe.resetTraffic(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.trafficReset",{defaultValue:"{{email}} counters were reset.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.resetFailed",{defaultValue:"Failed to reset user traffic"}))}},bs=async(t,a)=>{try{await fe.extendExpiry(t.id,a),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.expiryExtended",{defaultValue:"{{email}} extended by {{days}} day(s).",email:t.email,days:a}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.extendFailed",{defaultValue:"Failed to extend user expiry"}))}},gs=async t=>{if(await O({title:s("users.actions.disableTitle",{defaultValue:"Disable User"}),description:s("users.actions.disableDescription",{defaultValue:"Disable {{email}}?",email:t.email}),confirmLabel:s("common.disable",{defaultValue:"Disable"}),tone:"danger"}))try{await fe.updateUser(t.id,{status:"DISABLED"}),await fe.disconnectUserSessions(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userDisabled",{defaultValue:"{{email}} is now disabled and disconnected.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disableFailed",{defaultValue:"Failed to disable user"}))}},hs=async t=>{if(await O({title:s("users.actions.disconnectTitle",{defaultValue:"Disconnect Sessions"}),description:s("users.actions.disconnectDescription",{defaultValue:"Disconnect all active sessions for {{email}}?",email:t.email}),confirmLabel:s("common.disconnect",{defaultValue:"Disconnect"}),tone:"danger"}))try{const a=await fe.disconnectUserSessions(t.id);await D();const n=a!=null&&a.data?`${a.data.disconnectedDevices} device(s), ${a.data.disconnectedIps} IP(s)`:s("users.toast.sessionsDisconnectedFallback",{defaultValue:"Active sessions disconnected."});l.success(s("common.success",{defaultValue:"Success"}),n)}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disconnectFailed",{defaultValue:"Failed to disconnect active sessions"}))}},ys=async t=>{const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;await qe(a)?l.success(s("common.copied",{defaultValue:"Copied"}),s("users.toast.subscriptionCopied",{defaultValue:"Subscription link copied to clipboard."})):l.warning(s("users.toast.clipboardUnavailableTitle",{defaultValue:"Clipboard unavailable"}),s("users.toast.clipboardUnavailableBody",{defaultValue:`Copy failed. Use this link manually:
{{link}}`,link:a}),1e4)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:s("users.title")}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.subtitle",{defaultValue:"Manage your VPN users and subscriptions"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(j,{variant:"secondary",onClick:Wt,disabled:T.length===0,children:[e.jsx(Rt,{className:"mr-2 h-4 w-4"}),s("common.export",{defaultValue:"Export CSV"})]}),e.jsxs(j,{variant:"secondary",loading:st.isPending,onClick:()=>{as()},children:[e.jsx(ra,{className:"mr-2 h-4 w-4"}),s("users.smartFallbackNow",{defaultValue:"Smart Fallback Now"})]}),e.jsxs(j,{variant:"secondary",onClick:()=>C(!0),children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),s("users.bulkProvision",{defaultValue:"Bulk Provision"})]}),e.jsxs(j,{onClick:()=>H(!0),children:[e.jsx(wt,{className:"mr-2 h-4 w-4"}),s("users.addUser")]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(ye,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.totalUsers")}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(ge==null?void 0:ge.total)||T.length})]}),e.jsx(vt,{className:"h-6 w-6 text-brand-500"})]})}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.activeUsers")}),e.jsx("p",{className:"text-2xl font-bold text-emerald-500",children:Pt})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"relative inline-flex h-3 w-3",children:[He>0?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-3 w-3 rounded-full ${He>0?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:He})]}),e.jsxs("p",{className:"mt-1 text-xs text-muted",children:[s("users.sessionStream",{defaultValue:"Session stream"}),": ",$t]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[Kt,B.streamError?` • ${B.streamError}`:""]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[s("users.telemetry.label",{defaultValue:"Telemetry"}),":"," ",e.jsx("span",{className:"font-medium text-foreground",children:Qt})," • ",Gt]})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.limited",{defaultValue:"Limited Users"})}),e.jsx("p",{className:"text-2xl font-bold text-amber-500",children:qt})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.expiredUsers")}),e.jsx("p",{className:"text-2xl font-bold text-rose-500",children:Bt})]})]}),e.jsx(ye,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(sa,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-muted"}),e.jsx(ee,{placeholder:s("users.searchPlaceholder",{defaultValue:"Search by email or UUID..."}),value:W,onChange:t=>w(t.target.value),className:"pl-10"})]})}),e.jsxs("select",{className:"rounded-xl border border-line/80 bg-card/75 px-4 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:P,onChange:t=>Q(t.target.value),children:[e.jsx("option",{value:"",children:s("users.allStatus",{defaultValue:"All Status"})}),e.jsx("option",{value:"ACTIVE",children:s("status.active")}),e.jsx("option",{value:"LIMITED",children:s("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:s("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:s("status.expired",{defaultValue:"Expired"})})]}),e.jsxs(j,{variant:"secondary",onClick:()=>{oe.forceRefresh()},children:[e.jsx(Qs,{className:`mr-2 h-4 w-4 ${X.isFetching||B.isFetching?"animate-spin":""}`}),s("common.refresh",{defaultValue:"Refresh"})]})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsxs("details",{className:"group lg:hidden",children:[e.jsxs("summary",{className:"flex list-none items-center justify-between gap-3 rounded-xl px-2 py-2 text-left text-sm font-medium text-foreground transition hover:bg-panel/50 [&::-webkit-details-marker]:hidden",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate",children:s("common.advancedControls",{defaultValue:"Advanced controls"})}),e.jsx("p",{className:"mt-0.5 text-xs font-normal text-muted",children:it})]}),e.jsx(Be,{className:"h-5 w-5 shrink-0 text-muted transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] flex-1 rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:N,onChange:t=>ut(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(j,{size:"sm",variant:"secondary",onClick:()=>{ot()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(j,{size:"sm",variant:"ghost",onClick:dt,disabled:!N,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>o(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${Z===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(j,{size:"sm",variant:"ghost",onClick:oe.togglePaused,children:oe.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})})]})]})]}),e.jsxs("div",{className:"hidden items-center justify-between gap-3 lg:flex",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:N,onChange:t=>ut(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(j,{size:"sm",variant:"secondary",onClick:()=>{ot()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(j,{size:"sm",variant:"ghost",onClick:dt,disabled:!N,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>o(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${Z===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(j,{size:"sm",variant:"ghost",onClick:oe.togglePaused,children:oe.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})}),e.jsx("span",{className:"text-xs text-muted",children:it})]})]})]})]})}),e.jsxs(ye,{padding:!1,children:[d.length>0?e.jsx("div",{className:"border-b border-line/70 bg-panel/50 px-4 py-3 sm:px-6",children:e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"text-sm text-foreground",children:[s("users.selectedCount",{defaultValue:"{{count}} selected",count:d.length}),_e.length>0?` (${_e.map(t=>t.email).slice(0,2).join(", ")}${_e.length>2?", ...":""})`:""]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsxs("details",{className:"group relative",children:[e.jsx("summary",{className:"list-none",onClick:t=>{G&&t.preventDefault()},children:e.jsxs(j,{size:"sm",variant:"secondary",disabled:G,children:[e.jsx(Mt,{className:"mr-2 h-4 w-4"}),s("common.bulkActions",{defaultValue:"Bulk actions"}),e.jsx(Be,{className:"ml-2 h-4 w-4 text-muted transition-transform group-open:rotate-180"})]})}),e.jsxs("div",{className:"absolute right-0 z-20 mt-2 w-[min(92vw,22rem)] rounded-2xl border border-line/70 bg-panel/95 p-2 shadow-soft backdrop-blur",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-medium text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,se),disabled:G,children:s("common.clearSelection",{defaultValue:"Clear selection"})}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void Xt()),disabled:G,children:"Reset traffic"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void Zt()),disabled:G,children:"Extend expiry"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void Jt()),disabled:G,children:"Rotate keys"}),Xe?e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void es()),disabled:G,children:"Revoke access"}):null,e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void os()),disabled:G,children:"Myanmar priority reorder"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void ds()),disabled:G,children:s("users.bulkQualityAutoTune",{defaultValue:"Quality auto-tune reorder"})})]}),e.jsx("div",{className:"my-2 border-t border-line/60"}),ue.length>0?e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Groups"}),e.jsx("select",{value:q,onChange:t=>r(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:G||ne.isFetching,children:ue.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>J(t,()=>void rs()),loading:Qe.isPending,disabled:G||!q,children:"Assign"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>J(t,()=>void ns()),loading:Oe.isPending,disabled:G||!q,children:"Move"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>J(t,()=>void ls()),loading:Ge.isPending,disabled:G||!q,children:"Remove"}),e.jsx(j,{size:"sm",variant:"secondary",onClick:t=>J(t,()=>void is()),loading:Te.isPending,disabled:G||!q,children:"Apply Policy"})]})]}):e.jsx("div",{className:"px-2 pb-1 pt-2",children:e.jsx(j,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>J(t,()=>u("/groups")),disabled:ne.isFetching,children:"Create group"})}),e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Status"}),e.jsxs("select",{value:k,onChange:t=>g(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:G,children:[e.jsx("option",{value:"ACTIVE",children:"ACTIVE"}),e.jsx("option",{value:"LIMITED",children:"LIMITED"}),e.jsx("option",{value:"DISABLED",children:"DISABLED"}),e.jsx("option",{value:"EXPIRED",children:"EXPIRED"})]}),e.jsx(j,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>J(t,()=>void Yt()),loading:Ke.isPending,disabled:G,children:"Apply status"})]}),at?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10 focus:outline-none focus:ring-2 focus:ring-rose-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>J(t,()=>void _t()),disabled:G,children:"Delete selected"})]}):null]})]})})]})}):null,X.isLoading?e.jsx("div",{className:"space-y-4 p-5",children:Array.from({length:6}).map((t,a)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ke,{className:"h-4 w-4 rounded"}),e.jsx(ke,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ke,{className:"h-4 w-1/3"}),e.jsx(ke,{className:"h-3 w-1/4"})]}),e.jsx(ke,{className:"h-6 w-16 rounded-full"}),e.jsx(ke,{className:"h-4 w-24"}),e.jsx(ke,{className:"h-8 w-8 rounded-lg"})]},a))}):T.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.noUsers",{defaultValue:"No users found"})}),e.jsxs(j,{className:"mt-4",onClick:()=>H(!0),children:[e.jsx(wt,{className:"mr-2 h-4 w-4"}),s("users.addFirst")]})]}):e.jsx(ca,{users:T,viewMode:Z,onlineUuidSet:We,sessionsByUserId:ze,onQuickQr:t=>_(t),onQuickEdit:t=>be(t),onRotateKeys:t=>{ms(t)},onRevokeKeys:Xe?t=>{fs(t)}:void 0,onKillUser:t=>{Ot(t)},onDisconnectSessions:t=>{hs(t)},onRegenerateSubscription:t=>{ps(t)},onResetTraffic:t=>{xs(t)},onExtendExpiry:(t,a)=>{bs(t,a)},onDisableUser:Xe?t=>{gs(t)}:void 0,onCopySubscription:t=>{ys(t)},onUpdateLimits:(t,a)=>{ts(t,a)},onRunDiagnostics:t=>{ss(t)},selectedUserIds:d,onSelectionChange:Se,onPrefetch:t=>{yt(`/users/${t.id}`)},onView:t=>{yt(`/users/${t.id}`),u(`/users/${t.id}`)},onDelete:at?t=>{zt(t)}:void 0})]}),ge&&ge.totalPages>1?e.jsxs(ye,{className:"flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center",children:[e.jsx("div",{className:"text-sm text-muted",children:s("common.showing",{count:T.length,total:ge.total})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"secondary",size:"sm",disabled:S<=1,onClick:()=>M(t=>t-1),children:s("common.previous")}),e.jsx("span",{className:"px-3 text-sm text-foreground/85",children:s("common.page",{current:S,total:ge.totalPages})}),e.jsx(j,{variant:"secondary",size:"sm",disabled:S>=ge.totalPages,onClick:()=>M(t=>t+1),children:s("common.next")})]})]}):null,pe?e.jsx(Ws,{onClose:()=>H(!1),onSuccess:t=>{if(H(!1),D(),t!=null&&t.subscriptionToken){const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;qe(a).then(n=>{n?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreatedCopied",{defaultValue:"User created. Subscription link copied to clipboard."})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreated",{defaultValue:"User created successfully."}))}),_(t)}}}):null,je?e.jsx(ia,{onClose:()=>C(!1),onSuccess:()=>{C(!1),D()}}):null,re?e.jsx(da,{user:re,onClose:()=>_(null)}):null,xe?e.jsx(oa,{user:xe,onClose:()=>be(null),onSuccess:()=>{be(null),D()}}):null,e.jsx(bt,{open:!!F,title:"Bulk Myanmar Priority Preview",description:"Review the dry-run summary before applying reorder to selected users.",summaryRows:[{label:"Target Users",value:(F==null?void 0:F.targetUsers)??0},{label:"Would Reorder",value:(F==null?void 0:F.wouldUpdateUsers)??0},{label:"Unchanged",value:(F==null?void 0:F.unchangedUsers)??0}],previewLines:(F==null?void 0:F.previewLines)||[],confirmLabel:"Apply Bulk Priority",loading:Ae.isPending,disableConfirm:!F||F.wouldUpdateUsers===0,onClose:()=>{Ae.isPending||Ne(null)},onConfirm:()=>{us()}}),e.jsx(bt,{open:!!I,title:s("users.bulkQualityPreviewTitle",{defaultValue:"Bulk Quality Auto-tune Preview"}),description:s("users.bulkQualityPreviewBody",{defaultValue:"Reorder selected users by recent connect success, rejects, and reconnects."}),summaryRows:[{label:"Target Users",value:(I==null?void 0:I.targetUsers)??0},{label:"Would Reorder",value:(I==null?void 0:I.wouldUpdateUsers)??0},{label:"Telemetry Keys",value:(I==null?void 0:I.scoredKeys)??0}],previewLines:(I==null?void 0:I.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:Ee.isPending,disableConfirm:!I||I.wouldUpdateUsers===0,onClose:()=>{Ee.isPending||Ce(null)},onConfirm:()=>{cs()}}),e.jsx(At,{open:!!U,title:(U==null?void 0:U.title)||"Confirm",description:U==null?void 0:U.description,confirmLabel:(U==null?void 0:U.confirmLabel)||"Confirm",tone:(U==null?void 0:U.tone)||"danger",onCancel:()=>rt(!1),onConfirm:()=>rt(!0)}),e.jsx(ma,{open:!!L,title:(L==null?void 0:L.title)||"Enter value",description:L==null?void 0:L.description,label:L==null?void 0:L.label,placeholder:L==null?void 0:L.placeholder,defaultValue:L==null?void 0:L.defaultValue,inputType:L==null?void 0:L.inputType,confirmLabel:(L==null?void 0:L.confirmLabel)||"Save",onCancel:()=>nt(null),onConfirm:t=>nt(t)})]})}const Wa=pa;export{pa as Users,Wa as UsersPage};
