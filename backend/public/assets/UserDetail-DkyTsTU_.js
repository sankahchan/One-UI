const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TrafficChart-Dnau1IQu.js","assets/index-ChtKAPqG.js","assets/index-DRQwGVZd.css","assets/useQuery-mVO-xzsj.js","assets/client-BWRwYwPB.js","assets/formatters-CEEtD2TU.js","assets/useToast-BxOwwlIy.js","assets/cn-BLSKlp9E.js","assets/UserActivityTimeline-CjQzuFfP.js","assets/Button-T8YJUWY5.js","assets/Input-DlnO8F_u.js","assets/useUsers-DGhADmq7.js","assets/useMutation-2ZGjeOrH.js","assets/users-D7myuJLy.js","assets/useTranslation-CbOZUL4C.js","assets/wifi-DY9BHK-_.js","assets/activity-seodxBt0.js","assets/SubscriptionLinksPanel-DOL-dopO.js","assets/index-DbIyfRQU.js","assets/subscriptionApps-DtH1h3Op.js","assets/MyanmarPriorityPreviewModal-B-fGeijF.js","assets/index.esm-DdvCTHSY.js","assets/useGroups-j6JcvMul.js","assets/inbounds-8AlK81ie.js","assets/copy-Bg-hzpeO.js","assets/smartphone-DcK4Ovbt.js","assets/external-link-CBA7-AzB.js","assets/download-yCyE9L0-.js","assets/qr-code-BFaDNMra.js","assets/chevron-up-lbV20Fty.js","assets/chevron-down-CrJDupcf.js"])))=>i.map(i=>d[i]);
import{c as ce,h as Gs,u as Ws,r as c,j as e,R as z,_ as Te}from"./index-ChtKAPqG.js";import{apiClient as qs}from"./client-BWRwYwPB.js";import{B as De}from"./Badge-DsQ77_oe.js";import{B as g}from"./Button-T8YJUWY5.js";import{u as Js,C as j}from"./useToast-BxOwwlIy.js";import{D as ts,M as as}from"./DropdownMenu-kkNXcKEg.js";import{C as Xs}from"./ConfirmDialog-CjBCvnL2.js";import{I as Ys,P as Zs,a as et}from"./InboundClientProfileModal-C8uhDBsx.js";import{C as ls,U as st,M as ns}from"./MyanmarPriorityPreviewModal-B-fGeijF.js";import{S as _}from"./Skeleton-BZScUyMR.js";import{p as tt,q as at}from"./useGroups-j6JcvMul.js";import{n as lt,o as nt,p as rt,c as it,q as dt,r as ot,s as ct,t as ut,m as mt}from"./useUsers-DGhADmq7.js";import{u as de}from"./users-D7myuJLy.js";import{f as N,b as B}from"./formatters-CEEtD2TU.js";import{u as ft,R as oe}from"./useTranslation-CbOZUL4C.js";import{L as xt}from"./layout-dashboard-DcyPg36I.js";import{P as pt}from"./pen-square-DX8-DY1S.js";import{C as Pe}from"./copy-Bg-hzpeO.js";import{S as bt}from"./sparkles-DE7CnD1o.js";import{T as yt}from"./trash-2-Dc6eDpHg.js";import{F as ht}from"./file-code-2-CFmaDJ4_.js";import{A as gt,a as jt}from"./arrow-up-t3VZ_ZER.js";import{E as vt}from"./external-link-CBA7-AzB.js";import"./cn-BLSKlp9E.js";import"./index-DbIyfRQU.js";import"./useQuery-mVO-xzsj.js";import"./Spinner-C7voP0o8.js";import"./download-yCyE9L0-.js";import"./qr-code-BFaDNMra.js";import"./index.esm-DdvCTHSY.js";import"./Input-DlnO8F_u.js";import"./inbounds-8AlK81ie.js";import"./useMutation-2ZGjeOrH.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=ce("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=ce("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=ce("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=ce("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),wt=z.lazy(()=>Te(()=>import("./TrafficChart-Dnau1IQu.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])).then(y=>({default:y.TrafficChart}))),It=z.lazy(()=>Te(()=>import("./UserActivityTimeline-CjQzuFfP.js"),__vite__mapDeps([8,1,2,6,7,9,10,11,3,12,13,4,5,14,15,16])).then(y=>({default:y.UserActivityTimeline}))),Dt=z.lazy(()=>Te(()=>import("./SubscriptionLinksPanel-DOL-dopO.js"),__vite__mapDeps([17,1,2,3,18,4,19,9,7,6,20,21,22,23,12,13,11,10,14,24,25,26,27,28,29,30])).then(y=>({default:y.SubscriptionLinksPanel}))),Se=()=>e.jsx(j,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"h-5 w-40"}),e.jsx(_,{className:"h-4 w-full"}),e.jsx(_,{className:"h-4 w-3/4"}),e.jsx(_,{className:"h-32 w-full"})]})}),Pt=[{label:"5s",value:5e3},{label:"10s",value:1e4},{label:"30s",value:3e4},{label:"Manual",value:0}],Ae=(y,E,f,s)=>{if(E)return y("users.sessions.liveNow",{defaultValue:"Live now"});if(!f)return y("users.sessions.noActivity",{defaultValue:"No activity"});const X=new Date(f).getTime();if(Number.isNaN(X))return y("users.sessions.noActivity",{defaultValue:"No activity"});const Q=Math.max(0,s-X),A=Math.floor(Q/6e4),L=Math.floor(A/60),i=Math.floor(L/24),D=A<1?y("users.sessions.justNow",{defaultValue:"just now"}):A<60?y("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:A}):L<24?y("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:L}):y("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:i});return y("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:D})},St=()=>{var Ge,We,qe,Je,Xe,Ye,Ze,es,ss;const{id:y}=Gs(),E=Ws(),f=Js(),{t:s}=ft(),[X,Q]=c.useState(!1),[A,L]=c.useState(""),[i,D]=c.useState(null),[Me,Ce]=c.useState(null),[ue,Ee]=c.useState(null),[is,Le]=c.useState(null),[ds,Ke]=c.useState(null),[P,Ue]=c.useState(!1),[me,Y]=c.useState(!1),[fe,Z]=c.useState(!1),[K,Fe]=c.useState(null),[Re,xe]=c.useState(null),[U,os]=c.useState(()=>Date.now()),[F,cs]=c.useState(1e4),[T,pe]=c.useState("all"),[H,be]=c.useState("priority"),[ye,ee]=c.useState("asc"),[M,us]=c.useState("comfortable"),[p,he]=c.useState(null),[m,ge]=c.useState(null),V=Number.parseInt(y||"",10),{data:je,isLoading:ms,refetch:S}=lt(V),k=nt(V,60,{refetchInterval:F===0?!1:F,staleTime:5e3}),se=tt(V),te=at(V),ae=rt(),le=it(),ve=dt(),fs=ot(),xs=ct(),ps=ut(),R=mt(Number.isInteger(V)&&V>0?[V]:[],{includeOffline:!0,live:F!==0,refetchInterval:F===0?!1:F,staleTime:5e3,streamInterval:2e3});c.useEffect(()=>{const t=window.setInterval(()=>{os(Date.now())},6e4);return()=>{window.clearInterval(t)}},[]);const r=(je==null?void 0:je.data)??null,h=c.useMemo(()=>{var t;return(((t=R.data)==null?void 0:t.sessions)||[]).find(l=>l.userId===V)||null},[(Ge=R.data)==null?void 0:Ge.sessions,V]),Ne=(We=se.data)==null?void 0:We.data,o=(qe=te.data)==null?void 0:qe.data,v=Number((r==null?void 0:r.dataLimit)||0),bs=Number((r==null?void 0:r.uploadUsed)||0),ys=Number((r==null?void 0:r.downloadUsed)||0),G=Number((r==null?void 0:r.totalUsed)??bs+ys),$e=Number((r==null?void 0:r.remaining)??Math.max(0,v-G)),hs=Number((r==null?void 0:r.remainingPercent)??(v>0?$e/v*100:0)),Oe=v>0?Math.min(G/v*100,100):0,ne=Number((r==null?void 0:r.daysRemaining)??Math.ceil((new Date((r==null?void 0:r.expireDate)||U).getTime()-U)/(1e3*60*60*24))),Be=!!(r!=null&&r.startOnFirstUse)&&!(r!=null&&r.firstUsedAt),W=!!(h!=null&&h.online),gs=c.useMemo(()=>Ae(s,W,(h==null?void 0:h.lastSeenAt)??null,U),[W,U,h==null?void 0:h.lastSeenAt,s]),js=R.isFetching||R.streamStatus==="connecting",re=c.useMemo(()=>{var t,l;return((l=(t=k.data)==null?void 0:t.data)==null?void 0:l.devices)??[]},[(Xe=(Je=k.data)==null?void 0:Je.data)==null?void 0:Xe.devices]),q=c.useMemo(()=>{var l;const t=new Map;for(const a of re){const d=Number((l=a==null?void 0:a.inbound)==null?void 0:l.id);if(!Number.isInteger(d)||d<=0)continue;const n=t.get(d)||{onlineDevices:0,seenDevices:0,lastSeenAt:null},x=!!(a!=null&&a.online),u=typeof(a==null?void 0:a.lastSeenAt)=="string"?a.lastSeenAt:null,b=u?n.lastSeenAt?new Date(u).getTime()>new Date(n.lastSeenAt).getTime()?u:n.lastSeenAt:u:n.lastSeenAt;t.set(d,{onlineDevices:n.onlineDevices+(x?1:0),seenDevices:n.seenDevices+1,lastSeenAt:b})}return t},[re]),w=M==="compact"?"px-3 py-2.5":"px-4 py-3",I=M==="compact"?"px-3 py-2":"px-4 py-3",vs=M==="compact"?"p-3":"p-4",Ns=M==="compact"?"space-y-1.5":"space-y-2",Vs=M==="compact"?"mt-2.5":"mt-3",$=c.useMemo(()=>{const t=(r==null?void 0:r.inbounds)||[],l=W&&t.length===1;return t.map((a,d)=>({relation:a,index:d,label:a.inbound.remark||a.inbound.tag||s("users.detail.keyFallback",{defaultValue:"Key {{count}}",count:d+1}),protocol:a.inbound.protocol,port:Number(a.inbound.port||0),priority:Number.isInteger(Number(a.priority))?Number(a.priority):100+d,enabled:!!a.enabled,online:(()=>{var x;if(!a.enabled)return!1;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));if(Number.isInteger(n)&&n>0){const u=q.get(n);if(u&&u.onlineDevices>0)return!0}return l})(),lastSeenAt:(()=>{var x;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));if(Number.isInteger(n)&&n>0){const u=q.get(n);if(u!=null&&u.lastSeenAt)return u.lastSeenAt}return l?(h==null?void 0:h.lastSeenAt)??null:null})(),onlineDevices:(()=>{var x,u;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));return Number.isInteger(n)&&n>0?((u=q.get(n))==null?void 0:u.onlineDevices)??0:l?1:0})(),seenDevices:(()=>{var x,u;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));return Number.isInteger(n)&&n>0?((u=q.get(n))==null?void 0:u.seenDevices)??0:l?1:0})(),expirationDays:ne}))},[ne,q,W,h==null?void 0:h.lastSeenAt,s,r==null?void 0:r.inbounds]),ks=c.useMemo(()=>$.filter(t=>t.enabled).length,[$]),ws=c.useMemo(()=>$.filter(t=>t.online).length,[$]),ie=c.useMemo(()=>{const t=$.filter(a=>T==="enabled"?a.enabled:T==="disabled"?!a.enabled:T==="online"?a.online:T==="offline"?!a.online:!0),l=ye==="asc"?1:-1;return t.sort((a,d)=>{let n=0;switch(H){case"key":n=a.label.localeCompare(d.label);break;case"protocol":n=a.protocol.localeCompare(d.protocol);break;case"port":n=a.port-d.port;break;case"priority":n=a.priority-d.priority;break;case"enabled":n=Number(a.enabled)-Number(d.enabled);break;case"online":n=Number(a.online)-Number(d.online);break;case"expiration":n=a.expirationDays-d.expirationDays;break;default:n=0}return n===0&&(n=a.index-d.index),n*l}),t},[T,$,ye,H]),O=T==="all"&&H==="priority"&&ye==="asc";if(ms)return e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("div",{className:"h-12 w-12 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})});if(!r)return e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.detail.notFound",{defaultValue:"User not found"})}),e.jsx(g,{className:"mt-4",onClick:()=>E("/users"),children:s("users.detail.backToUsers",{defaultValue:"Back to Users"})})]});const Is=t=>{if(H===t){ee(l=>l==="asc"?"desc":"asc");return}be(t),ee("asc")},C=(t,l)=>{const a=H===l;return e.jsxs("button",{type:"button",className:`inline-flex items-center gap-1 rounded px-1 py-0.5 transition-colors ${a?"text-foreground":"text-muted hover:text-foreground"}`,onClick:()=>Is(l),children:[e.jsx("span",{children:t}),e.jsx(rs,{className:`h-3.5 w-3.5 ${a?"opacity-100":"opacity-40"}`})]})},Ve=t=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs ${t?"bg-emerald-500/15 text-emerald-300":"bg-zinc-500/15 text-zinc-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[t?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${t?"bg-emerald-400":"bg-zinc-400"}`})]}),e.jsx("span",{children:t?s("common.online",{defaultValue:"Online"}):s("common.offline",{defaultValue:"Offline"})})]}),Ds=(t,l)=>{const a=t>0,d=l>0?s("users.keysActive",{defaultValue:"Keys active {{online}}/{{total}}",online:t,total:l}):s("users.detail.noKeysEnabled",{defaultValue:"No keys enabled"});return e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${a?"bg-emerald-500/15 text-emerald-300":"bg-panel/60 text-muted"}`,title:d,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[a?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${a?"bg-emerald-400":"bg-zinc-400"}`})]}),e.jsx("span",{children:d})]})},_e=t=>{const l=[{key:"enabled",dotClass:"bg-sky-400",value:t.enabled?1:0,label:s("common.enabled",{defaultValue:"Enabled"})},{key:"disabled",dotClass:"bg-rose-400",value:t.enabled?0:1,label:s("common.disabled",{defaultValue:"Disabled"})},{key:"online",dotClass:"bg-emerald-400",value:t.online?1:0,label:s("common.online",{defaultValue:"Online"})}];return e.jsx("div",{className:"mt-1 flex items-center gap-2",children:l.map(a=>e.jsxs("span",{title:a.label,className:"inline-flex items-center gap-1 rounded-full border border-line/60 bg-panel/65 px-1.5 py-0.5 text-[10px] font-medium text-muted",children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${a.dotClass}`}),e.jsx("span",{children:a.value})]},`${t.relation.id}-${a.key}`))})},Ps=()=>{D({type:"reset-traffic"})},Ss=()=>{D({type:"delete-user"})},ke=async(t,l)=>{await navigator.clipboard.writeText(l),L(t),window.setTimeout(()=>L(""),1800)},As=t=>{const l=t.map(n=>({id:String(n.id||""),content:String(n.content||"").trim()})).filter(n=>!!n.content),a=l.find(n=>/^(vless|vmess|trojan|ss|socks5|http|wireguard):\/\//i.test(n.content));if(a)return a.content;const d=l.find(n=>n.id.includes("url"));return d?d.content:r.subscriptionToken?`${window.location.origin}/sub/${r.subscriptionToken}?target=v2ray`:""},Ts=async t=>{var l;if(t.inboundId){Le(t.inboundId);try{const a=await qs.get(`/inbounds/${t.inboundId}/client-templates`,{params:{userId:r.id}}),d=((l=a==null?void 0:a.data)==null?void 0:l.templates)||[],n=As(d);if(!n)throw new Error(s("users.detail.toast.noKeyUrl",{defaultValue:"No key URL available for this inbound"}));await ke(`key-${t.inboundId}`,n)}catch(a){f.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.detail.toast.copyKeyFailed",{defaultValue:"Failed to copy key"}))}finally{Le(null)}}},we=async t=>{if(t.inboundId){Ee(t.inboundId);try{await fs.mutateAsync({id:r.id,inboundId:t.inboundId,enabled:!t.enabled}),S()}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.keyStatusFailed",{defaultValue:"Failed to update key status"}))}finally{Ee(null)}}},ze=async(t,l)=>{if(!t.inboundId)return;const a=Number.isInteger(Number(t.priority))?Number(t.priority):100,d=Math.max(1,Math.min(9999,a+l));if(d!==a){Ke(t.inboundId);try{await xs.mutateAsync({id:r.id,inboundId:t.inboundId,priority:d}),S()}catch(n){f.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.detail.toast.keyPriorityFailed",{defaultValue:"Failed to update key priority"}))}finally{Ke(null)}}},Ms=()=>{const t=[{key:"reset-traffic",label:ae.isPending?s("users.detail.actions.resettingTraffic",{defaultValue:"Resetting traffic..."}):s("users.detail.actions.resetTraffic",{defaultValue:"Reset traffic"}),icon:kt,disabled:ae.isPending,onClick:()=>Ps()},{key:"delete-user",label:le.isPending?s("users.detail.actions.deletingUser",{defaultValue:"Deleting user..."}):s("users.detail.actions.deleteUser",{defaultValue:"Delete user"}),icon:yt,tone:"danger",disabled:le.isPending,onClick:()=>Ss()}];return e.jsx(ts,{items:t,ariaLabel:s("common.moreActions",{defaultValue:"More actions"}),triggerClassName:"inline-flex items-center rounded-xl border border-line/70 bg-card/75 px-3 py-2 text-foreground transition hover:bg-panel/60 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:s("common.actions",{defaultValue:"Actions"})})]})})},Qe=(t,l={})=>{const a=t.relation,d=!!l.mobile,n=Number.parseInt(String(a.inboundId||0),10),x=n>0&&is===n,u=n>0&&ue===n,b=n>0&&ds===n,Ie=[{key:"templates",label:s("users.detail.keyMenu.templates",{defaultValue:"Client templates"}),icon:ht,disabled:!a.inbound,onClick:()=>Ce(a.inbound)},{key:"copy",label:x?s("users.detail.keyMenu.copyingKey",{defaultValue:"Copying key..."}):s("users.detail.keyMenu.copyKeyUrl",{defaultValue:"Copy key URL"}),icon:Pe,disabled:n<=0||x,onClick:()=>void Ts(a)},{key:"toggle",label:u?s("users.detail.keyMenu.updating",{defaultValue:"Updating..."}):a.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),icon:a.enabled?Zs:et,disabled:n<=0||u,onClick:()=>void we(a)},{key:"move-up",label:s("users.detail.keyMenu.moveUp",{defaultValue:"Move up (higher priority)"}),icon:gt,disabled:n<=0||b||P||t.priority<=1,onClick:()=>void ze(a,-1)},{key:"move-down",label:s("users.detail.keyMenu.moveDown",{defaultValue:"Move down (lower priority)"}),icon:jt,disabled:n<=0||b||P||t.priority>=9999,onClick:()=>void ze(a,1)},{key:"open-inbounds",label:s("users.detail.keyMenu.openInbounds",{defaultValue:"Open inbounds page"}),icon:vt,onClick:()=>E("/inbounds?tab=inbounds")}];return e.jsx(ts,{items:Ie,ariaLabel:s("common.moreActions",{defaultValue:"More actions"}),triggerClassName:`rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${d?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,children:e.jsx(as,{className:"h-4 w-4"})})},Cs=async()=>{if((r.inbounds||[]).filter(l=>Number.isInteger(Number(l.inboundId))&&Number(l.inboundId)>0).length===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noKeys",{defaultValue:"No keys available for this user."}));return}Y(!0);try{const a=(await de.previewUserInboundPatternReorder(r.id,"myanmar")).data;if(!a)throw new Error(s("users.detail.toast.previewGenerateFailed",{defaultValue:"Failed to generate preview"}));if((a.matchedKeys||0)===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noMyanmarProfiles",{defaultValue:"No Myanmar-compatible profiles found (expected REALITY / VLESS WS TLS / TROJAN WS TLS)."}));return}he({totalKeys:a.totalKeys??0,matchedKeys:a.matchedKeys??0,changedKeys:a.changedKeys??0,currentTop3:a.currentTop3||[],newTop3:a.newTop3||[]})}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.myanmarPreviewFailed",{defaultValue:"Failed to preview Myanmar priority order"}))}finally{Y(!1)}},Es=async()=>{if(p){Y(!0);try{const l=(await de.reorderUserInboundsByPattern(r.id,{pattern:"myanmar"})).data;be("priority"),ee("asc"),pe("all"),he(null),S(),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.myanmarApplied",{defaultValue:"Promoted {{count}} matching key(s).",count:(l==null?void 0:l.matchedKeys)??p.matchedKeys??0}))}catch(t){f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.myanmarApplyFailed",{defaultValue:"Failed to apply Myanmar priority order"}))}finally{Y(!1)}}},Ls=async()=>{if(!r)return;if((r.inbounds||[]).filter(l=>Number.isInteger(Number(l.inboundId))&&Number(l.inboundId)>0).length===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noKeys",{defaultValue:"No keys available for this user."}));return}Z(!0);try{const a=(await de.previewUserInboundQualityReorder(r.id,{windowMinutes:60})).data;if(!a)throw new Error(s("users.detail.toast.previewGenerateFailed",{defaultValue:"Failed to generate preview"}));if((a.scoredKeys||0)===0){f.warning(s("common.warning",{defaultValue:"Warning"}),s("users.detail.toast.noTelemetry",{defaultValue:"No recent connections were detected. Generate traffic on at least one key and try again."}));return}const d=(a.preview||[]).slice(0,10).map(n=>{const x=n.score===null?"-":n.score.toFixed(0);return`P${n.toPriority} • ${n.key} • score ${x} • connect ${n.connectSuccesses} • reject ${n.limitRejects} • reconnect ${n.reconnects}`});ge({windowMinutes:a.windowMinutes??60,totalKeys:a.totalKeys??0,scoredKeys:a.scoredKeys??0,changedKeys:a.changedKeys??0,currentTop3:a.currentTop3||[],newTop3:a.newTop3||[],previewLines:d})}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.qualityPreviewFailed",{defaultValue:"Failed to generate quality preview"}))}finally{Z(!1)}},Ks=async()=>{if(!(!m||!r)){Z(!0);try{const l=(await de.reorderUserInboundsByQuality(r.id,{windowMinutes:m.windowMinutes})).data;be("priority"),ee("asc"),pe("all"),ge(null),S(),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.qualityApplied",{defaultValue:"Reordered {{count}} key(s) with telemetry.",count:(l==null?void 0:l.scoredKeys)??m.scoredKeys}))}catch(t){f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.qualityApplyFailed",{defaultValue:"Failed to apply quality ordering"}))}finally{Z(!1)}}},J=()=>{Fe(null),xe(null)},Us=t=>{!O||P||(Fe(t),xe(t))},Fs=(t,l)=>{!O||P||K===null||(t.preventDefault(),Re!==l&&xe(l))},Rs=async t=>{if(!O||P||K===null){J();return}if(K===t){J();return}const l=ie.filter(b=>Number.isInteger(Number(b.relation.inboundId))&&Number(b.relation.inboundId)>0),a=l.findIndex(b=>b.relation.inboundId===K),d=l.findIndex(b=>b.relation.inboundId===t);if(a<0||d<0){J();return}const n=[...l],[x]=n.splice(a,1);n.splice(d,0,x);const u=n.map((b,Ie)=>({inboundId:Number(b.relation.inboundId),priority:100+Ie,enabled:!!b.relation.enabled}));Ue(!0);try{await ps.mutateAsync({id:r.id,assignments:u}),S()}catch(b){f.error(s("common.error",{defaultValue:"Error"}),(b==null?void 0:b.message)||s("users.detail.toast.reorderFailed",{defaultValue:"Failed to reorder keys"}))}finally{Ue(!1),J()}},$s=t=>{D({type:"revoke-device",fingerprint:t})},He=(i==null?void 0:i.type)==="reset-traffic"?ae.isPending:(i==null?void 0:i.type)==="delete-user"?le.isPending:(i==null?void 0:i.type)==="revoke-device"?ve.isPending:!1,Os=async()=>{if(i)try{if(i.type==="reset-traffic")await ae.mutateAsync(r.id),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.trafficReset",{defaultValue:"User traffic counters were reset."})),S();else if(i.type==="delete-user"){await le.mutateAsync(r.id),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.userDeleted",{defaultValue:"User was deleted successfully."})),D(null),E("/users");return}else i.type==="revoke-device"&&(await ve.mutateAsync({id:r.id,fingerprint:i.fingerprint}),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.deviceRevoked",{defaultValue:"Device session was revoked."})),k.refetch(),R.refetch());D(null)}catch(t){i.type==="reset-traffic"?f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.resetFailed",{defaultValue:"Failed to reset traffic"})):i.type==="delete-user"?f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.deleteFailed",{defaultValue:"Failed to delete user"})):f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.revokeFailed",{defaultValue:"Failed to revoke device session"}))}},Bs=(i==null?void 0:i.type)==="reset-traffic"?s("users.actions.resetTrafficTitle",{defaultValue:"Reset traffic?"}):(i==null?void 0:i.type)==="delete-user"?s("users.detail.confirm.deleteTitle",{defaultValue:"Delete user?"}):(i==null?void 0:i.type)==="revoke-device"?s("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}):"",_s=(i==null?void 0:i.type)==="reset-traffic"?s("users.actions.resetTrafficDescription",{defaultValue:"Reset this user's upload/download counters."}):(i==null?void 0:i.type)==="delete-user"?s("users.detail.confirm.deleteDescription",{defaultValue:"Are you sure you want to delete this user? This action cannot be undone."}):(i==null?void 0:i.type)==="revoke-device"?s("users.devices.revokeDescription",{defaultValue:"Revoke this device? It will need to reconnect."}):"",zs=(i==null?void 0:i.type)==="delete-user"?s("common.delete",{defaultValue:"Delete"}):(i==null?void 0:i.type)==="reset-traffic"?s("common.reset",{defaultValue:"Reset"}):s("common.revoke",{defaultValue:"Revoke"}),Qs=(i==null?void 0:i.type)==="delete-user"?"danger":"primary",Hs=()=>{const t={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"};return e.jsx(De,{variant:t[r.status],children:r.status})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx(g,{variant:"ghost",onClick:()=>E("/users"),children:e.jsx(Nt,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground sm:text-3xl",children:r.email}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.subtitle",{defaultValue:"User details & access keys"})}),e.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:Ds(ws,ks)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:gap-3",children:[e.jsxs(g,{variant:"secondary",onClick:()=>{const t="/8ba880e2".replace(/\/+$/,"")||"";window.open(`${t}/user/${r.subscriptionToken}`,"_blank")},children:[e.jsx(xt,{className:"mr-2 h-4 w-4"}),s("users.detail.openDashboard",{defaultValue:"User Dashboard"})]}),e.jsxs(g,{variant:"secondary",onClick:()=>Q(!0),children:[e.jsx(pt,{className:"mr-2 h-4 w-4"}),s("common.edit",{defaultValue:"Edit"})]}),Ms()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-5",children:[e.jsxs(j,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.status",{defaultValue:"Status"})}),e.jsx("div",{className:"mt-2",children:Hs()})]}),e.jsxs(j,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsx("div",{className:"mt-2",children:Ve(W)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:gs})]}),e.jsxs(j,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.dataUsed",{defaultValue:"Data Used"})}),e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:N(G)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.dataLimitCaption",{defaultValue:"Limit: {{limit}}",limit:N(v)})})]}),e.jsxs(j,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.detail.remaining",{defaultValue:"Remaining"})}),e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:N($e)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.remainingPercentLeft",{defaultValue:"{{percent}}% left",percent:hs.toFixed(1)})})]}),e.jsxs(j,{children:[e.jsx("p",{className:"text-sm text-muted",children:Be?s("common.expiry",{defaultValue:"Expiry"}):s("users.detail.expiresIn",{defaultValue:"Expires in"})}),Be?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mt-2 text-base font-semibold text-foreground",children:s("users.startOnFirstConnect",{defaultValue:"Starts on first connect"})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.expiry.afterFirstConnect",{defaultValue:"{{days}} days after first connect",days:ne})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:s("users.detail.expiry.daysValue",{defaultValue:"{{count}} days",count:ne})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:B(r.expireDate)})]})]})]}),e.jsxs(j,{children:[e.jsx("h2",{className:"mb-4 text-xl font-bold text-foreground",children:s("users.detail.userInfoTitle",{defaultValue:"User Information"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.email",{defaultValue:"Email"})}),e.jsx("p",{className:"mt-1 font-medium text-foreground",children:r.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.uuid",{defaultValue:"UUID"})}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("code",{className:"rounded-lg border border-line/70 bg-panel/70 px-2 py-1 font-mono text-sm text-foreground",children:r.uuid}),e.jsx("button",{onClick:()=>{ke("uuid",r.uuid)},className:"rounded p-1 transition-colors hover:bg-card","aria-label":s("users.detail.copyUuid",{defaultValue:"Copy UUID"}),children:A==="uuid"?e.jsx(ls,{className:"h-4 w-4 text-emerald-500"}):e.jsx(Pe,{className:"h-4 w-4 text-muted"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("auth.password",{defaultValue:"Password"})}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("code",{className:"rounded-lg border border-line/70 bg-panel/70 px-2 py-1 font-mono text-sm text-foreground",children:r.password}),e.jsx("button",{onClick:()=>{ke("password",r.password)},className:"rounded p-1 transition-colors hover:bg-card","aria-label":s("users.detail.copyPassword",{defaultValue:"Copy password"}),children:A==="password"?e.jsx(ls,{className:"h-4 w-4 text-emerald-500"}):e.jsx(Pe,{className:"h-4 w-4 text-muted"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.detail.createdAt",{defaultValue:"Created at"})}),e.jsx("p",{className:"mt-1 text-foreground",children:B(r.createdAt)})]}),r.note?e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.note",{defaultValue:"Note"})}),e.jsx("p",{className:"mt-1 text-foreground",children:r.note})]}):null]})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.effectiveInbounds.title",{defaultValue:"Effective inbound access"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.effectiveInbounds.subtitle",{defaultValue:"Combined view of direct assignments and inherited group mappings."})})]}),e.jsxs(g,{size:"sm",variant:"secondary",loading:se.isFetching,onClick:()=>{se.refetch()},children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]})]}),se.isLoading?e.jsx("div",{className:"py-4 text-sm text-muted",children:s("users.detail.effectiveInbounds.loading",{defaultValue:"Loading effective access..."})}):!Ne||Ne.effectiveInbounds.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4 text-sm text-muted",children:s("users.detail.effectiveInbounds.empty",{defaultValue:"No effective inbounds found for this user."})}):e.jsx("div",{className:"space-y-3",children:Ne.effectiveInbounds.map(t=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-foreground",children:[t.inbound.protocol," • ",t.inbound.port]}),e.jsx("p",{className:"text-sm text-muted",children:t.inbound.remark||t.inbound.tag})]}),e.jsx(De,{variant:t.inbound.enabled?"success":"warning",children:t.inbound.enabled?s("users.detail.effectiveInbounds.badgeEnabled",{defaultValue:"Inbound enabled"}):s("users.detail.effectiveInbounds.badgeDisabled",{defaultValue:"Inbound disabled"})})]}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:t.sources.map((l,a)=>e.jsx("span",{className:`inline-flex rounded-full px-2.5 py-1 text-xs font-medium ${l.type==="DIRECT"?"bg-brand-500/20 text-brand-200":"bg-violet-500/20 text-violet-200"}`,children:l.type==="DIRECT"?s("users.detail.effectiveInbounds.sourceDirect",{defaultValue:"Direct"}):s("users.detail.effectiveInbounds.sourceGroup",{defaultValue:"Group: {{name}}",name:l.groupName||String(l.groupId)})},`effective-source-${t.inboundId}-${a}`))})]},`effective-inbound-${t.inboundId}`))})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.policy.title",{defaultValue:"Effective policy"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.policy.subtitle",{defaultValue:"Compare direct user policy with inherited group policy overrides."})})]}),e.jsxs(g,{size:"sm",variant:"secondary",loading:te.isFetching,onClick:()=>{te.refetch()},children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]})]}),te.isLoading?e.jsx("div",{className:"py-4 text-sm text-muted",children:s("users.detail.policy.loading",{defaultValue:"Loading effective policy..."})}):o?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto rounded-xl border border-line/70 bg-panel/55",children:e.jsxs("table",{className:"min-w-[760px] w-full text-sm",children:[e.jsx("thead",{className:"bg-panel/80 text-xs uppercase tracking-wide text-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.field",{defaultValue:"Field"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.direct",{defaultValue:"Direct"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.inherited",{defaultValue:"Inherited"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.effective",{defaultValue:"Effective"})})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.dataLimit",{defaultValue:"Data Limit"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:N(Number(o.directPolicy.dataLimit||0))}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.dataLimit!==null?N(Number(o.inheritedPolicy.dataLimit||0)):s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[N(Number(o.effectivePolicy.dataLimit||0)),o.drift.dataLimit?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("common.expiry",{defaultValue:"Expiry"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:B(o.directPolicy.expireDate)}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.expireDate?B(o.inheritedPolicy.expireDate):s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[B(o.effectivePolicy.expireDate),o.drift.expireDate?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.form.ipLimitLabel",{defaultValue:"IP Limit"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.directPolicy.ipLimit}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.ipLimit??s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.ipLimit,o.drift.ipLimit?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("common.status",{defaultValue:"Status"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.directPolicy.status}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.status||s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.status,o.drift.status?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.detail.policy.table.trafficReset",{defaultValue:"Traffic reset"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.directPolicy.trafficResetPeriod,o.directPolicy.trafficResetDay?` @${o.directPolicy.trafficResetDay}`:""]}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.trafficResetPeriod?`${o.inheritedPolicy.trafficResetPeriod}${o.inheritedPolicy.trafficResetDay?` @${o.inheritedPolicy.trafficResetDay}`:""}`:s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.trafficResetPeriod,o.effectivePolicy.trafficResetDay?` @${o.effectivePolicy.trafficResetDay}`:""]})]})]})]})}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-xs font-semibold uppercase tracking-[0.08em] text-muted",children:s("users.detail.policy.groupSources",{defaultValue:"Group policy sources"})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.groups.length===0?e.jsx("span",{className:"text-sm text-muted",children:s("users.detail.policy.noGroups",{defaultValue:"No active groups assigned"})}):o.groups.map(t=>e.jsx("span",{className:"rounded-full border border-line/70 bg-card/70 px-3 py-1 text-xs text-foreground",children:t.name},`policy-group-${t.id}`))})]})]}):e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4 text-sm text-muted",children:s("users.detail.policy.unavailable",{defaultValue:"Effective policy is unavailable for this user."})})]}),e.jsxs(j,{className:"p-0",children:[e.jsxs("div",{className:"border-b border-line/70 px-5 py-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.keys.title",{defaultValue:"Access keys"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.keys.subtitle",{defaultValue:"Manage per-inbound keys, status, online visibility, and client templates."})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{value:T,onChange:t=>pe(t.target.value),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:[e.jsx("option",{value:"all",children:s("users.detail.keys.filter.all",{defaultValue:"All keys"})}),e.jsx("option",{value:"enabled",children:s("common.enabled",{defaultValue:"Enabled"})}),e.jsx("option",{value:"disabled",children:s("common.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"online",children:s("common.online",{defaultValue:"Online"})}),e.jsx("option",{value:"offline",children:s("common.offline",{defaultValue:"Offline"})})]}),e.jsx("select",{value:String(F),onChange:t=>cs(Number(t.target.value)),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:Pt.map(t=>e.jsxs("option",{value:t.value,children:[s("common.refresh",{defaultValue:"Refresh"})," ",t.label]},t.value))}),e.jsxs("select",{value:M,onChange:t=>us(t.target.value),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:[e.jsx("option",{value:"comfortable",children:s("users.detail.keys.density.comfortable",{defaultValue:"Comfortable rows"})}),e.jsx("option",{value:"compact",children:s("users.detail.keys.density.compact",{defaultValue:"Compact rows"})})]}),e.jsxs(g,{size:"sm",variant:"secondary",loading:js,onClick:()=>{R.refetch(),k.refetch(),S()},children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]}),e.jsxs(g,{size:"sm",variant:"secondary",loading:me,disabled:P||(r.inbounds||[]).length===0,onClick:()=>{Cs()},children:[e.jsx(rs,{className:"mr-2 h-4 w-4"}),s("users.myanmarPriority",{defaultValue:"Myanmar Priority"})]}),e.jsxs(g,{size:"sm",variant:"secondary",loading:fe,disabled:P||(r.inbounds||[]).length===0,onClick:()=>{Ls()},children:[e.jsx(bt,{className:"mr-2 h-4 w-4"}),s("users.autoTune",{defaultValue:"Auto-tune"})]})]})]}),e.jsx("p",{className:"mt-2 text-xs text-muted",children:O?s("users.detail.keys.dragHintEnabled",{defaultValue:"Drag rows from the Menu column to reorder key priority. The order controls subscription fallback."}):s("users.detail.keys.dragHintDisabled",{defaultValue:"Enable drag reorder by setting Filter: All keys and Sort: Priority ascending."})})]}),ie.length===0?e.jsx("div",{className:"px-5 py-8 text-sm text-muted",children:s("users.detail.keys.empty",{defaultValue:"No keys match the selected filter."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden overflow-x-auto lg:block",children:e.jsxs("table",{className:`min-w-[1100px] w-full ${M==="compact"?"text-xs":"text-sm"}`,children:[e.jsx("thead",{className:"bg-panel/65",children:e.jsxs("tr",{className:"border-b border-line/70 text-left text-xs uppercase tracking-wide text-muted",children:[e.jsx("th",{className:w,children:s("users.detail.keys.table.menu",{defaultValue:"Menu"})}),e.jsx("th",{className:w,children:C(s("common.enabled",{defaultValue:"Enabled"}),"enabled")}),e.jsx("th",{className:w,children:C(s("common.online",{defaultValue:"Online"}),"online")}),e.jsx("th",{className:w,children:C(s("users.detail.keys.table.clientKey",{defaultValue:"Client / Key"}),"key")}),e.jsx("th",{className:w,children:C(s("users.detail.keys.table.protocol",{defaultValue:"Protocol"}),"protocol")}),e.jsx("th",{className:w,children:C(s("users.detail.keys.table.port",{defaultValue:"Port"}),"port")}),e.jsx("th",{className:w,children:C(s("users.detail.keys.table.priority",{defaultValue:"Priority"}),"priority")}),e.jsx("th",{className:w,children:s("users.detail.keys.table.traffic",{defaultValue:"Traffic"})}),e.jsx("th",{className:w,children:C(s("users.detail.keys.table.expiration",{defaultValue:"Expiration"}),"expiration")})]})}),e.jsx("tbody",{children:ie.map(t=>{const l=t.relation,a=Number.parseInt(String(l.inboundId||0),10),d=Ae(s,t.online,t.lastSeenAt,U),n=O&&a>0&&!P,x=K===a,u=Re===a&&K!==a;return e.jsxs("tr",{className:`border-b border-line/70 transition-colors hover:bg-panel/35 ${x?"bg-brand-500/10":""} ${u?"ring-1 ring-inset ring-brand-500/50":""}`,draggable:n,onDragStart:()=>{Us(a)},onDragOver:b=>{Fs(b,a)},onDrop:()=>{Rs(a)},onDragEnd:J,children:[e.jsx("td",{className:I,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex items-center rounded p-1 ${n?"cursor-grab text-muted hover:bg-panel/70 hover:text-foreground":"text-muted/40"}`,title:O?s("users.detail.keys.dragHandleEnabled",{defaultValue:"Drag to reorder priority"}):s("users.detail.keys.dragHandleDisabled",{defaultValue:"Sort by priority ascending to enable drag reorder"}),children:e.jsx(Vt,{className:"h-4 w-4"})}),Qe(t)]})}),e.jsx("td",{className:I,children:e.jsx("button",{type:"button",role:"switch","aria-checked":l.enabled,"aria-label":l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),title:l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),disabled:ue===l.inboundId,onClick:()=>{we(l)},className:`relative inline-flex h-6 w-11 items-center rounded-full border border-line/70 transition focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${l.enabled?"bg-emerald-500/25":"bg-panel/70"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full border border-line/70 bg-white shadow-sm transition ${l.enabled?"translate-x-5":"translate-x-1"}`})})}),e.jsxs("td",{className:I,children:[Ve(t.online),e.jsx("p",{className:"mt-1 text-[11px] text-muted",children:d}),t.seenDevices>0?e.jsx("p",{className:"mt-0.5 text-[11px] text-muted",children:s("users.detail.keys.devicesCount",{defaultValue:"Devices {{online}}/{{seen}}",online:t.onlineDevices,seen:t.seenDevices})}):null]}),e.jsx("td",{className:I,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-foreground",children:r.email}),e.jsx("span",{className:"text-xs text-muted",children:t.label}),_e(t)]})}),e.jsx("td",{className:I,children:e.jsx(De,{variant:"info",children:t.protocol})}),e.jsx("td",{className:I,children:e.jsx("span",{className:"font-semibold text-foreground",children:t.port})}),e.jsx("td",{className:I,children:e.jsx("span",{className:"inline-flex items-center rounded-full border border-line/70 bg-card/70 px-3 py-1 text-xs font-semibold text-foreground",children:t.priority})}),e.jsx("td",{className:I,children:e.jsxs("div",{className:"w-48",children:[e.jsxs("p",{className:"text-xs text-muted",children:[N(G)," / ",v>0?N(v):"∞"]}),e.jsx("div",{className:"mt-1 h-2 rounded-full bg-panel/80",children:e.jsx("div",{className:"h-2 rounded-full bg-gradient-to-r from-brand-500 to-brand-600",style:{width:`${Oe}%`}})})]})}),e.jsx("td",{className:I,children:e.jsx("span",{className:`inline-flex rounded-full px-2 py-0.5 text-xs ${t.expirationDays<=0?"bg-red-500/20 text-red-300":t.expirationDays<=7?"bg-amber-500/20 text-amber-300":"bg-brand-500/20 text-brand-200"}`,children:t.expirationDays<=0?s("common.expired",{defaultValue:"Expired"}):s("users.detail.keys.shortDays",{defaultValue:"{{count}}d",count:t.expirationDays})})})]},l.id)})})]})}),e.jsx("div",{className:"grid grid-cols-1 gap-3 p-4 lg:hidden",children:ie.map(t=>{const l=t.relation,a=Ae(s,t.online,t.lastSeenAt,U);return e.jsxs("div",{className:`rounded-xl border border-line/70 bg-card/70 ${vs}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:t.label}),e.jsxs("p",{className:"text-xs text-muted",children:[t.protocol," · ",s("users.detail.keys.portLabelShort",{defaultValue:"Port"})," ",t.port]}),_e(t)]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-right",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[Ve(t.online),Qe(t,{mobile:!0})]}),e.jsx("p",{className:"text-[11px] text-muted",children:a}),t.seenDevices>0?e.jsx("p",{className:"text-[11px] text-muted",children:s("users.detail.keys.devicesCount",{defaultValue:"Devices {{online}}/{{seen}}",online:t.onlineDevices,seen:t.seenDevices})}):null]})]}),e.jsxs("div",{className:`mt-3 ${Ns}`,children:[e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.table.priority",{defaultValue:"Priority"}),":"," ",e.jsx("span",{className:"inline-flex items-center rounded-full border border-line/70 bg-card/70 px-2 py-0.5 text-[11px] font-semibold text-foreground",children:t.priority})]}),e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.usageLabel",{defaultValue:"Usage"}),":"," ",N(G)," / ",v>0?N(v):"∞"]}),e.jsx("div",{className:"h-2 rounded-full bg-panel/80",children:e.jsx("div",{className:"h-2 rounded-full bg-gradient-to-r from-brand-500 to-brand-600",style:{width:`${Oe}%`}})}),e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.table.expiration",{defaultValue:"Expiration"}),":"," ",t.expirationDays<=0?s("common.expired",{defaultValue:"Expired"}):s("common.daysLeft",{defaultValue:"{{count}} days left",count:t.expirationDays})]})]}),e.jsxs("div",{className:`${Vs} flex items-center justify-between rounded-xl border border-line/70 bg-panel/40 px-3 py-2`,children:[e.jsx("span",{className:"text-xs font-medium text-foreground",children:s("common.enabled",{defaultValue:"Enabled"})}),e.jsx("button",{type:"button",role:"switch","aria-checked":l.enabled,"aria-label":l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),title:l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),disabled:ue===l.inboundId,onClick:()=>{we(l)},className:`relative inline-flex h-6 w-11 items-center rounded-full border border-line/70 transition focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${l.enabled?"bg-emerald-500/25":"bg-card/70"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full border border-line/70 bg-white shadow-sm transition ${l.enabled?"translate-x-5":"translate-x-1"}`})})]})]},`mobile-${l.id}`)})})]})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.devicesSessions.title",{defaultValue:"Device sessions"})}),e.jsx("p",{className:"text-xs text-muted",children:s("users.detail.devicesSessions.subtitle",{defaultValue:"{{online}} online / {{total}} seen in last {{minutes}} minutes",online:((Ze=(Ye=k.data)==null?void 0:Ye.data)==null?void 0:Ze.online)||0,total:((ss=(es=k.data)==null?void 0:es.data)==null?void 0:ss.total)||0,minutes:60})})]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{k.refetch()},loading:k.isFetching,children:e.jsx(oe,{className:"h-4 w-4"})})]}),k.isLoading?e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"h-10 w-full"}),e.jsx(_,{className:"h-10 w-full"})]}):re.length===0?e.jsx("p",{className:"text-sm text-muted",children:s("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-xs uppercase tracking-wide text-muted",children:e.jsxs("tr",{className:"border-b border-line/70",children:[e.jsx("th",{className:"py-2 pr-3",children:s("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.fingerprint",{defaultValue:"Fingerprint"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.ip",{defaultValue:"IP"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.lastSeen",{defaultValue:"Last seen"})}),e.jsx("th",{className:"py-2 text-right",children:s("common.action",{defaultValue:"Action"})})]})}),e.jsx("tbody",{children:re.slice(0,12).map(t=>e.jsxs("tr",{className:"border-b border-line/50",children:[e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2 py-0.5 text-xs ${t.online?"bg-emerald-500/15 text-emerald-300":"bg-zinc-500/15 text-zinc-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[t.online?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${t.online?"bg-emerald-400":"bg-zinc-400"}`})]}),t.online?s("common.online",{defaultValue:"Online"}):s("common.offline",{defaultValue:"Offline"})]})}),e.jsx("td",{className:"py-2 pr-3 font-mono text-xs text-muted",children:t.shortFingerprint}),e.jsx("td",{className:"py-2 pr-3 text-muted",children:t.clientIp||"-"}),e.jsx("td",{className:"py-2 pr-3 text-muted",children:B(t.lastSeenAt)}),e.jsx("td",{className:"py-2 text-right",children:e.jsx(g,{size:"sm",variant:"ghost",onClick:()=>{$s(t.fingerprint)},loading:ve.isPending,children:s("common.revoke",{defaultValue:"Revoke"})})})]},t.fingerprint))})]})})]}),e.jsx(z.Suspense,{fallback:e.jsx(Se,{}),children:e.jsx(wt,{userId:r.id})}),e.jsx(z.Suspense,{fallback:e.jsx(Se,{}),children:e.jsx(It,{userId:r.id})}),e.jsx(z.Suspense,{fallback:e.jsx(Se,{}),children:e.jsx(Dt,{userId:r.id})}),X?e.jsx(st,{user:r,onClose:()=>Q(!1),onSuccess:()=>{Q(!1),S()}}):null,Me?e.jsx(Ys,{inbound:Me,initialUserId:r.id,onClose:()=>Ce(null)}):null,e.jsx(Xs,{open:!!i,title:Bs,description:_s,confirmLabel:zs,cancelLabel:s("common.cancel",{defaultValue:"Cancel"}),tone:Qs,loading:He,onCancel:()=>{He||D(null)},onConfirm:()=>{Os()}}),e.jsx(ns,{open:!!p,title:s("users.myanmarPriorityPreviewTitle",{defaultValue:"Myanmar Priority Preview"}),description:s("users.myanmarPriorityPreviewBody",{defaultValue:"Review current and new fallback order before applying."}),summaryRows:[{label:s("users.preview.totalKeys",{defaultValue:"Total keys"}),value:(p==null?void 0:p.totalKeys)??0},{label:s("users.preview.matchedKeys",{defaultValue:"Matched keys"}),value:(p==null?void 0:p.matchedKeys)??0},{label:s("users.preview.keysToReorder",{defaultValue:"Keys to reorder"}),value:(p==null?void 0:p.changedKeys)??0}],currentTop3:(p==null?void 0:p.currentTop3)||[],newTop3:(p==null?void 0:p.newTop3)||[],confirmLabel:s("users.applyPriority",{defaultValue:"Apply Priority"}),loading:me,disableConfirm:!p||p.changedKeys===0,onClose:()=>{me||he(null)},onConfirm:()=>{Es()}}),e.jsx(ns,{open:!!m,title:s("users.qualityAutoTunePreviewTitle",{defaultValue:"Quality Auto-tune Preview"}),description:s("users.qualityAutoTunePreviewBody",{defaultValue:"Reorder keys based on recent connect success, rejects, and reconnects."}),summaryRows:[{label:s("users.preview.totalKeys",{defaultValue:"Total keys"}),value:(m==null?void 0:m.totalKeys)??0},{label:s("users.preview.telemetryKeys",{defaultValue:"Telemetry keys"}),value:(m==null?void 0:m.scoredKeys)??0},{label:s("users.preview.keysToReorder",{defaultValue:"Keys to reorder"}),value:(m==null?void 0:m.changedKeys)??0}],currentTop3:((m==null?void 0:m.currentTop3)||[]).map(t=>({key:t.key,toPriority:t.fromPriority})),newTop3:((m==null?void 0:m.newTop3)||[]).map(t=>({key:t.key,toPriority:t.toPriority})),previewLines:(m==null?void 0:m.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:fe,disableConfirm:!m||m.changedKeys===0,onClose:()=>{fe||ge(null)},onConfirm:()=>{Ks()}})]})},oa=St;export{St as UserDetail,oa as UserDetailPage};
