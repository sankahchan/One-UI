const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TrafficChart-DTzAvmOc.js","assets/index-ypj_4hQQ.js","assets/index-CrFD7or9.css","assets/useQuery-CrpZYdr1.js","assets/client-DZBKUZYs.js","assets/formatters-CEEtD2TU.js","assets/useToast-DzXNWj1a.js","assets/cn-BLSKlp9E.js","assets/UserActivityTimeline-NQbasR_3.js","assets/Button-CkiGx0aE.js","assets/Input-ConZjJPP.js","assets/useUsers-hAWBrssX.js","assets/useMutation-aFhPvO3K.js","assets/users-Bcq3n9Ku.js","assets/useTranslation-Z2v1dAK4.js","assets/wifi-vXn1a77V.js","assets/activity-CypHx8FZ.js","assets/SubscriptionLinksPanel-C0PFKdg9.js","assets/index-DsE4WUd3.js","assets/subscriptionApps-DtH1h3Op.js","assets/MyanmarPriorityPreviewModal-B2XtM-Vq.js","assets/index.esm-_pe0Q6up.js","assets/useGroups-BoMyyBJY.js","assets/inbounds-DgeWEcQ1.js","assets/copy-DWHnKXpQ.js","assets/smartphone-BXgonLBv.js","assets/external-link-CPTWrx_T.js","assets/download-OAarbMeU.js","assets/qr-code-CVMz2PO2.js","assets/chevron-up-CyERGkmt.js","assets/chevron-down-B79rH5Dx.js"])))=>i.map(i=>d[i]);
import{c as ue,h as Xs,u as Ys,r as c,j as e,R as Q,_ as Me}from"./index-ypj_4hQQ.js";import{apiClient as Zs}from"./client-DZBKUZYs.js";import{B as Pe}from"./Badge-DPaWFYN-.js";import{B as v}from"./Button-CkiGx0aE.js";import{u as et,C as g}from"./useToast-DzXNWj1a.js";import{C as st}from"./ConfirmDialog-Dz1Z9-vA.js";import{I as tt,P as at,a as lt}from"./InboundClientProfileModal-CXAgPHm5.js";import{C as ns,U as nt,M as rs}from"./MyanmarPriorityPreviewModal-B2XtM-Vq.js";import{S as _}from"./Skeleton-CKYJx_Kj.js";import{p as rt,q as it}from"./useGroups-BoMyyBJY.js";import{n as dt,o as ot,p as ct,c as ut,q as mt,r as ft,s as xt,t as pt,m as bt}from"./useUsers-hAWBrssX.js";import{u as oe}from"./users-Bcq3n9Ku.js";import{f as N,b as z}from"./formatters-CEEtD2TU.js";import{u as yt,R as ce}from"./useTranslation-Z2v1dAK4.js";import{P as ht}from"./pen-square-CB0IYL2P.js";import{C as Se}from"./copy-DWHnKXpQ.js";import{S as gt}from"./sparkles-BLCQef2z.js";import{T as jt}from"./trash-2-zr-0-aP_.js";import{M as is}from"./more-vertical-sqkUXgRJ.js";import{F as vt}from"./file-code-2-DLigbjmx.js";import{A as Nt,a as Vt}from"./arrow-up-0ynxtF6g.js";import{E as kt}from"./external-link-CPTWrx_T.js";import"./cn-BLSKlp9E.js";import"./index-DsE4WUd3.js";import"./useQuery-CrpZYdr1.js";import"./Spinner-Bm50HMVp.js";import"./download-OAarbMeU.js";import"./qr-code-CVMz2PO2.js";import"./index.esm-_pe0Q6up.js";import"./Input-ConZjJPP.js";import"./inbounds-DgeWEcQ1.js";import"./useMutation-aFhPvO3K.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=ue("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=ue("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=ue("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=ue("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),Pt=Q.lazy(()=>Me(()=>import("./TrafficChart-DTzAvmOc.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])).then(y=>({default:y.TrafficChart}))),St=Q.lazy(()=>Me(()=>import("./UserActivityTimeline-NQbasR_3.js"),__vite__mapDeps([8,1,2,6,7,9,10,11,3,12,13,4,5,14,15,16])).then(y=>({default:y.UserActivityTimeline}))),At=Q.lazy(()=>Me(()=>import("./SubscriptionLinksPanel-C0PFKdg9.js"),__vite__mapDeps([17,1,2,3,18,4,19,9,7,6,20,21,22,23,12,13,11,10,14,24,25,26,27,28,29,30])).then(y=>({default:y.SubscriptionLinksPanel}))),Ae=()=>e.jsx(g,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"h-5 w-40"}),e.jsx(_,{className:"h-4 w-full"}),e.jsx(_,{className:"h-4 w-3/4"}),e.jsx(_,{className:"h-32 w-full"})]})}),Tt=[{label:"5s",value:5e3},{label:"10s",value:1e4},{label:"30s",value:3e4},{label:"Manual",value:0}],Te=(y,K,f,s)=>{if(K)return y("users.sessions.liveNow",{defaultValue:"Live now"});if(!f)return y("users.sessions.noActivity",{defaultValue:"No activity"});const Y=new Date(f).getTime();if(Number.isNaN(Y))return y("users.sessions.noActivity",{defaultValue:"No activity"});const H=Math.max(0,s-Y),T=Math.floor(H/6e4),L=Math.floor(T/60),i=Math.floor(L/24),P=T<1?y("users.sessions.justNow",{defaultValue:"just now"}):T<60?y("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:T}):L<24?y("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:L}):y("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:i});return y("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:P})},Mt=()=>{var qe,Je,Xe,Ye,Ze,es,ss,ts,as;const{id:y}=Xs(),K=Ys(),f=et(),{t:s}=yt(),[Y,H]=c.useState(!1),[T,L]=c.useState(""),[i,P]=c.useState(null),[Ce,Ee]=c.useState(null),[me,Ke]=c.useState(null),[os,Le]=c.useState(null),[cs,Ue]=c.useState(null),[S,Fe]=c.useState(!1),[fe,Z]=c.useState(!1),[xe,ee]=c.useState(!1),[U,Re]=c.useState(null),[$e,pe]=c.useState(null),[F,us]=c.useState(()=>Date.now()),[R,ms]=c.useState(1e4),[M,be]=c.useState("all"),[G,ye]=c.useState("priority"),[he,se]=c.useState("asc"),[C,fs]=c.useState("comfortable"),[p,ge]=c.useState(null),[m,je]=c.useState(null),V=Number.parseInt(y||"",10),{data:ve,isLoading:xs,refetch:A}=dt(V),k=ot(V,60,{refetchInterval:R===0?!1:R,staleTime:5e3}),te=rt(V),ae=it(V),le=ct(),ne=ut(),Ne=mt(),ps=ft(),bs=xt(),ys=pt(),$=bt(Number.isInteger(V)&&V>0?[V]:[],{includeOffline:!0,live:R!==0,refetchInterval:R===0?!1:R,staleTime:5e3,streamInterval:2e3});c.useEffect(()=>{const t=window.setInterval(()=>{us(Date.now())},6e4);return()=>{window.clearInterval(t)}},[]);const r=(ve==null?void 0:ve.data)??null,h=c.useMemo(()=>{var t;return(((t=$.data)==null?void 0:t.sessions)||[]).find(l=>l.userId===V)||null},[(qe=$.data)==null?void 0:qe.sessions,V]),Ve=(Je=te.data)==null?void 0:Je.data,o=(Xe=ae.data)==null?void 0:Xe.data,j=Number((r==null?void 0:r.dataLimit)||0),hs=Number((r==null?void 0:r.uploadUsed)||0),gs=Number((r==null?void 0:r.downloadUsed)||0),W=Number((r==null?void 0:r.totalUsed)??hs+gs),Oe=Number((r==null?void 0:r.remaining)??Math.max(0,j-W)),js=Number((r==null?void 0:r.remainingPercent)??(j>0?Oe/j*100:0)),Be=j>0?Math.min(W/j*100,100):0,re=Number((r==null?void 0:r.daysRemaining)??Math.ceil((new Date((r==null?void 0:r.expireDate)||F).getTime()-F)/(1e3*60*60*24))),ze=!!(r!=null&&r.startOnFirstUse)&&!(r!=null&&r.firstUsedAt),q=!!(h!=null&&h.online),vs=c.useMemo(()=>Te(s,q,(h==null?void 0:h.lastSeenAt)??null,F),[q,F,h==null?void 0:h.lastSeenAt,s]),Ns=$.isFetching||$.streamStatus==="connecting",ie=c.useMemo(()=>{var t,l;return((l=(t=k.data)==null?void 0:t.data)==null?void 0:l.devices)??[]},[(Ze=(Ye=k.data)==null?void 0:Ye.data)==null?void 0:Ze.devices]),J=c.useMemo(()=>{var l;const t=new Map;for(const a of ie){const d=Number((l=a==null?void 0:a.inbound)==null?void 0:l.id);if(!Number.isInteger(d)||d<=0)continue;const n=t.get(d)||{onlineDevices:0,seenDevices:0,lastSeenAt:null},x=!!(a!=null&&a.online),u=typeof(a==null?void 0:a.lastSeenAt)=="string"?a.lastSeenAt:null,b=u?n.lastSeenAt?new Date(u).getTime()>new Date(n.lastSeenAt).getTime()?u:n.lastSeenAt:u:n.lastSeenAt;t.set(d,{onlineDevices:n.onlineDevices+(x?1:0),seenDevices:n.seenDevices+1,lastSeenAt:b})}return t},[ie]),w=C==="compact"?"px-3 py-2.5":"px-4 py-3",I=C==="compact"?"px-3 py-2":"px-4 py-3",Vs=C==="compact"?"p-3":"p-4",ks=C==="compact"?"space-y-1.5":"space-y-2",ws=C==="compact"?"mt-2.5":"mt-3",O=c.useMemo(()=>{const t=(r==null?void 0:r.inbounds)||[],l=q&&t.length===1;return t.map((a,d)=>({relation:a,index:d,label:a.inbound.remark||a.inbound.tag||s("users.detail.keyFallback",{defaultValue:"Key {{count}}",count:d+1}),protocol:a.inbound.protocol,port:Number(a.inbound.port||0),priority:Number.isInteger(Number(a.priority))?Number(a.priority):100+d,enabled:!!a.enabled,online:(()=>{var x;if(!a.enabled)return!1;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));if(Number.isInteger(n)&&n>0){const u=J.get(n);if(u&&u.onlineDevices>0)return!0}return l})(),lastSeenAt:(()=>{var x;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));if(Number.isInteger(n)&&n>0){const u=J.get(n);if(u!=null&&u.lastSeenAt)return u.lastSeenAt}return l?(h==null?void 0:h.lastSeenAt)??null:null})(),onlineDevices:(()=>{var x,u;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));return Number.isInteger(n)&&n>0?((u=J.get(n))==null?void 0:u.onlineDevices)??0:l?1:0})(),seenDevices:(()=>{var x,u;const n=Number(a.inboundId||((x=a.inbound)==null?void 0:x.id));return Number.isInteger(n)&&n>0?((u=J.get(n))==null?void 0:u.seenDevices)??0:l?1:0})(),expirationDays:re}))},[re,J,q,h==null?void 0:h.lastSeenAt,s,r==null?void 0:r.inbounds]),Is=c.useMemo(()=>O.filter(t=>t.enabled).length,[O]),Ds=c.useMemo(()=>O.filter(t=>t.online).length,[O]),de=c.useMemo(()=>{const t=O.filter(a=>M==="enabled"?a.enabled:M==="disabled"?!a.enabled:M==="online"?a.online:M==="offline"?!a.online:!0),l=he==="asc"?1:-1;return t.sort((a,d)=>{let n=0;switch(G){case"key":n=a.label.localeCompare(d.label);break;case"protocol":n=a.protocol.localeCompare(d.protocol);break;case"port":n=a.port-d.port;break;case"priority":n=a.priority-d.priority;break;case"enabled":n=Number(a.enabled)-Number(d.enabled);break;case"online":n=Number(a.online)-Number(d.online);break;case"expiration":n=a.expirationDays-d.expirationDays;break;default:n=0}return n===0&&(n=a.index-d.index),n*l}),t},[M,O,he,G]),B=M==="all"&&G==="priority"&&he==="asc";if(xs)return e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("div",{className:"h-12 w-12 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})});if(!r)return e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.detail.notFound",{defaultValue:"User not found"})}),e.jsx(v,{className:"mt-4",onClick:()=>K("/users"),children:s("users.detail.backToUsers",{defaultValue:"Back to Users"})})]});const Ps=t=>{if(G===t){se(l=>l==="asc"?"desc":"asc");return}ye(t),se("asc")},E=(t,l)=>{const a=G===l;return e.jsxs("button",{type:"button",className:`inline-flex items-center gap-1 rounded px-1 py-0.5 transition-colors ${a?"text-foreground":"text-muted hover:text-foreground"}`,onClick:()=>Ps(l),children:[e.jsx("span",{children:t}),e.jsx(ds,{className:`h-3.5 w-3.5 ${a?"opacity-100":"opacity-40"}`})]})},ke=t=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs ${t?"bg-emerald-500/15 text-emerald-300":"bg-zinc-500/15 text-zinc-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[t?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${t?"bg-emerald-400":"bg-zinc-400"}`})]}),e.jsx("span",{children:t?s("common.online",{defaultValue:"Online"}):s("common.offline",{defaultValue:"Offline"})})]}),Ss=(t,l)=>{const a=t>0,d=l>0?s("users.keysActive",{defaultValue:"Keys active {{online}}/{{total}}",online:t,total:l}):s("users.detail.noKeysEnabled",{defaultValue:"No keys enabled"});return e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${a?"bg-emerald-500/15 text-emerald-300":"bg-panel/60 text-muted"}`,title:d,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[a?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${a?"bg-emerald-400":"bg-zinc-400"}`})]}),e.jsx("span",{children:d})]})},_e=t=>{const l=[{key:"enabled",dotClass:"bg-sky-400",value:t.enabled?1:0,label:s("common.enabled",{defaultValue:"Enabled"})},{key:"disabled",dotClass:"bg-rose-400",value:t.enabled?0:1,label:s("common.disabled",{defaultValue:"Disabled"})},{key:"online",dotClass:"bg-emerald-400",value:t.online?1:0,label:s("common.online",{defaultValue:"Online"})}];return e.jsx("div",{className:"mt-1 flex items-center gap-2",children:l.map(a=>e.jsxs("span",{title:a.label,className:"inline-flex items-center gap-1 rounded-full border border-line/60 bg-panel/65 px-1.5 py-0.5 text-[10px] font-medium text-muted",children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${a.dotClass}`}),e.jsx("span",{children:a.value})]},`${t.relation.id}-${a.key}`))})},As=t=>{const l=t,a=l==null?void 0:l.closest("details");a&&(a.open=!1)},Qe=(t,l)=>{t.preventDefault(),t.stopPropagation(),l&&l(),As(t.currentTarget)},Ts=()=>{P({type:"reset-traffic"})},Ms=()=>{P({type:"delete-user"})},we=async(t,l)=>{await navigator.clipboard.writeText(l),L(t),window.setTimeout(()=>L(""),1800)},Cs=t=>{const l=t.map(n=>({id:String(n.id||""),content:String(n.content||"").trim()})).filter(n=>!!n.content),a=l.find(n=>/^(vless|vmess|trojan|ss|socks5|http|wireguard):\/\//i.test(n.content));if(a)return a.content;const d=l.find(n=>n.id.includes("url"));return d?d.content:r.subscriptionToken?`${window.location.origin}/sub/${r.subscriptionToken}?target=v2ray`:""},Es=async t=>{var l;if(t.inboundId){Le(t.inboundId);try{const a=await Zs.get(`/inbounds/${t.inboundId}/client-templates`,{params:{userId:r.id}}),d=((l=a==null?void 0:a.data)==null?void 0:l.templates)||[],n=Cs(d);if(!n)throw new Error(s("users.detail.toast.noKeyUrl",{defaultValue:"No key URL available for this inbound"}));await we(`key-${t.inboundId}`,n)}catch(a){f.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.detail.toast.copyKeyFailed",{defaultValue:"Failed to copy key"}))}finally{Le(null)}}},Ie=async t=>{if(t.inboundId){Ke(t.inboundId);try{await ps.mutateAsync({id:r.id,inboundId:t.inboundId,enabled:!t.enabled}),A()}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.keyStatusFailed",{defaultValue:"Failed to update key status"}))}finally{Ke(null)}}},He=async(t,l)=>{if(!t.inboundId)return;const a=Number.isInteger(Number(t.priority))?Number(t.priority):100,d=Math.max(1,Math.min(9999,a+l));if(d!==a){Ue(t.inboundId);try{await bs.mutateAsync({id:r.id,inboundId:t.inboundId,priority:d}),A()}catch(n){f.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.detail.toast.keyPriorityFailed",{defaultValue:"Failed to update key priority"}))}finally{Ue(null)}}},Ks=()=>{const t=[{key:"reset-traffic",label:le.isPending?s("users.detail.actions.resettingTraffic",{defaultValue:"Resetting traffic..."}):s("users.detail.actions.resetTraffic",{defaultValue:"Reset traffic"}),icon:Dt,disabled:le.isPending,onClick:()=>Ts()},{key:"delete-user",label:ne.isPending?s("users.detail.actions.deletingUser",{defaultValue:"Deleting user..."}):s("users.detail.actions.deleteUser",{defaultValue:"Delete user"}),icon:jt,tone:"danger",disabled:ne.isPending,onClick:()=>Ms()}];return e.jsxs("details",{className:"relative",children:[e.jsx("summary",{className:"list-none cursor-pointer rounded-xl border border-line/70 bg-card/75 px-3 py-2 text-foreground transition hover:bg-panel/60 [&::-webkit-details-marker]:hidden","aria-label":s("common.moreActions",{defaultValue:"More actions"}),title:s("common.moreActions",{defaultValue:"More actions"}),children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:s("common.actions",{defaultValue:"Actions"})})]})}),e.jsx("div",{className:"absolute right-0 z-20 mt-2 w-56 rounded-xl border border-line/70 bg-card/95 p-1 shadow-lg shadow-black/10 backdrop-blur-sm",children:t.map(l=>{const a=l.icon;return e.jsxs("button",{type:"button",className:`flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm transition-colors disabled:cursor-not-allowed disabled:opacity-50 ${l.tone==="danger"?"text-red-500 hover:bg-red-500/10":"text-foreground hover:bg-panel/70"}`,disabled:l.disabled,onClick:d=>Qe(d,l.onClick),children:[a?e.jsx(a,{className:`h-4 w-4 ${l.tone==="danger"?"text-red-500":"text-muted"}`}):null,l.label]},l.key)})})]})},Ge=(t,l={})=>{const a=t.relation,d=!!l.mobile,n=Number.parseInt(String(a.inboundId||0),10),x=n>0&&os===n,u=n>0&&me===n,b=n>0&&cs===n,De=[{key:"templates",label:s("users.detail.keyMenu.templates",{defaultValue:"Client templates"}),icon:vt,disabled:!a.inbound,onClick:()=>Ee(a.inbound)},{key:"copy",label:x?s("users.detail.keyMenu.copyingKey",{defaultValue:"Copying key..."}):s("users.detail.keyMenu.copyKeyUrl",{defaultValue:"Copy key URL"}),icon:Se,disabled:n<=0||x,onClick:()=>void Es(a)},{key:"toggle",label:u?s("users.detail.keyMenu.updating",{defaultValue:"Updating..."}):a.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),icon:a.enabled?at:lt,disabled:n<=0||u,onClick:()=>void Ie(a)},{key:"move-up",label:s("users.detail.keyMenu.moveUp",{defaultValue:"Move up (higher priority)"}),icon:Nt,disabled:n<=0||b||S||t.priority<=1,onClick:()=>void He(a,-1)},{key:"move-down",label:s("users.detail.keyMenu.moveDown",{defaultValue:"Move down (lower priority)"}),icon:Vt,disabled:n<=0||b||S||t.priority>=9999,onClick:()=>void He(a,1)},{key:"open-inbounds",label:s("users.detail.keyMenu.openInbounds",{defaultValue:"Open inbounds page"}),icon:kt,onClick:()=>K("/inbounds?tab=inbounds")}];return e.jsxs("details",{className:"relative",children:[e.jsx("summary",{className:`list-none cursor-pointer rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 [&::-webkit-details-marker]:hidden ${d?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,"aria-label":s("common.moreActions",{defaultValue:"More actions"}),title:s("common.moreActions",{defaultValue:"More actions"}),onClick:D=>D.stopPropagation(),children:e.jsx("span",{className:"inline-flex items-center",children:e.jsx(is,{className:"h-4 w-4"})})}),e.jsx("div",{className:"absolute right-0 z-20 mt-2 w-60 rounded-xl border border-line/70 bg-card/95 p-1 shadow-lg shadow-black/10 backdrop-blur-sm",children:De.map(D=>{const ls=D.icon;return e.jsxs("button",{type:"button",className:`flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm transition-colors disabled:cursor-not-allowed disabled:opacity-50 ${D.tone==="danger"?"text-red-500 hover:bg-red-500/10":"text-foreground hover:bg-panel/70"}`,disabled:D.disabled,onClick:Js=>Qe(Js,D.onClick),children:[ls?e.jsx(ls,{className:`h-4 w-4 ${D.tone==="danger"?"text-red-500":"text-muted"}`}):null,D.label]},`${a.id}-${D.key}`)})})]})},Ls=async()=>{if((r.inbounds||[]).filter(l=>Number.isInteger(Number(l.inboundId))&&Number(l.inboundId)>0).length===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noKeys",{defaultValue:"No keys available for this user."}));return}Z(!0);try{const a=(await oe.previewUserInboundPatternReorder(r.id,"myanmar")).data;if(!a)throw new Error(s("users.detail.toast.previewGenerateFailed",{defaultValue:"Failed to generate preview"}));if((a.matchedKeys||0)===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noMyanmarProfiles",{defaultValue:"No Myanmar-compatible profiles found (expected REALITY / VLESS WS TLS / TROJAN WS TLS)."}));return}ge({totalKeys:a.totalKeys??0,matchedKeys:a.matchedKeys??0,changedKeys:a.changedKeys??0,currentTop3:a.currentTop3||[],newTop3:a.newTop3||[]})}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.myanmarPreviewFailed",{defaultValue:"Failed to preview Myanmar priority order"}))}finally{Z(!1)}},Us=async()=>{if(p){Z(!0);try{const l=(await oe.reorderUserInboundsByPattern(r.id,{pattern:"myanmar"})).data;ye("priority"),se("asc"),be("all"),ge(null),A(),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.myanmarApplied",{defaultValue:"Promoted {{count}} matching key(s).",count:(l==null?void 0:l.matchedKeys)??p.matchedKeys??0}))}catch(t){f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.myanmarApplyFailed",{defaultValue:"Failed to apply Myanmar priority order"}))}finally{Z(!1)}}},Fs=async()=>{if(!r)return;if((r.inbounds||[]).filter(l=>Number.isInteger(Number(l.inboundId))&&Number(l.inboundId)>0).length===0){f.error(s("common.error",{defaultValue:"Error"}),s("users.detail.toast.noKeys",{defaultValue:"No keys available for this user."}));return}ee(!0);try{const a=(await oe.previewUserInboundQualityReorder(r.id,{windowMinutes:60})).data;if(!a)throw new Error(s("users.detail.toast.previewGenerateFailed",{defaultValue:"Failed to generate preview"}));if((a.scoredKeys||0)===0){f.warning(s("common.warning",{defaultValue:"Warning"}),s("users.detail.toast.noTelemetry",{defaultValue:"No recent connections were detected. Generate traffic on at least one key and try again."}));return}const d=(a.preview||[]).slice(0,10).map(n=>{const x=n.score===null?"-":n.score.toFixed(0);return`P${n.toPriority} • ${n.key} • score ${x} • connect ${n.connectSuccesses} • reject ${n.limitRejects} • reconnect ${n.reconnects}`});je({windowMinutes:a.windowMinutes??60,totalKeys:a.totalKeys??0,scoredKeys:a.scoredKeys??0,changedKeys:a.changedKeys??0,currentTop3:a.currentTop3||[],newTop3:a.newTop3||[],previewLines:d})}catch(l){f.error(s("common.error",{defaultValue:"Error"}),(l==null?void 0:l.message)||s("users.detail.toast.qualityPreviewFailed",{defaultValue:"Failed to generate quality preview"}))}finally{ee(!1)}},Rs=async()=>{if(!(!m||!r)){ee(!0);try{const l=(await oe.reorderUserInboundsByQuality(r.id,{windowMinutes:m.windowMinutes})).data;ye("priority"),se("asc"),be("all"),je(null),A(),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.qualityApplied",{defaultValue:"Reordered {{count}} key(s) with telemetry.",count:(l==null?void 0:l.scoredKeys)??m.scoredKeys}))}catch(t){f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.qualityApplyFailed",{defaultValue:"Failed to apply quality ordering"}))}finally{ee(!1)}}},X=()=>{Re(null),pe(null)},$s=t=>{!B||S||(Re(t),pe(t))},Os=(t,l)=>{!B||S||U===null||(t.preventDefault(),$e!==l&&pe(l))},Bs=async t=>{if(!B||S||U===null){X();return}if(U===t){X();return}const l=de.filter(b=>Number.isInteger(Number(b.relation.inboundId))&&Number(b.relation.inboundId)>0),a=l.findIndex(b=>b.relation.inboundId===U),d=l.findIndex(b=>b.relation.inboundId===t);if(a<0||d<0){X();return}const n=[...l],[x]=n.splice(a,1);n.splice(d,0,x);const u=n.map((b,De)=>({inboundId:Number(b.relation.inboundId),priority:100+De,enabled:!!b.relation.enabled}));Fe(!0);try{await ys.mutateAsync({id:r.id,assignments:u}),A()}catch(b){f.error(s("common.error",{defaultValue:"Error"}),(b==null?void 0:b.message)||s("users.detail.toast.reorderFailed",{defaultValue:"Failed to reorder keys"}))}finally{Fe(!1),X()}},zs=t=>{P({type:"revoke-device",fingerprint:t})},We=(i==null?void 0:i.type)==="reset-traffic"?le.isPending:(i==null?void 0:i.type)==="delete-user"?ne.isPending:(i==null?void 0:i.type)==="revoke-device"?Ne.isPending:!1,_s=async()=>{if(i)try{if(i.type==="reset-traffic")await le.mutateAsync(r.id),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.trafficReset",{defaultValue:"User traffic counters were reset."})),A();else if(i.type==="delete-user"){await ne.mutateAsync(r.id),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.userDeleted",{defaultValue:"User was deleted successfully."})),P(null),K("/users");return}else i.type==="revoke-device"&&(await Ne.mutateAsync({id:r.id,fingerprint:i.fingerprint}),f.success(s("common.success",{defaultValue:"Success"}),s("users.detail.toast.deviceRevoked",{defaultValue:"Device session was revoked."})),k.refetch(),$.refetch());P(null)}catch(t){i.type==="reset-traffic"?f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.resetFailed",{defaultValue:"Failed to reset traffic"})):i.type==="delete-user"?f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.deleteFailed",{defaultValue:"Failed to delete user"})):f.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.detail.toast.revokeFailed",{defaultValue:"Failed to revoke device session"}))}},Qs=(i==null?void 0:i.type)==="reset-traffic"?s("users.actions.resetTrafficTitle",{defaultValue:"Reset traffic?"}):(i==null?void 0:i.type)==="delete-user"?s("users.detail.confirm.deleteTitle",{defaultValue:"Delete user?"}):(i==null?void 0:i.type)==="revoke-device"?s("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}):"",Hs=(i==null?void 0:i.type)==="reset-traffic"?s("users.actions.resetTrafficDescription",{defaultValue:"Reset this user's upload/download counters."}):(i==null?void 0:i.type)==="delete-user"?s("users.detail.confirm.deleteDescription",{defaultValue:"Are you sure you want to delete this user? This action cannot be undone."}):(i==null?void 0:i.type)==="revoke-device"?s("users.devices.revokeDescription",{defaultValue:"Revoke this device? It will need to reconnect."}):"",Gs=(i==null?void 0:i.type)==="delete-user"?s("common.delete",{defaultValue:"Delete"}):(i==null?void 0:i.type)==="reset-traffic"?s("common.reset",{defaultValue:"Reset"}):s("common.revoke",{defaultValue:"Revoke"}),Ws=(i==null?void 0:i.type)==="delete-user"?"danger":"primary",qs=()=>{const t={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"};return e.jsx(Pe,{variant:t[r.status],children:r.status})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx(v,{variant:"ghost",onClick:()=>K("/users"),children:e.jsx(wt,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground sm:text-3xl",children:r.email}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.subtitle",{defaultValue:"User details & access keys"})}),e.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:Ss(Ds,Is)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:gap-3",children:[e.jsxs(v,{variant:"secondary",onClick:()=>H(!0),children:[e.jsx(ht,{className:"mr-2 h-4 w-4"}),s("common.edit",{defaultValue:"Edit"})]}),Ks()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-5",children:[e.jsxs(g,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.status",{defaultValue:"Status"})}),e.jsx("div",{className:"mt-2",children:qs()})]}),e.jsxs(g,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsx("div",{className:"mt-2",children:ke(q)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:vs})]}),e.jsxs(g,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.dataUsed",{defaultValue:"Data Used"})}),e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:N(W)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.dataLimitCaption",{defaultValue:"Limit: {{limit}}",limit:N(j)})})]}),e.jsxs(g,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.detail.remaining",{defaultValue:"Remaining"})}),e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:N(Oe)}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.remainingPercentLeft",{defaultValue:"{{percent}}% left",percent:js.toFixed(1)})})]}),e.jsxs(g,{children:[e.jsx("p",{className:"text-sm text-muted",children:ze?s("common.expiry",{defaultValue:"Expiry"}):s("users.detail.expiresIn",{defaultValue:"Expires in"})}),ze?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mt-2 text-base font-semibold text-foreground",children:s("users.startOnFirstConnect",{defaultValue:"Starts on first connect"})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:s("users.detail.expiry.afterFirstConnect",{defaultValue:"{{days}} days after first connect",days:re})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mt-1 text-2xl font-bold text-foreground",children:s("users.detail.expiry.daysValue",{defaultValue:"{{count}} days",count:re})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:z(r.expireDate)})]})]})]}),e.jsxs(g,{children:[e.jsx("h2",{className:"mb-4 text-xl font-bold text-foreground",children:s("users.detail.userInfoTitle",{defaultValue:"User Information"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.email",{defaultValue:"Email"})}),e.jsx("p",{className:"mt-1 font-medium text-foreground",children:r.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.uuid",{defaultValue:"UUID"})}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("code",{className:"rounded-lg border border-line/70 bg-panel/70 px-2 py-1 font-mono text-sm text-foreground",children:r.uuid}),e.jsx("button",{onClick:()=>{we("uuid",r.uuid)},className:"rounded p-1 transition-colors hover:bg-card","aria-label":s("users.detail.copyUuid",{defaultValue:"Copy UUID"}),children:T==="uuid"?e.jsx(ns,{className:"h-4 w-4 text-emerald-500"}):e.jsx(Se,{className:"h-4 w-4 text-muted"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("auth.password",{defaultValue:"Password"})}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("code",{className:"rounded-lg border border-line/70 bg-panel/70 px-2 py-1 font-mono text-sm text-foreground",children:r.password}),e.jsx("button",{onClick:()=>{we("password",r.password)},className:"rounded p-1 transition-colors hover:bg-card","aria-label":s("users.detail.copyPassword",{defaultValue:"Copy password"}),children:T==="password"?e.jsx(ns,{className:"h-4 w-4 text-emerald-500"}):e.jsx(Se,{className:"h-4 w-4 text-muted"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.detail.createdAt",{defaultValue:"Created at"})}),e.jsx("p",{className:"mt-1 text-foreground",children:z(r.createdAt)})]}),r.note?e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm text-muted",children:s("users.note",{defaultValue:"Note"})}),e.jsx("p",{className:"mt-1 text-foreground",children:r.note})]}):null]})]}),e.jsxs(g,{children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.effectiveInbounds.title",{defaultValue:"Effective inbound access"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.effectiveInbounds.subtitle",{defaultValue:"Combined view of direct assignments and inherited group mappings."})})]}),e.jsxs(v,{size:"sm",variant:"secondary",loading:te.isFetching,onClick:()=>{te.refetch()},children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]})]}),te.isLoading?e.jsx("div",{className:"py-4 text-sm text-muted",children:s("users.detail.effectiveInbounds.loading",{defaultValue:"Loading effective access..."})}):!Ve||Ve.effectiveInbounds.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4 text-sm text-muted",children:s("users.detail.effectiveInbounds.empty",{defaultValue:"No effective inbounds found for this user."})}):e.jsx("div",{className:"space-y-3",children:Ve.effectiveInbounds.map(t=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-foreground",children:[t.inbound.protocol," • ",t.inbound.port]}),e.jsx("p",{className:"text-sm text-muted",children:t.inbound.remark||t.inbound.tag})]}),e.jsx(Pe,{variant:t.inbound.enabled?"success":"warning",children:t.inbound.enabled?s("users.detail.effectiveInbounds.badgeEnabled",{defaultValue:"Inbound enabled"}):s("users.detail.effectiveInbounds.badgeDisabled",{defaultValue:"Inbound disabled"})})]}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:t.sources.map((l,a)=>e.jsx("span",{className:`inline-flex rounded-full px-2.5 py-1 text-xs font-medium ${l.type==="DIRECT"?"bg-brand-500/20 text-brand-200":"bg-violet-500/20 text-violet-200"}`,children:l.type==="DIRECT"?s("users.detail.effectiveInbounds.sourceDirect",{defaultValue:"Direct"}):s("users.detail.effectiveInbounds.sourceGroup",{defaultValue:"Group: {{name}}",name:l.groupName||String(l.groupId)})},`effective-source-${t.inboundId}-${a}`))})]},`effective-inbound-${t.inboundId}`))})]}),e.jsxs(g,{children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.policy.title",{defaultValue:"Effective policy"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.policy.subtitle",{defaultValue:"Compare direct user policy with inherited group policy overrides."})})]}),e.jsxs(v,{size:"sm",variant:"secondary",loading:ae.isFetching,onClick:()=>{ae.refetch()},children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]})]}),ae.isLoading?e.jsx("div",{className:"py-4 text-sm text-muted",children:s("users.detail.policy.loading",{defaultValue:"Loading effective policy..."})}):o?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto rounded-xl border border-line/70 bg-panel/55",children:e.jsxs("table",{className:"min-w-[760px] w-full text-sm",children:[e.jsx("thead",{className:"bg-panel/80 text-xs uppercase tracking-wide text-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.field",{defaultValue:"Field"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.direct",{defaultValue:"Direct"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.inherited",{defaultValue:"Inherited"})}),e.jsx("th",{className:"px-4 py-3 text-left",children:s("users.detail.policy.table.effective",{defaultValue:"Effective"})})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.dataLimit",{defaultValue:"Data Limit"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:N(Number(o.directPolicy.dataLimit||0))}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.dataLimit!==null?N(Number(o.inheritedPolicy.dataLimit||0)):s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[N(Number(o.effectivePolicy.dataLimit||0)),o.drift.dataLimit?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("common.expiry",{defaultValue:"Expiry"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:z(o.directPolicy.expireDate)}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.expireDate?z(o.inheritedPolicy.expireDate):s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[z(o.effectivePolicy.expireDate),o.drift.expireDate?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.form.ipLimitLabel",{defaultValue:"IP Limit"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.directPolicy.ipLimit}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.ipLimit??s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.ipLimit,o.drift.ipLimit?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("common.status",{defaultValue:"Status"})}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.directPolicy.status}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.status||s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.status,o.drift.status?e.jsx("span",{className:"ml-2 rounded-full bg-amber-500/20 px-2 py-0.5 text-xs text-amber-300",children:s("common.drift",{defaultValue:"Drift"})}):null]})]}),e.jsxs("tr",{className:"border-t border-line/70",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-foreground",children:s("users.detail.policy.table.trafficReset",{defaultValue:"Traffic reset"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.directPolicy.trafficResetPeriod,o.directPolicy.trafficResetDay?` @${o.directPolicy.trafficResetDay}`:""]}),e.jsx("td",{className:"px-4 py-3 text-foreground",children:o.inheritedPolicy.trafficResetPeriod?`${o.inheritedPolicy.trafficResetPeriod}${o.inheritedPolicy.trafficResetDay?` @${o.inheritedPolicy.trafficResetDay}`:""}`:s("common.noOverride",{defaultValue:"No override"})}),e.jsxs("td",{className:"px-4 py-3 text-foreground",children:[o.effectivePolicy.trafficResetPeriod,o.effectivePolicy.trafficResetDay?` @${o.effectivePolicy.trafficResetDay}`:""]})]})]})]})}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-xs font-semibold uppercase tracking-[0.08em] text-muted",children:s("users.detail.policy.groupSources",{defaultValue:"Group policy sources"})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.groups.length===0?e.jsx("span",{className:"text-sm text-muted",children:s("users.detail.policy.noGroups",{defaultValue:"No active groups assigned"})}):o.groups.map(t=>e.jsx("span",{className:"rounded-full border border-line/70 bg-card/70 px-3 py-1 text-xs text-foreground",children:t.name},`policy-group-${t.id}`))})]})]}):e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4 text-sm text-muted",children:s("users.detail.policy.unavailable",{defaultValue:"Effective policy is unavailable for this user."})})]}),e.jsxs(g,{className:"p-0",children:[e.jsxs("div",{className:"border-b border-line/70 px-5 py-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.keys.title",{defaultValue:"Access keys"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.detail.keys.subtitle",{defaultValue:"Manage per-inbound keys, status, online visibility, and client templates."})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{value:M,onChange:t=>be(t.target.value),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:[e.jsx("option",{value:"all",children:s("users.detail.keys.filter.all",{defaultValue:"All keys"})}),e.jsx("option",{value:"enabled",children:s("common.enabled",{defaultValue:"Enabled"})}),e.jsx("option",{value:"disabled",children:s("common.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"online",children:s("common.online",{defaultValue:"Online"})}),e.jsx("option",{value:"offline",children:s("common.offline",{defaultValue:"Offline"})})]}),e.jsx("select",{value:String(R),onChange:t=>ms(Number(t.target.value)),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:Tt.map(t=>e.jsxs("option",{value:t.value,children:[s("common.refresh",{defaultValue:"Refresh"})," ",t.label]},t.value))}),e.jsxs("select",{value:C,onChange:t=>fs(t.target.value),className:"rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/30",children:[e.jsx("option",{value:"comfortable",children:s("users.detail.keys.density.comfortable",{defaultValue:"Comfortable rows"})}),e.jsx("option",{value:"compact",children:s("users.detail.keys.density.compact",{defaultValue:"Compact rows"})})]}),e.jsxs(v,{size:"sm",variant:"secondary",loading:Ns,onClick:()=>{$.refetch(),k.refetch(),A()},children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),s("common.refresh",{defaultValue:"Refresh"})]}),e.jsxs(v,{size:"sm",variant:"secondary",loading:fe,disabled:S||(r.inbounds||[]).length===0,onClick:()=>{Ls()},children:[e.jsx(ds,{className:"mr-2 h-4 w-4"}),s("users.myanmarPriority",{defaultValue:"Myanmar Priority"})]}),e.jsxs(v,{size:"sm",variant:"secondary",loading:xe,disabled:S||(r.inbounds||[]).length===0,onClick:()=>{Fs()},children:[e.jsx(gt,{className:"mr-2 h-4 w-4"}),s("users.autoTune",{defaultValue:"Auto-tune"})]})]})]}),e.jsx("p",{className:"mt-2 text-xs text-muted",children:B?s("users.detail.keys.dragHintEnabled",{defaultValue:"Drag rows from the Menu column to reorder key priority. The order controls subscription fallback."}):s("users.detail.keys.dragHintDisabled",{defaultValue:"Enable drag reorder by setting Filter: All keys and Sort: Priority ascending."})})]}),de.length===0?e.jsx("div",{className:"px-5 py-8 text-sm text-muted",children:s("users.detail.keys.empty",{defaultValue:"No keys match the selected filter."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden overflow-x-auto lg:block",children:e.jsxs("table",{className:`min-w-[1100px] w-full ${C==="compact"?"text-xs":"text-sm"}`,children:[e.jsx("thead",{className:"bg-panel/65",children:e.jsxs("tr",{className:"border-b border-line/70 text-left text-xs uppercase tracking-wide text-muted",children:[e.jsx("th",{className:w,children:s("users.detail.keys.table.menu",{defaultValue:"Menu"})}),e.jsx("th",{className:w,children:E(s("common.enabled",{defaultValue:"Enabled"}),"enabled")}),e.jsx("th",{className:w,children:E(s("common.online",{defaultValue:"Online"}),"online")}),e.jsx("th",{className:w,children:E(s("users.detail.keys.table.clientKey",{defaultValue:"Client / Key"}),"key")}),e.jsx("th",{className:w,children:E(s("users.detail.keys.table.protocol",{defaultValue:"Protocol"}),"protocol")}),e.jsx("th",{className:w,children:E(s("users.detail.keys.table.port",{defaultValue:"Port"}),"port")}),e.jsx("th",{className:w,children:E(s("users.detail.keys.table.priority",{defaultValue:"Priority"}),"priority")}),e.jsx("th",{className:w,children:s("users.detail.keys.table.traffic",{defaultValue:"Traffic"})}),e.jsx("th",{className:w,children:E(s("users.detail.keys.table.expiration",{defaultValue:"Expiration"}),"expiration")})]})}),e.jsx("tbody",{children:de.map(t=>{const l=t.relation,a=Number.parseInt(String(l.inboundId||0),10),d=Te(s,t.online,t.lastSeenAt,F),n=B&&a>0&&!S,x=U===a,u=$e===a&&U!==a;return e.jsxs("tr",{className:`border-b border-line/70 transition-colors hover:bg-panel/35 ${x?"bg-brand-500/10":""} ${u?"ring-1 ring-inset ring-brand-500/50":""}`,draggable:n,onDragStart:()=>{$s(a)},onDragOver:b=>{Os(b,a)},onDrop:()=>{Bs(a)},onDragEnd:X,children:[e.jsx("td",{className:I,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex items-center rounded p-1 ${n?"cursor-grab text-muted hover:bg-panel/70 hover:text-foreground":"text-muted/40"}`,title:B?s("users.detail.keys.dragHandleEnabled",{defaultValue:"Drag to reorder priority"}):s("users.detail.keys.dragHandleDisabled",{defaultValue:"Sort by priority ascending to enable drag reorder"}),children:e.jsx(It,{className:"h-4 w-4"})}),Ge(t)]})}),e.jsx("td",{className:I,children:e.jsx("button",{type:"button",role:"switch","aria-checked":l.enabled,"aria-label":l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),title:l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),disabled:me===l.inboundId,onClick:()=>{Ie(l)},className:`relative inline-flex h-6 w-11 items-center rounded-full border border-line/70 transition focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${l.enabled?"bg-emerald-500/25":"bg-panel/70"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full border border-line/70 bg-white shadow-sm transition ${l.enabled?"translate-x-5":"translate-x-1"}`})})}),e.jsxs("td",{className:I,children:[ke(t.online),e.jsx("p",{className:"mt-1 text-[11px] text-muted",children:d}),t.seenDevices>0?e.jsx("p",{className:"mt-0.5 text-[11px] text-muted",children:s("users.detail.keys.devicesCount",{defaultValue:"Devices {{online}}/{{seen}}",online:t.onlineDevices,seen:t.seenDevices})}):null]}),e.jsx("td",{className:I,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-foreground",children:r.email}),e.jsx("span",{className:"text-xs text-muted",children:t.label}),_e(t)]})}),e.jsx("td",{className:I,children:e.jsx(Pe,{variant:"info",children:t.protocol})}),e.jsx("td",{className:I,children:e.jsx("span",{className:"font-semibold text-foreground",children:t.port})}),e.jsx("td",{className:I,children:e.jsx("span",{className:"inline-flex items-center rounded-full border border-line/70 bg-card/70 px-3 py-1 text-xs font-semibold text-foreground",children:t.priority})}),e.jsx("td",{className:I,children:e.jsxs("div",{className:"w-48",children:[e.jsxs("p",{className:"text-xs text-muted",children:[N(W)," / ",j>0?N(j):"∞"]}),e.jsx("div",{className:"mt-1 h-2 rounded-full bg-panel/80",children:e.jsx("div",{className:"h-2 rounded-full bg-gradient-to-r from-brand-500 to-brand-600",style:{width:`${Be}%`}})})]})}),e.jsx("td",{className:I,children:e.jsx("span",{className:`inline-flex rounded-full px-2 py-0.5 text-xs ${t.expirationDays<=0?"bg-red-500/20 text-red-300":t.expirationDays<=7?"bg-amber-500/20 text-amber-300":"bg-brand-500/20 text-brand-200"}`,children:t.expirationDays<=0?s("common.expired",{defaultValue:"Expired"}):s("users.detail.keys.shortDays",{defaultValue:"{{count}}d",count:t.expirationDays})})})]},l.id)})})]})}),e.jsx("div",{className:"grid grid-cols-1 gap-3 p-4 lg:hidden",children:de.map(t=>{const l=t.relation,a=Te(s,t.online,t.lastSeenAt,F);return e.jsxs("div",{className:`rounded-xl border border-line/70 bg-card/70 ${Vs}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:t.label}),e.jsxs("p",{className:"text-xs text-muted",children:[t.protocol," · ",s("users.detail.keys.portLabelShort",{defaultValue:"Port"})," ",t.port]}),_e(t)]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-right",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ke(t.online),Ge(t,{mobile:!0})]}),e.jsx("p",{className:"text-[11px] text-muted",children:a}),t.seenDevices>0?e.jsx("p",{className:"text-[11px] text-muted",children:s("users.detail.keys.devicesCount",{defaultValue:"Devices {{online}}/{{seen}}",online:t.onlineDevices,seen:t.seenDevices})}):null]})]}),e.jsxs("div",{className:`mt-3 ${ks}`,children:[e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.table.priority",{defaultValue:"Priority"}),":"," ",e.jsx("span",{className:"inline-flex items-center rounded-full border border-line/70 bg-card/70 px-2 py-0.5 text-[11px] font-semibold text-foreground",children:t.priority})]}),e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.usageLabel",{defaultValue:"Usage"}),":"," ",N(W)," / ",j>0?N(j):"∞"]}),e.jsx("div",{className:"h-2 rounded-full bg-panel/80",children:e.jsx("div",{className:"h-2 rounded-full bg-gradient-to-r from-brand-500 to-brand-600",style:{width:`${Be}%`}})}),e.jsxs("p",{className:"text-xs text-muted",children:[s("users.detail.keys.table.expiration",{defaultValue:"Expiration"}),":"," ",t.expirationDays<=0?s("common.expired",{defaultValue:"Expired"}):s("common.daysLeft",{defaultValue:"{{count}} days left",count:t.expirationDays})]})]}),e.jsxs("div",{className:`${ws} flex items-center justify-between rounded-xl border border-line/70 bg-panel/40 px-3 py-2`,children:[e.jsx("span",{className:"text-xs font-medium text-foreground",children:s("common.enabled",{defaultValue:"Enabled"})}),e.jsx("button",{type:"button",role:"switch","aria-checked":l.enabled,"aria-label":l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),title:l.enabled?s("users.detail.keyMenu.disableKey",{defaultValue:"Disable key"}):s("users.detail.keyMenu.enableKey",{defaultValue:"Enable key"}),disabled:me===l.inboundId,onClick:()=>{Ie(l)},className:`relative inline-flex h-6 w-11 items-center rounded-full border border-line/70 transition focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${l.enabled?"bg-emerald-500/25":"bg-card/70"}`,children:e.jsx("span",{className:`inline-block h-5 w-5 transform rounded-full border border-line/70 bg-white shadow-sm transition ${l.enabled?"translate-x-5":"translate-x-1"}`})})]})]},`mobile-${l.id}`)})})]})]}),e.jsxs(g,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:s("users.detail.devicesSessions.title",{defaultValue:"Device sessions"})}),e.jsx("p",{className:"text-xs text-muted",children:s("users.detail.devicesSessions.subtitle",{defaultValue:"{{online}} online / {{total}} seen in last {{minutes}} minutes",online:((ss=(es=k.data)==null?void 0:es.data)==null?void 0:ss.online)||0,total:((as=(ts=k.data)==null?void 0:ts.data)==null?void 0:as.total)||0,minutes:60})})]}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>{k.refetch()},loading:k.isFetching,children:e.jsx(ce,{className:"h-4 w-4"})})]}),k.isLoading?e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"h-10 w-full"}),e.jsx(_,{className:"h-10 w-full"})]}):ie.length===0?e.jsx("p",{className:"text-sm text-muted",children:s("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-xs uppercase tracking-wide text-muted",children:e.jsxs("tr",{className:"border-b border-line/70",children:[e.jsx("th",{className:"py-2 pr-3",children:s("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.fingerprint",{defaultValue:"Fingerprint"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.ip",{defaultValue:"IP"})}),e.jsx("th",{className:"py-2 pr-3",children:s("users.detail.devicesSessions.columns.lastSeen",{defaultValue:"Last seen"})}),e.jsx("th",{className:"py-2 text-right",children:s("common.action",{defaultValue:"Action"})})]})}),e.jsx("tbody",{children:ie.slice(0,12).map(t=>e.jsxs("tr",{className:"border-b border-line/50",children:[e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2 py-0.5 text-xs ${t.online?"bg-emerald-500/15 text-emerald-300":"bg-zinc-500/15 text-zinc-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[t.online?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${t.online?"bg-emerald-400":"bg-zinc-400"}`})]}),t.online?s("common.online",{defaultValue:"Online"}):s("common.offline",{defaultValue:"Offline"})]})}),e.jsx("td",{className:"py-2 pr-3 font-mono text-xs text-muted",children:t.shortFingerprint}),e.jsx("td",{className:"py-2 pr-3 text-muted",children:t.clientIp||"-"}),e.jsx("td",{className:"py-2 pr-3 text-muted",children:z(t.lastSeenAt)}),e.jsx("td",{className:"py-2 text-right",children:e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>{zs(t.fingerprint)},loading:Ne.isPending,children:s("common.revoke",{defaultValue:"Revoke"})})})]},t.fingerprint))})]})})]}),e.jsx(Q.Suspense,{fallback:e.jsx(Ae,{}),children:e.jsx(Pt,{userId:r.id})}),e.jsx(Q.Suspense,{fallback:e.jsx(Ae,{}),children:e.jsx(St,{userId:r.id})}),e.jsx(Q.Suspense,{fallback:e.jsx(Ae,{}),children:e.jsx(At,{userId:r.id})}),Y?e.jsx(nt,{user:r,onClose:()=>H(!1),onSuccess:()=>{H(!1),A()}}):null,Ce?e.jsx(tt,{inbound:Ce,initialUserId:r.id,onClose:()=>Ee(null)}):null,e.jsx(st,{open:!!i,title:Qs,description:Hs,confirmLabel:Gs,cancelLabel:s("common.cancel",{defaultValue:"Cancel"}),tone:Ws,loading:We,onCancel:()=>{We||P(null)},onConfirm:()=>{_s()}}),e.jsx(rs,{open:!!p,title:s("users.myanmarPriorityPreviewTitle",{defaultValue:"Myanmar Priority Preview"}),description:s("users.myanmarPriorityPreviewBody",{defaultValue:"Review current and new fallback order before applying."}),summaryRows:[{label:s("users.preview.totalKeys",{defaultValue:"Total keys"}),value:(p==null?void 0:p.totalKeys)??0},{label:s("users.preview.matchedKeys",{defaultValue:"Matched keys"}),value:(p==null?void 0:p.matchedKeys)??0},{label:s("users.preview.keysToReorder",{defaultValue:"Keys to reorder"}),value:(p==null?void 0:p.changedKeys)??0}],currentTop3:(p==null?void 0:p.currentTop3)||[],newTop3:(p==null?void 0:p.newTop3)||[],confirmLabel:s("users.applyPriority",{defaultValue:"Apply Priority"}),loading:fe,disableConfirm:!p||p.changedKeys===0,onClose:()=>{fe||ge(null)},onConfirm:()=>{Us()}}),e.jsx(rs,{open:!!m,title:s("users.qualityAutoTunePreviewTitle",{defaultValue:"Quality Auto-tune Preview"}),description:s("users.qualityAutoTunePreviewBody",{defaultValue:"Reorder keys based on recent connect success, rejects, and reconnects."}),summaryRows:[{label:s("users.preview.totalKeys",{defaultValue:"Total keys"}),value:(m==null?void 0:m.totalKeys)??0},{label:s("users.preview.telemetryKeys",{defaultValue:"Telemetry keys"}),value:(m==null?void 0:m.scoredKeys)??0},{label:s("users.preview.keysToReorder",{defaultValue:"Keys to reorder"}),value:(m==null?void 0:m.changedKeys)??0}],currentTop3:((m==null?void 0:m.currentTop3)||[]).map(t=>({key:t.key,toPriority:t.fromPriority})),newTop3:((m==null?void 0:m.newTop3)||[]).map(t=>({key:t.key,toPriority:t.toPriority})),previewLines:(m==null?void 0:m.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:xe,disableConfirm:!m||m.changedKeys===0,onClose:()=>{xe||je(null)},onConfirm:()=>{Rs()}})]})},ua=Mt;export{Mt as UserDetail,ua as UserDetailPage};
