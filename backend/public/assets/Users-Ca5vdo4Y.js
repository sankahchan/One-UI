import{c as jt,r as c,j as e,X as qe,e as Nt,b as ft,u as vs,h as ws,f as Vs}from"./index-CcK4tOfC.js";import{u as ve}from"./useMutation-DZpYtY5A.js";import{u as me,g as Ie}from"./users-DJwBx_cg.js";import{B as k}from"./Button-D1Vl4E60.js";import{u as Ct,C as ye}from"./useToast-BnKQFuqP.js";import{u as St}from"./index.esm-6ooOXtNp.js";import{u as ks,a as js}from"./useGroups-5gV7fWJG.js";import{u as Ns,a as Cs,b as Ss,c as Ls,d as Ds,e as Rs,f as Us,g as Ms,h as As,i as Es,j as Is,k as Ts,l as Fs,m as Ps,n as qs,o as Bs,p as $s,q as Ks}from"./useUsers-B7GL2jXA.js";import{I as Z}from"./Input-CQ9kTGid.js";import{u as Le,R as Qs}from"./useTranslation-BAr0hstR.js";import{D as Lt}from"./download-DLQAnIUC.js";import{u as Dt}from"./useQuery-B_n5M2_v.js";import{Q as Gs}from"./index-D21TPvDG.js";import{C as Os,c as Fe}from"./clipboard-Be9-ly6g.js";import{C as zs,U as Ws,M as pt}from"./MyanmarPriorityPreviewModal-CvhtMfBN.js";import{E as _s}from"./external-link-UcL_bThf.js";import{B as Hs}from"./Badge-DKtFh9Vg.js";import{D as Xs,M as Rt}from"./DropdownMenu-DSsZCamQ.js";import{C as Ut}from"./ConfirmDialog-Cfo88enq.js";import{g as xt,f as Te,a as Zs}from"./formatters-CEEtD2TU.js";import{C as bt}from"./chevron-up-CsgsE5VC.js";import{C as Pe}from"./chevron-down-2QwyzXam.js";import{u as Ys}from"./useDebouncedValue-DR7p1Hrh.js";import{u as Js,a as ea,b as ta}from"./useSmartAutoRefresh-DqWn8HDG.js";import{S as ke}from"./Skeleton-BQEtEzO0.js";import{p as gt}from"./routePrefetch-BvCb9yGN.js";import{U as ht}from"./users-B4SKmIn4.js";import{P as yt}from"./plus-BgytMRdz.js";import{S as sa}from"./search-BAGV-28h.js";import"./cn-BLSKlp9E.js";import"./inbounds-CIHw7SgX.js";import"./xray-BC2MSUWr.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const aa=jt("MessageSquareText",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M13 8H7",key:"14i4kc"}],["path",{d:"M17 12H7",key:"16if0g"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ra=jt("Wand2",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z",key:"1bcowg"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]);function vt(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function la(o){if(!Array.isArray(o.users)||o.users.length===0)return;const v=[["Email","UUID","Password","Subscription Token","Expire Date","Status"].map(vt).join(","),...o.users.map(p=>[p.email,p.uuid,p.password,p.subscriptionToken,p.expireDate,p.status].map(vt).join(","))].join(`
`),i=new Blob([v],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.setAttribute("download",`bulk-users-${new Date().toISOString().replace(/[:.]/g,"-")}.csv`),l.click(),window.URL.revokeObjectURL(s)}function na(o,m,v,i,s){const l=o.trim(),p=m.trim().replace(/^@+/,""),h=Number.isInteger(v)?Math.max(0,Math.min(v,5)):0,R=Number.isInteger(i)?Math.max(1,i):1,x=Number.isInteger(s)?Math.max(0,s):0;return!l||!p||h===0?[]:Array.from({length:h},(V,q)=>{const j=R+q,A=x>0?String(j).padStart(x,"0"):String(j);return`${l}${A}@${p}`})}const ia=({onClose:o,onSuccess:m})=>{var B,M,w,$,u,fe,W,je;const v=Ct(),{t:i}=Le(),{data:s}=ks(),l=Ns(),p=(s||[]).filter(N=>N.enabled!==!1),{register:h,handleSubmit:R,watch:x,formState:{errors:V}}=St({defaultValues:{prefix:"user",domain:"example.com",count:10,startIndex:1,padding:2,dataLimit:50,expiryDays:30,inboundIds:[],ipLimit:0,status:"ACTIVE"}}),q=x("prefix"),j=x("domain"),A=Number(x("count")),S=Number(x("startIndex")),z=Number(x("padding")),F=c.useMemo(()=>na(q||"",j||"",A,S,z),[q,j,A,S,z]),H=async N=>{try{const se={...N,inboundIds:(N.inboundIds||[]).map(U=>Number(U)).filter(U=>Number.isInteger(U)&&U>0),count:Number(N.count),startIndex:Number(N.startIndex),padding:Number(N.padding),dataLimit:Number(N.dataLimit),expiryDays:Number(N.expiryDays),ipLimit:Number(N.ipLimit)},_=await l.mutateAsync(se);la(_);const pe=(_.failed||[]).slice(0,5).map(U=>`${U.email}: ${U.reason}`).join(`
`),xe=[i("users.bulkCreate.toast.requested",{defaultValue:"Requested: {{count}}",count:_.requestedCount}),i("users.bulkCreate.toast.created",{defaultValue:"Created: {{count}}",count:_.createdCount}),i("users.bulkCreate.toast.failed",{defaultValue:"Failed: {{count}}",count:_.failedCount}),_.createdCount>0?i("users.bulkCreate.toast.csvDownloaded",{defaultValue:"Credentials CSV downloaded."}):void 0].filter(Boolean);v.success(i("common.success",{defaultValue:"Success"}),xe.join(" • ")),pe&&v.warning(i("common.warning",{defaultValue:"Warning"}),pe),_.createdCount>0&&m()}catch(se){v.error(i("common.error",{defaultValue:"Error"}),(se==null?void 0:se.message)||i("users.bulkCreate.toast.failedBody",{defaultValue:"Failed to create users in bulk"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"my-6 w-full max-w-3xl overflow-hidden rounded-2xl border border-line/80 bg-card/95 shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-line/80 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i("users.bulkCreate.title",{defaultValue:"Bulk User Provisioning"})}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:i("users.bulkCreate.subtitle",{defaultValue:"Create multiple users with consistent limits and inbound assignments."})})]}),e.jsx("button",{onClick:o,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":i("common.close",{defaultValue:"Close"}),children:e.jsx(qe,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:R(H),className:"space-y-6 p-5 sm:p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(Z,{label:`${i("users.bulkCreate.prefixLabel",{defaultValue:"Email Prefix"})} *`,...h("prefix",{required:i("users.bulkCreate.validation.prefixRequired",{defaultValue:"Prefix is required"})}),error:(B=V.prefix)==null?void 0:B.message,placeholder:"user"}),e.jsx(Z,{label:`${i("users.bulkCreate.domainLabel",{defaultValue:"Domain"})} *`,...h("domain",{required:i("users.bulkCreate.validation.domainRequired",{defaultValue:"Domain is required"})}),error:(M=V.domain)==null?void 0:M.message,placeholder:"example.com"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(Z,{label:`${i("users.bulkCreate.countLabel",{defaultValue:"Count"})} *`,type:"number",...h("count",{valueAsNumber:!0,required:i("users.bulkCreate.validation.countRequired",{defaultValue:"Count is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})},max:{value:200,message:i("users.bulkCreate.validation.countMax",{defaultValue:"Maximum 200"})}}),error:(w=V.count)==null?void 0:w.message}),e.jsx(Z,{label:`${i("users.bulkCreate.startIndexLabel",{defaultValue:"Start Index"})} *`,type:"number",...h("startIndex",{valueAsNumber:!0,required:i("users.bulkCreate.validation.startIndexRequired",{defaultValue:"Start index is required"}),min:{value:1,message:i("users.bulkCreate.validation.countMin",{defaultValue:"Minimum 1"})}}),error:($=V.startIndex)==null?void 0:$.message}),e.jsx(Z,{label:i("users.bulkCreate.paddingLabel",{defaultValue:"Padding"}),type:"number",...h("padding",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})},max:{value:8,message:i("users.bulkCreate.validation.paddingMax",{defaultValue:"Maximum 8"})}}),error:(u=V.padding)==null?void 0:u.message})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/55 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:i("users.bulkCreate.previewTitle",{defaultValue:"Email Preview"})}),F.length===0?e.jsx("p",{className:"mt-1 text-xs text-muted",children:i("users.bulkCreate.previewEmpty",{defaultValue:"Enter prefix/domain to preview generated emails."})}):e.jsxs("ul",{className:"mt-2 space-y-1 text-xs text-muted",children:[F.map(N=>e.jsx("li",{children:N},N)),A>F.length?e.jsx("li",{children:"..."}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(Z,{label:`${i("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...h("dataLimit",{valueAsNumber:!0,required:i("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(fe=V.dataLimit)==null?void 0:fe.message}),e.jsx(Z,{label:`${i("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...h("expiryDays",{valueAsNumber:!0,required:i("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:i("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(W=V.expiryDays)==null?void 0:W.message}),e.jsx(Z,{label:i("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...h("ipLimit",{valueAsNumber:!0,min:{value:0,message:i("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(je=V.ipLimit)==null?void 0:je.message,placeholder:i("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-muted",children:i("common.status",{defaultValue:"Status"})}),e.jsxs("select",{...h("status"),className:"w-full rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",children:[e.jsx("option",{value:"ACTIVE",children:i("status.active",{defaultValue:"Active"})}),e.jsx("option",{value:"LIMITED",children:i("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:i("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:i("status.expired",{defaultValue:"Expired"})})]})]}),e.jsx(Z,{label:i("users.note",{defaultValue:"Note"}),...h("note"),placeholder:i("users.bulkCreate.notePlaceholder",{defaultValue:"Optional note applied to all created users"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[i("users.bulkCreate.assignInboundsLabel",{defaultValue:"Assign Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-card/65 p-3",children:p.length===0?e.jsx("p",{className:"text-sm text-muted",children:i("users.bulkCreate.noActiveInbounds",{defaultValue:"No active inbounds available."})}):p.map(N=>e.jsxs("label",{className:"flex items-center gap-3 rounded-lg p-2 hover:bg-card/80",children:[e.jsx("input",{type:"checkbox",value:N.id,...h("inboundIds",{required:i("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line bg-card"}),e.jsxs("span",{className:"text-sm text-foreground",children:[N.protocol," - ",N.remark||`Port ${N.port}`]})]},N.id))}),V.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500",children:V.inboundIds.message}):null]}),e.jsxs("div",{className:"flex flex-col gap-2 border-t border-line/70 pt-4 sm:flex-row",children:[e.jsxs(k,{type:"submit",className:"flex-1",loading:l.isPending,children:[e.jsx(Lt,{className:"mr-2 h-4 w-4"}),i("users.bulkCreate.submit",{defaultValue:"Create Users & Download Credentials"})]}),e.jsx(k,{type:"button",variant:"secondary",className:"flex-1",onClick:o,children:i("common.cancel",{defaultValue:"Cancel"})})]})]})]})})};function wt(o){const m=new Date(o),v=m.getFullYear(),i=String(m.getMonth()+1).padStart(2,"0"),s=String(m.getDate()).padStart(2,"0");return`${v}-${i}-${s}`}function oa({user:o,onClose:m,onSuccess:v}){var j,A,S,z;const[i,s]=c.useState(""),l=Cs(),{t:p}=Le(),{register:h,handleSubmit:R,reset:x,formState:{errors:V}}=St({defaultValues:{dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:wt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))}});c.useEffect(()=>{x({dataLimitGb:Math.max(1,Math.round(Number(o.dataLimit||0)/1024**3)),expireDate:wt(o.expireDate),ipLimit:Math.max(0,Number(o.ipLimit||0)),deviceLimit:Math.max(0,Number(o.deviceLimit||0))})},[x,o.dataLimit,o.deviceLimit,o.expireDate,o.ipLimit]);const q=async F=>{s("");const H=new Date,M=new Date(`${F.expireDate}T23:59:59`).getTime()-H.getTime(),w=Math.max(1,Math.ceil(M/(1e3*60*60*24)));try{await l.mutateAsync({id:o.id,data:{dataLimit:Number(F.dataLimitGb),expiryDays:w,ipLimit:Number(F.ipLimit),deviceLimit:Number(F.deviceLimit)}}),v()}catch($){s(($==null?void 0:$.message)||p("users.quickEdit.saveFailed",{defaultValue:"Failed to update user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-md overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:p("users.quickEdit.title",{defaultValue:"Quick Edit"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":p("common.close",{defaultValue:"Close"}),children:e.jsx(qe,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:R(q),className:"space-y-5 p-5 sm:p-6",children:[i?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:i}):null,e.jsx(Z,{label:p("users.quickEdit.dataLimitLabel",{defaultValue:"Data Limit (GB)"}),type:"number",...h("dataLimitGb",{valueAsNumber:!0,required:p("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:p("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(j=V.dataLimitGb)==null?void 0:j.message}),e.jsx(Z,{label:p("users.quickEdit.expiryDateLabel",{defaultValue:"Expiry Date"}),type:"date",...h("expireDate",{required:p("users.quickEdit.validation.expiryDateRequired",{defaultValue:"Expiry date is required"})}),error:(A=V.expireDate)==null?void 0:A.message}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(Z,{label:p("users.quickEdit.ipLimitLabel",{defaultValue:"IP Limit (0 = unlimited)"}),type:"number",...h("ipLimit",{valueAsNumber:!0,min:{value:0,message:p("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(S=V.ipLimit)==null?void 0:S.message}),e.jsx(Z,{label:p("users.quickEdit.deviceLimitLabel",{defaultValue:"Device Limit (0 = unlimited)"}),type:"number",...h("deviceLimit",{valueAsNumber:!0,min:{value:0,message:p("users.quickEdit.validation.minZero",{defaultValue:"Minimum 0"})}}),error:(z=V.deviceLimit)==null?void 0:z.message})]}),e.jsx("p",{className:"rounded-lg border border-line/70 bg-panel/60 px-3 py-2 text-xs text-muted",children:p("users.quickEdit.helper",{defaultValue:"Expiry is stored as days from now. We convert this date automatically when saving."})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{type:"submit",className:"flex-1",loading:l.isPending,children:p("users.quickEdit.saveChanges",{defaultValue:"Save Changes"})}),e.jsx(k,{type:"button",variant:"secondary",className:"flex-1",onClick:m,children:p("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}const ua=[{key:"v2ray",label:"V2Ray"},{key:"clash",label:"Clash"},{key:"singbox",label:"Sing-box"},{key:"wireguard",label:"WireGuard"}];function da({user:o,onClose:m}){var z,F,H,B,M;const{t:v}=Le(),[i,s]=c.useState("v2ray"),[l,p]=c.useState(!1),h=Dt({queryKey:["subscription-info",o.id],queryFn:()=>me.getSubscriptionInfo(o.id)}),R=c.useMemo(()=>{var w,$;return(($=(w=h.data)==null?void 0:w.data)==null?void 0:$.urls)??{}},[(F=(z=h.data)==null?void 0:z.data)==null?void 0:F.urls]),x=c.useMemo(()=>{var w,$;return(($=(w=h.data)==null?void 0:w.data)==null?void 0:$.qrCodes)??{}},[(B=(H=h.data)==null?void 0:H.data)==null?void 0:B.qrCodes]),V=c.useMemo(()=>ua.filter(w=>!!R[w.key]),[R]),q=V.some(w=>w.key===i)?i:((M=V[0])==null?void 0:M.key)??"v2ray",j=R[q]||"",A=x[q],S=async()=>{!j||!await Fe(j)||(p(!0),window.setTimeout(()=>p(!1),1200))};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:v("users.qrModal.title",{defaultValue:"Quick QR"})}),e.jsx("p",{className:"text-sm text-muted",children:o.email})]}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":v("common.close",{defaultValue:"Close"}),children:e.jsx(qe,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"space-y-5 p-5 sm:p-6",children:h.isLoading?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-line/70 border-t-brand-500"})}):h.isError?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:v("users.qrModal.loadFailed",{defaultValue:"Failed to load subscription QR."})}):V.length===0?e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/60 px-4 py-6 text-center text-sm text-muted",children:v("users.qrModal.noFormats",{defaultValue:"No subscription formats available for this user."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:V.map(w=>e.jsx("button",{type:"button",onClick:()=>s(w.key),className:`rounded-lg px-3 py-2 text-xs font-medium transition ${q===w.key?"bg-brand-500 text-white":"border border-line/70 bg-card/80 text-muted hover:text-foreground"}`,children:w.label},w.key))}),e.jsxs("div",{className:"flex flex-col items-center gap-4 rounded-2xl border border-line/70 bg-panel/60 p-4",children:[e.jsx("div",{className:"rounded-xl border border-line/70 bg-white p-3",children:A?e.jsx("img",{src:A,alt:v("users.qrModal.alt",{defaultValue:"Subscription QR"}),className:"h-[220px] w-[220px]"}):e.jsx(Gs,{value:j,size:220})}),e.jsx("p",{className:"w-full break-all rounded-lg border border-line/70 bg-card/80 px-3 py-2 text-xs text-foreground",children:j})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsxs(k,{type:"button",className:"flex-1",onClick:()=>void S(),children:[l?e.jsx(zs,{className:"mr-2 h-4 w-4"}):e.jsx(Os,{className:"mr-2 h-4 w-4"}),l?v("common.copied",{defaultValue:"Copied"}):v("users.copyLink",{defaultValue:"Copy Link"})]}),e.jsxs(k,{type:"button",variant:"secondary",className:"flex-1",onClick:()=>window.open(j,"_blank","noopener,noreferrer"),children:[e.jsx(_s,{className:"mr-2 h-4 w-4"}),v("common.open",{defaultValue:"Open"})]})]})]})})]})})}const Vt=({userId:o})=>{var R;const{t:m}=Le(),v=Nt(),[i,s]=c.useState(null),l=Dt({queryKey:["user-devices",o,60],queryFn:async()=>(await ft.get(`/users/${o}/devices`,{params:{windowMinutes:60}})).data,staleTime:1e4}),p=ve({mutationFn:async x=>{await ft.delete(`/users/${o}/devices/${encodeURIComponent(x)}`)},onSuccess:async()=>{await v.invalidateQueries({queryKey:["user-devices",o,60]}),await v.invalidateQueries({queryKey:["user-sessions"]})}}),h=((R=l.data)==null?void 0:R.devices)||[];return l.isLoading?e.jsx("p",{className:"text-xs text-muted",children:m("users.devices.loading",{defaultValue:"Loading active devices..."})}):h.length===0?e.jsx("p",{className:"text-xs text-muted",children:m("users.devices.noneRecent",{defaultValue:"No devices tracked in the last {{minutes}} minutes.",minutes:60})}):e.jsxs("div",{className:"space-y-2",children:[h.slice(0,6).map(x=>e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-lg border border-line/60 bg-card/70 px-3 py-2 text-xs",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-mono text-foreground",children:x.shortFingerprint||x.fingerprint.slice(0,10)}),e.jsxs("p",{className:"text-muted",children:[x.clientIp||m("users.devices.unknownIp",{defaultValue:"unknown IP"})," •"," ",x.online?m("common.online",{defaultValue:"Online"}):m("users.devices.lastSeen",{defaultValue:"Last {{time}}",time:Zs(x.lastSeenAt)})]})]}),e.jsx(k,{size:"sm",variant:"ghost",loading:p.isPending,onClick:()=>{s(x.fingerprint)},children:m("common.revoke",{defaultValue:"Revoke"})})]},x.fingerprint)),e.jsx(Ut,{open:!!i,title:m("users.devices.revokeTitle",{defaultValue:"Revoke Device Session"}),description:m("users.devices.revokeDescription",{defaultValue:"This device will be disconnected and must refresh subscription before reconnecting."}),confirmLabel:m("common.revoke",{defaultValue:"Revoke"}),tone:"danger",loading:p.isPending,onCancel:()=>{p.isPending||s(null)},onConfirm:()=>{i&&p.mutateAsync(i).finally(()=>{s(null)})}})]})},ca=({users:o,viewMode:m="auto",onlineUuidSet:v=new Set,onView:i,onPrefetch:s,onDelete:l,onQuickQr:p,onQuickEdit:h,onRunDiagnostics:R,onRotateKeys:x,onRevokeKeys:V,onDisconnectSessions:q,onRegenerateSubscription:j,onResetTraffic:A,onExtendExpiry:S,onDisableUser:z,onKillUser:F,onCopySubscription:H,onUpdateLimits:B,selectedUserIds:M=[],onSelectionChange:w,sessionsByUserId:$={}})=>{const{t:u}=Le(),fe=80,[W,je]=c.useState([]),[N,se]=c.useState(()=>Math.min(o.length,fe)),_=o.length>0&&M.length===o.length,pe=M.length>0&&M.length<o.length;c.useEffect(()=>{se(Math.min(o.length,fe))},[o.length]),c.useEffect(()=>{if(N>=o.length)return;const r=window.setTimeout(()=>{se(C=>Math.min(o.length,C+fe))},32);return()=>{window.clearTimeout(r)}},[N,o.length]);const xe=o.slice(0,N),U=()=>{w&&w(_?[]:o.map(r=>r.id))},De=r=>{w&&(M.includes(r)?w(M.filter(C=>C!==r)):w([...M,r]))},L=r=>{je(C=>C.includes(r)?C.filter(b=>b!==r):[...C,r])},Ae=m==="auto"?"space-y-3 md:hidden":m==="cards"?"space-y-3":"hidden",T=m==="auto"?"hidden overflow-x-auto md:block":m==="table"?"overflow-x-auto":"hidden",Ne=r=>{const C={ACTIVE:"success",EXPIRED:"danger",DISABLED:"warning",LIMITED:"warning"},b={ACTIVE:"status.active",EXPIRED:"status.expired",DISABLED:"status.disabled",LIMITED:"status.limited"}[r];return e.jsx(Hs,{variant:C[r]||"info",children:b?u(b,{defaultValue:r}):r})},E=r=>e.jsxs("span",{className:`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${r?"bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"}`,children:[e.jsxs("span",{className:"relative inline-flex h-2.5 w-2.5",children:[r?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-2.5 w-2.5 rounded-full ${r?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),r?u("common.online",{defaultValue:"Online"}):u("common.offline",{defaultValue:"Offline"})]}),Ce=r=>{if(!(r!=null&&r.lastSeenAt))return u("users.sessions.noActivity",{defaultValue:"No activity"});const C=new Date(r.lastSeenAt).getTime();if(Number.isNaN(C))return u("users.sessions.noActivity",{defaultValue:"No activity"});const b=Math.floor((Date.now()-C)/6e4);if(b<1)return u("users.sessions.justNow",{defaultValue:"just now"});if(b<60)return u("users.sessions.minutesAgo",{defaultValue:"{{count}}m ago",count:b});const O=Math.floor(b/60);if(O<24)return u("users.sessions.hoursAgo",{defaultValue:"{{count}}h ago",count:O});const ae=Math.floor(O/24);return u("users.sessions.daysAgo",{defaultValue:"{{count}}d ago",count:ae})},d=r=>{var O;if(!r)return"";const C=((O=r.currentInbound)==null?void 0:O.tag)||"",b=r.currentIp||"";return C&&b?`${C} • ${b}`:C||b||""},Se=(r,C=!1)=>{const b=[];return p&&b.push({key:"qr",label:u("users.actions.showQr",{defaultValue:"Show QR"}),onClick:()=>p(r)}),h&&b.push({key:"edit",label:u("users.actions.quickEdit",{defaultValue:"Quick Edit"}),onClick:()=>h(r)}),R&&b.push({key:"diagnostics",label:u("users.actions.runDiagnostics",{defaultValue:"Run diagnostics"}),onClick:()=>R(r)}),!h&&B&&b.push({key:"limits",label:u("users.actions.increaseLimits",{defaultValue:"Increase limits"}),onClick:()=>B(r,{ipLimit:Number(r.ipLimit||0)+1,deviceLimit:Number(r.deviceLimit||0)+1})}),H&&b.push({key:"copy-sub",label:u("users.actions.copySubscription",{defaultValue:"Copy Subscription"}),onClick:()=>H(r)}),j&&b.push({key:"regen-token",label:u("users.actions.regenerateToken",{defaultValue:"Regenerate Token"}),onClick:()=>j(r)}),S&&(b.push({key:"extend7",label:u("users.actions.extend7",{defaultValue:"Extend +7 Days"}),onClick:()=>S(r,7)}),b.push({key:"extend30",label:u("users.actions.extend30",{defaultValue:"Extend +30 Days"}),onClick:()=>S(r,30)})),A&&b.push({key:"reset-traffic",label:u("users.actions.resetTraffic",{defaultValue:"Reset Traffic"}),onClick:()=>A(r)}),q&&b.push({key:"disconnect",label:u("users.actions.disconnectSessions",{defaultValue:"Disconnect Sessions"}),onClick:()=>q(r)}),x&&b.push({key:"rotate",label:u("users.actions.rotateCredentials",{defaultValue:"Rotate Credentials"}),onClick:()=>x(r)}),V&&b.push({key:"revoke",label:u("users.actions.revokeAccess",{defaultValue:"Revoke Access"}),onClick:()=>V(r)}),z&&b.push({key:"disable",label:u("users.actions.disableUser",{defaultValue:"Disable User"}),onClick:()=>z(r)}),F&&b.push({key:"kill",label:"Kill Connection",tone:"danger",onClick:()=>F(r)}),l&&b.push({key:"delete",label:u("users.actions.deleteUser",{defaultValue:"Delete User"}),tone:"danger",onClick:()=>l(r.id)}),b.length===0?null:e.jsx(Xs,{items:b,ariaLabel:u("common.moreActions",{defaultValue:"More actions"}),triggerClassName:`rounded-lg border border-line/60 bg-card/70 px-2 py-1 text-foreground transition hover:bg-panel/70 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-50 ${C?"inline-flex h-10 w-10 items-center justify-center":"inline-flex h-8 w-8 items-center justify-center"}`,children:e.jsx(Rt,{className:"h-4 w-4"})})};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:Ae,children:[w?e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-line/70 bg-card/75 px-4 py-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-foreground",children:[e.jsx("input",{type:"checkbox",checked:_,ref:r=>{r&&(r.indeterminate=pe)},onChange:U,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),u("common.selectAll",{defaultValue:"Select All"})]}),e.jsx("span",{className:"text-xs text-muted",children:u("users.selectedCount",{defaultValue:"{{count}} selected",count:M.length})})]}):null,xe.map(r=>{var Ve;const C=Number(r.uploadUsed||0),b=Number(r.downloadUsed||0),O=Number(r.dataLimit||0),ae=C+b,re=O>0?(ae/O*100).toFixed(1):"0.0",le=!!r.startOnFirstUse&&!r.firstUsedAt,be=le?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,te=le?be||0:xt(r.expireDate),g=$[r.id],Y=(g==null?void 0:g.online)??v.has(r.uuid),J=Number.isFinite(g==null?void 0:g.activeKeyCount)?Number(g==null?void 0:g.activeKeyCount):Number(((Ve=r.inbounds)==null?void 0:Ve.length)||0),ue=Number.isFinite(g==null?void 0:g.onlineKeyCount)?Number(g==null?void 0:g.onlineKeyCount):Y?Math.min(1,J||1):0,we=d(g),Re=Ce(g);return e.jsxs("div",{className:"rounded-xl border border-line/70 bg-card/80 p-4",onMouseEnter:()=>s==null?void 0:s(r),onFocus:()=>s==null?void 0:s(r),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("button",{type:"button",className:"truncate text-left text-sm font-medium text-foreground transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40",onClick:()=>i(r),children:r.email}),e.jsxs("p",{className:"font-mono text-xs text-muted",children:[r.uuid.substring(0,8),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[w?e.jsx("input",{type:"checkbox",checked:M.includes(r.id),onChange:()=>De(r.id),className:"mt-0.5 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}):null,Se(r,!0)]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[Ne(r.status),E(Y),e.jsx("span",{className:"text-xs text-muted",children:u("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:ue,total:J||0})}),e.jsx("span",{className:"text-xs text-muted",children:u("users.limitIpShort",{defaultValue:"IP {{count}}",count:Number(r.ipLimit||0)})}),e.jsx("span",{className:"text-xs text-muted",children:u("users.limitDeviceShort",{defaultValue:"DEV {{count}}",count:Number(r.deviceLimit||0)})}),we?e.jsx("span",{className:"text-xs text-muted",children:we}):null,Y?null:e.jsx("span",{className:"text-xs text-muted",children:u("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Re})})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-xs text-foreground",children:[Te(ae)," / ",Te(O)]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(re)>90?"bg-red-600":Number.parseFloat(re)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(re),100)}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted",children:[e.jsx("span",{children:u("users.usagePercent",{defaultValue:"{{percent}}% used",percent:re})}),le?e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:u("users.startOnFirstConnectBadge",{defaultValue:"Starts on first connect (+{{days}}d)",days:be})}):e.jsx("span",{className:te<7?"text-red-600 dark:text-red-400":"",children:te>0?u("common.daysLeft",{defaultValue:"{{count}} days left",count:te}):u("common.expired",{defaultValue:"Expired"})})]})]}),e.jsxs("button",{type:"button",onClick:()=>L(r.id),className:"mt-3 flex w-full items-center justify-between rounded-xl border border-line/60 bg-panel/35 px-4 py-3 text-left text-sm text-foreground transition hover:bg-panel/55","aria-label":W.includes(r.id)?u("users.devices.hide",{defaultValue:"Hide devices"}):u("users.devices.show",{defaultValue:"Show devices"}),children:[e.jsx("span",{className:"font-medium",children:u("users.devices.title",{defaultValue:"Devices"})}),W.includes(r.id)?e.jsx(bt,{className:"h-4 w-4 text-brand-500"}):e.jsx(Pe,{className:"h-4 w-4 text-brand-500"})]}),W.includes(r.id)?e.jsx("div",{className:"mt-3 rounded-lg border border-line/60 bg-panel/50 p-3",children:e.jsx(Vt,{userId:r.id})}):null]},`mobile-${r.id}`)})]}),e.jsx("div",{className:T,children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800/50",children:e.jsxs("tr",{children:[w&&e.jsx("th",{className:"w-12 px-6 py-3",children:e.jsx("input",{type:"checkbox",checked:_,ref:r=>{r&&(r.indeterminate=pe)},onChange:U,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("users.table.user",{defaultValue:"User"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("common.status",{defaultValue:"Status"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("common.online",{defaultValue:"Online"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("users.table.dataUsage",{defaultValue:"Data Usage"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("users.table.limits",{defaultValue:"Limits"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("common.expiry",{defaultValue:"Expiry"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("users.devices.title",{defaultValue:"Devices"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400",children:u("common.actions",{defaultValue:"Actions"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-800",children:xe.map(r=>{var Ve;const C=Number(r.uploadUsed||0),b=Number(r.downloadUsed||0),O=Number(r.dataLimit||0),ae=C+b,re=O>0?(ae/O*100).toFixed(1):"0.0",le=!!r.startOnFirstUse&&!r.firstUsedAt,be=le?Math.max(1,Math.ceil((new Date(r.expireDate).getTime()-new Date(r.createdAt).getTime())/(1e3*60*60*24))):null,te=le?be||0:xt(r.expireDate),g=$[r.id],Y=(g==null?void 0:g.online)??v.has(r.uuid),J=Number.isFinite(g==null?void 0:g.activeKeyCount)?Number(g==null?void 0:g.activeKeyCount):Number(((Ve=r.inbounds)==null?void 0:Ve.length)||0),ue=Number.isFinite(g==null?void 0:g.onlineKeyCount)?Number(g==null?void 0:g.onlineKeyCount):Y?Math.min(1,J||1):0,we=d(g),Re=Ce(g);return e.jsxs(c.Fragment,{children:[e.jsxs("tr",{className:"transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50",onMouseEnter:()=>s==null?void 0:s(r),children:[w&&e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"checkbox",checked:M.includes(r.id),onChange:()=>De(r.id),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{type:"button",className:"text-left text-sm font-medium text-gray-900 transition hover:text-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:text-white",onClick:()=>i(r),children:r.email}),e.jsxs("span",{className:"font-mono text-xs text-gray-500 dark:text-gray-400",children:[r.uuid.substring(0,8),"..."]})]})}),e.jsx("td",{className:"px-6 py-4",children:Ne(r.status)}),e.jsxs("td",{className:"px-6 py-4",children:[E(Y),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:u("users.keysActive",{defaultValue:"Keys {{online}}/{{total}} active",online:ue,total:J||0})}),we?e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:we}):null,Y?null:e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:u("users.sessions.lastSeenPrefix",{defaultValue:"Last seen {{label}}",label:Re})})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:[Te(ae)," / ",Te(O)]}),e.jsx("div",{className:"mt-1 h-2 w-32 rounded-full bg-gray-200 dark:bg-gray-700",children:e.jsx("div",{className:`h-2 rounded-full ${Number.parseFloat(re)>90?"bg-red-600":Number.parseFloat(re)>70?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(Number.parseFloat(re),100)}%`}})}),e.jsx("span",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:u("users.usagePercent",{defaultValue:"{{percent}}% used",percent:re})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:u("users.limitIpAbbrev",{defaultValue:"IP"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.ipLimit||0)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted",children:u("users.limitDeviceAbbrev",{defaultValue:"DEV"})}),e.jsx("span",{className:"font-semibold text-foreground",children:Number(r.deviceLimit||0)})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:le?u("users.startOnFirstConnect",{defaultValue:"Starts on first connect"}):new Date(r.expireDate).toLocaleDateString()}),le?e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400",children:u("users.startOnFirstConnectAfter",{defaultValue:"{{count}} days after first connect",count:be||0})}):e.jsx("span",{className:`text-xs ${te<7?"text-red-600 dark:text-red-400":te<30?"text-yellow-600 dark:text-yellow-400":"text-gray-500 dark:text-gray-400"}`,children:te>0?u("common.daysLeft",{defaultValue:"{{count}} days left",count:te}):u("common.expired",{defaultValue:"Expired"})})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>L(r.id),"aria-label":W.includes(r.id)?u("users.devices.hide",{defaultValue:"Hide devices"}):u("users.devices.show",{defaultValue:"Show devices"}),children:W.includes(r.id)?e.jsx(bt,{className:"h-4 w-4 text-brand-500"}):e.jsx(Pe,{className:"h-4 w-4 text-brand-500"})})}),e.jsx("td",{className:"px-6 py-4",children:Se(r)})]}),W.includes(r.id)?e.jsx("tr",{className:"bg-panel/45",children:e.jsx("td",{colSpan:(w?1:0)+8,className:"px-6 py-4",children:e.jsx(Vt,{userId:r.id})})}):null]},r.id)})})]})}),N<o.length?e.jsx("div",{className:"flex items-center justify-center rounded-xl border border-line/60 bg-card/60 px-3 py-2 text-xs text-muted",children:u("users.rendering",{defaultValue:"Rendering {{count}} of {{total}} users...",count:N,total:o.length})}):null]})};function ma({open:o,title:m,description:v,label:i="Value",placeholder:s,defaultValue:l="",inputType:p="text",confirmLabel:h="Save",cancelLabel:R="Cancel",loading:x=!1,onCancel:V,onConfirm:q}){const[j,A]=c.useState(l);return c.useEffect(()=>{o&&A(l)},[l,o]),o?e.jsx("div",{className:"fixed inset-0 z-[110] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:S=>{S.target===S.currentTarget&&!x&&V()},children:e.jsxs("div",{className:"w-full max-w-md overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/20",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-5",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"mt-0.5 rounded-full bg-brand-500/15 p-1 text-brand-400",children:e.jsx(aa,{className:"h-4 w-4"})}),e.jsx("h3",{className:"text-base font-semibold text-foreground",children:m})]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:V,disabled:x,"aria-label":"Close dialog",children:e.jsx(qe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 px-4 py-4 sm:px-5",children:[v?e.jsx("p",{className:"whitespace-pre-wrap text-sm text-muted",children:v}):null,e.jsxs("label",{className:"space-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-foreground",children:i}),e.jsx("input",{autoFocus:!0,type:p,className:"w-full rounded-xl border border-line/80 bg-card/80 px-3 py-2 text-sm text-foreground outline-none transition focus:border-brand-500/70 focus:ring-2 focus:ring-brand-500/35",placeholder:s,value:j,disabled:x,onChange:S=>{A(S.target.value)},onKeyDown:S=>{S.key==="Enter"&&!x&&(S.preventDefault(),q(j)),S.key==="Escape"&&!x&&(S.preventDefault(),V())}})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-5",children:[e.jsx(k,{type:"button",variant:"secondary",onClick:V,disabled:x,children:R}),e.jsx(k,{type:"button",variant:"primary",onClick:()=>q(j),loading:x,disabled:x,children:h})]})]})}):null}function fa(o){if(!o||typeof o!="object")return;const m=o.meta||o.pagination;if(m)return m}function kt(o){return`"${(o==null?"":String(o)).replace(/"/g,'""')}"`}function pa(){var ut,dt,ct;const o=vs(),m=Nt(),[v,i]=ws(),{t:s}=Le(),l=Ct(),p=Vs(t=>t.admin),h=(p==null?void 0:p.role)==="SUPER_ADMIN",R=Js("one-ui/users-filters",{page:1,search:"",status:"",viewMode:"auto"}),{views:x,saveView:V,deleteView:q}=ea("one-ui/users-saved-views"),[j,A]=c.useState(""),S=R.value.page,z=R.value.search,F=R.value.status,H=R.value.viewMode,B=R.setValue,M=c.useCallback(t=>{B(a=>{const n=typeof t=="function"?t(a.page):t;return{...a,page:Math.max(1,n)}})},[B]),w=c.useCallback(t=>{B(a=>({...a,search:t}))},[B]),$=c.useCallback(t=>{B(a=>({...a,status:t}))},[B]),u=c.useCallback(t=>{B(a=>({...a,viewMode:t}))},[B]),[fe,W]=c.useState(!1),[je,N]=c.useState(!1),[se,_]=c.useState(null),[pe,xe]=c.useState(null),[U,De]=c.useState(null),[L,Ae]=c.useState(null),[T,Ne]=c.useState(null),[E,Ce]=c.useState(null),[d,Se]=c.useState([]),[r,C]=c.useState(""),[b,O]=c.useState("DISABLED"),[ae,re]=c.useState(()=>typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(max-width: 1023px), (pointer: coarse)").matches),le=Ys(z,320),be=v.get("quick"),te=c.useRef(null),g=c.useRef(null),Y=ae?15e3:5e3,J=Ss({page:S,limit:50,search:le,status:F||void 0}),ue=js({page:1,limit:100,includeDisabled:!1}),we=Ls(),Re=Ds(),Ve=Rs(),Mt=Us(),At=Ms(),He=As(),Xe=Es(),Ze=Is(),Be=Ts(),Ye=Fs(),Je=Ps(),Et=qs({refetchInterval:Y,staleTime:Y}),et=Bs(),It=$s(),Ue=ve({mutationFn:({userIds:t,dryRun:a})=>me.bulkReorderUserInboundsByPattern({userIds:t,pattern:"myanmar",dryRun:a})}),Me=ve({mutationFn:({userIds:t,dryRun:a,windowMinutes:n})=>me.bulkReorderUserInboundsByQuality({userIds:t,windowMinutes:n,dryRun:a})}),$e=ve({mutationFn:({groupId:t,userIds:a})=>Ie.addUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Ke=ve({mutationFn:({groupId:t,userIds:a})=>Ie.removeUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Qe=ve({mutationFn:({groupId:t,userIds:a})=>Ie.moveUsers(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]})])}}),Ee=ve({mutationFn:({groupId:t,payload:a})=>Ie.applyPolicy(t,a),onSuccess:async(t,a)=>{await Promise.all([m.invalidateQueries({queryKey:["groups"]}),m.invalidateQueries({queryKey:["group",a.groupId]}),m.invalidateQueries({queryKey:["users"]}),m.invalidateQueries({queryKey:["user-effective-policy"]})])}}),Tt=ve({mutationFn:({userId:t,payload:a})=>me.updateUser(t,a),onMutate:async({userId:t,payload:a})=>{const n=m.getQueriesData({queryKey:["users"]});return m.setQueriesData({queryKey:["users"]},f=>!f||!Array.isArray(f.data)?f:{...f,data:f.data.map(y=>y.id===t?{...y,ipLimit:a.ipLimit??y.ipLimit,deviceLimit:a.deviceLimit??y.deviceLimit}:y)}),{previousUsersQueries:n}},onError:(t,a,n)=>{if(n!=null&&n.previousUsersQueries)for(const[f,y]of n.previousUsersQueries)m.setQueryData(f,y)},onSuccess:async(t,a)=>{var n;(n=t==null?void 0:t.data)!=null&&n.id&&m.setQueryData(["user",a.userId],{success:!0,data:t.data}),await Promise.all([m.invalidateQueries({queryKey:["user",a.userId]}),m.invalidateQueries({queryKey:["user-devices",a.userId,60]})])}}),I=c.useMemo(()=>{var t;return((t=J.data)==null?void 0:t.data)??[]},[J.data]),oe=c.useMemo(()=>{var t;return((t=ue.data)==null?void 0:t.data)??[]},[ue.data]),ge=c.useMemo(()=>fa(J.data),[J.data]),Ft=c.useMemo(()=>I.map(t=>t.id),[I]),P=Ks(Ft,{includeOffline:!0,live:!ae,refetchInterval:Y,staleTime:Y}),Ge=c.useMemo(()=>{var t;return Object.fromEntries((((t=P.data)==null?void 0:t.sessions)||[]).map(a=>[a.userId,a]))},[(ut=P.data)==null?void 0:ut.sessions]),Oe=c.useMemo(()=>{var t;return new Set((((t=P.data)==null?void 0:t.sessions)||[]).filter(a=>a.online).map(a=>String(a.uuid||"")))},[(dt=P.data)==null?void 0:dt.sessions]),Pt=c.useMemo(()=>I.filter(t=>t.status==="ACTIVE").length,[I]),ze=c.useMemo(()=>I.filter(t=>{var a;return((a=Ge[t.id])==null?void 0:a.online)||Oe.has(t.uuid)}).length,[Oe,Ge,I]),qt=c.useMemo(()=>I.filter(t=>t.status==="LIMITED").length,[I]),Bt=c.useMemo(()=>I.filter(t=>t.status==="EXPIRED").length,[I]),We=c.useMemo(()=>I.filter(t=>d.includes(t.id)),[I,d]),tt=h,_e=h,K=He.isPending||Xe.isPending||Ze.isPending||Be.isPending||Ye.isPending||Je.isPending||Ue.isPending||Me.isPending||$e.isPending||Ke.isPending||Qe.isPending||Ee.isPending,$t=c.useMemo(()=>P.streamStatus==="connected"?s("users.streamStatus.connected",{defaultValue:"Connected"}):P.streamStatus==="connecting"?P.reconnectAttempts>0?s("users.streamStatus.reconnecting",{defaultValue:"Reconnecting ({{count}})",count:P.reconnectAttempts}):s("users.streamStatus.connecting",{defaultValue:"Connecting"}):P.streamStatus==="error"?s("common.error",{defaultValue:"Error"}):s("users.streamStatus.idle",{defaultValue:"Idle"}),[s,P.reconnectAttempts,P.streamStatus]),Kt=c.useMemo(()=>{if(!P.lastSnapshotAt)return s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"});const t=new Date(P.lastSnapshotAt);return Number.isNaN(t.getTime())?s("users.streamSnapshot.none",{defaultValue:"No live snapshot yet"}):s("users.streamSnapshot.lastUpdate",{defaultValue:"Last update {{time}}",time:t.toLocaleTimeString()})},[s,P.lastSnapshotAt]),ne=(ct=Et.data)==null?void 0:ct.data,Qt=c.useMemo(()=>{const t=(ne==null?void 0:ne.status)||"stopped";return t==="healthy"?s("users.telemetry.healthy",{defaultValue:"Healthy"}):t==="degraded"?s("users.telemetry.degraded",{defaultValue:"Degraded"}):t==="stale"?s("users.telemetry.stale",{defaultValue:"Stale"}):t==="starting"?s("users.telemetry.starting",{defaultValue:"Starting"}):s("users.telemetry.stopped",{defaultValue:"Stopped"})},[s,ne==null?void 0:ne.status]),Gt=c.useMemo(()=>!ne||ne.lagMs===null||ne.lagMs===void 0?s("users.telemetry.noLag",{defaultValue:"No lag data yet"}):s("users.telemetry.lag",{defaultValue:"Lag {{seconds}}s",seconds:Math.max(0,Math.round(ne.lagMs/1e3))}),[s,ne]);c.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const t=window.matchMedia("(max-width: 1023px), (pointer: coarse)"),a=n=>{re(n?n.matches:t.matches)};return a(),typeof t.addEventListener=="function"?(t.addEventListener("change",a),()=>t.removeEventListener("change",a)):(t.addListener(a),()=>t.removeListener(a))},[]),c.useEffect(()=>{M(1)},[le,M,F]),c.useEffect(()=>{Se(t=>t.filter(a=>I.some(n=>n.id===a)))},[I]),c.useEffect(()=>{if(!oe.length){r!==""&&C("");return}oe.some(a=>String(a.id)===r)||C(String(oe[0].id))},[oe,r]),c.useEffect(()=>{if(be==="create"){W(!0);const t=new URLSearchParams(v);t.delete("quick"),i(t,{replace:!0})}},[be,v,i]);const Q=({title:t,description:a,confirmLabel:n="Confirm",tone:f="danger"})=>new Promise(y=>{te.current=y,De({title:t,description:a,confirmLabel:n,tone:f})}),st=t=>{const a=te.current;te.current=null,De(null),a&&a(t)},at=({title:t,description:a,label:n,placeholder:f,defaultValue:y="",inputType:G="text",confirmLabel:de="Save"})=>new Promise(he=>{g.current=he,Ae({title:t,description:a,label:n,placeholder:f,defaultValue:y,inputType:G,confirmLabel:de})}),rt=t=>{const a=g.current;g.current=null,Ae(null),a&&a(t)},Ot=async t=>{if(await Q({title:"Kill Connection",description:"Are you sure you want to instantly drop all active socket connections for this user?",confirmLabel:"Kill Connection",tone:"danger"}))try{await Re.mutateAsync(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),"User connection killed successfully")}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||"Failed to kill connection")}},zt=async t=>{if(await Q({title:s("users.deleteUser",{defaultValue:"Delete User"}),description:s("users.confirmDelete",{defaultValue:"Are you sure you want to delete this user?"}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await we.mutateAsync(t),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.userDeleted",{defaultValue:"User deleted successfully"}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.deleteFailed",{defaultValue:"Failed to delete user"}))}},Wt=()=>{if(I.length===0)return;const t=[[s("users.email",{defaultValue:"Email"}),s("users.uuid",{defaultValue:"UUID"}),s("common.status",{defaultValue:"Status"}),s("users.dataUsed",{defaultValue:"Data Used"}),s("users.dataLimit",{defaultValue:"Data Limit"}),s("users.expireDate",{defaultValue:"Expire Date"})].map(kt).join(","),...I.map(y=>[y.email,y.uuid,y.status,Number(y.uploadUsed)+Number(y.downloadUsed),y.dataLimit,y.expireDate].map(kt).join(","))].join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=window.URL.createObjectURL(a),f=document.createElement("a");f.href=n,f.setAttribute("download",`users-${new Date().toISOString()}.csv`),f.click(),window.URL.revokeObjectURL(n)},ee=()=>{Se([])},_t=t=>{const a=t,n=a==null?void 0:a.closest("details");n&&(n.open=!1)},X=(t,a)=>{t.preventDefault(),t.stopPropagation(),a&&a(),_t(t.currentTarget)},D=async(t={})=>{const a=[J.refetch()];P.streamStatus!=="connected"&&a.push(P.refetch()),t.includeGroups&&a.push(ue.refetch()),await Promise.all(a)},ie=ta(()=>D(),{enabled:!ae,intervalMs:Y}),lt=c.useMemo(()=>ie.enabled?s("autoRefresh.line",{defaultValue:"Auto refresh: {{status}} ({{seconds}}s)",status:ie.statusLabel,seconds:Math.ceil(ie.nextRunInMs/1e3)}):s("autoRefresh.mobileOff",{defaultValue:"Auto refresh: Off on mobile (smooth scrolling mode)"}),[ie.enabled,ie.nextRunInMs,ie.statusLabel,s]),nt=async()=>{const t=await at({title:s("common.saveView",{defaultValue:"Save View"}),description:s("users.views.saveDescription",{defaultValue:"Create a reusable filter preset for this Users page."}),label:s("users.views.nameLabel",{defaultValue:"View name"}),placeholder:s("users.views.namePlaceholder",{defaultValue:"My team filter"}),confirmLabel:s("common.saveView",{defaultValue:"Save View"})});if(!(!t||!t.trim()))try{const a=V(t.trim(),{search:z,status:F,viewMode:H});A(a.id),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.savedToast",{defaultValue:'View "{{name}}" saved',name:a.name}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.views.saveFailed",{defaultValue:"Unable to save view"}))}},it=t=>{A(t);const a=x.find(n=>n.id===t);a&&(R.setValue(n=>({...n,page:1,search:a.filters.search||"",status:a.filters.status||"",viewMode:a.filters.viewMode||"auto"})),l.success(s("common.success",{defaultValue:"Success"}),s("users.views.appliedToast",{defaultValue:'Applied "{{name}}"',name:a.name})))},ot=()=>{if(!j)return;const t=x.find(a=>a.id===j);q(j),A(""),l.info(s("common.info",{defaultValue:"Info"}),t?s("users.views.removedToast",{defaultValue:'Removed "{{name}}"',name:t.name}):s("users.views.removedToastGeneric",{defaultValue:"Saved view removed"}))},Ht=async()=>{if(d.length!==0&&await Q({title:s("users.bulk.deleteTitle",{defaultValue:"Delete Selected Users"}),description:s("users.bulk.deleteDescription",{defaultValue:"Delete {{count}} selected users? This cannot be undone.",count:d.length}),confirmLabel:s("common.delete",{defaultValue:"Delete"}),tone:"danger"}))try{await He.mutateAsync(d),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkDeleted",{defaultValue:"{{count}} user(s) deleted.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkDeleteFailed",{defaultValue:"Failed to delete selected users"}))}},Xt=async()=>{if(d.length!==0&&await Q({title:s("users.bulk.resetTrafficTitle",{defaultValue:"Reset Traffic"}),description:s("users.bulk.resetTrafficDescription",{defaultValue:"Reset traffic for {{count}} selected users?",count:d.length}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await Xe.mutateAsync(d),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkTrafficReset",{defaultValue:"{{count}} user(s) reset.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkResetFailed",{defaultValue:"Failed to reset traffic"}))}},Zt=async()=>{if(d.length===0)return;const t=await at({title:s("users.bulk.extendExpiryTitle",{defaultValue:"Extend Expiry"}),description:s("users.bulk.extendExpiryDescription",{defaultValue:"Extend expiry for {{count}} selected users.",count:d.length}),label:s("users.bulk.daysToAdd",{defaultValue:"Days to add"}),defaultValue:"30",inputType:"number",confirmLabel:s("common.extend",{defaultValue:"Extend"})});if(!t||!t.trim())return;const a=Number.parseInt(t,10);if(Number.isNaN(a)||a<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.invalidDays",{defaultValue:"Please enter a valid positive number of days."}));return}try{await Ze.mutateAsync({userIds:d,days:a}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkExpiryExtended",{defaultValue:"{{count}} user(s) extended by {{days}} day(s).",count:d.length,days:a}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.bulkExtendFailed",{defaultValue:"Failed to extend expiry"}))}},Yt=async()=>{if(d.length!==0&&await Q({title:s("users.bulk.applyStatusTitle",{defaultValue:"Apply Status"}),description:s("users.bulk.applyStatusDescription",{defaultValue:"Set status to {{status}} for {{count}} selected users?",status:b,count:d.length}),confirmLabel:s("common.apply",{defaultValue:"Apply"}),tone:"primary"}))try{await Be.mutateAsync({userIds:d,status:b}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkStatusUpdated",{defaultValue:"{{count}} user(s) set to {{status}}.",count:d.length,status:b}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkUpdateFailed",{defaultValue:"Failed to update status"}))}},Jt=async()=>{if(d.length!==0&&await Q({title:s("users.bulk.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.bulk.rotateDescription",{defaultValue:"Rotate credentials for {{count}} selected users?",count:d.length}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await Ye.mutateAsync({userIds:d,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRotated",{defaultValue:"{{count}} user(s) rotated.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRotateFailed",{defaultValue:"Failed to rotate selected user keys"}))}},es=async()=>{if(d.length!==0&&await Q({title:s("users.bulk.revokeTitle",{defaultValue:"Revoke Access"}),description:s("users.bulk.revokeDescription",{defaultValue:"Revoke access for {{count}} selected users?",count:d.length}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await Je.mutateAsync({userIds:d,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.bulkRevoked",{defaultValue:"{{count}} user(s) revoked.",count:d.length}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.bulkRevokeFailed",{defaultValue:"Failed to revoke selected user access"}))}},ts=async(t,a)=>{try{await Tt.mutateAsync({userId:t.id,payload:a}),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.limitUpdated",{defaultValue:"User limits updated."}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.limitUpdateFailed",{defaultValue:"Failed to update user limits"}))}},ss=async t=>{var a;try{const n=await It.mutateAsync({id:t.id,payload:{windowMinutes:60,portProbeTimeoutMs:1200}}),f=n==null?void 0:n.data;if(!f){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.diagnosticsEmpty",{defaultValue:"No diagnostics result returned."}));return}const y=f.summary||{pass:0,warn:0,fail:0},G=s("users.toast.diagnosticsSummary",{defaultValue:"PASS {{pass}} • WARN {{warn}} • FAIL {{fail}}",pass:y.pass,warn:y.warn,fail:y.fail});if(y.fail>0||y.warn>0){const de=(a=f.recommendedActions)==null?void 0:a[0];l.warning(s("users.toast.diagnosticsTitle",{defaultValue:"Diagnostics completed"}),de?`${G} • ${de}`:G,12e3)}else l.success(s("users.toast.diagnosticsTitle",{defaultValue:"Diagnostics completed"}),G)}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.diagnosticsFailed",{defaultValue:"Failed to run diagnostics"}))}},as=async()=>{var t;try{const a=await et.mutateAsync(),n=(t=a==null?void 0:a.data)==null?void 0:t.summary,f=Number((n==null?void 0:n.updatedUsers)||0),y=Number((n==null?void 0:n.changedKeys)||0);l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.autotuneSummary",{defaultValue:"Smart fallback completed. Updated users: {{users}}, changed keys: {{keys}}.",users:f,keys:y}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.autotuneFailed",{defaultValue:"Failed to run smart fallback autotune"}))}},rs=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=oe.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await Q({title:s("users.bulk.assignTitle",{defaultValue:"Assign To Group"}),description:s("users.bulk.assignDescription",{defaultValue:'Assign {{count}} selected users to group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.assign",{defaultValue:"Assign"}),tone:"primary"}))try{await $e.mutateAsync({groupId:t,userIds:d}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.assignedToGroup",{defaultValue:"{{count}} user(s) assigned to {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.assignFailed",{defaultValue:"Failed to assign users to group"}))}},ls=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=oe.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await Q({title:s("users.bulk.removeTitle",{defaultValue:"Remove From Group"}),description:s("users.bulk.removeDescription",{defaultValue:'Remove {{count}} selected users from group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.remove",{defaultValue:"Remove"}),tone:"danger"}))try{await Ke.mutateAsync({groupId:t,userIds:d}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.removedFromGroup",{defaultValue:"{{count}} user(s) removed from {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.removeFailed",{defaultValue:"Failed to remove users from group"}))}},ns=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=oe.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;if(await Q({title:s("users.bulk.moveTitle",{defaultValue:"Move To Group"}),description:s("users.bulk.moveDescription",{defaultValue:'Move {{count}} selected users exclusively to group "{{group}}"?',count:d.length,group:n}),confirmLabel:s("common.move",{defaultValue:"Move"}),tone:"primary"}))try{await Qe.mutateAsync({groupId:t,userIds:d}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.movedToGroup",{defaultValue:"{{count}} user(s) moved to {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.moveFailed",{defaultValue:"Failed to move users to group"}))}},is=async()=>{if(d.length===0)return;if(!r){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.selectGroupFirst",{defaultValue:"Select a group first"}));return}const t=Number.parseInt(r,10);if(!Number.isInteger(t)||t<1){l.warning(s("common.warning",{defaultValue:"Warning"}),s("users.toast.groupInvalid",{defaultValue:"Selected group is invalid."}));return}const a=oe.find(f=>f.id===t),n=(a==null?void 0:a.name)||`#${t}`;try{const y=(await Ee.mutateAsync({groupId:t,payload:{dryRun:!0,userIds:d}})).data||{},G=y.summary||{},he=(Array.isArray(y.preview)?y.preview:[]).slice(0,2).map(mt=>`${mt.email}: ${Object.keys(mt.changes||{}).join(", ")||s("common.noChanges",{defaultValue:"no changes"})}`).join(`
`),ce=[s("users.bulk.policyDryRunTitle",{defaultValue:'Group policy dry-run for "{{group}}":',group:n}),s("users.bulk.policyDryRunTarget",{defaultValue:"- target users: {{count}}",count:G.targetUsers??d.length}),s("users.bulk.policyDryRunWouldUpdate",{defaultValue:"- would update: {{count}}",count:G.wouldUpdateUsers??0}),s("users.bulk.policyDryRunSkipped",{defaultValue:"- skipped: {{count}}",count:G.skippedUsers??0}),he?`
${s("common.preview",{defaultValue:"Preview"})}:
${he}`:"",`
${s("users.bulk.applyNow",{defaultValue:"Apply now?"})}`].filter(Boolean).join(`
`);if(!await Q({title:s("users.bulk.applyPolicyTitle",{defaultValue:"Apply Group Policy"}),description:ce,confirmLabel:s("users.bulk.applyPolicyConfirm",{defaultValue:"Apply Policy"}),tone:"primary"}))return;await Ee.mutateAsync({groupId:t,payload:{dryRun:!1,userIds:d}}),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.policyApplied",{defaultValue:"{{count}} user(s) updated from {{group}}.",count:d.length,group:n}))}catch(f){l.error(s("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||s("users.toast.policyApplyFailed",{defaultValue:"Failed to apply group policy"}))}},os=async()=>{if(d.length!==0)try{const a=(await Ue.mutateAsync({userIds:d,dryRun:!0})).data||{},n=a.summary||{},y=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(G=>{const de=(G.currentTop3||[]).map(ce=>ce.key).join(" > ")||"none",he=(G.newTop3||[]).map(ce=>ce.key).join(" > ")||"none";return`${G.email}: ${de} -> ${he}`}).filter(Boolean);Ne({userIds:[...d],targetUsers:n.targetUsers??d.length,wouldUpdateUsers:n.wouldUpdateUsers??0,unchangedUsers:n.unchangedUsers??0,changedKeys:n.changedKeys??0,matchedUsers:n.matchedUsers??0,previewLines:y})}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},us=async()=>{if(T)try{await Ue.mutateAsync({userIds:T.userIds,dryRun:!1});const t=T.wouldUpdateUsers??0;Ne(null),ee(),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.myanmarPriorityApplied",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("users.toast.myanmarPriorityFailed",{defaultValue:"Failed to reorder selected users"}))}},ds=async()=>{if(d.length!==0)try{const a=(await Me.mutateAsync({userIds:d,windowMinutes:60,dryRun:!0})).data||{},n=a.summary||{},y=(Array.isArray(a.preview)?a.preview:[]).slice(0,2).map(G=>{const de=(G.currentTop3||[]).map(ce=>ce.key).join(" > ")||"none",he=(G.newTop3||[]).map(ce=>ce.key).join(" > ")||"none";return`${G.email}: ${de} -> ${he}`}).filter(Boolean);Ce({userIds:[...d],targetUsers:n.targetUsers??d.length,wouldUpdateUsers:n.wouldUpdateUsers??0,unchangedUsers:n.unchangedUsers??0,changedKeys:n.changedKeys??0,scoredKeys:n.scoredKeys??0,previewLines:y})}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},cs=async()=>{if(E)try{await Me.mutateAsync({userIds:E.userIds,windowMinutes:60,dryRun:!1});const t=E.wouldUpdateUsers??0;Ce(null),ee(),await D(),l.success(s("users.autoTuneAppliedTitle",{defaultValue:"Auto-tune applied"}),s("users.autoTuneAppliedBody",{defaultValue:"{{count}} user(s) reordered.",count:t}))}catch(t){l.error(s("users.autoTuneFailedTitle",{defaultValue:"Auto-tune failed"}),(t==null?void 0:t.message)||s("users.autoTuneFailedBody",{defaultValue:"Failed to auto-tune selected users"}))}},ms=async t=>{if(await Q({title:s("users.actions.rotateTitle",{defaultValue:"Rotate Credentials"}),description:s("users.actions.rotateDescription",{defaultValue:"Rotate all credentials for {{email}}?",email:t.email}),confirmLabel:s("common.rotate",{defaultValue:"Rotate"}),tone:"primary"}))try{await Ve.mutateAsync({id:t.id,data:{rotateUuid:!0,rotatePassword:!0,rotateSubscriptionToken:!0}}),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.rotated",{defaultValue:"Updated {{email}}.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.rotateFailed",{defaultValue:"Failed to rotate user keys"}))}},fs=async t=>{if(await Q({title:s("users.actions.revokeTitle",{defaultValue:"Revoke User Access"}),description:s("users.actions.revokeDescription",{defaultValue:"Revoke all access for {{email}}? This will disable the user.",email:t.email}),confirmLabel:s("common.revoke",{defaultValue:"Revoke"}),tone:"danger"}))try{await Mt.mutateAsync({id:t.id,data:{disableUser:!0,disableInbounds:!0,revokeSubscription:!0}}),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.accessRevoked",{defaultValue:"{{email}} was disabled.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.revokeFailed",{defaultValue:"Failed to revoke user access"}))}},ps=async t=>{if(await Q({title:s("users.actions.regenerateTitle",{defaultValue:"Regenerate Subscription Token"}),description:s("users.actions.regenerateDescription",{defaultValue:"Regenerate subscription token for {{email}}?",email:t.email}),confirmLabel:s("common.regenerate",{defaultValue:"Regenerate"}),tone:"primary"}))try{const a=await At.mutateAsync(t.id),n=`${window.location.origin}/sub/${a.subscriptionToken}?target=v2ray`;await Fe(n)?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegeneratedCopied",{defaultValue:"New link for {{email}} was copied.",email:t.email})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.subscriptionRegenerated",{defaultValue:"Token updated for {{email}}.",email:t.email})),await D()}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.regenerateFailed",{defaultValue:"Failed to regenerate subscription token"}))}},xs=async t=>{if(await Q({title:s("users.actions.resetTrafficTitle",{defaultValue:"Reset User Traffic"}),description:s("users.actions.resetTrafficDescription",{defaultValue:"Reset traffic for {{email}}?",email:t.email}),confirmLabel:s("common.reset",{defaultValue:"Reset"}),tone:"primary"}))try{await me.resetTraffic(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.trafficReset",{defaultValue:"{{email}} counters were reset.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.resetFailed",{defaultValue:"Failed to reset user traffic"}))}},bs=async(t,a)=>{try{await me.extendExpiry(t.id,a),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.expiryExtended",{defaultValue:"{{email}} extended by {{days}} day(s).",email:t.email,days:a}))}catch(n){l.error(s("common.error",{defaultValue:"Error"}),(n==null?void 0:n.message)||s("users.toast.extendFailed",{defaultValue:"Failed to extend user expiry"}))}},gs=async t=>{if(await Q({title:s("users.actions.disableTitle",{defaultValue:"Disable User"}),description:s("users.actions.disableDescription",{defaultValue:"Disable {{email}}?",email:t.email}),confirmLabel:s("common.disable",{defaultValue:"Disable"}),tone:"danger"}))try{await me.updateUser(t.id,{status:"DISABLED"}),await me.disconnectUserSessions(t.id),await D(),l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userDisabled",{defaultValue:"{{email}} is now disabled and disconnected.",email:t.email}))}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disableFailed",{defaultValue:"Failed to disable user"}))}},hs=async t=>{if(await Q({title:s("users.actions.disconnectTitle",{defaultValue:"Disconnect Sessions"}),description:s("users.actions.disconnectDescription",{defaultValue:"Disconnect all active sessions for {{email}}?",email:t.email}),confirmLabel:s("common.disconnect",{defaultValue:"Disconnect"}),tone:"danger"}))try{const a=await me.disconnectUserSessions(t.id);await D();const n=a!=null&&a.data?`${a.data.disconnectedDevices} device(s), ${a.data.disconnectedIps} IP(s)`:s("users.toast.sessionsDisconnectedFallback",{defaultValue:"Active sessions disconnected."});l.success(s("common.success",{defaultValue:"Success"}),n)}catch(a){l.error(s("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||s("users.toast.disconnectFailed",{defaultValue:"Failed to disconnect active sessions"}))}},ys=async t=>{const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;await Fe(a)?l.success(s("common.copied",{defaultValue:"Copied"}),s("users.toast.subscriptionCopied",{defaultValue:"Subscription link copied to clipboard."})):l.warning(s("users.toast.clipboardUnavailableTitle",{defaultValue:"Clipboard unavailable"}),s("users.toast.clipboardUnavailableBody",{defaultValue:`Copy failed. Use this link manually:
{{link}}`,link:a}),1e4)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:s("users.title")}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:s("users.subtitle",{defaultValue:"Manage your VPN users and subscriptions"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(k,{variant:"secondary",onClick:Wt,disabled:I.length===0,children:[e.jsx(Lt,{className:"mr-2 h-4 w-4"}),s("common.export",{defaultValue:"Export CSV"})]}),e.jsxs(k,{variant:"secondary",loading:et.isPending,onClick:()=>{as()},children:[e.jsx(ra,{className:"mr-2 h-4 w-4"}),s("users.smartFallbackNow",{defaultValue:"Smart Fallback Now"})]}),e.jsxs(k,{variant:"secondary",onClick:()=>N(!0),children:[e.jsx(ht,{className:"mr-2 h-4 w-4"}),s("users.bulkProvision",{defaultValue:"Bulk Provision"})]}),e.jsxs(k,{onClick:()=>W(!0),children:[e.jsx(yt,{className:"mr-2 h-4 w-4"}),s("users.addUser")]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(ye,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.totalUsers")}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(ge==null?void 0:ge.total)||I.length})]}),e.jsx(ht,{className:"h-6 w-6 text-brand-500"})]})}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.activeUsers")}),e.jsx("p",{className:"text-2xl font-bold text-emerald-500",children:Pt})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("common.online",{defaultValue:"Online"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"relative inline-flex h-3 w-3",children:[ze>0?e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-70"}):null,e.jsx("span",{className:`relative inline-flex h-3 w-3 rounded-full ${ze>0?"bg-emerald-500":"bg-gray-400 dark:bg-gray-500"}`})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:ze})]}),e.jsxs("p",{className:"mt-1 text-xs text-muted",children:[s("users.sessionStream",{defaultValue:"Session stream"}),": ",$t]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[Kt,P.streamError?` • ${P.streamError}`:""]}),e.jsxs("p",{className:"mt-0.5 text-[11px] text-muted",children:[s("users.telemetry.label",{defaultValue:"Telemetry"}),":"," ",e.jsx("span",{className:"font-medium text-foreground",children:Qt})," • ",Gt]})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("users.limited",{defaultValue:"Limited Users"})}),e.jsx("p",{className:"text-2xl font-bold text-amber-500",children:qt})]}),e.jsxs(ye,{children:[e.jsx("p",{className:"text-sm text-muted",children:s("dashboard.expiredUsers")}),e.jsx("p",{className:"text-2xl font-bold text-rose-500",children:Bt})]})]}),e.jsx(ye,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(sa,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-muted"}),e.jsx(Z,{placeholder:s("users.searchPlaceholder",{defaultValue:"Search by email or UUID..."}),value:z,onChange:t=>w(t.target.value),className:"pl-10"})]})}),e.jsxs("select",{className:"rounded-xl border border-line/80 bg-card/75 px-4 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:F,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"",children:s("users.allStatus",{defaultValue:"All Status"})}),e.jsx("option",{value:"ACTIVE",children:s("status.active")}),e.jsx("option",{value:"LIMITED",children:s("status.limited",{defaultValue:"Limited"})}),e.jsx("option",{value:"DISABLED",children:s("status.disabled",{defaultValue:"Disabled"})}),e.jsx("option",{value:"EXPIRED",children:s("status.expired",{defaultValue:"Expired"})})]}),e.jsxs(k,{variant:"secondary",onClick:()=>{ie.forceRefresh()},children:[e.jsx(Qs,{className:`mr-2 h-4 w-4 ${J.isFetching||P.isFetching?"animate-spin":""}`}),s("common.refresh",{defaultValue:"Refresh"})]})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsxs("details",{className:"group lg:hidden",children:[e.jsxs("summary",{className:"flex list-none items-center justify-between gap-3 rounded-xl px-2 py-2 text-left text-sm font-medium text-foreground transition hover:bg-panel/50 [&::-webkit-details-marker]:hidden",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate",children:s("common.advancedControls",{defaultValue:"Advanced controls"})}),e.jsx("p",{className:"mt-0.5 text-xs font-normal text-muted",children:lt})]}),e.jsx(Pe,{className:"h-5 w-5 shrink-0 text-muted transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] flex-1 rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:j,onChange:t=>it(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(k,{size:"sm",variant:"secondary",onClick:()=>{nt()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(k,{size:"sm",variant:"ghost",onClick:ot,disabled:!j,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>u(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${H===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(k,{size:"sm",variant:"ghost",onClick:ie.togglePaused,children:ie.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})})]})]})]}),e.jsxs("div",{className:"hidden items-center justify-between gap-3 lg:flex",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"min-w-[180px] rounded-xl border border-line/80 bg-card/75 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",value:j,onChange:t=>it(t.target.value),children:[e.jsx("option",{value:"",children:s("common.savedViews",{defaultValue:"Saved views"})}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx(k,{size:"sm",variant:"secondary",onClick:()=>{nt()},children:s("common.saveView",{defaultValue:"Save View"})}),e.jsx(k,{size:"sm",variant:"ghost",onClick:ot,disabled:!j,children:s("common.removeView",{defaultValue:"Remove View"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-xl border border-line/70 bg-card/70 p-1",children:["auto","table","cards"].map(t=>e.jsx("button",{type:"button",onClick:()=>u(t),className:`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${H===t?"bg-gradient-to-r from-brand-500 to-brand-600 text-white":"text-muted hover:text-foreground"}`,children:t.toUpperCase()},t))}),e.jsx(k,{size:"sm",variant:"ghost",onClick:ie.togglePaused,children:ie.paused?s("autoRefresh.resume",{defaultValue:"Resume Auto"}):s("autoRefresh.pause",{defaultValue:"Pause Auto"})}),e.jsx("span",{className:"text-xs text-muted",children:lt})]})]})]})]})}),e.jsxs(ye,{padding:!1,children:[d.length>0?e.jsx("div",{className:"border-b border-line/70 bg-panel/50 px-4 py-3 sm:px-6",children:e.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"text-sm text-foreground",children:[s("users.selectedCount",{defaultValue:"{{count}} selected",count:d.length}),We.length>0?` (${We.map(t=>t.email).slice(0,2).join(", ")}${We.length>2?", ...":""})`:""]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsxs("details",{className:"group relative",children:[e.jsx("summary",{className:"list-none",onClick:t=>{K&&t.preventDefault()},children:e.jsxs(k,{size:"sm",variant:"secondary",disabled:K,children:[e.jsx(Rt,{className:"mr-2 h-4 w-4"}),s("common.bulkActions",{defaultValue:"Bulk actions"}),e.jsx(Pe,{className:"ml-2 h-4 w-4 text-muted transition-transform group-open:rotate-180"})]})}),e.jsxs("div",{className:"absolute right-0 z-20 mt-2 w-[min(92vw,22rem)] rounded-2xl border border-line/70 bg-panel/95 p-2 shadow-soft backdrop-blur",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-medium text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,ee),disabled:K,children:s("common.clearSelection",{defaultValue:"Clear selection"})}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void Xt()),disabled:K,children:"Reset traffic"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void Zt()),disabled:K,children:"Extend expiry"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void Jt()),disabled:K,children:"Rotate keys"}),_e?e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void es()),disabled:K,children:"Revoke access"}):null,e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void os()),disabled:K,children:"Myanmar priority reorder"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm text-foreground transition hover:bg-card/80 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void ds()),disabled:K,children:s("users.bulkQualityAutoTune",{defaultValue:"Quality auto-tune reorder"})})]}),e.jsx("div",{className:"my-2 border-t border-line/60"}),oe.length>0?e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Groups"}),e.jsx("select",{value:r,onChange:t=>C(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:K||ue.isFetching,children:oe.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(k,{size:"sm",variant:"secondary",onClick:t=>X(t,()=>void rs()),loading:$e.isPending,disabled:K||!r,children:"Assign"}),e.jsx(k,{size:"sm",variant:"secondary",onClick:t=>X(t,()=>void ns()),loading:Qe.isPending,disabled:K||!r,children:"Move"}),e.jsx(k,{size:"sm",variant:"secondary",onClick:t=>X(t,()=>void ls()),loading:Ke.isPending,disabled:K||!r,children:"Remove"}),e.jsx(k,{size:"sm",variant:"secondary",onClick:t=>X(t,()=>void is()),loading:Ee.isPending,disabled:K||!r,children:"Apply Policy"})]})]}):e.jsx("div",{className:"px-2 pb-1 pt-2",children:e.jsx(k,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>X(t,()=>o("/groups")),disabled:ue.isFetching,children:"Create group"})}),e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsxs("div",{className:"space-y-2 px-2 pb-1 pt-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Status"}),e.jsxs("select",{value:b,onChange:t=>O(t.target.value),className:"w-full rounded-xl border border-line/70 bg-card/80 px-3 py-2 text-sm text-foreground focus:border-brand-500/60 focus:outline-none focus:ring-2 focus:ring-brand-500/35",disabled:K,children:[e.jsx("option",{value:"ACTIVE",children:"ACTIVE"}),e.jsx("option",{value:"LIMITED",children:"LIMITED"}),e.jsx("option",{value:"DISABLED",children:"DISABLED"}),e.jsx("option",{value:"EXPIRED",children:"EXPIRED"})]}),e.jsx(k,{size:"sm",variant:"secondary",className:"w-full",onClick:t=>X(t,()=>void Yt()),loading:Be.isPending,disabled:K,children:"Apply status"})]}),tt?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-2 border-t border-line/60"}),e.jsx("button",{type:"button",className:"w-full rounded-xl px-3 py-2 text-left text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10 focus:outline-none focus:ring-2 focus:ring-rose-500/40 disabled:cursor-not-allowed disabled:opacity-60",onClick:t=>X(t,()=>void Ht()),disabled:K,children:"Delete selected"})]}):null]})]})})]})}):null,J.isLoading?e.jsx("div",{className:"space-y-4 p-5",children:Array.from({length:6}).map((t,a)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ke,{className:"h-4 w-4 rounded"}),e.jsx(ke,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ke,{className:"h-4 w-1/3"}),e.jsx(ke,{className:"h-3 w-1/4"})]}),e.jsx(ke,{className:"h-6 w-16 rounded-full"}),e.jsx(ke,{className:"h-4 w-24"}),e.jsx(ke,{className:"h-8 w-8 rounded-lg"})]},a))}):I.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted",children:s("users.noUsers",{defaultValue:"No users found"})}),e.jsxs(k,{className:"mt-4",onClick:()=>W(!0),children:[e.jsx(yt,{className:"mr-2 h-4 w-4"}),s("users.addFirst")]})]}):e.jsx(ca,{users:I,viewMode:H,onlineUuidSet:Oe,sessionsByUserId:Ge,onQuickQr:t=>_(t),onQuickEdit:t=>xe(t),onRotateKeys:t=>{ms(t)},onRevokeKeys:_e?t=>{fs(t)}:void 0,onKillUser:t=>{Ot(t)},onDisconnectSessions:t=>{hs(t)},onRegenerateSubscription:t=>{ps(t)},onResetTraffic:t=>{xs(t)},onExtendExpiry:(t,a)=>{bs(t,a)},onDisableUser:_e?t=>{gs(t)}:void 0,onCopySubscription:t=>{ys(t)},onUpdateLimits:(t,a)=>{ts(t,a)},onRunDiagnostics:t=>{ss(t)},selectedUserIds:d,onSelectionChange:Se,onPrefetch:t=>{gt(`/users/${t.id}`)},onView:t=>{gt(`/users/${t.id}`),o(`/users/${t.id}`)},onDelete:tt?t=>{zt(t)}:void 0})]}),ge&&ge.totalPages>1?e.jsxs(ye,{className:"flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center",children:[e.jsx("div",{className:"text-sm text-muted",children:s("common.showing",{count:I.length,total:ge.total})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"secondary",size:"sm",disabled:S<=1,onClick:()=>M(t=>t-1),children:s("common.previous")}),e.jsx("span",{className:"px-3 text-sm text-foreground/85",children:s("common.page",{current:S,total:ge.totalPages})}),e.jsx(k,{variant:"secondary",size:"sm",disabled:S>=ge.totalPages,onClick:()=>M(t=>t+1),children:s("common.next")})]})]}):null,fe?e.jsx(Ws,{onClose:()=>W(!1),onSuccess:t=>{if(W(!1),D(),t!=null&&t.subscriptionToken){const a=`${window.location.origin}/sub/${t.subscriptionToken}?target=v2ray`;Fe(a).then(n=>{n?l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreatedCopied",{defaultValue:"User created. Subscription link copied to clipboard."})):l.success(s("common.success",{defaultValue:"Success"}),s("users.toast.userCreated",{defaultValue:"User created successfully."}))}),_(t)}}}):null,je?e.jsx(ia,{onClose:()=>N(!1),onSuccess:()=>{N(!1),D()}}):null,se?e.jsx(da,{user:se,onClose:()=>_(null)}):null,pe?e.jsx(oa,{user:pe,onClose:()=>xe(null),onSuccess:()=>{xe(null),D()}}):null,e.jsx(pt,{open:!!T,title:"Bulk Myanmar Priority Preview",description:"Review the dry-run summary before applying reorder to selected users.",summaryRows:[{label:"Target Users",value:(T==null?void 0:T.targetUsers)??0},{label:"Would Reorder",value:(T==null?void 0:T.wouldUpdateUsers)??0},{label:"Unchanged",value:(T==null?void 0:T.unchangedUsers)??0}],previewLines:(T==null?void 0:T.previewLines)||[],confirmLabel:"Apply Bulk Priority",loading:Ue.isPending,disableConfirm:!T||T.wouldUpdateUsers===0,onClose:()=>{Ue.isPending||Ne(null)},onConfirm:()=>{us()}}),e.jsx(pt,{open:!!E,title:s("users.bulkQualityPreviewTitle",{defaultValue:"Bulk Quality Auto-tune Preview"}),description:s("users.bulkQualityPreviewBody",{defaultValue:"Reorder selected users by recent connect success, rejects, and reconnects."}),summaryRows:[{label:"Target Users",value:(E==null?void 0:E.targetUsers)??0},{label:"Would Reorder",value:(E==null?void 0:E.wouldUpdateUsers)??0},{label:"Telemetry Keys",value:(E==null?void 0:E.scoredKeys)??0}],previewLines:(E==null?void 0:E.previewLines)||[],confirmLabel:s("users.applyAutoTune",{defaultValue:"Apply Auto-tune"}),loading:Me.isPending,disableConfirm:!E||E.wouldUpdateUsers===0,onClose:()=>{Me.isPending||Ce(null)},onConfirm:()=>{cs()}}),e.jsx(Ut,{open:!!U,title:(U==null?void 0:U.title)||"Confirm",description:U==null?void 0:U.description,confirmLabel:(U==null?void 0:U.confirmLabel)||"Confirm",tone:(U==null?void 0:U.tone)||"danger",onCancel:()=>st(!1),onConfirm:()=>st(!0)}),e.jsx(ma,{open:!!L,title:(L==null?void 0:L.title)||"Enter value",description:L==null?void 0:L.description,label:L==null?void 0:L.label,placeholder:L==null?void 0:L.placeholder,defaultValue:L==null?void 0:L.defaultValue,inputType:L==null?void 0:L.inputType,confirmLabel:(L==null?void 0:L.confirmLabel)||"Save",onCancel:()=>rt(null),onConfirm:t=>rt(t)})]})}const Wa=pa;export{pa as Users,Wa as UsersPage};
