import{b as Z,r as n,j as e}from"./index-ChtKAPqG.js";import{u as F}from"./useQuery-mVO-xzsj.js";import{u as Q}from"./useMutation-2ZGjeOrH.js";import{apiClient as g}from"./client-BWRwYwPB.js";import{u as _,C as b}from"./useToast-BxOwwlIy.js";import{B as l}from"./Button-T8YJUWY5.js";import{I as d}from"./Input-DlnO8F_u.js";import{u as $,R as z}from"./useTranslation-CbOZUL4C.js";import{S as ee}from"./save-Bwv0F6JP.js";import{B as te}from"./Settings-DjpIkszR.js";import"./cn-BLSKlp9E.js";import"./Skeleton-BZScUyMR.js";import"./lock-o9j8Ht5l.js";import"./server-BFFxcmak.js";import"./activity-seodxBt0.js";const fe=()=>{var I,U;const c=Z(),x=_(),{t:a}=$(),[k,j]=n.useState(!1),[S,v]=n.useState(""),[m,N]=n.useState(""),[w,V]=n.useState("10000"),[C,L]=n.useState("3"),[A,E]=n.useState("1000"),[u,R]=n.useState({webhook:!0,telegram:!1,systemLog:!0}),[M,D]=n.useState("{}"),[T,y]=n.useState(""),[J,H]=n.useState("all"),[q,G]=n.useState("system.notification.test"),[K,X]=n.useState('{"source":"settings-ui"}'),[O,h]=n.useState(1),{data:f,isLoading:Y}=F({queryKey:["notification-settings"],queryFn:async()=>await g.get("/settings/notifications")}),P=F({queryKey:["notification-settings-audit",O],queryFn:async()=>await g.get("/settings/notifications/audit",{params:{page:O,limit:10}}),staleTime:3e4}),s=f==null?void 0:f.data,r=(I=P.data)==null?void 0:I.data;n.useEffect(()=>{var t,i;s&&(j(!!s.webhookEnabled),v(s.webhookUrl||""),V(String(s.timeoutMs||1e4)),L(String(s.retryAttempts||3)),E(String(s.retryDelayMs||1e3)),R(((t=s.routeMatrix)==null?void 0:t.default)||{webhook:!0,telegram:!1,systemLog:!0}),D(JSON.stringify(((i=s.routeMatrix)==null?void 0:i.routes)||{},null,2)),N(""),y(""))},[s]);const B=Q({mutationFn:async()=>{let t;try{const o=JSON.parse(M||"{}");if(!o||typeof o!="object"||Array.isArray(o))throw new Error(a("notificationsSettings.errors.routesMustBeObject",{defaultValue:"Routes JSON must be an object"}));t=o}catch(o){throw new Error((o==null?void 0:o.message)||a("notificationsSettings.errors.invalidRoutesJson",{defaultValue:"Invalid routes JSON"}))}const i={webhookEnabled:k,webhookUrl:S,timeoutMs:Number.parseInt(w,10)||1e4,retryAttempts:Number.parseInt(C,10)||3,retryDelayMs:Number.parseInt(A,10)||1e3,defaultRoute:u,routes:t};return m.trim()&&(i.webhookSecret=m.trim()),await g.put("/settings/notifications",i)},onSuccess:async()=>{y(""),h(1),await c.invalidateQueries({queryKey:["notification-settings"]}),await c.invalidateQueries({queryKey:["notification-settings-audit"]}),x.success(a("common.success",{defaultValue:"Success"}),a("notificationsSettings.toast.saved",{defaultValue:"Notification settings saved."}))},onError:t=>{y((t==null?void 0:t.message)||a("notificationsSettings.errors.saveFailed",{defaultValue:"Failed to save notification settings"}))}}),W=Q({mutationFn:async()=>{let t={};try{const i=JSON.parse(K||"{}");if(i&&typeof i=="object"&&!Array.isArray(i))t=i;else throw new Error(a("notificationsSettings.errors.testDataMustBeObject",{defaultValue:"Test data must be a JSON object"}))}catch(i){throw new Error((i==null?void 0:i.message)||a("notificationsSettings.errors.invalidTestPayload",{defaultValue:"Invalid test payload JSON"}))}return await g.post("/settings/notifications/test",{channel:J,event:q,data:t})},onSuccess:t=>{x.success(a("common.success",{defaultValue:"Success"}),t.message||a("notificationsSettings.toast.testSent",{defaultValue:"Notification test sent."}))},onError:t=>{x.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("notificationsSettings.toast.testFailed",{defaultValue:"Failed to dispatch test notification"}))}}),p=(t,i)=>{R(o=>({...o,[t]:i}))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:a("notificationsSettings.channels.title",{defaultValue:"Notification channels"})}),Y?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("notificationsSettings.channels.loading",{defaultValue:"Loading notification settings..."})}):e.jsxs("div",{className:"space-y-5",children:[e.jsx("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-800/50",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[a("notificationsSettings.channels.lastUpdated",{defaultValue:"Last updated"}),":"]})," ",s!=null&&s.updatedAt?new Date(s.updatedAt).toLocaleString():a("common.na",{defaultValue:"N/A"})]}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[a("notificationsSettings.channels.created",{defaultValue:"Created"}),":"," ",s!=null&&s.createdAt?new Date(s.createdAt).toLocaleString():a("common.na",{defaultValue:"N/A"})]})]}),e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>{c.invalidateQueries({queryKey:["notification-settings"]}),c.invalidateQueries({queryKey:["notification-settings-audit"]})},children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),a("common.refresh",{defaultValue:"Refresh"})]})]})}),e.jsxs("label",{className:"flex items-center gap-3 rounded-lg border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500",checked:k,onChange:t=>j(t.target.checked)}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-gray-200",children:a("notificationsSettings.channels.enableWebhook",{defaultValue:"Enable webhook delivery"})})]}),e.jsx(d,{label:a("notificationsSettings.channels.webhookUrlLabel",{defaultValue:"Webhook URL"}),value:S,onChange:t=>v(t.target.value),placeholder:a("notificationsSettings.channels.webhookUrlPlaceholder",{defaultValue:"https://your-notify-service.example/webhook"})}),e.jsx(d,{label:s!=null&&s.webhookSecretConfigured?a("notificationsSettings.channels.webhookSecretKeepLabel",{defaultValue:"Webhook secret (leave blank to keep existing)"}):a("notificationsSettings.channels.webhookSecretLabel",{defaultValue:"Webhook secret"}),type:"password",value:m,onChange:t=>N(t.target.value),placeholder:a("notificationsSettings.channels.webhookSecretPlaceholder",{defaultValue:"Enter webhook signing secret"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsx(d,{label:a("notificationsSettings.channels.timeoutLabel",{defaultValue:"Timeout (ms)"}),type:"number",min:1e3,value:w,onChange:t=>V(t.target.value)}),e.jsx(d,{label:a("notificationsSettings.channels.retryAttemptsLabel",{defaultValue:"Retry attempts"}),type:"number",min:1,value:C,onChange:t=>L(t.target.value)}),e.jsx(d,{label:a("notificationsSettings.channels.retryDelayLabel",{defaultValue:"Retry delay (ms)"}),type:"number",min:100,value:A,onChange:t=>E(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:a("notificationsSettings.channels.defaultRouteTitle",{defaultValue:"Default route"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-3",children:[e.jsxs("label",{className:"flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm dark:border-gray-700",children:[e.jsx("input",{type:"checkbox",checked:u.webhook,onChange:t=>p("webhook",t.target.checked)}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:a("notificationsSettings.channels.route.webhook",{defaultValue:"Webhook"})})]}),e.jsxs("label",{className:"flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm dark:border-gray-700",children:[e.jsx("input",{type:"checkbox",checked:u.telegram,onChange:t=>p("telegram",t.target.checked)}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:a("notificationsSettings.channels.route.telegram",{defaultValue:"Telegram"})})]}),e.jsxs("label",{className:"flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm dark:border-gray-700",children:[e.jsx("input",{type:"checkbox",checked:u.systemLog,onChange:t=>p("systemLog",t.target.checked)}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:a("notificationsSettings.channels.route.systemLog",{defaultValue:"System log"})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:a("notificationsSettings.channels.routeMatrixLabel",{defaultValue:"Route matrix (JSON)"})}),e.jsx("textarea",{className:"min-h-[220px] w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-xs text-gray-900 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",value:M,onChange:t=>D(t.target.value),placeholder:'{"user.*":{"webhook":true,"telegram":false,"systemLog":true}}'}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a("notificationsSettings.channels.routeMatrixHelp",{defaultValue:"Use event names (e.g. auth.login.success) or wildcard prefixes (e.g. user.*)."})})]}),T?e.jsx("div",{className:"rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700 dark:border-red-900/60 dark:bg-red-900/20 dark:text-red-300",children:T}):null,e.jsxs(l,{onClick:()=>B.mutate(),loading:B.isPending,className:"w-full sm:w-auto",children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),a("notificationsSettings.channels.saveButton",{defaultValue:"Save notification settings"})]})]})]}),e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:a("notificationsSettings.test.title",{defaultValue:"Send test notification"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:a("notificationsSettings.test.channelLabel",{defaultValue:"Channel"})}),e.jsxs("select",{value:J,onChange:t=>H(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",children:[e.jsx("option",{value:"all",children:a("notificationsSettings.test.channelAll",{defaultValue:"All channels"})}),e.jsx("option",{value:"webhook",children:a("notificationsSettings.test.channelWebhook",{defaultValue:"Webhook only"})}),e.jsx("option",{value:"telegram",children:a("notificationsSettings.test.channelTelegram",{defaultValue:"Telegram only"})}),e.jsx("option",{value:"systemLog",children:a("notificationsSettings.test.channelSystemLog",{defaultValue:"System log only"})})]})]}),e.jsx(d,{label:a("notificationsSettings.test.eventLabel",{defaultValue:"Event name"}),value:q,onChange:t=>G(t.target.value),placeholder:"system.notification.test"}),e.jsx("div",{className:"flex items-end",children:e.jsxs(l,{className:"w-full",onClick:()=>W.mutate(),loading:W.isPending,children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),a("notificationsSettings.test.dispatchButton",{defaultValue:"Dispatch test"})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:a("notificationsSettings.test.payloadLabel",{defaultValue:"Test payload (JSON)"})}),e.jsx("textarea",{value:K,onChange:t=>X(t.target.value),className:"min-h-[120px] w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-xs text-gray-900 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100"})]})]})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:a("notificationsSettings.audit.title",{defaultValue:"Notification audit history"})}),e.jsxs(l,{variant:"secondary",size:"sm",onClick:()=>void c.invalidateQueries({queryKey:["notification-settings-audit"]}),children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),a("notificationsSettings.audit.refreshButton",{defaultValue:"Refresh audit"})]})]}),P.isLoading?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("notificationsSettings.audit.loading",{defaultValue:"Loading audit history..."})}):(U=r==null?void 0:r.items)!=null&&U.length?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300",children:a("notificationsSettings.audit.table.time",{defaultValue:"Time"})}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300",children:a("notificationsSettings.audit.table.admin",{defaultValue:"Admin"})}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300",children:a("notificationsSettings.audit.table.ip",{defaultValue:"IP"})}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300",children:a("common.action",{defaultValue:"Action"})}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300",children:a("notificationsSettings.audit.table.changedKeys",{defaultValue:"Changed keys"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:r.items.map(t=>{var i;return e.jsxs("tr",{className:"bg-white dark:bg-gray-900",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-700 dark:text-gray-200",children:new Date(t.createdAt).toLocaleString()}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-700 dark:text-gray-200",children:t.adminUsername||a("common.system",{defaultValue:"system"})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-300",children:t.requestIp||a("common.na",{defaultValue:"N/A"})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-300",children:t.action}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-300",children:(i=t.changedKeys)!=null&&i.length?t.changedKeys.join(", "):"-"})]},t.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l,{variant:"secondary",size:"sm",disabled:(r.pagination.page||1)<=1,onClick:()=>h(t=>Math.max(1,t-1)),children:a("common.previous",{defaultValue:"Previous"})}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a("notificationsSettings.audit.pageLine",{defaultValue:"Page {{page}} of {{pages}} ({{total}} total)",page:r.pagination.page,pages:r.pagination.totalPages,total:r.pagination.total})}),e.jsx(l,{variant:"secondary",size:"sm",disabled:(r.pagination.page||1)>=(r.pagination.totalPages||1),onClick:()=>h(t=>t+1),children:a("common.next",{defaultValue:"Next"})})]})]}):e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:a("notificationsSettings.audit.empty",{defaultValue:"No audit records yet."})})]})]})};export{fe as default};
