import{c as Z,r as w,u as _,j as e,X as R}from"./index-CcK4tOfC.js";import{u as H}from"./index.esm-6ooOXtNp.js";import{u as X}from"./useGroups-5gV7fWJG.js";import{z as J,a as K}from"./useUsers-B7GL2jXA.js";import{B as N}from"./Button-D1Vl4E60.js";import{I as y}from"./Input-CQ9kTGid.js";import{u as Q,R as F}from"./useTranslation-BAr0hstR.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=Z("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function le({user:a,onClose:f,onSuccess:b}){var q,S,P,A;const i=!!a,[p,c]=w.useState(""),[n,h]=w.useState("name"),{t}=Q(),L=_(),x="one-ui.local",{data:k}=X(),r=k||[],d=J(),I=K(),{register:u,handleSubmit:O,reset:D,setValue:j,watch:T,clearErrors:$,formState:{errors:o}}=H({defaultValues:{email:"",name:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""}});w.useEffect(()=>{var s;if(a){h("email");const l=1e3*60*60*24,V=!!a.startOnFirstUse&&!a.firstUsedAt?Math.max(1,Math.ceil((new Date(a.expireDate).getTime()-new Date(a.createdAt).getTime())/l)):Math.max(1,Math.ceil((new Date(a.expireDate).getTime()-Date.now())/l));D({email:a.email,name:"",dataLimit:Number(a.dataLimit)/1024**3,expiryDays:V,startOnFirstUse:!!a.startOnFirstUse,ipLimit:a.ipLimit??0,deviceLimit:a.deviceLimit??0,inboundIds:((s=a.inbounds)==null?void 0:s.map(v=>String(v.inboundId)))||[],note:a.note||""});return}h("name"),D({email:"",name:"",dataLimit:50,expiryDays:30,startOnFirstUse:!1,ipLimit:0,deviceLimit:0,inboundIds:[],note:""})},[a,D]);const E=()=>{const s="abcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let g=0;g<8;g+=1)l+=s[Math.floor(Math.random()*s.length)];return l};w.useEffect(()=>{i||j("name",E(),{shouldDirty:!1,shouldTouch:!1,shouldValidate:!1})},[i,j]);const U=s=>String(s||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9._-]/g,"").replace(/[-._]{2,}/g,"-").replace(/^[-._]+|[-._]+$/g,"").slice(0,32),C=()=>{const s=E();if(n==="name"){j("name",s,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),$("name");return}j("email",`${s}@${x}`,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),$("email")},M=T("name"),B=U(M)?`${U(M)}@${x}`:"",G=async s=>{c("");const l=(s.inboundIds||[]).map(m=>Number.parseInt(String(m),10)).filter(m=>Number.isInteger(m)&&m>0),g=U(s.name),V=!i&&n==="name"?g?`${g}@${x}`:"":String(s.email||"").trim();if(!V){c(n==="name"?t("users.form.validation.nameRequired",{defaultValue:"Name is required"}):t("users.form.validation.emailRequired",{defaultValue:"Email is required"}));return}if(l.length===0){c(t("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"}));return}const v={email:V,dataLimit:Number(s.dataLimit),expiryDays:Number(s.expiryDays),ipLimit:Number(s.ipLimit),deviceLimit:Number(s.deviceLimit),inboundIds:l,note:s.note||void 0};i||(v.startOnFirstUse=!!s.startOnFirstUse);try{if(i&&a)await I.mutateAsync({id:a.id,data:v}),b();else{const m=await d.mutateAsync(v);b(m.data)}}catch(m){c((m==null?void 0:m.message)||t("users.form.saveFailed",{defaultValue:"Failed to save user"}))}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/45 p-2 backdrop-blur-sm sm:items-center sm:p-4",children:e.jsxs("div",{className:"max-h-[92vh] w-full max-w-2xl overflow-y-auto rounded-2xl border border-line/80 bg-card/95 shadow-soft backdrop-blur-xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-line/80 bg-card/95 p-5",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground sm:text-2xl",children:i?t("users.editUser",{defaultValue:"Edit User"}):t("users.addUser",{defaultValue:"Add User"})}),e.jsx("button",{onClick:f,className:"rounded-lg p-2 text-muted transition-colors hover:bg-card hover:text-foreground","aria-label":t("common.close",{defaultValue:"Close"}),children:e.jsx(R,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:O(G),className:"space-y-6 p-5 sm:p-6",children:[p?e.jsx("div",{className:"rounded-xl border border-red-500/35 bg-red-500/10 px-4 py-3 text-sm text-red-500 dark:text-red-300",children:p}):null,i?null:e.jsxs("div",{className:"space-y-2 rounded-xl border border-line/70 bg-panel/40 p-3",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-[0.14em] text-muted",children:t("users.form.identityMode",{defaultValue:"Identity input"})}),e.jsxs("div",{className:"inline-flex rounded-lg border border-line/70 bg-card/70 p-1",children:[e.jsx("button",{type:"button",onClick:()=>h("name"),className:`rounded-md px-3 py-1.5 text-sm font-medium transition ${n==="name"?"bg-brand-500 text-white":"text-muted hover:bg-card hover:text-foreground"}`,children:t("users.form.useName",{defaultValue:"Name"})}),e.jsx("button",{type:"button",onClick:()=>h("email"),className:`rounded-md px-3 py-1.5 text-sm font-medium transition ${n==="email"?"bg-brand-500 text-white":"text-muted hover:bg-card hover:text-foreground"}`,children:t("users.form.useEmail",{defaultValue:"Email"})})]})]}),!i&&n==="name"?e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"ml-1 block text-sm font-medium text-muted",children:`${t("users.form.nameLabel",{defaultValue:"Name"})} *`}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"w-full rounded-xl border border-line/80 bg-card/75 px-4 py-2.5 pr-24 text-sm text-foreground outline-none transition-all duration-200 placeholder:text-muted focus-visible:border-brand-500/50 focus-visible:ring-2 focus-visible:ring-brand-500/40 focus-visible:ring-offset-2 focus-visible:ring-offset-app sm:text-base",placeholder:t("users.form.namePlaceholder",{defaultValue:"client001"}),...u("name",{validate:s=>i||n!=="name"?!0:String(s||"").trim()?/^[A-Za-z0-9._\-\s]{3,32}$/.test(String(s||""))?!0:t("users.form.validation.nameInvalid",{defaultValue:"Use 3-32 letters, numbers, dots, dashes, or underscores"}):t("users.form.validation.nameRequired",{defaultValue:"Name is required"})})}),e.jsxs("button",{type:"button",onClick:C,className:"absolute right-2 top-1/2 inline-flex -translate-y-1/2 items-center gap-1 rounded-lg border border-line/70 bg-card/90 px-2.5 py-1 text-xs font-medium text-foreground transition hover:bg-panel","aria-label":t("users.form.generateName",{defaultValue:"Generate name"}),children:[e.jsx(F,{className:"h-3.5 w-3.5"}),t("users.form.generate",{defaultValue:"Generate"})]})]}),o.name?e.jsx("p",{className:"ml-1 text-sm text-red-500 dark:text-red-300",children:o.name.message}):null,e.jsx("p",{className:"ml-1 text-xs text-muted",children:t("users.form.generatedEmailPreview",{defaultValue:"Stored email: {{email}}",email:B||`name@${x}`})})]}):e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"ml-1 block text-sm font-medium text-muted",children:`${t("users.email",{defaultValue:"Email"})} *`}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"email",className:"w-full rounded-xl border border-line/80 bg-card/75 px-4 py-2.5 pr-24 text-sm text-foreground outline-none transition-all duration-200 placeholder:text-muted focus-visible:border-brand-500/50 focus-visible:ring-2 focus-visible:ring-brand-500/40 focus-visible:ring-offset-2 focus-visible:ring-offset-app sm:text-base",placeholder:"user@example.com",...u("email",{validate:s=>{if(!i&&n!=="email")return!0;const l=String(s||"").trim();return l?/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(l)?!0:t("users.form.validation.emailInvalid",{defaultValue:"Invalid email address"}):t("users.form.validation.emailRequired",{defaultValue:"Email is required"})}})}),i?null:e.jsxs("button",{type:"button",onClick:C,className:"absolute right-2 top-1/2 inline-flex -translate-y-1/2 items-center gap-1 rounded-lg border border-line/70 bg-card/90 px-2.5 py-1 text-xs font-medium text-foreground transition hover:bg-panel","aria-label":t("users.form.generateEmail",{defaultValue:"Generate email"}),children:[e.jsx(F,{className:"h-3.5 w-3.5"}),t("users.form.generate",{defaultValue:"Generate"})]})]}),o.email?e.jsx("p",{className:"ml-1 text-sm text-red-500 dark:text-red-300",children:o.email.message}):null]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(y,{label:`${t("users.form.dataLimitLabel",{defaultValue:"Data Limit (GB)"})} *`,type:"number",...u("dataLimit",{valueAsNumber:!0,required:t("users.form.validation.dataLimitRequired",{defaultValue:"Data limit is required"}),min:{value:1,message:t("users.form.validation.minGb",{defaultValue:"Minimum 1 GB"})}}),error:(q=o.dataLimit)==null?void 0:q.message,placeholder:"50"}),e.jsx(y,{label:`${t("users.expiryDays",{defaultValue:"Expiry Days"})} *`,type:"number",...u("expiryDays",{valueAsNumber:!0,required:t("users.form.validation.expiryDaysRequired",{defaultValue:"Expiry days is required"}),min:{value:1,message:t("users.form.validation.minDay",{defaultValue:"Minimum 1 day"})}}),error:(S=o.expiryDays)==null?void 0:S.message,placeholder:"30"})]}),i?null:e.jsx("div",{className:"rounded-xl border border-line/70 bg-panel/40 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx("input",{type:"checkbox",...u("startOnFirstUse"),className:"mt-1 h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t("users.form.startOnFirstUseTitle",{defaultValue:"Start expiry on first connect"})}),e.jsx("p",{className:"mt-1 text-xs text-muted",children:t("users.form.startOnFirstUseDescription",{defaultValue:"The expiry timer begins when the user first connects (downloads subscription). Until then, the account stays active."})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(y,{label:t("users.form.ipLimitLabel",{defaultValue:"IP Limit"}),type:"number",...u("ipLimit",{valueAsNumber:!0,min:{value:0,message:t("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(P=o.ipLimit)==null?void 0:P.message,placeholder:t("users.ipLimitHint",{defaultValue:"0 = unlimited"})}),e.jsx(y,{label:t("users.form.deviceLimitLabel",{defaultValue:"Device Limit"}),type:"number",...u("deviceLimit",{valueAsNumber:!0,min:{value:0,message:t("users.form.validation.minZero",{defaultValue:"Must be 0 or greater"})}}),error:(A=o.deviceLimit)==null?void 0:A.message,placeholder:t("users.ipLimitHint",{defaultValue:"0 = unlimited"})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-2 block text-sm font-medium text-muted",children:[t("inbounds.title",{defaultValue:"Inbounds"})," *"]}),e.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto rounded-xl border border-line/80 bg-panel/55 p-3",children:r.length===0?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted",children:t("users.form.noInboundsHint",{defaultValue:"No inbounds available. Create one first."})}),e.jsx(N,{type:"button",size:"sm",variant:"secondary",onClick:()=>{f(),L("/inbounds")},children:t("inbounds.addInbound",{defaultValue:"Add Inbound"})})]}):r.map(s=>e.jsxs("label",{className:"flex cursor-pointer items-center space-x-3 rounded-lg p-2.5 transition hover:bg-card",children:[e.jsx("input",{type:"checkbox",value:s.id,...u("inboundIds",{validate:l=>l&&l.length>0||t("users.form.validation.inboundRequired",{defaultValue:"Select at least one inbound"})}),className:"h-4 w-4 rounded border-line text-brand-500 focus:ring-brand-500/40"}),e.jsxs("span",{className:"text-sm text-foreground",children:[s.protocol," - ",s.remark||`Port ${s.port}`]})]},s.id))}),o.inboundIds?e.jsx("p",{className:"mt-1 text-sm text-red-500 dark:text-red-300",children:o.inboundIds.message}):null]}),e.jsx(y,{label:t("users.note",{defaultValue:"Note"}),...u("note"),placeholder:t("users.form.notePlaceholder",{defaultValue:"Optional note about this user"})}),e.jsxs("div",{className:"sticky bottom-0 flex flex-col gap-2 border-t border-line/70 bg-card/95 pt-4 sm:flex-row",children:[e.jsx(N,{type:"submit",className:"flex-1",loading:d.isPending||I.isPending,disabled:r.length===0,children:i?t("users.form.updateUser",{defaultValue:"Update User"}):t("users.form.createUser",{defaultValue:"Create User"})}),e.jsx(N,{type:"button",variant:"secondary",onClick:f,className:"flex-1",children:t("common.cancel",{defaultValue:"Cancel"})})]})]})]})})}function z(a,f){const b=Number.isInteger(Number(a.toPriority))?` [P${a.toPriority}]`:"";return`${f+1}. ${a.key}${b}`}function ne({open:a,title:f="Myanmar Priority Preview",description:b,summaryRows:i,currentTop3:p=[],newTop3:c=[],previewLines:n=[],confirmLabel:h="Apply",loading:t=!1,disableConfirm:L=!1,onClose:x,onConfirm:k}){return a?e.jsx("div",{className:"fixed inset-0 z-[95] flex items-end justify-center bg-black/55 p-2 backdrop-blur-sm sm:items-center sm:p-4",onClick:r=>{r.target===r.currentTarget&&!t&&x()},children:e.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-2xl border border-line/70 bg-card/95 shadow-2xl shadow-black/25",children:[e.jsxs("div",{className:"flex items-start justify-between border-b border-line/70 px-4 py-3 sm:px-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:f}),b?e.jsx("p",{className:"mt-1 text-sm text-muted",children:b}):null]}),e.jsx("button",{type:"button",className:"rounded-lg p-1.5 text-muted transition hover:bg-panel/70 hover:text-foreground",onClick:x,disabled:t,"aria-label":"Close preview",children:e.jsx(R,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"max-h-[70vh] space-y-4 overflow-y-auto px-4 py-4 sm:px-6",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-3",children:i.map(r=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/50 p-3",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-muted",children:r.label}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-foreground",children:r.value})]},r.label))}),p.length>0||c.length>0?e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Current Top 3"}),p.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No current entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:p.slice(0,3).map((r,d)=>e.jsx("li",{children:z(r,d)},`before-${r.key}-${d}`))})]}),e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"New Top 3"}),c.length===0?e.jsx("p",{className:"mt-2 text-xs text-muted",children:"No new entries"}):e.jsx("ul",{className:"mt-2 space-y-1 text-sm text-foreground/90",children:c.slice(0,3).map((r,d)=>e.jsx("li",{children:z(r,d)},`after-${r.key}-${d}`))})]})]}):null,n.length>0?e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Preview"}),e.jsx("ul",{className:"mt-2 space-y-1 text-xs text-foreground/90",children:n.map((r,d)=>e.jsx("li",{children:r},`${r}-${d}`))})]}):null]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-line/70 bg-panel/35 px-4 py-3 sm:px-6",children:[e.jsx(N,{type:"button",variant:"secondary",onClick:x,disabled:t,children:"Cancel"}),e.jsx(N,{type:"button",onClick:k,loading:t,disabled:L||t,children:h})]})]})}):null}export{ie as C,ne as M,le as U};
