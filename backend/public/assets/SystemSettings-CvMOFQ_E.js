import{c as ht,f as bt,d as kt,e as jt,r as c,j as e,C as wt,b as Nt}from"./index-DrL1zW_A.js";import{u as vt}from"./useQuery-KR27nzFv.js";import{e as Ct,f as St,g as Rt,h as Vt,b as Ft,u as Xt,i as Lt,j as At,k as Mt,l as Et,m as Pt,n as Tt,o as Ut,p as Gt,q as $t,r as Bt,s as Dt,t as It,v as zt,w as Qt,x as Ot,y as qt,c as Wt,d as _t}from"./useXray-Dh-4uVLX.js";import{u as Jt,C as w}from"./useToast-BeE1NVOC.js";import{B as l}from"./Button-DfueQd-M.js";import{C as Kt}from"./ConfirmDialog-CBCqIpu-.js";import{C as Yt,c as ze}from"./clipboard-DmYgx5sl.js";import{g as Q,a as Qe}from"./xrayUpdatePreflight-CrNj47ho.js";import{u as Zt,R as le}from"./useTranslation-BKUwUwH0.js";import{F as Oe}from"./file-code-2-CajqfVDh.js";import{S as Ht}from"./server-BAAycAvu.js";import"./useMutation-DkKyHOPA.js";import"./xray-DA2VgF-5.js";import"./cn-BLSKlp9E.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ea=ht("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);function ta(N){if(!N||N<1)return"N/A";const U=Math.floor(N/86400),O=Math.floor(N%86400/3600),s=Math.floor(N%3600/60);return`${U}d ${O}h ${s}m`}const fa=()=>{var Ve,Fe,Xe,Le,Ae,Me,Ee,Pe,Te,Ue,Ge,$e,Be,De,Ie;const N=bt(t=>{var r;return((r=t.admin)==null?void 0:r.role)==="SUPER_ADMIN"}),U=kt(),O=jt(),s=Jt(),{t:a}=Zt(),oe=c.useRef(null),S=c.useRef(null),[G,qe]=c.useState(!1),[We,ie]=c.useState(!1),[R,de]=c.useState("stable"),[_e,ce]=c.useState(1),[p,q]=c.useState(""),[v,W]=c.useState(""),[ue,me]=c.useState(!1),[u,ge]=c.useState(null),{data:_}=vt({queryKey:["system-stats"],queryFn:async()=>await Nt.get("/system/stats"),refetchInterval:5e3}),$=Ct(),J=St(G),K=Rt(),Y=Vt(),Z=Ft(),h=Xt(),o=Z.data,n=h.data,g=(o==null?void 0:o.updatesEnabled)!==!1,Je=Z.isSuccess?g:!1,B=Lt(_e,10),L=At(Je),xe=Mt(g),ye=Et(),H=Pt(!0),fe=Tt(),pe=Ut(),Ke=Gt(!0),he=$t(),Ye=Bt(!0),be=Dt(),Ze=It(!0),ke=zt(),A=Qt(),V=Ot(),T=qt(),je=Wt(),ee=_t(),b=_==null?void 0:_.data,y=$.data,D=J.data,i=B.data,m=xe.data,C=c.useMemo(()=>{var t;return((t=H.data)==null?void 0:t.snapshots)??[]},[(Ve=H.data)==null?void 0:Ve.snapshots]),k=Ke.data,te=Ye.data,M=Ze.data,j=c.useMemo(()=>L.data??[],[L.data]),we=(o==null?void 0:o.mode)||(n==null?void 0:n.mode)||"docker",E=h.isLoading||!(n!=null&&n.ready),ae=((n==null?void 0:n.checks)||[]).filter(t=>!t.ok),He=ae.filter(t=>t.blocking),P=((n==null?void 0:n.checks)||[]).find(t=>t.id==="update-lock"&&!t.ok),Ne=!!P,et=Q(P,"ownerId"),ve=Q(P,"expiresAt"),Ce=n!=null&&n.generatedAt?new Date(n.generatedAt).getTime():Number.NaN,I=ve&&Number.isFinite(Ce)?new Date(ve).getTime()<=Ce:!1,se=c.useMemo(()=>Array.from(new Set(ae.flatMap(t=>Qe(t)).filter(t=>t.trim().length>0))),[ae]),F=ue||A.isPending||V.isPending||T.isPending||ee.isPending;c.useEffect(()=>{if(!C.length){W("");return}(!v||!C.some(t=>t.id===v))&&W(C[0].id)},[C,v]),c.useEffect(()=>{if(!j.length){p!==""&&q("");return}(!p||!j.includes(p))&&q(j[0])},[j,p]),c.useEffect(()=>{if(new URLSearchParams(U.search).get("section")!=="xray-updates")return;const r=window.setTimeout(()=>{var d;(d=oe.current)==null||d.scrollIntoView({behavior:"smooth",block:"start"})},120);return()=>window.clearTimeout(r)},[U.search]),c.useEffect(()=>()=>{var t;(t=S.current)==null||t.call(S,!1),S.current=null},[]);const X=({title:t,description:r,confirmLabel:d="Confirm",cancelLabel:x="Cancel",tone:f="danger"})=>new Promise(z=>{S.current=z,ge({title:t,description:r,confirmLabel:d,cancelLabel:x,tone:f})}),Se=t=>{const r=S.current;S.current=null,ge(null),r==null||r(t)},tt=()=>{O.invalidateQueries({queryKey:["xray-status"]})},at=async()=>{try{const t=await Y.mutateAsync();s.success(a("common.success",{defaultValue:"Success"}),t.message||a("systemSettings.toast.configReloaded",{defaultValue:"Xray config reloaded successfully."}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.configReloadFailed",{defaultValue:"Failed to reload Xray config"}))}},st=async()=>{try{const t=await K.mutateAsync();s.success(a("common.success",{defaultValue:"Success"}),t.message||a("systemSettings.toast.restartSuccess",{defaultValue:"Xray restarted successfully!"}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.restartFailed",{defaultValue:"Failed to restart Xray"}))}},rt=async()=>{if(!g){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}try{const t=await A.mutateAsync({channel:R});s.success(a("common.success",{defaultValue:"Success"}),t.summary||a("systemSettings.toast.canaryComplete",{defaultValue:"Canary update completed successfully."}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.canaryFailed",{defaultValue:"Failed to run canary update"}))}},Re=async(t=!1)=>{if(!g){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}if(await X({title:t?"Force full rollout?":"Run full rollout?",description:t?"Run full rollout and bypass canary requirement?":"Run full rollout now? This will restart Xray service.",confirmLabel:t?"Force rollout":"Run rollout",tone:t?"danger":"primary"}))try{const x=await V.mutateAsync({channel:R,force:t});s.success(a("common.success",{defaultValue:"Success"}),x.summary||a("systemSettings.toast.fullRolloutComplete",{defaultValue:"Full rollout completed successfully."}))}catch(x){s.error(a("common.error",{defaultValue:"Error"}),(x==null?void 0:x.message)||a("systemSettings.toast.fullRolloutFailed",{defaultValue:"Failed to run full rollout"}))}},nt=async()=>{var r;if(!g){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.manualModeGuidedUnavailable",{defaultValue:"Guided rollout is unavailable in manual mode. Use your host update workflow."}));return}if(await X({title:`Start guided rollout (${R.toUpperCase()})?`,description:"This flow runs Canary first, then prompts Full rollout.",confirmLabel:"Start guided rollout",tone:"primary"})){me(!0);try{if(!((r=(await h.refetch()).data)!=null&&r.ready)){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.preflightBlocked",{defaultValue:"Resolve preflight checks before guided rollout."}));return}const x=await A.mutateAsync({channel:R});if(!await X({title:"Canary complete",description:`Canary finished successfully.${x.summary?`

${x.summary}`:""}

Continue with Full rollout now?`,confirmLabel:"Continue to full rollout",tone:"primary"})){s.info(a("common.info",{defaultValue:"Info"}),a("systemSettings.toast.guidedPaused",{defaultValue:"Canary complete. Full rollout skipped."}));return}const z=await V.mutateAsync({channel:R});s.success(a("common.success",{defaultValue:"Success"}),z.summary||a("systemSettings.toast.guidedComplete",{defaultValue:"Guided rollout completed successfully."}))}catch(d){const x=(d==null?void 0:d.message)||"Guided rollout failed";if(!await X({title:"Guided rollout failed",description:`${x}

Run rollback shortcut now?`,confirmLabel:"Run rollback",tone:"danger"}))return;const re=(await L.refetch()).data||j,ne=p||(re==null?void 0:re[0]);if(!ne){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.noRollbackTag",{defaultValue:"No rollback backup tag available. Refresh tags and try again."}));return}const pt=await T.mutateAsync({backupTag:ne});s.success(a("common.success",{defaultValue:"Success"}),pt.summary||a("systemSettings.toast.rollbackCompleteWithTag",{defaultValue:"Rollback completed using {{tag}}.",tag:ne}))}finally{me(!1)}}},lt=async()=>{if(!g){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.manualModeRollbackDisabled",{defaultValue:"Scripted rollback is disabled in manual mode. Use your host rollback workflow."}));return}const t=p?`Run rollback with ${p}?`:"Run rollback with latest available backup tag?";if(await X({title:"Run rollback?",description:t,confirmLabel:"Run rollback",tone:"danger"}))try{const d=await T.mutateAsync({backupTag:p||void 0});s.success(a("common.success",{defaultValue:"Success"}),d.summary||a("systemSettings.toast.rollbackComplete",{defaultValue:"Rollback completed successfully."}))}catch(d){s.error(a("common.error",{defaultValue:"Error"}),(d==null?void 0:d.message)||a("systemSettings.toast.rollbackFailed",{defaultValue:"Failed to run rollback"}))}},ot=async()=>{if(D)try{if(!await ze(JSON.stringify(D,null,2)))throw new Error("copy_failed");ie(!0),window.setTimeout(()=>ie(!1),1500)}catch{s.error(a("common.error",{defaultValue:"Error"}),a("systemSettings.toast.copyConfigFailed",{defaultValue:"Failed to copy config to clipboard"}))}},it=async()=>{if(!se.length)return;const t=["# One-UI Xray Update Preflight Fixes",...se.map(r=>`- ${r}`)].join(`
`);try{if(!await ze(t))throw new Error("copy_failed");s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.copyPreflightFixesSuccess",{defaultValue:"Preflight fix commands copied."}))}catch{s.error(a("common.error",{defaultValue:"Error"}),a("systemSettings.toast.copyPreflightFixesFailed",{defaultValue:"Failed to copy preflight fix commands."}))}},dt=async()=>{try{const t=await ee.mutateAsync({repair:!0,source:"system-settings"});s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.runtimeDoctorComplete",{defaultValue:"Runtime doctor completed. Applied {{count}} repair action(s).",count:t.repairedCount||0})),await Promise.all([h.refetch(),Z.refetch(),$.refetch()])}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.runtimeDoctorFailed",{defaultValue:"Runtime doctor failed."}))}},ct=async()=>{try{await ye.mutateAsync(),s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.releaseIntelRefreshed",{defaultValue:"Latest release metadata pulled from upstream."}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.releaseIntelRefreshFailed",{defaultValue:"Failed to refresh release intel"}))}},ut=async()=>{try{const t=await fe.mutateAsync();s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.snapshotCreated",{defaultValue:"Snapshot ID: {{id}}",id:t.id}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.snapshotFailed",{defaultValue:"Failed to create config snapshot"}))}},mt=async()=>{if(!v){s.warning(a("common.warning",{defaultValue:"Warning"}),a("systemSettings.toast.selectSnapshot",{defaultValue:"Choose a snapshot before rollback."}));return}if(await X({title:"Rollback config snapshot?",description:`Rollback Xray config using snapshot ${v}?`,confirmLabel:"Rollback snapshot",tone:"danger"}))try{const r=await pe.mutateAsync({snapshotId:v,applyMethod:"restart"});s.success(a("common.success",{defaultValue:"Success"}),r.message||a("systemSettings.toast.configRollbackComplete",{defaultValue:"Config rollback completed."}))}catch(r){s.error(a("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||a("systemSettings.toast.configRollbackFailed",{defaultValue:"Failed to rollback snapshot"}))}},gt=async t=>{try{await he.mutateAsync({mode:t,apply:!0}),s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.routingUpdated",{defaultValue:"Routing profile switched to {{mode}}.",mode:t}))}catch(r){s.error(a("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||a("systemSettings.toast.routingUpdateFailed",{defaultValue:"Failed to update routing profile"}))}},xt=async()=>{try{await be.mutateAsync({useCommand:!0,forceDownload:!1,reload:!0}),s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.geodataUpdated",{defaultValue:"Geodata updated successfully."}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.geodataUpdateFailed",{defaultValue:"Failed to update geodata"}))}},yt=async()=>{try{const t=await ke.mutateAsync();s.success(a("common.success",{defaultValue:"Success"}),a("systemSettings.toast.confdirSynced",{defaultValue:"{{count}} file(s) synchronized.",count:t.files.length}))}catch(t){s.error(a("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||a("systemSettings.toast.confdirSyncFailed",{defaultValue:"Failed to sync confdir"}))}},ft=async()=>{if(!N||!Ne)return;const t=Q(P,"ownerId"),r=Q(P,"expiresAt"),d=t&&r?`Force unlock active update lock owned by ${t} (expires ${new Date(r).toLocaleString()})?`:"Force unlock the active Xray update lock?";if(await X({title:I?"Unlock stale update lock?":"Force unlock active update lock?",description:d,confirmLabel:I?"Unlock":"Force unlock",tone:"danger"}))try{const f=await je.mutateAsync({reason:"manual-force-unlock-from-settings",force:!I});s.success(a("common.success",{defaultValue:"Success"}),f.message||(f.unlocked?a("systemSettings.toast.updateLockReleased",{defaultValue:"Update lock released."}):a("systemSettings.toast.updateLockNotReleased",{defaultValue:"Update lock not released."})))}catch(f){s.error(a("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||a("systemSettings.toast.unlockFailed",{defaultValue:"Failed to unlock update lock."}))}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(w,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"System Information"}),b?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"CPU Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[b.cpu??"N/A",typeof b.cpu=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Memory Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[b.memory??"N/A",typeof b.memory=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:b.users??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Inbounds:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:b.inbounds??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Uptime:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:b.uptime||ta(b.uptimeSeconds)})]})]}):null]}),e.jsxs(w,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Runtime"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Monitor service status and run zero-downtime config reloads."})]}),e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${y!=null&&y.running?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900/35 dark:text-red-300"}`,children:y!=null&&y.running?"Running":"Stopped"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Version:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:(y==null?void 0:y.version)||"unknown"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Status Updated:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:$.isFetching?"Refreshing...":"Live"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-3",children:[e.jsxs(l,{variant:"secondary",onClick:tt,loading:$.isFetching,children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Refresh Status"]}),e.jsxs(l,{variant:"secondary",onClick:()=>{at()},loading:Y.isPending,disabled:K.isPending,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Reload Config"]}),e.jsxs(l,{variant:"danger",onClick:()=>{st()},loading:K.isPending,disabled:Y.isPending,children:[e.jsx(Ht,{className:"mr-2 h-4 w-4"}),"Restart Xray"]})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"`Reload Config` validates and reapplies generated config without hard restart. Use `Restart Xray` for binary/runtime issues."})]}),e.jsx("div",{id:"xray-updates",ref:oe,children:e.jsxs(w,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Core Updates"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Canary-first rollout with audit logging and Telegram notifications."})]}),e.jsxs("span",{className:"inline-flex items-center rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-900/35 dark:text-indigo-300",children:[(o==null?void 0:o.defaultChannel)||"stable"," default"]})]}),g?null:e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-500/35 bg-amber-500/10 px-3 py-2 text-xs text-amber-300",children:["Runtime mode is ",e.jsx("code",{className:"font-mono",children:we}),". Scripted update/rollback actions are disabled. Use your host updater flow for Xray-core lifecycle management."]}),e.jsxs("div",{className:"mb-4 grid grid-cols-1 gap-2 text-xs sm:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Runtime Mode"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:we.toUpperCase()})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Preflight"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:n!=null&&n.ready?"Ready":h.isLoading?"Checking":"Blocked"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Blocking Failures"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:He.length})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Update Lock"}),e.jsx("p",{className:"mt-1 truncate font-semibold text-gray-900 dark:text-gray-200",children:P?et||"Locked":"Unlocked"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-sm sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Canary Policy"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-200",children:o!=null&&o.requireCanaryBeforeFull?"Required before full rollout":"Optional"}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Window: ",(o==null?void 0:o.canaryWindowMinutes)||0," minutes"]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Last canary: ",o!=null&&o.lastSuccessfulCanaryAt?new Date(o.lastSuccessfulCanaryAt).toLocaleString():"none"]})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Execution Channel"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(l,{type:"button",size:"sm",variant:R==="stable"?"primary":"secondary",onClick:()=>de("stable"),disabled:A.isPending||V.isPending,children:"Stable"}),e.jsx(l,{type:"button",size:"sm",variant:R==="latest"?"primary":"secondary",onClick:()=>de("latest"),disabled:A.isPending||V.isPending,children:"Latest"})]})]})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Preflight Checks"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Validate script, Docker connectivity, and update lock before rollout."})]}),e.jsxs("div",{className:"flex w-full flex-wrap items-center gap-2 sm:w-auto sm:justify-end",children:[e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${n!=null&&n.ready?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-amber-100 text-amber-700 dark:bg-amber-900/35 dark:text-amber-300"}`,children:n!=null&&n.ready?"Ready":h.isLoading?"Checking...":"Blocked"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{h.refetch()},loading:h.isFetching,children:"Run Preflight"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{it()},disabled:se.length===0,children:"Copy Fixes"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{dt()},loading:ee.isPending,disabled:F,children:a("updateHealth.runtimeDoctor",{defaultValue:"Runtime Doctor"})}),N?e.jsx(l,{type:"button",size:"sm",variant:"danger",onClick:()=>{ft()},loading:je.isPending,disabled:!Ne||F,children:I?"Unlock Stale":"Force Unlock"}):null]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[((n==null?void 0:n.checks)||[]).map(t=>{const r=Qe(t);return e.jsxs("div",{className:"rounded-md border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-400",children:t.label}),e.jsx("p",{className:"break-all whitespace-normal text-sm text-gray-800 dark:text-gray-200",children:t.detail||(t.ok?"OK":"Failed")})]}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-1",children:[t.ok?e.jsx(wt,{className:"h-4 w-4 text-green-500"}):e.jsx(ea,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:`text-xs font-semibold ${t.ok?"text-green-600 dark:text-green-300":"text-red-600 dark:text-red-300"}`,children:t.ok?"PASS":t.blocking?"FAIL":"WARN"})]})]}),!t.ok&&r.length>0?e.jsxs("details",{className:"mt-2 rounded-md border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-semibold text-blue-600 dark:text-blue-300",children:"Show fix commands"}),e.jsx("div",{className:"mt-2 space-y-1",children:r.map(d=>e.jsx("pre",{className:"overflow-x-auto rounded bg-gray-900/95 px-2 py-1 text-[11px] text-gray-100",children:d},`${t.id}-${d}`))})]}):null]},t.id)}),!h.isLoading&&n&&!n.ready?e.jsx("p",{className:"text-xs text-red-600 dark:text-red-300",children:"Resolve blocking preflight checks before running canary/full/rollback update operations."}):null]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{rt()},loading:A.isPending,disabled:!g||F||E,children:"Run Canary"}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{nt()},loading:ue,disabled:!g||F||E,children:"Guided Rollout"}),e.jsx(l,{type:"button",onClick:()=>{Re(!1)},loading:V.isPending,disabled:!g||F||E||(o==null?void 0:o.requireCanaryBeforeFull)&&!(o!=null&&o.canaryReady),children:"Run Full Rollout"}),e.jsx(l,{type:"button",variant:"danger",onClick:()=>{Re(!0)},loading:V.isPending,disabled:!g||F||E,children:"Force Full Rollout"})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"Force is for emergency recoveries only. Standard rollout should run canary first."}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Rollback"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{L.refetch()},loading:L.isFetching,disabled:!g,children:"Refresh Tags"})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:"Select backup tag to roll back immediately to a previous working Xray image."}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]",children:[e.jsx("select",{value:p,onChange:t=>q(t.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",disabled:T.isPending||L.isLoading||j.length===0||E,children:j.length===0?e.jsx("option",{value:"",children:"No backup tags available"}):j.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx(l,{type:"button",variant:"danger",onClick:()=>{lt()},loading:T.isPending,disabled:!g||j.length===0||F||E,children:"Run Rollback"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Update Audit Trail"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{B.refetch()},loading:B.isFetching,children:"Refresh"})]}),B.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading history..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2",children:((i==null?void 0:i.items)||[]).map(t=>e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 text-xs dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-200",children:t.message}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:new Date(t.timestamp).toLocaleString()})]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["level=",t.level,t.metadata&&typeof t.metadata=="object"&&"actorUsername"in t.metadata?` â€¢ actor=${String(t.metadata.actorUsername||"system")}`:""]})]},t.id))}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Page ",((Fe=i==null?void 0:i.pagination)==null?void 0:Fe.page)||1," / ",((Xe=i==null?void 0:i.pagination)==null?void 0:Xe.totalPages)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>ce(t=>Math.max(1,t-1)),disabled:(((Le=i==null?void 0:i.pagination)==null?void 0:Le.page)||1)<=1,children:"Previous"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>ce(t=>{var r;return Math.min(((r=i==null?void 0:i.pagination)==null?void 0:r.totalPages)||t+1,t+1)}),disabled:(((Ae=i==null?void 0:i.pagination)==null?void 0:Ae.page)||1)>=(((Me=i==null?void 0:i.pagination)==null?void 0:Me.totalPages)||1),children:"Next"})]})]})]})]})]})}),e.jsxs(w,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Release Intelligence"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Live upstream view from XTLS/Xray-core to decide when to run canary/full upgrades."})]}),e.jsxs(l,{type:"button",variant:"secondary",onClick:()=>{ct()},loading:ye.isPending,children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Refresh Release Data"]})]}),xe.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading release intel..."}):e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Current Version"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:(m==null?void 0:m.currentVersion)||(y==null?void 0:y.version)||"unknown"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Stable"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:((Pe=(Ee=m==null?void 0:m.channels)==null?void 0:Ee.stable)==null?void 0:Pe.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(Ue=(Te=m==null?void 0:m.channels)==null?void 0:Te.stable)!=null&&Ue.needsUpdate?"Update available":"Up-to-date"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Latest"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:(($e=(Ge=m==null?void 0:m.channels)==null?void 0:Ge.latest)==null?void 0:$e.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(De=(Be=m==null?void 0:m.channels)==null?void 0:Be.latest)!=null&&De.publishedAt?new Date(m.channels.latest.publishedAt).toLocaleString():"No release data"})]})]})]}),e.jsxs(w,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Config Snapshots"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Create, list, and rollback generated Xray config snapshots directly from the panel."})]}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{ut()},loading:fe.isPending,children:"Create Snapshot"})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-[1fr_auto]",children:[e.jsx("select",{className:"rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",value:v,onChange:t=>W(t.target.value),disabled:H.isLoading||C.length===0,children:C.length===0?e.jsx("option",{value:"",children:"No snapshots found"}):C.map(t=>e.jsxs("option",{value:t.id,children:[t.id," ",t.reason?`(${t.reason})`:""]},t.id))}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{mt()},loading:pe.isPending,disabled:!v||C.length===0,children:"Rollback Snapshot"})]})]}),e.jsxs(w,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Routing Profile"}),e.jsxs("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:["Active mode: ",e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:(k==null?void 0:k.mode)||"smart"})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:["smart","filtered","strict","open"].map(t=>e.jsx(l,{type:"button",variant:(k==null?void 0:k.mode)===t?"primary":"secondary",onClick:()=>{gt(t)},loading:he.isPending&&(k==null?void 0:k.mode)!==t,children:t},t))})]}),e.jsxs(w,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Generated Xray Config"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Inspect the currently generated config JSON directly from One-UI."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{variant:"secondary",onClick:()=>qe(t=>!t),children:G?"Hide Preview":"Show Preview"}),e.jsxs(l,{variant:"secondary",onClick:()=>{ot()},disabled:!G||J.isLoading||!D,children:[e.jsx(Yt,{className:"mr-2 h-4 w-4"}),We?"Copied":"Copy JSON"]})]})]}),G?J.isLoading?e.jsx("div",{className:"py-6 text-sm text-gray-600 dark:text-gray-400",children:"Loading config preview..."}):e.jsx("pre",{className:"max-h-[420px] overflow-auto rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200",children:JSON.stringify(D||{},null,2)}):e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Open preview to inspect inbound, outbound, and routing payload before applying runtime changes."})]}),e.jsxs(w,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Geo Files"}),e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:"Update and verify geosite.dat / geoip.dat from configured geodata sources."}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:"Current Geodata"}),e.jsx("div",{className:"mt-2 space-y-1 text-gray-600 dark:text-gray-400",children:((te==null?void 0:te.files)||[]).map(t=>e.jsxs("p",{children:[t.name,": ",t.exists?`${(t.size/(1024*1024)).toFixed(2)} MB`:"missing"]},t.key))})]}),e.jsxs(l,{onClick:()=>{xt()},className:"w-full",variant:"secondary",loading:be.isPending,children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Update Geodata Files"]})]}),e.jsxs(w,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Confdir Sync"}),e.jsxs("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:["Export generated config into multi-file ",e.jsx("code",{className:"font-mono",children:"conf.d"})," layout for advanced deployments."]}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:["Directory: ",(M==null?void 0:M.directory)||"n/a"]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["Files: ",((Ie=M==null?void 0:M.files)==null?void 0:Ie.length)||0]})]}),e.jsxs(l,{onClick:()=>{yt()},className:"w-full",variant:"secondary",loading:ke.isPending,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Sync Confdir"]})]}),e.jsx(Kt,{open:!!u,title:(u==null?void 0:u.title)||"",description:u==null?void 0:u.description,confirmLabel:u==null?void 0:u.confirmLabel,cancelLabel:u==null?void 0:u.cancelLabel,tone:(u==null?void 0:u.tone)||"danger",onCancel:()=>Se(!1),onConfirm:()=>Se(!0)})]})};export{fa as default};
