import{c as La,f as Aa,d as Ea,e as Ua,r as m,j as e,C as Ta,b as Pa}from"./index-CG9kpP9Y.js";import{u as $a}from"./useQuery-ClalJbNF.js";import{e as Ga,f as Qa,g as Da,h as Ba,b as Ia,u as Oa,i as za,j as qa,k as Wa,l as Ka,m as _a,n as Ja,o as Ya,p as Za,q as Ha,r as et,s as at,t as tt,v as st,w as rt,x as nt,y as lt,c as ot,d as dt}from"./useXray-SvnEARzK.js";import{u as it,a as ct,k as ut,e as mt,d as gt}from"./useMieru-ChZiSjrZ.js";import{u as xt,C as b}from"./useToast-C_OO-2JX.js";import{B as l}from"./Button-B80QVKRC.js";import{C as yt}from"./ConfirmDialog-BK4iJYOB.js";import{C as ft,c as Ze}from"./clipboard-D_hUxpVN.js";import{g as J,a as He}from"./xrayUpdatePreflight-CrNj47ho.js";import{u as pt,R as D}from"./useTranslation-DQjABgHn.js";import{F as ea}from"./file-code-2-B1nNAYmF.js";import{S as ht}from"./server-QlfyTjA1.js";import"./useMutation-Br-t0osD.js";import"./xray-BZhXygCD.js";import"./cn-BLSKlp9E.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=La("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);function kt(S){if(!S||S<1)return"N/A";const B=Math.floor(S/86400),G=Math.floor(S%86400/3600),s=Math.floor(S%3600/60);return`${B}d ${G}h ${s}m`}const Tt=()=>{var Te,Pe,$e,Ge,Qe,De,Be,Ie,Oe,ze,qe,We,Ke,_e,Je,Ye;const S=Aa(a=>{var r;return((r=a.admin)==null?void 0:r.role)==="SUPER_ADMIN"}),B=Ea(),G=Ua(),s=xt(),{t}=pt(),ue=m.useRef(null),V=m.useRef(null),[I,aa]=m.useState(!1),[ta,me]=m.useState(!1),[F,ge]=m.useState("stable"),[sa,xe]=m.useState(1),[k,Y]=m.useState(""),[C,Z]=m.useState(""),[ye,fe]=m.useState(!1),[O,ra]=m.useState(!1),[g,pe]=m.useState(null),{data:H}=$a({queryKey:["system-stats"],queryFn:async()=>await Pa.get("/system/stats"),refetchInterval:5e3}),z=Ga(),na=it(),he=ct(),be=ut(120,O),ke=mt(),je=gt(),ee=Qa(I),ae=Da(),te=Ba(),se=Ia(),j=Oa(),o=se.data,n=j.data,y=(o==null?void 0:o.updatesEnabled)!==!1,la=se.isSuccess?y:!1,q=za(sa,10),A=qa(la),Ne=Wa(y),we=Ka(),re=_a(!0),ve=Ja(),Se=Ya(),oa=Za(!0),Ce=Ha(),da=et(!0),Re=at(),ia=tt(!0),Ve=st(),E=rt(),M=nt(),Q=lt(),Fe=ot(),ne=dt(),N=H==null?void 0:H.data,p=z.data,u=na.data,d=he.data,U=be.data,W=ee.data,i=q.data,x=Ne.data,R=m.useMemo(()=>{var a;return((a=re.data)==null?void 0:a.snapshots)??[]},[(Te=re.data)==null?void 0:Te.snapshots]),w=oa.data,le=da.data,T=ia.data,v=m.useMemo(()=>A.data??[],[A.data]),Me=(o==null?void 0:o.mode)||(n==null?void 0:n.mode)||"docker",P=j.isLoading||!(n!=null&&n.ready),oe=((n==null?void 0:n.checks)||[]).filter(a=>!a.ok),ca=oe.filter(a=>a.blocking),$=((n==null?void 0:n.checks)||[]).find(a=>a.id==="update-lock"&&!a.ok),Xe=!!$,ua=J($,"ownerId"),Le=J($,"expiresAt"),Ae=n!=null&&n.generatedAt?new Date(n.generatedAt).getTime():Number.NaN,K=Le&&Number.isFinite(Ae)?new Date(Le).getTime()<=Ae:!1,de=m.useMemo(()=>Array.from(new Set(oe.flatMap(a=>He(a)).filter(a=>a.trim().length>0))),[oe]),X=ye||E.isPending||M.isPending||Q.isPending||ne.isPending;m.useEffect(()=>{if(!R.length){Z("");return}(!C||!R.some(a=>a.id===C))&&Z(R[0].id)},[R,C]),m.useEffect(()=>{if(!v.length){k!==""&&Y("");return}(!k||!v.includes(k))&&Y(v[0])},[v,k]),m.useEffect(()=>{if(new URLSearchParams(B.search).get("section")!=="xray-updates")return;const r=window.setTimeout(()=>{var c;(c=ue.current)==null||c.scrollIntoView({behavior:"smooth",block:"start"})},120);return()=>window.clearTimeout(r)},[B.search]),m.useEffect(()=>()=>{var a;(a=V.current)==null||a.call(V,!1),V.current=null},[]);const L=({title:a,description:r,confirmLabel:c="Confirm",cancelLabel:f="Cancel",tone:h="danger"})=>new Promise(_=>{V.current=_,pe({title:a,description:r,confirmLabel:c,cancelLabel:f,tone:h})}),Ee=a=>{const r=V.current;V.current=null,pe(null),r==null||r(a)},ma=()=>{G.invalidateQueries({queryKey:["xray-status"]})},ga=()=>{G.invalidateQueries({queryKey:["mieru-status"]}),O&&G.invalidateQueries({queryKey:["mieru-logs"]})},xa=async()=>{try{const a=await te.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),a.message||t("systemSettings.toast.configReloaded",{defaultValue:"Xray config reloaded successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.configReloadFailed",{defaultValue:"Failed to reload Xray config"}))}},ya=async()=>{try{const a=await ae.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),a.message||t("systemSettings.toast.restartSuccess",{defaultValue:"Xray restarted successfully!"}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.restartFailed",{defaultValue:"Failed to restart Xray"}))}},fa=async()=>{try{const a=await ke.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),a.message||t("systemSettings.toast.mieruRestartSuccess",{defaultValue:"Mieru sidecar restarted successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.mieruRestartFailed",{defaultValue:"Failed to restart Mieru sidecar."}))}},pa=async()=>{try{const a=await je.mutateAsync("manual.sync.button");if(a.skipped){s.warning(t("common.warning",{defaultValue:"Warning"}),a.skippedReason||t("systemSettings.toast.mieruSyncSkipped",{defaultValue:"Mieru sync is currently skipped."}));return}a.changed?s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.mieruSyncChanged",{defaultValue:"Mieru users synced successfully ({{count}} users).",count:a.userCount})):s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.mieruSyncNoChange",{defaultValue:"Mieru users are already in sync ({{count}} users).",count:a.userCount})),a.restartError&&s.warning(t("common.warning",{defaultValue:"Warning"}),a.restartError)}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.mieruSyncFailed",{defaultValue:"Failed to sync Mieru users."}))}},ha=async()=>{if(!y){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}try{const a=await E.mutateAsync({channel:F});s.success(t("common.success",{defaultValue:"Success"}),a.summary||t("systemSettings.toast.canaryComplete",{defaultValue:"Canary update completed successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.canaryFailed",{defaultValue:"Failed to run canary update"}))}},Ue=async(a=!1)=>{if(!y){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}if(await L({title:a?"Force full rollout?":"Run full rollout?",description:a?"Run full rollout and bypass canary requirement?":"Run full rollout now? This will restart Xray service.",confirmLabel:a?"Force rollout":"Run rollout",tone:a?"danger":"primary"}))try{const f=await M.mutateAsync({channel:F,force:a});s.success(t("common.success",{defaultValue:"Success"}),f.summary||t("systemSettings.toast.fullRolloutComplete",{defaultValue:"Full rollout completed successfully."}))}catch(f){s.error(t("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||t("systemSettings.toast.fullRolloutFailed",{defaultValue:"Failed to run full rollout"}))}},ba=async()=>{var r;if(!y){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeGuidedUnavailable",{defaultValue:"Guided rollout is unavailable in manual mode. Use your host update workflow."}));return}if(await L({title:`Start guided rollout (${F.toUpperCase()})?`,description:"This flow runs Canary first, then prompts Full rollout.",confirmLabel:"Start guided rollout",tone:"primary"})){fe(!0);try{if(!((r=(await j.refetch()).data)!=null&&r.ready)){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.preflightBlocked",{defaultValue:"Resolve preflight checks before guided rollout."}));return}const f=await E.mutateAsync({channel:F});if(!await L({title:"Canary complete",description:`Canary finished successfully.${f.summary?`

${f.summary}`:""}

Continue with Full rollout now?`,confirmLabel:"Continue to full rollout",tone:"primary"})){s.info(t("common.info",{defaultValue:"Info"}),t("systemSettings.toast.guidedPaused",{defaultValue:"Canary complete. Full rollout skipped."}));return}const _=await M.mutateAsync({channel:F});s.success(t("common.success",{defaultValue:"Success"}),_.summary||t("systemSettings.toast.guidedComplete",{defaultValue:"Guided rollout completed successfully."}))}catch(c){const f=(c==null?void 0:c.message)||"Guided rollout failed";if(!await L({title:"Guided rollout failed",description:`${f}

Run rollback shortcut now?`,confirmLabel:"Run rollback",tone:"danger"}))return;const ie=(await A.refetch()).data||v,ce=k||(ie==null?void 0:ie[0]);if(!ce){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.noRollbackTag",{defaultValue:"No rollback backup tag available. Refresh tags and try again."}));return}const Xa=await Q.mutateAsync({backupTag:ce});s.success(t("common.success",{defaultValue:"Success"}),Xa.summary||t("systemSettings.toast.rollbackCompleteWithTag",{defaultValue:"Rollback completed using {{tag}}.",tag:ce}))}finally{fe(!1)}}},ka=async()=>{if(!y){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeRollbackDisabled",{defaultValue:"Scripted rollback is disabled in manual mode. Use your host rollback workflow."}));return}const a=k?`Run rollback with ${k}?`:"Run rollback with latest available backup tag?";if(await L({title:"Run rollback?",description:a,confirmLabel:"Run rollback",tone:"danger"}))try{const c=await Q.mutateAsync({backupTag:k||void 0});s.success(t("common.success",{defaultValue:"Success"}),c.summary||t("systemSettings.toast.rollbackComplete",{defaultValue:"Rollback completed successfully."}))}catch(c){s.error(t("common.error",{defaultValue:"Error"}),(c==null?void 0:c.message)||t("systemSettings.toast.rollbackFailed",{defaultValue:"Failed to run rollback"}))}},ja=async()=>{if(W)try{if(!await Ze(JSON.stringify(W,null,2)))throw new Error("copy_failed");me(!0),window.setTimeout(()=>me(!1),1500)}catch{s.error(t("common.error",{defaultValue:"Error"}),t("systemSettings.toast.copyConfigFailed",{defaultValue:"Failed to copy config to clipboard"}))}},Na=async()=>{if(!de.length)return;const a=["# One-UI Xray Update Preflight Fixes",...de.map(r=>`- ${r}`)].join(`
`);try{if(!await Ze(a))throw new Error("copy_failed");s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.copyPreflightFixesSuccess",{defaultValue:"Preflight fix commands copied."}))}catch{s.error(t("common.error",{defaultValue:"Error"}),t("systemSettings.toast.copyPreflightFixesFailed",{defaultValue:"Failed to copy preflight fix commands."}))}},wa=async()=>{try{const a=await ne.mutateAsync({repair:!0,source:"system-settings"});s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.runtimeDoctorComplete",{defaultValue:"Runtime doctor completed. Applied {{count}} repair action(s).",count:a.repairedCount||0})),await Promise.all([j.refetch(),se.refetch(),z.refetch()])}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.runtimeDoctorFailed",{defaultValue:"Runtime doctor failed."}))}},va=async()=>{try{await we.mutateAsync(),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.releaseIntelRefreshed",{defaultValue:"Latest release metadata pulled from upstream."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.releaseIntelRefreshFailed",{defaultValue:"Failed to refresh release intel"}))}},Sa=async()=>{try{const a=await ve.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.snapshotCreated",{defaultValue:"Snapshot ID: {{id}}",id:a.id}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.snapshotFailed",{defaultValue:"Failed to create config snapshot"}))}},Ca=async()=>{if(!C){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.selectSnapshot",{defaultValue:"Choose a snapshot before rollback."}));return}if(await L({title:"Rollback config snapshot?",description:`Rollback Xray config using snapshot ${C}?`,confirmLabel:"Rollback snapshot",tone:"danger"}))try{const r=await Se.mutateAsync({snapshotId:C,applyMethod:"restart"});s.success(t("common.success",{defaultValue:"Success"}),r.message||t("systemSettings.toast.configRollbackComplete",{defaultValue:"Config rollback completed."}))}catch(r){s.error(t("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||t("systemSettings.toast.configRollbackFailed",{defaultValue:"Failed to rollback snapshot"}))}},Ra=async a=>{try{await Ce.mutateAsync({mode:a,apply:!0}),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.routingUpdated",{defaultValue:"Routing profile switched to {{mode}}.",mode:a}))}catch(r){s.error(t("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||t("systemSettings.toast.routingUpdateFailed",{defaultValue:"Failed to update routing profile"}))}},Va=async()=>{try{await Re.mutateAsync({useCommand:!0,forceDownload:!1,reload:!0}),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.geodataUpdated",{defaultValue:"Geodata updated successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.geodataUpdateFailed",{defaultValue:"Failed to update geodata"}))}},Fa=async()=>{try{const a=await Ve.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.confdirSynced",{defaultValue:"{{count}} file(s) synchronized.",count:a.files.length}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.confdirSyncFailed",{defaultValue:"Failed to sync confdir"}))}},Ma=async()=>{if(!S||!Xe)return;const a=J($,"ownerId"),r=J($,"expiresAt"),c=a&&r?`Force unlock active update lock owned by ${a} (expires ${new Date(r).toLocaleString()})?`:"Force unlock the active Xray update lock?";if(await L({title:K?"Unlock stale update lock?":"Force unlock active update lock?",description:c,confirmLabel:K?"Unlock":"Force unlock",tone:"danger"}))try{const h=await Fe.mutateAsync({reason:"manual-force-unlock-from-settings",force:!K});s.success(t("common.success",{defaultValue:"Success"}),h.message||(h.unlocked?t("systemSettings.toast.updateLockReleased",{defaultValue:"Update lock released."}):t("systemSettings.toast.updateLockNotReleased",{defaultValue:"Update lock not released."})))}catch(h){s.error(t("common.error",{defaultValue:"Error"}),(h==null?void 0:h.message)||t("systemSettings.toast.unlockFailed",{defaultValue:"Failed to unlock update lock."}))}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"System Information"}),N?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"CPU Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[N.cpu??"N/A",typeof N.cpu=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Memory Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[N.memory??"N/A",typeof N.memory=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:N.users??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Inbounds:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:N.inbounds??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Uptime:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:N.uptime||kt(N.uptimeSeconds)})]})]}):null]}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Runtime"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Monitor service status and run zero-downtime config reloads."})]}),e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${p!=null&&p.running?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900/35 dark:text-red-300"}`,children:p!=null&&p.running?"Running":"Stopped"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Version:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:(p==null?void 0:p.version)||"unknown"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Status Updated:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:z.isFetching?"Refreshing...":"Live"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-3",children:[e.jsxs(l,{variant:"secondary",onClick:ma,loading:z.isFetching,children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Refresh Status"]}),e.jsxs(l,{variant:"secondary",onClick:()=>{xa()},loading:te.isPending,disabled:ae.isPending,children:[e.jsx(ea,{className:"mr-2 h-4 w-4"}),"Reload Config"]}),e.jsxs(l,{variant:"danger",onClick:()=>{ya()},loading:ae.isPending,disabled:te.isPending,children:[e.jsx(ht,{className:"mr-2 h-4 w-4"}),"Restart Xray"]})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"`Reload Config` validates and reapplies generated config without hard restart. Use `Restart Xray` for binary/runtime issues."})]}),e.jsx("div",{id:"mieru-sidecar",children:e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Mieru Sidecar (Option 2)"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"External runtime integration for GPL-safe deployment. Managed as an isolated sidecar."})]}),e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${u!=null&&u.enabled?d!=null&&d.running?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-amber-100 text-amber-700 dark:bg-amber-900/35 dark:text-amber-300":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200"}`,children:u!=null&&u.enabled?d!=null&&d.running?"Running":"Stopped":"Disabled"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 text-sm sm:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Mode"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-100",children:(u==null?void 0:u.mode)||"docker"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"State"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-100",children:(d==null?void 0:d.state)||"unknown"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Version"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-100",children:(d==null?void 0:d.version)||"unknown"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Health"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-100",children:(Pe=d==null?void 0:d.health)!=null&&Pe.configured?d.health.ok?`OK${typeof d.health.latencyMs=="number"?` (${d.health.latencyMs}ms)`:""}`:"Unreachable":"Not configured"})]})]}),d!=null&&d.detail?e.jsx("p",{className:"mt-3 text-xs text-gray-600 dark:text-gray-400",children:d.detail}):null,e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-4",children:[e.jsxs(l,{variant:"secondary",onClick:ga,loading:he.isFetching,children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Refresh Status"]}),e.jsxs(l,{variant:"secondary",onClick:()=>{pa()},loading:je.isPending,disabled:!(u!=null&&u.enabled),children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Sync Users"]}),e.jsx(l,{variant:"secondary",onClick:()=>ra(a=>!a),disabled:!(u!=null&&u.enabled),children:O?"Hide Logs":"Show Logs"}),e.jsx(l,{variant:"primary",onClick:()=>{fa()},loading:ke.isPending,disabled:!(u!=null&&u.enabled),children:"Restart Mieru"})]}),O?e.jsx("div",{className:"mt-3 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:be.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading Mieru logs..."}):e.jsx("pre",{className:"max-h-56 overflow-auto whitespace-pre-wrap rounded bg-gray-900/95 p-3 text-xs text-gray-100",children:(U==null?void 0:U.raw)||(U==null?void 0:U.detail)||"No log output available."})}):null]})}),e.jsx("div",{id:"xray-updates",ref:ue,children:e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Core Updates"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Canary-first rollout with audit logging and Telegram notifications."})]}),e.jsxs("span",{className:"inline-flex items-center rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-900/35 dark:text-indigo-300",children:[(o==null?void 0:o.defaultChannel)||"stable"," default"]})]}),y?null:e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-500/35 bg-amber-500/10 px-3 py-2 text-xs text-amber-300",children:["Runtime mode is ",e.jsx("code",{className:"font-mono",children:Me}),". Scripted update/rollback actions are disabled. Use your host updater flow for Xray-core lifecycle management."]}),e.jsxs("div",{className:"mb-4 grid grid-cols-1 gap-2 text-xs sm:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Runtime Mode"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:Me.toUpperCase()})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Preflight"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:n!=null&&n.ready?"Ready":j.isLoading?"Checking":"Blocked"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Blocking Failures"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:ca.length})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Update Lock"}),e.jsx("p",{className:"mt-1 truncate font-semibold text-gray-900 dark:text-gray-200",children:$?ua||"Locked":"Unlocked"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-sm sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Canary Policy"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-200",children:o!=null&&o.requireCanaryBeforeFull?"Required before full rollout":"Optional"}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Window: ",(o==null?void 0:o.canaryWindowMinutes)||0," minutes"]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Last canary: ",o!=null&&o.lastSuccessfulCanaryAt?new Date(o.lastSuccessfulCanaryAt).toLocaleString():"none"]})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Execution Channel"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(l,{type:"button",size:"sm",variant:F==="stable"?"primary":"secondary",onClick:()=>ge("stable"),disabled:E.isPending||M.isPending,children:"Stable"}),e.jsx(l,{type:"button",size:"sm",variant:F==="latest"?"primary":"secondary",onClick:()=>ge("latest"),disabled:E.isPending||M.isPending,children:"Latest"})]})]})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Preflight Checks"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Validate script, Docker connectivity, and update lock before rollout."})]}),e.jsxs("div",{className:"flex w-full flex-wrap items-center gap-2 sm:w-auto sm:justify-end",children:[e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${n!=null&&n.ready?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-amber-100 text-amber-700 dark:bg-amber-900/35 dark:text-amber-300"}`,children:n!=null&&n.ready?"Ready":j.isLoading?"Checking...":"Blocked"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{j.refetch()},loading:j.isFetching,children:"Run Preflight"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{Na()},disabled:de.length===0,children:"Copy Fixes"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{wa()},loading:ne.isPending,disabled:X,children:t("updateHealth.runtimeDoctor",{defaultValue:"Runtime Doctor"})}),S?e.jsx(l,{type:"button",size:"sm",variant:"danger",onClick:()=>{Ma()},loading:Fe.isPending,disabled:!Xe||X,children:K?"Unlock Stale":"Force Unlock"}):null]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[((n==null?void 0:n.checks)||[]).map(a=>{const r=He(a);return e.jsxs("div",{className:"rounded-md border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-400",children:a.label}),e.jsx("p",{className:"break-all whitespace-normal text-sm text-gray-800 dark:text-gray-200",children:a.detail||(a.ok?"OK":"Failed")})]}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-1",children:[a.ok?e.jsx(Ta,{className:"h-4 w-4 text-green-500"}):e.jsx(bt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:`text-xs font-semibold ${a.ok?"text-green-600 dark:text-green-300":"text-red-600 dark:text-red-300"}`,children:a.ok?"PASS":a.blocking?"FAIL":"WARN"})]})]}),!a.ok&&r.length>0?e.jsxs("details",{className:"mt-2 rounded-md border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-semibold text-blue-600 dark:text-blue-300",children:"Show fix commands"}),e.jsx("div",{className:"mt-2 space-y-1",children:r.map(c=>e.jsx("pre",{className:"overflow-x-auto rounded bg-gray-900/95 px-2 py-1 text-[11px] text-gray-100",children:c},`${a.id}-${c}`))})]}):null]},a.id)}),!j.isLoading&&n&&!n.ready?e.jsx("p",{className:"text-xs text-red-600 dark:text-red-300",children:"Resolve blocking preflight checks before running canary/full/rollback update operations."}):null]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{ha()},loading:E.isPending,disabled:!y||X||P,children:"Run Canary"}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{ba()},loading:ye,disabled:!y||X||P,children:"Guided Rollout"}),e.jsx(l,{type:"button",onClick:()=>{Ue(!1)},loading:M.isPending,disabled:!y||X||P||(o==null?void 0:o.requireCanaryBeforeFull)&&!(o!=null&&o.canaryReady),children:"Run Full Rollout"}),e.jsx(l,{type:"button",variant:"danger",onClick:()=>{Ue(!0)},loading:M.isPending,disabled:!y||X||P,children:"Force Full Rollout"})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"Force is for emergency recoveries only. Standard rollout should run canary first."}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Rollback"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{A.refetch()},loading:A.isFetching,disabled:!y,children:"Refresh Tags"})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:"Select backup tag to roll back immediately to a previous working Xray image."}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]",children:[e.jsx("select",{value:k,onChange:a=>Y(a.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",disabled:Q.isPending||A.isLoading||v.length===0||P,children:v.length===0?e.jsx("option",{value:"",children:"No backup tags available"}):v.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx(l,{type:"button",variant:"danger",onClick:()=>{ka()},loading:Q.isPending,disabled:!y||v.length===0||X||P,children:"Run Rollback"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Update Audit Trail"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>{q.refetch()},loading:q.isFetching,children:"Refresh"})]}),q.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading history..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2",children:((i==null?void 0:i.items)||[]).map(a=>e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 text-xs dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-200",children:a.message}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:new Date(a.timestamp).toLocaleString()})]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["level=",a.level,a.metadata&&typeof a.metadata=="object"&&"actorUsername"in a.metadata?` â€¢ actor=${String(a.metadata.actorUsername||"system")}`:""]})]},a.id))}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Page ",(($e=i==null?void 0:i.pagination)==null?void 0:$e.page)||1," / ",((Ge=i==null?void 0:i.pagination)==null?void 0:Ge.totalPages)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>xe(a=>Math.max(1,a-1)),disabled:(((Qe=i==null?void 0:i.pagination)==null?void 0:Qe.page)||1)<=1,children:"Previous"}),e.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:()=>xe(a=>{var r;return Math.min(((r=i==null?void 0:i.pagination)==null?void 0:r.totalPages)||a+1,a+1)}),disabled:(((De=i==null?void 0:i.pagination)==null?void 0:De.page)||1)>=(((Be=i==null?void 0:i.pagination)==null?void 0:Be.totalPages)||1),children:"Next"})]})]})]})]})]})}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Release Intelligence"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Live upstream view from XTLS/Xray-core to decide when to run canary/full upgrades."})]}),e.jsxs(l,{type:"button",variant:"secondary",onClick:()=>{va()},loading:we.isPending,children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Refresh Release Data"]})]}),Ne.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading release intel..."}):e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Current Version"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:(x==null?void 0:x.currentVersion)||(p==null?void 0:p.version)||"unknown"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Stable"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:((Oe=(Ie=x==null?void 0:x.channels)==null?void 0:Ie.stable)==null?void 0:Oe.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(qe=(ze=x==null?void 0:x.channels)==null?void 0:ze.stable)!=null&&qe.needsUpdate?"Update available":"Up-to-date"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Latest"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:((Ke=(We=x==null?void 0:x.channels)==null?void 0:We.latest)==null?void 0:Ke.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(Je=(_e=x==null?void 0:x.channels)==null?void 0:_e.latest)!=null&&Je.publishedAt?new Date(x.channels.latest.publishedAt).toLocaleString():"No release data"})]})]})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Config Snapshots"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Create, list, and rollback generated Xray config snapshots directly from the panel."})]}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{Sa()},loading:ve.isPending,children:"Create Snapshot"})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-[1fr_auto]",children:[e.jsx("select",{className:"rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",value:C,onChange:a=>Z(a.target.value),disabled:re.isLoading||R.length===0,children:R.length===0?e.jsx("option",{value:"",children:"No snapshots found"}):R.map(a=>e.jsxs("option",{value:a.id,children:[a.id," ",a.reason?`(${a.reason})`:""]},a.id))}),e.jsx(l,{type:"button",variant:"secondary",onClick:()=>{Ca()},loading:Se.isPending,disabled:!C||R.length===0,children:"Rollback Snapshot"})]})]}),e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Routing Profile"}),e.jsxs("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:["Active mode: ",e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:(w==null?void 0:w.mode)||"smart"})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:["smart","filtered","strict","open"].map(a=>e.jsx(l,{type:"button",variant:(w==null?void 0:w.mode)===a?"primary":"secondary",onClick:()=>{Ra(a)},loading:Ce.isPending&&(w==null?void 0:w.mode)!==a,children:a},a))})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Generated Xray Config"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Inspect the currently generated config JSON directly from One-UI."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{variant:"secondary",onClick:()=>aa(a=>!a),children:I?"Hide Preview":"Show Preview"}),e.jsxs(l,{variant:"secondary",onClick:()=>{ja()},disabled:!I||ee.isLoading||!W,children:[e.jsx(ft,{className:"mr-2 h-4 w-4"}),ta?"Copied":"Copy JSON"]})]})]}),I?ee.isLoading?e.jsx("div",{className:"py-6 text-sm text-gray-600 dark:text-gray-400",children:"Loading config preview..."}):e.jsx("pre",{className:"max-h-[420px] overflow-auto rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200",children:JSON.stringify(W||{},null,2)}):e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Open preview to inspect inbound, outbound, and routing payload before applying runtime changes."})]}),e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Geo Files"}),e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:"Update and verify geosite.dat / geoip.dat from configured geodata sources."}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:"Current Geodata"}),e.jsx("div",{className:"mt-2 space-y-1 text-gray-600 dark:text-gray-400",children:((le==null?void 0:le.files)||[]).map(a=>e.jsxs("p",{children:[a.name,": ",a.exists?`${(a.size/(1024*1024)).toFixed(2)} MB`:"missing"]},a.key))})]}),e.jsxs(l,{onClick:()=>{Va()},className:"w-full",variant:"secondary",loading:Re.isPending,children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Update Geodata Files"]})]}),e.jsxs(b,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Confdir Sync"}),e.jsxs("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:["Export generated config into multi-file ",e.jsx("code",{className:"font-mono",children:"conf.d"})," layout for advanced deployments."]}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:["Directory: ",(T==null?void 0:T.directory)||"n/a"]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["Files: ",((Ye=T==null?void 0:T.files)==null?void 0:Ye.length)||0]})]}),e.jsxs(l,{onClick:()=>{Fa()},className:"w-full",variant:"secondary",loading:Ve.isPending,children:[e.jsx(ea,{className:"mr-2 h-4 w-4"}),"Sync Confdir"]})]}),e.jsx(yt,{open:!!g,title:(g==null?void 0:g.title)||"",description:g==null?void 0:g.description,confirmLabel:g==null?void 0:g.confirmLabel,cancelLabel:g==null?void 0:g.cancelLabel,tone:(g==null?void 0:g.tone)||"danger",onCancel:()=>Ee(!1),onConfirm:()=>Ee(!0)})]})};export{Tt as default};
