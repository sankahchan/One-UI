import{b as r,e as z,r as v,k as I}from"./index-ypj_4hQQ.js";import{u as q}from"./useQuery-CrpZYdr1.js";import{u as n}from"./useMutation-aFhPvO3K.js";import{u as o,b as G,a as X,c as H,d as V,e as Y,r as Z,f as ee,h as se,i as te,j as re,k as ne,l as ie}from"./users-Bcq3n9Ku.js";import{API_URL as ue}from"./client-DZBKUZYs.js";const ye=(e={})=>q({queryKey:["users",e],queryFn:()=>o.getUsers(e),placeholderData:I,staleTime:3e4}),ve=e=>q({queryKey:["user",e],queryFn:()=>o.getUserById(e),enabled:!!e,staleTime:3e4}),me=(e,s=60,t={})=>q({queryKey:["user-devices",e,s],queryFn:()=>o.getUserDevices(e,s),enabled:!!e,staleTime:t.staleTime??15e3,refetchInterval:t.refetchInterval}),fe=(e,s={})=>{const t=z(a=>a.token),[f,C]=v.useState(null),[F,i]=v.useState("idle"),[_,u]=v.useState(""),[L,M]=v.useState(null),[O,K]=v.useState(0),h=s.live!==!1,T=s.includeOffline??!0,R=v.useMemo(()=>e.filter(a=>Number.isInteger(a)&&a>0).join(","),[e]),A=Number.isInteger(s.streamInterval)?Math.min(Math.max(s.streamInterval,500),1e4):2e3,Q=s.refetchInterval??1e4,D=q({queryKey:["user-sessions",e,s.includeOffline??!0],queryFn:()=>ne(e,{includeOffline:s.includeOffline??!0,limit:e.length}),enabled:e.length>0,refetchInterval:h&&F==="connected"?!1:Q,staleTime:s.staleTime??5e3});return v.useEffect(()=>{if(!h){i("idle"),u(""),K(0);return}if(e.length===0){i("idle"),u(""),K(0),C(null);return}if(!t){i("error"),u("Missing auth token");return}const a=new AbortController,B=new TextDecoder;let U="",d=!0,S=null,m=0;const w=()=>{S&&(window.clearTimeout(S),S=null)},N=10,g=y=>{if(!d||a.signal.aborted)return;if(m+=1,K(m),m>N){i("error"),u("Live stream unavailable after multiple retries. Falling back to polling.");return}const c=Math.min(1e3*2**Math.max(0,m-1),15e3);i("connecting"),u(y||`Stream disconnected. Retrying in ${(c/1e3).toFixed(0)}s...`),w(),S=window.setTimeout(()=>{E()},c)},E=async()=>{if(!(!d||a.signal.aborted)){i("connecting"),m===0&&u("");try{const y=new URLSearchParams({userIds:R,includeOffline:String(T),limit:String(e.length||200),interval:String(A)}),c=await fetch(`${ue}/users/sessions/stream?${y.toString()}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,Accept:"text/event-stream"},signal:a.signal,cache:"no-store"});if(!c.ok||!c.body)throw new Error(`Live session stream unavailable (${c.status})`);if(!d)return;i("connected"),u(""),m=0,K(0);const P=c.body.getReader();for(;d;){const{done:$,value:j}=await P.read();if($){a.signal.aborted||g("Live stream ended unexpectedly.");return}U+=B.decode(j,{stream:!0});const x=U.split(`

`);U=x.pop()||"";for(const J of x){const W=J.split(`
`);let p="message";const k=[];for(const l of W)l.startsWith("event:")?p=l.slice(6).trim():l.startsWith("data:")&&k.push(l.slice(5).trim());if(k.length===0)continue;const b=k.join(`
`);if(p==="snapshot")try{const l=JSON.parse(b);d&&(C(l),M(l.generatedAt||new Date().toISOString()),i("connected"),u(""))}catch{}else if(p==="error")try{const l=JSON.parse(b);d&&(u(l.message||"Live stream error"),i("error"),g(l.message||"Live stream error"))}catch{d&&(u(b||"Live stream error"),i("error"),g(b||"Live stream error"))}}}}catch(y){if(!a.signal.aborted&&d){i("error");const c=(y==null?void 0:y.message)||"Failed to connect live stream";u(c),g(c)}}}};return E(),()=>{d=!1,w(),a.abort()}},[Q,T,R,h,A,t,e.length]),{...D,data:f||D.data,streamStatus:F,streamError:_,lastSnapshotAt:L,reconnectAttempts:O}},qe=()=>{const e=r();return n({mutationFn:o.createUser,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Ke=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>o.updateUser(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]})}})},Se=()=>{const e=r();return n({mutationFn:o.deleteUser,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},ge=()=>{const e=r();return n({mutationFn:({id:s,fingerprint:t})=>o.revokeUserDevice(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user-devices",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},be=()=>{const e=r();return n({mutationFn:o.resetTraffic,onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t]})}})},he=()=>{const e=r();return n({mutationFn:({id:s,inboundId:t,enabled:f})=>o.toggleUserInbound(s,t,f),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds"]})}})},Qe=()=>{const e=r();return n({mutationFn:({id:s,inboundId:t,priority:f})=>o.updateUserInboundPriority(s,t,f),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds-users-directory"]})}})},Ue=()=>{const e=r();return n({mutationFn:({id:s,assignments:t})=>o.reorderUserInbounds(s,t),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["inbounds-users-directory"]})}})},pe=(e,s={})=>q({queryKey:["user-activity",e,s],queryFn:()=>ie(e,s),enabled:!!e,placeholderData:I,staleTime:1e4}),ke=()=>{const e=r();return n({mutationFn:s=>X(s),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Ce=()=>{const e=r();return n({mutationFn:G,onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Fe=()=>{const e=r();return n({mutationFn:s=>H(s),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Te=()=>{const e=r();return n({mutationFn:({userIds:s,days:t})=>V(s,t),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Re=()=>{const e=r();return n({mutationFn:({userIds:s,status:t})=>Y(s,t),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]})}})},Ae=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>Z(s,t||{}),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["subscription-info",t.id]})}})},De=()=>{const e=r();return n({mutationFn:({id:s,data:t})=>ee(s,t||{}),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t.id]}),e.invalidateQueries({queryKey:["user-sessions"]}),e.invalidateQueries({queryKey:["subscription-info",t.id]})}})},we=()=>{const e=r();return n({mutationFn:s=>se(s),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user",t]}),e.invalidateQueries({queryKey:["subscription-info",t]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},Ee=()=>{const e=r();return n({mutationFn:({userIds:s,data:t})=>te(s,t||{}),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user-sessions"]})}})},xe=()=>{const e=r();return n({mutationFn:({userIds:s,data:t})=>re(s,t||{}),onSuccess:()=>{e.invalidateQueries({queryKey:["users"]}),e.invalidateQueries({queryKey:["user-sessions"]})}})};export{Ke as a,ye as b,Se as c,Ae as d,De as e,we as f,ke as g,Fe as h,Te as i,Re as j,Ee as k,xe as l,fe as m,ve as n,me as o,be as p,ge as q,he as r,Qe as s,Ue as t,Ce as u,qe as v,pe as w};
