import{b as st,e as Ue,r as i,j as e}from"./index-ypj_4hQQ.js";import{Q as at}from"./index-DsE4WUd3.js";import{u as v}from"./useQuery-CrpZYdr1.js";import{u as g}from"./useMutation-aFhPvO3K.js";import{a as j}from"./auth-D-N3itKB.js";import{apiClient as x}from"./client-DZBKUZYs.js";import{u as rt,C as y}from"./useToast-DzXNWj1a.js";import{B as d}from"./Button-CkiGx0aE.js";import{I as h}from"./Input-ConZjJPP.js";import{u as nt}from"./useTranslation-Z2v1dAK4.js";import{S as lt}from"./Settings-Du5uqlhw.js";import{T as it}from"./trash-2-zr-0-aP_.js";import"./cn-BLSKlp9E.js";import"./Skeleton-CKYJx_Kj.js";import"./lock-lf7eObvM.js";import"./server-BXCBKq6E.js";import"./activity-CypHx8FZ.js";const ct={ALL:"SECURITY_",AUTH:"SECURITY_AUTH_",POLICY:"SECURITY_POLICIES_",RULE:"SECURITY_RULE_",ACCESS:"SECURITY_IP_ALLOWLIST_"},qe=["security.policy.updated","security.allowlist.updated","security.rule.created","security.rule.updated","security.rule.toggled","security.rule.deleted"];function N(n,a){const s=n||a;return{webhook:!!s.webhook,telegram:!!s.telegram,systemLog:!!s.systemLog}}function E(n,a){var p;const s=N(n==null?void 0:n.default,{webhook:!0,telegram:!1,systemLog:!0});return N((p=n==null?void 0:n.routes)==null?void 0:p[a],s)}function ot(n){const a=Date.now(),s={"15m":15*60*1e3,"1h":60*60*1e3,"24h":24*60*60*1e3,"7d":7*24*60*60*1e3,"30d":30*24*60*60*1e3};return new Date(a-s[n]).toISOString()}function Oe(n){return String(n||"").replace(/^SECURITY_/,"").replace(/_/g," ").trim()}function S(n){return`"${String(n??"").replace(/"/g,'""')}"`}const Et=()=>{var Pe,Ve;const n=st(),a=rt(),{t:s}=nt(),p=Ue(t=>t.admin),De=Ue(t=>t.setAdmin),k=(p==null?void 0:p.role)==="SUPER_ADMIN",[L,P]=i.useState(null),[V,U]=i.useState(""),[q,z]=i.useState(""),[R,G]=i.useState(""),[O,H]=i.useState(""),[D,B]=i.useState(""),[K,J]=i.useState(""),[X,Z]=i.useState(""),[ee,Be]=i.useState(!1),[te,se]=i.useState(!1),[ae,re]=i.useState(!1),[ne,le]=i.useState(!1),[ie,ce]=i.useState(!1),[Ke,Qe]=i.useState(!1),[Q,oe]=i.useState(""),[de,_e]=i.useState("BLOCK"),[F,$e]=i.useState("IP"),[_,ue]=i.useState(""),[ge,me]=i.useState(100),[xe,ye]=i.useState(!1),[$,pe]=i.useState(!1),[he,fe]=i.useState(!1),[A,Ye]=i.useState("ALL"),[be,Me]=i.useState("ALL"),[Y,We]=i.useState("24h"),je=ct[be],{data:r,isLoading:ze}=v({queryKey:["auth-me"],queryFn:async()=>j.me()}),M=v({queryKey:["auth-sessions"],queryFn:async()=>j.getSessions({limit:20}),refetchInterval:1e4}),f=v({queryKey:["security-ip-allowlist"],queryFn:async()=>(await x.get("/settings/security/ip-allowlist")).data,enabled:k}),W=v({queryKey:["security-rules"],queryFn:async()=>{var l;return((l=(await x.get("/settings/security/rules")).data)==null?void 0:l.rules)||[]},enabled:k}),b=v({queryKey:["security-policies"],queryFn:async()=>(await x.get("/settings/security/policies")).data,enabled:k}),I=v({queryKey:["security-events",A,je,Y],queryFn:async()=>{var c;const t=ot(Y);return((c=(await x.get("/logs/system",{params:{page:1,limit:100,search:je,level:A==="ALL"?void 0:A,start:t}})).data)==null?void 0:c.logs)||[]},enabled:k,refetchInterval:5e3}),T=v({queryKey:["notification-settings-security"],queryFn:async()=>(await x.get("/settings/notifications")).data,enabled:k}),w=I.data||[],ke=(t,l,c)=>{const o=new Blob([l],{type:c}),m=window.URL.createObjectURL(o),u=document.createElement("a");u.href=m,u.download=t,u.click(),window.URL.revokeObjectURL(m)},Ge=()=>{const t=`security-events-${new Date().toISOString()}.json`;ke(t,JSON.stringify(w,null,2),"application/json;charset=utf-8")},He=()=>{const t=[["id","timestamp","level","event","user","ip","reason"].join(","),...w.map(c=>{const o=c.metadata||{},m=typeof o.username=="string"?o.username:typeof o.actorUsername=="string"?o.actorUsername:"",u=typeof o.ip=="string"?o.ip:"",C=typeof o.reason=="string"?o.reason:"";return[S(c.id),S(c.timestamp),S(c.level),S(Oe(c.message)),S(m),S(u),S(C)].join(",")})].join(`
`),l=`security-events-${new Date().toISOString()}.csv`;ke(l,t,"text/csv;charset=utf-8")},ve=g({mutationFn:async()=>{var m;const t=(m=T.data)==null?void 0:m.routeMatrix,l=E(t,"__default__"),c=(t==null?void 0:t.routes)||{},o={"security.critical":{...N(c["security.critical"],l),telegram:xe},"auth.login.failed":{...N(c["auth.login.failed"],l),telegram:$},"auth.login.telegram.failed":{...N(c["auth.login.telegram.failed"],l),telegram:$}};qe.forEach(u=>{o[u]={...N(c[u],l),telegram:he}}),await x.put("/settings/notifications",{routes:o})},onSuccess:async()=>{await Promise.all([n.invalidateQueries({queryKey:["notification-settings-security"]}),n.invalidateQueries({queryKey:["notification-settings"]})]),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.escalationUpdated",{defaultValue:"Security escalation rules updated."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.escalationUpdateFailed",{defaultValue:"Failed to update security escalation rules"}))}}),Se=g({mutationFn:async()=>{await x.post("/settings/notifications/test",{channel:"all",event:"security.critical",data:{source:"security-settings-ui",message:"Manual security escalation test",severity:"critical",timestamp:new Date().toISOString()}})},onSuccess:()=>{a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.testAlertSent",{defaultValue:"Test security alert dispatched to configured channels."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.testAlertFailed",{defaultValue:"Failed to send test security alert"}))}}),we=g({mutationFn:async()=>{const t={currentPassword:q},l=V.trim();return r&&l&&l!==r.username&&(t.username=l),R.trim()&&(t.newPassword=R,t.confirmPassword=O),j.updateProfile(t)},onSuccess:async t=>{z(""),G(""),H(""),U(t.username),De({id:t.id,username:t.username,role:t.role,email:t.email,twoFactorEnabled:t.twoFactorEnabled}),await Promise.all([n.invalidateQueries({queryKey:["auth-me"]}),n.invalidateQueries({queryKey:["auth-sessions"]})]),a.success(s("common.success",{defaultValue:"Success"}),t.passwordChanged?s("securitySettings.toast.profileUpdatedCredentials",{defaultValue:"Credentials updated. Existing refresh sessions were revoked."}):s("securitySettings.toast.profileUpdated",{defaultValue:"Profile updated successfully."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.profileUpdateFailed",{defaultValue:"Failed to update profile"}))}}),Ne=g({mutationFn:async()=>j.setupTwoFactor(),onSuccess:t=>{P(t),B(""),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.otpSetupInitialized",{defaultValue:"Scan the QR code and enter OTP to complete setup."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.otpSetupFailed",{defaultValue:"Failed to initialize 2FA setup"}))}}),Ce=g({mutationFn:async t=>j.enableTwoFactor(t),onSuccess:()=>{P(null),B(""),n.invalidateQueries({queryKey:["auth-me"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.otpEnabled",{defaultValue:"Two-factor authentication is now enabled."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.otpEnableFailed",{defaultValue:"Failed to enable 2FA"}))}}),Ee=g({mutationFn:async t=>j.disableTwoFactor(t),onSuccess:()=>{J(""),P(null),n.invalidateQueries({queryKey:["auth-me"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.otpDisabled",{defaultValue:"Two-factor authentication has been disabled."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.otpDisableFailed",{defaultValue:"Failed to disable 2FA"}))}}),Re=g({mutationFn:async()=>j.logoutAll(),onSuccess:async()=>{await n.invalidateQueries({queryKey:["auth-sessions"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.sessionsRevoked",{defaultValue:"All refresh sessions revoked. Current access token remains valid until it expires."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.sessionsRevokeFailed",{defaultValue:"Failed to revoke sessions"}))}}),Fe=g({mutationFn:async t=>j.revokeSessionById(t,!1),onSuccess:async()=>{await n.invalidateQueries({queryKey:["auth-sessions"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.sessionRevoked",{defaultValue:"The selected session has been revoked."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.sessionRevokeFailed",{defaultValue:"Failed to revoke session"}))}}),Ae=g({mutationFn:async()=>{await x.put("/settings/security/ip-allowlist",{allowlist:X,forceCurrentIp:ee})},onSuccess:async()=>{await n.invalidateQueries({queryKey:["security-ip-allowlist"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.allowlistUpdated",{defaultValue:"Admin access policy updated."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.allowlistUpdateFailed",{defaultValue:"Failed to update IP allowlist"}))}}),Ie=g({mutationFn:async()=>{await x.put("/settings/security/policies",{requireTwoFactorForSuperAdmin:ae,strictSessionBinding:ne,requirePrivateIp:te,secretsEncryptionRequired:ie})},onSuccess:async()=>{await Promise.all([n.invalidateQueries({queryKey:["security-policies"]}),n.invalidateQueries({queryKey:["security-ip-allowlist"]})]),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.policiesUpdated",{defaultValue:"Security policies updated."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.policiesUpdateFailed",{defaultValue:"Failed to update security policies"}))}}),Te=g({mutationFn:async()=>{await x.post("/settings/security/rules",{name:Q,action:de,targetType:F,targetValue:_,priority:ge,enabled:!0})},onSuccess:async()=>{oe(""),ue(""),me(100),await n.invalidateQueries({queryKey:["security-rules"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.ruleCreated",{defaultValue:"Security rule created successfully."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.ruleCreateFailed",{defaultValue:"Failed to create security rule"}))}}),Je=g({mutationFn:async({id:t,enabled:l})=>{await x.patch(`/settings/security/rules/${t}/enabled`,{enabled:l})},onSuccess:async()=>{await n.invalidateQueries({queryKey:["security-rules"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.ruleUpdated",{defaultValue:"Security rule status updated."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.ruleUpdateFailed",{defaultValue:"Failed to update security rule"}))}}),Xe=g({mutationFn:async t=>{await x.delete(`/settings/security/rules/${t}`)},onSuccess:async()=>{await n.invalidateQueries({queryKey:["security-rules"]}),a.success(s("common.success",{defaultValue:"Success"}),s("securitySettings.toast.ruleDeleted",{defaultValue:"Security rule deleted."}))},onError:t=>{a.error(s("common.error",{defaultValue:"Error"}),(t==null?void 0:t.message)||s("securitySettings.toast.ruleDeleteFailed",{defaultValue:"Failed to delete security rule"}))}});i.useEffect(()=>{f.data&&Z(f.data.raw||"")},[f.data]),i.useEffect(()=>{b.data&&(re(!!b.data.requireTwoFactorForSuperAdmin),le(!!b.data.strictSessionBinding),se(!!b.data.requirePrivateIp),ce(!!b.data.secretsEncryptionRequired),Qe(!!b.data.secretsEncryptionConfigured))},[b.data]),i.useEffect(()=>{r!=null&&r.username&&U(r.username)},[r==null?void 0:r.username]),i.useEffect(()=>{var u;const t=(u=T.data)==null?void 0:u.routeMatrix;if(!t)return;const l=E(t,"security.critical"),c=E(t,"auth.login.failed"),o=E(t,"auth.login.telegram.failed"),m=qe.every(C=>E(t,C).telegram);ye(!!l.telegram),pe(!!c.telegram&&!!o.telegram),fe(!!m)},[T.data]);const Le=V.trim(),Ze=!!(r&&Le&&Le!==r.username),et=!!(R.trim()||O.trim()),tt=!!q.trim()&&(Ze||et);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(y,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Administrator Security"}),ze?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading profile..."}):e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Username"}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:r==null?void 0:r.username})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Role"}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:r==null?void 0:r.role})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Two-Factor Authentication"}),e.jsx("span",{className:`font-medium ${r!=null&&r.twoFactorEnabled?"text-green-600 dark:text-green-400":"text-yellow-600 dark:text-yellow-400"}`,children:r!=null&&r.twoFactorEnabled?"Enabled":"Disabled"})]})]})]}),k?e.jsxs(e.Fragment,{children:[e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Security Policies"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Global security behavior for admin authentication and session handling."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:ae,onChange:t=>re(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Require 2FA for all SUPER_ADMIN accounts"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:t=>le(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Strict session binding (invalidate refresh token on IP change)"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:te,onChange:t=>se(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Require private/internal IP for admin access"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:ie,onChange:t=>ce(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Require configured encryption key for secrets at rest"})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Encryption key configured: ",Ke?"Yes":"No"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(d,{onClick:()=>Ie.mutate(),loading:Ie.isPending||b.isFetching,children:"Save Security Policies"})})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Security Alert Escalation"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Choose which security event categories should escalate to Telegram notifications."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:xe,onChange:t=>ye(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Critical security incidents (lockout, blocked access, high-risk auth failures)"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:t=>pe(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Failed login attempts (password + Telegram auth)"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:he,onChange:t=>fe(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Security admin changes (policies, rules, IP allowlist updates)"})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx(d,{onClick:()=>ve.mutate(),loading:ve.isPending||T.isFetching,children:"Save Escalation Rules"}),e.jsx(d,{variant:"secondary",onClick:()=>Se.mutate(),loading:Se.isPending,children:"Send Test Security Alert"})]})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Recent Security Events"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Live audit stream from admin authentication and security policy changes (refresh every 5 seconds)."}),e.jsxs("div",{className:"mb-4 grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Event Type"}),e.jsxs("select",{value:be,onChange:t=>Me(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-gray-600 dark:bg-gray-800 dark:text-white",children:[e.jsx("option",{value:"ALL",children:"All Security Events"}),e.jsx("option",{value:"AUTH",children:"Authentication"}),e.jsx("option",{value:"POLICY",children:"Policy Changes"}),e.jsx("option",{value:"RULE",children:"Rule Changes"}),e.jsx("option",{value:"ACCESS",children:"IP Allowlist"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Severity"}),e.jsxs("select",{value:A,onChange:t=>Ye(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-gray-600 dark:bg-gray-800 dark:text-white",children:[e.jsx("option",{value:"ALL",children:"All levels"}),e.jsx("option",{value:"INFO",children:"INFO"}),e.jsx("option",{value:"WARNING",children:"WARNING"}),e.jsx("option",{value:"ERROR",children:"ERROR"}),e.jsx("option",{value:"CRITICAL",children:"CRITICAL"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Time Range"}),e.jsxs("select",{value:Y,onChange:t=>We(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-gray-600 dark:bg-gray-800 dark:text-white",children:[e.jsx("option",{value:"15m",children:"Last 15 minutes"}),e.jsx("option",{value:"1h",children:"Last 1 hour"}),e.jsx("option",{value:"24h",children:"Last 24 hours"}),e.jsx("option",{value:"7d",children:"Last 7 days"}),e.jsx("option",{value:"30d",children:"Last 30 days"})]})]}),e.jsxs("div",{className:"flex flex-col justify-end gap-2 sm:flex-row sm:items-end xl:justify-end",children:[e.jsx(d,{variant:"secondary",onClick:()=>{I.refetch()},loading:I.isFetching,children:"Refresh"}),e.jsx(d,{variant:"secondary",onClick:He,disabled:w.length===0,children:"Export CSV"}),e.jsx(d,{variant:"secondary",onClick:Ge,disabled:w.length===0,children:"Export JSON"})]})]}),I.isLoading?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading events..."}):w.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No security events found."}):e.jsx("div",{className:"space-y-2",children:w.map(t=>{const l=t.metadata||{},c=typeof l.ip=="string"?l.ip:"",o=typeof l.username=="string"?l.username:typeof l.actorUsername=="string"?l.actorUsername:"",m=typeof l.reason=="string"?l.reason:"",u=Oe(t.message),C=t.level==="CRITICAL"?"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300":t.level==="ERROR"?"bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300":t.level==="WARNING"?"bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300":"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300";return e.jsxs("div",{className:"rounded-lg border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:`inline-flex rounded-full px-2 py-0.5 text-xs font-semibold ${C}`,children:t.level}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:u||"Security event"}),e.jsx("span",{className:"ml-auto text-xs text-gray-500 dark:text-gray-400",children:new Date(t.timestamp).toLocaleString()})]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:[o?`User: ${o}`:"User: system",c?` • IP: ${c}`:"",m?` • Reason: ${m}`:""]})]},t.id)})})]})]}):e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Security Administration"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Advanced security policies, allowlists, notification escalation, and rules engine are available to SUPER_ADMIN only."})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Account Credentials"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Change your administrator username and password. Current password verification is required."}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(h,{label:"Username",value:V,onChange:t=>U(t.target.value),placeholder:"admin"}),e.jsx(h,{label:"Current Password *",type:"password",value:q,onChange:t=>z(t.target.value),autoComplete:"current-password",placeholder:"Enter current password"}),e.jsx(h,{label:"New Password",type:"password",value:R,onChange:t=>G(t.target.value),autoComplete:"new-password",placeholder:"Leave empty to keep current password"}),e.jsx(h,{label:"Confirm New Password",type:"password",value:O,onChange:t=>H(t.target.value),autoComplete:"new-password",placeholder:"Re-enter new password"})]}),e.jsxs("div",{className:"mt-3 space-y-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"Password rules: 8-128 characters, include at least one letter and one number."}),e.jsx("p",{children:"When password changes, all refresh sessions are revoked for security."}),p!=null&&p.username&&(r!=null&&r.username)&&p.username!==r.username?e.jsx("p",{className:"text-amber-600 dark:text-amber-400",children:"Session username is syncing. Refresh the page if the sidebar still shows old username."}):null]}),e.jsx("div",{className:"mt-4",children:e.jsx(d,{onClick:()=>we.mutate(),loading:we.isPending,disabled:!tt,children:"Save Credentials"})})]}),r!=null&&r.twoFactorEnabled?e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Disable Two-Factor Authentication"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Enter a valid OTP code to disable 2FA for this admin account."}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[e.jsx(h,{label:"Current OTP",placeholder:"123456",value:K,onChange:t=>J(t.target.value)}),e.jsx(d,{variant:"danger",className:"sm:self-end",onClick:()=>Ee.mutate(K.trim()),loading:Ee.isPending,disabled:K.trim().length<6,children:"Disable 2FA"})]})]}):e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Enable Two-Factor Authentication"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Protect admin access with a TOTP app like Google Authenticator, 1Password, or Authy."}),L?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col items-start gap-4 rounded-lg border border-gray-200 p-4 dark:border-gray-700 md:flex-row",children:[e.jsx("div",{className:"rounded-lg bg-white p-2",children:e.jsx(at,{value:L.otpAuthUrl,size:164})}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:"Scan the QR with your authenticator app, then enter the OTP code to confirm."}),e.jsxs("p",{className:"font-mono text-xs text-gray-600 dark:text-gray-400 break-all",children:["Secret: ",L.secret]})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[e.jsx(h,{label:"Verification OTP",placeholder:"123456",value:D,onChange:t=>B(t.target.value)}),e.jsx(d,{className:"sm:self-end",onClick:()=>Ce.mutate(D.trim()),loading:Ce.isPending,disabled:D.trim().length<6,children:"Enable 2FA"})]})]}):e.jsxs(d,{onClick:()=>Ne.mutate(),loading:Ne.isPending,children:[e.jsx(lt,{className:"mr-2 h-4 w-4"}),"Generate 2FA Setup"]})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Session Controls"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Revoke refresh tokens across all devices. This forces new login on other active sessions."}),e.jsx("div",{className:"mb-4",children:e.jsx(d,{variant:"secondary",onClick:()=>Re.mutate(),loading:Re.isPending,children:"Revoke All Sessions"})}),M.isLoading?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading active sessions..."}):e.jsx("div",{className:"space-y-2",children:(((Pe=M.data)==null?void 0:Pe.sessions)||[]).length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No active sessions found."}):(((Ve=M.data)==null?void 0:Ve.sessions)||[]).map(t=>e.jsxs("div",{className:"rounded-lg border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:`inline-flex rounded-full px-2 py-0.5 text-xs font-semibold ${t.current?"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}`,children:t.current?"Current":"Active"}),e.jsxs("span",{className:"text-xs font-mono text-gray-500 dark:text-gray-400",children:[t.sessionId.slice(0,16),"..."]}),e.jsxs("span",{className:"ml-auto text-xs text-gray-500 dark:text-gray-400",children:["Expires: ",new Date(t.expiresAt).toLocaleString()]})]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-300",children:[t.ipAddress?`IP: ${t.ipAddress}`:"IP: unknown",t.lastUsedAt?` • Last used: ${new Date(t.lastUsedAt).toLocaleString()}`:""]}),t.userAgent?e.jsx("p",{className:"mt-1 truncate text-xs text-gray-500 dark:text-gray-400",children:t.userAgent}):null,t.current?null:e.jsx("div",{className:"mt-2",children:e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>Fe.mutate(t.sessionId),loading:Fe.isPending,children:"Revoke Session"})})]},t.sessionId))})]}),k?e.jsxs(e.Fragment,{children:[e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Admin IP Allowlist"}),e.jsxs("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:["Restrict admin login/API access to specific IPs or CIDR blocks. Example:",e.jsx("span",{className:"ml-1 font-mono",children:"203.0.113.10,198.51.100.0/24"})]}),e.jsx(h,{label:"Allowed IPs / CIDRs (comma-separated)",value:X,onChange:t=>Z(t.target.value),placeholder:"Leave empty to allow all IPs"}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("input",{id:"force-current-ip",type:"checkbox",checked:ee,onChange:t=>Be(t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"}),e.jsx("label",{htmlFor:"force-current-ip",className:"text-sm text-gray-700 dark:text-gray-300",children:"Force save even if current IP is not included"})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>f.refetch(),loading:f.isFetching,children:"Refresh"}),e.jsx(d,{onClick:()=>Ae.mutate(),loading:Ae.isPending,children:"Save Allowlist"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:f.data?`${f.data.count} entr${f.data.count===1?"y":"ies"}`:"Loading..."})]})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"mb-2 text-lg font-semibold text-gray-900 dark:text-white",children:"Security Rules Engine"}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:"Define ALLOW/BLOCK rules by exact IP, CIDR, or country code. Rules are matched by ascending priority."}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-6",children:[e.jsx(h,{label:"Rule Name",value:Q,onChange:t=>oe(t.target.value),placeholder:"Block suspicious IP"}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Action"}),e.jsxs("select",{value:de,onChange:t=>_e(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-gray-600 dark:bg-gray-800 dark:text-white",children:[e.jsx("option",{value:"BLOCK",children:"BLOCK"}),e.jsx("option",{value:"ALLOW",children:"ALLOW"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Target Type"}),e.jsxs("select",{value:F,onChange:t=>$e(t.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-gray-600 dark:bg-gray-800 dark:text-white",children:[e.jsx("option",{value:"IP",children:"IP"}),e.jsx("option",{value:"CIDR",children:"CIDR"}),e.jsx("option",{value:"COUNTRY",children:"COUNTRY"})]})]}),e.jsx(h,{label:"Target Value",value:_,onChange:t=>ue(t.target.value),placeholder:F==="COUNTRY"?"US":F==="CIDR"?"203.0.113.0/24":"203.0.113.9"}),e.jsx(h,{label:"Priority",type:"number",value:String(ge),onChange:t=>me(Number.parseInt(t.target.value||"100",10))}),e.jsx("div",{className:"flex items-end",children:e.jsx(d,{className:"w-full",onClick:()=>Te.mutate(),loading:Te.isPending,disabled:!Q.trim()||!_.trim(),children:"Add Rule"})})]}),e.jsx("div",{className:"mt-4 overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Rule"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Match"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Priority"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Hits"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Enabled"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300",children:"Action"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900",children:[(W.data||[]).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 text-sm text-gray-900 dark:text-gray-100",children:t.name}),e.jsxs("td",{className:"px-3 py-2 text-xs text-gray-600 dark:text-gray-300",children:[e.jsx("span",{className:`mr-2 inline-flex rounded-full px-2 py-0.5 font-semibold ${t.action==="BLOCK"?"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300":"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300"}`,children:t.action}),t.targetType,": ",t.targetValue]}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:t.priority}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:String(t.hitCount||0)}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("button",{type:"button",onClick:()=>Je.mutate({id:t.id,enabled:!t.enabled}),className:`inline-flex rounded-full px-2 py-1 text-xs font-medium ${t.enabled?"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300":"bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300"}`,children:t.enabled?"ON":"OFF"})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>Xe.mutate(t.id),className:"text-red-600 transition-colors hover:text-red-500",title:"Delete rule",children:e.jsx(it,{className:"h-4 w-4"})})})]},t.id)),!W.isLoading&&(W.data||[]).length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-4 text-center text-sm text-gray-500 dark:text-gray-400",children:"No security rules configured"})}):null]})]})})]})]}):null]})};export{Et as default};
