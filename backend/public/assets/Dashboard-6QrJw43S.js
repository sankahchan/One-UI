import{c as S,j as e,e as z,R as M,b as T,u as _,f as G,C as Y,A as J}from"./index-Mm4FQecB.js";import{u as F}from"./useQuery-Dl3gJxFq.js";import{C as k,u as Z}from"./useToast-CQz3nkev.js";import{a as ee,b as te,u as se,c as ae,d as ce}from"./useXray-DFuYMFy1.js";import{f as H}from"./formatters-CEEtD2TU.js";import{B as I}from"./Badge-BkksmqP6.js";import{S as D}from"./Spinner-DagcXMDx.js";import{u as q,R as O}from"./useTranslation-DKz5Ms18.js";import{W as le}from"./wifi-BxovJW0J.js";import{g as ne}from"./system-BvXAp4rJ.js";import{B as P}from"./Button-OXbbz5eU.js";import{S as re}from"./shield-check-CGQQtFpR.js";import{C as oe,c as de}from"./clipboard-CARLoSHl.js";import{g as B,a as ie}from"./xrayUpdatePreflight-CrNj47ho.js";import{C as ue}from"./ConfirmDialog-DVmFFAJ3.js";import{L as Q}from"./lock-BOVLtRb6.js";import{S as A}from"./settings-C89TIDAm.js";import{S as v}from"./Skeleton-D9V63kPJ.js";import{U as me}from"./users-bZ-QzGkU.js";import{A as xe}from"./activity-CbGHQ_hd.js";import"./cn-BLSKlp9E.js";import"./useMutation-BqgM2-rT.js";import"./xray-5OEEh6u8.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=S("HardDrive",[["line",{x1:"22",x2:"2",y1:"12",y2:"12",key:"1y58io"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16",key:"sgf278"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16",key:"1l4acy"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=S("ShieldX",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"m14.5 9-5 5",key:"1m49dw"}],["path",{d:"m9.5 9 5 5",key:"wyx7zg"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=S("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=S("Unlock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]);/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=S("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]),ge=()=>{const{t}=q(),{data:b,isLoading:p,isError:o}=ee();if(p)return e.jsxs(k,{children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("dashboard.onlineUsers",{defaultValue:"Online Users"})})}),e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(D,{})})]});if(o)return e.jsxs(k,{children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("dashboard.onlineUsers",{defaultValue:"Online Users"})})}),e.jsx("p",{className:"py-4 text-sm text-muted",children:t("dashboard.onlineUsersError",{defaultValue:"Unable to fetch online users"})})]});const f=(b==null?void 0:b.users)??[];return e.jsxs(k,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-emerald-500"}),e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("dashboard.onlineUsers",{defaultValue:"Online Users"})})]}),e.jsx(I,{variant:"success",children:t("dashboard.onlineBadge",{defaultValue:"{{count}} online",count:f.length})})]}),f.length===0?e.jsx("p",{className:"py-4 text-sm text-muted",children:t("dashboard.noOnlineUsers",{defaultValue:"No users currently online"})}):e.jsx("div",{className:"space-y-3",children:f.map(g=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-xl border border-line/70 bg-card/65 p-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsx("span",{className:"h-2.5 w-2.5 shrink-0 rounded-full bg-emerald-500"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:g.email}),e.jsx("p",{className:"text-xs text-muted",children:g.protocol})]})]}),e.jsxs("div",{className:"text-left sm:text-right",children:[e.jsxs("p",{className:"text-sm font-medium text-foreground",children:["↑ ",H(g.upload)," / ↓ ",H(g.download)]}),g.lastActivity?e.jsx("p",{className:"text-xs text-muted",children:new Date(g.lastActivity).toLocaleTimeString()}):null]})]},g.id))})]})};function be(){return F({queryKey:["health"],queryFn:ne,refetchInterval:3e4})}const Ne=()=>{var m,r,d;const{t}=q(),b=z(),{data:p,isLoading:o,isError:f,isFetching:g}=be(),{data:x}=F({queryKey:["system-health-quality"],queryFn:()=>T.get("/users/sessions",{params:{includeOffline:!0,limit:500}}),refetchInterval:15e3}),N=()=>{b.invalidateQueries({queryKey:["health"]}),b.invalidateQueries({queryKey:["system-health-quality"]})},y=(((m=x==null?void 0:x.data)==null?void 0:m.sessions)||[]).reduce((n,i)=>{var l,s,a;return n.connects+=Number(((l=i==null?void 0:i.quality)==null?void 0:l.connectSuccesses)||0),n.rejects+=Number(((s=i==null?void 0:i.quality)==null?void 0:s.limitRejects)||0),n.reconnects+=Number(((a=i==null?void 0:i.quality)==null?void 0:a.reconnects)||0),n},{connects:0,rejects:0,reconnects:0}),w=M.useMemo(()=>{var l,s;const n=new Map;for(const a of((l=x==null?void 0:x.data)==null?void 0:l.sessions)||[])for(const c of((s=a==null?void 0:a.quality)==null?void 0:s.byProtocol)||[]){const j=String((c==null?void 0:c.protocol)||"UNKNOWN").toUpperCase(),h=n.get(j)||{protocol:j,connects:0,rejects:0,reconnects:0};h.connects+=Number((c==null?void 0:c.connectSuccesses)||0),h.rejects+=Number((c==null?void 0:c.limitRejects)||0),h.reconnects+=Number((c==null?void 0:c.reconnects)||0),n.set(j,h)}const i=a=>{const c=a.connects+a.rejects,j=c>0?a.rejects/c:0,h=a.connects>0?a.reconnects/a.connects:a.reconnects;return Number((a.connects*10-a.rejects*16-a.reconnects*6-j*25-h*10).toFixed(2))};return Array.from(n.values()).map(a=>({...a,score:i(a)})).sort((a,c)=>a.score!==c.score?c.score-a.score:a.connects!==c.connects?c.connects-a.connects:a.protocol.localeCompare(c.protocol)).slice(0,3)},[(r=x==null?void 0:x.data)==null?void 0:r.sessions]),C=M.useMemo(()=>{var l,s;const n=new Map;for(const a of((l=x==null?void 0:x.data)==null?void 0:l.sessions)||[])for(const c of((s=a==null?void 0:a.quality)==null?void 0:s.byProfile)||[]){const j=Number.isInteger(Number(c==null?void 0:c.inboundId))?Number(c.inboundId):null,h=String((c==null?void 0:c.protocol)||"UNKNOWN").toUpperCase(),V=String((c==null?void 0:c.tag)||(j?`inbound-${j}`:"unknown")),R=j?`id:${j}`:`tag:${V}`,U=n.get(R)||{key:R,tag:V,protocol:h,port:Number((c==null?void 0:c.port)||0),connects:0,rejects:0,reconnects:0};U.connects+=Number((c==null?void 0:c.connectSuccesses)||0),U.rejects+=Number((c==null?void 0:c.limitRejects)||0),U.reconnects+=Number((c==null?void 0:c.reconnects)||0),n.set(R,U)}const i=a=>{const c=a.connects+a.rejects,j=c>0?a.rejects/c:0,h=a.connects>0?a.reconnects/a.connects:a.reconnects;return Number((a.connects*10-a.rejects*16-a.reconnects*6-j*25-h*10).toFixed(2))};return Array.from(n.values()).map(a=>({...a,score:i(a)})).sort((a,c)=>a.score!==c.score?c.score-a.score:a.connects!==c.connects?c.connects-a.connects:a.tag.localeCompare(c.tag)).slice(0,3)},[(d=x==null?void 0:x.data)==null?void 0:d.sessions]);return e.jsxs(k,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[f?e.jsx(fe,{className:"h-5 w-5 text-red-500"}):e.jsx(re,{className:"h-5 w-5 text-emerald-500"}),e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("systemHealth.title",{defaultValue:"System Health"})})]}),o?null:f?e.jsx(I,{variant:"danger",children:t("systemHealth.unreachable",{defaultValue:"Unreachable"})}):e.jsx(I,{variant:"success",children:t("systemHealth.healthy",{defaultValue:"Healthy"})})]}),o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(D,{})}):f?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted",children:t("systemHealth.errorBody",{defaultValue:"Could not reach backend health endpoint. Confirm `backend` is running on port `3000`."})}),e.jsxs(P,{type:"button",size:"sm",variant:"secondary",onClick:N,loading:g,children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),t("systemHealth.retry",{defaultValue:"Retry Health Check"})]})]}):e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted",children:t("common.status",{defaultValue:"Status"})}),e.jsx("span",{className:"font-semibold capitalize text-foreground",children:(p==null?void 0:p.status)||"ok"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted",children:t("systemHealth.lastCheck",{defaultValue:"Last Check"})}),e.jsx("span",{className:"font-medium text-foreground",children:p!=null&&p.timestamp?new Date(p.timestamp).toLocaleString():"N/A"})]}),e.jsx("div",{className:"pt-2",children:e.jsxs(P,{type:"button",size:"sm",variant:"secondary",onClick:N,loading:g,children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),t("common.refresh",{defaultValue:"Refresh"})]})}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 rounded-xl border border-line/70 bg-panel/45 p-3 text-xs sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:t("dashboard.quality.connectSuccess60m",{defaultValue:"Connect Success (60m)"})}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:y.connects})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:t("dashboard.quality.limitRejects60m",{defaultValue:"Limit Rejects (60m)"})}),e.jsx("p",{className:"text-sm font-semibold text-rose-400",children:y.rejects})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:t("dashboard.quality.reconnects60m",{defaultValue:"Reconnects (60m)"})}),e.jsx("p",{className:"text-sm font-semibold text-amber-300",children:y.reconnects})]})]}),e.jsxs("div",{className:"mt-3 space-y-2 text-xs",children:[e.jsx("p",{className:"uppercase tracking-wide text-muted",children:t("dashboard.topProtocolQuality.title",{defaultValue:"Top Protocol Quality (60m)"})}),w.length===0?e.jsx("p",{className:"text-muted",children:t("dashboard.topProtocolQuality.empty",{defaultValue:"No protocol quality data yet."})}):w.map(n=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-line/70 bg-panel/35 px-2.5 py-1.5",children:[e.jsx("p",{className:"font-medium text-foreground",children:n.protocol}),e.jsxs("p",{className:"text-muted",children:["C ",n.connects," / R ",n.rejects," / Re ",n.reconnects,e.jsx("span",{className:`ml-2 font-semibold ${n.score>=0?"text-emerald-300":"text-rose-300"}`,children:n.score})]})]},n.protocol))]}),e.jsxs("div",{className:"mt-3 space-y-2 text-xs",children:[e.jsx("p",{className:"uppercase tracking-wide text-muted",children:t("dashboard.topInboundProfiles.title",{defaultValue:"Top Inbound Profiles (60m)"})}),C.length===0?e.jsx("p",{className:"text-muted",children:t("dashboard.topInboundProfiles.empty",{defaultValue:"No inbound profile telemetry yet."})}):C.map(n=>e.jsxs("div",{className:"rounded-lg border border-line/70 bg-panel/35 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("p",{className:"font-medium text-foreground",children:[n.protocol," ",n.port?`:${n.port}`:""]}),e.jsx("span",{className:`font-semibold ${n.score>=0?"text-emerald-300":"text-rose-300"}`,children:n.score})]}),e.jsx("p",{className:"truncate text-muted",title:n.tag,children:n.tag}),e.jsxs("p",{className:"text-muted",children:["C ",n.connects," / R ",n.rejects," / Re ",n.reconnects]})]},n.key))]})]})]})},ye=()=>{const{t}=q(),b=_(),p=Z(),o=G(u=>u.admin),f=(o==null?void 0:o.role)==="SUPER_ADMIN"||(o==null?void 0:o.role)==="ADMIN",g=(o==null?void 0:o.role)==="SUPER_ADMIN",x=te(),N=se(f),y=x.data,w=ae(),C=ce(),m=N.data,r=(y==null?void 0:y.mode)||(m==null?void 0:m.mode)||"docker",d=(y==null?void 0:y.updatesEnabled)??(m==null?void 0:m.updatesEnabled)??!0,n=((m==null?void 0:m.checks)||[]).filter(u=>!u.ok),i=n.some(u=>u.blocking),l=n.find(u=>u.id==="update-lock"),s=g&&!!l,a=B(l,"expiresAt"),c=B(l,"ownerId"),[j,h]=M.useState(!1),V=m!=null&&m.generatedAt?new Date(m.generatedAt).getTime():Number.NaN,R=a&&Number.isFinite(V)?new Date(a).getTime()<=V:!1,U=Array.from(new Set(n.flatMap(u=>ie(u)).filter(u=>u.trim().length>0))),E=async()=>{if(!U.length)return;const u=["# One-UI Xray Update Preflight Fixes",...U.map(L=>`- ${L}`)].join(`
`);try{if(!await de(u))throw new Error("copy_failed");p.success(t("updateHealth.toast.copiedTitle",{defaultValue:"Copied to clipboard"}),t("updateHealth.toast.copiedBody",{defaultValue:"Preflight fix commands copied."}))}catch{p.error(t("updateHealth.toast.copyFailedTitle",{defaultValue:"Copy failed"}),t("updateHealth.toast.copyFailedBody",{defaultValue:"Failed to copy preflight fix commands."}))}},K=async()=>{if(s)try{const u=await w.mutateAsync({reason:"manual-force-unlock-from-dashboard",force:!R});p.success(t("updateHealth.toast.unlockCompleteTitle",{defaultValue:"Unlock complete"}),u.message||(u.unlocked?t("updateHealth.toast.unlockReleasedBody",{defaultValue:"Update lock released."}):t("updateHealth.toast.unlockNotReleasedBody",{defaultValue:"Update lock not released."}))),h(!1),await N.refetch()}catch(u){p.error(t("updateHealth.toast.unlockFailedTitle",{defaultValue:"Unlock failed"}),(u==null?void 0:u.message)||t("updateHealth.toast.unlockFailedBody",{defaultValue:"Failed to unlock update lock."}))}},W=async()=>{try{const u=await C.mutateAsync({repair:!0,source:"dashboard"});p.success(t("updateHealth.toast.doctorCompleteTitle",{defaultValue:"Runtime Doctor complete"}),t("updateHealth.toast.doctorCompleteBody",{defaultValue:"Applied {{count}} repair action(s).",count:u.repairedCount||0})),await N.refetch()}catch(u){p.error(t("updateHealth.toast.doctorFailedTitle",{defaultValue:"Runtime Doctor failed"}),(u==null?void 0:u.message)||t("updateHealth.toast.doctorFailedBody",{defaultValue:"Failed to run runtime doctor."}))}},X=c&&a?t("updateHealth.unlockConfirm.withOwner",{defaultValue:"Force unlock active update lock owned by {{owner}} (expires {{expiresAt}})?",owner:c,expiresAt:new Date(a).toLocaleString()}):t("updateHealth.unlockConfirm.default",{defaultValue:"Force unlock the active Xray update lock?"});return e.jsxs(k,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between gap-2",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("updateHealth.title",{defaultValue:"Update Health"})}),N.isLoading||f&&x.isLoading?e.jsx("span",{className:"inline-flex items-center rounded-full bg-card px-2.5 py-1 text-xs font-semibold text-muted",children:t("updateHealth.checking",{defaultValue:"Checking..."})}):f?d?m!=null&&m.ready?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-500/15 px-2.5 py-1 text-xs font-semibold text-emerald-300",children:[e.jsx(Y,{className:"h-3.5 w-3.5"}),t("updateHealth.ready",{defaultValue:"Ready"})]}):l?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-rose-500/15 px-2.5 py-1 text-xs font-semibold text-rose-300",children:[e.jsx(Q,{className:"h-3.5 w-3.5"}),t("updateHealth.locked",{defaultValue:"Locked"})]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-amber-500/15 px-2.5 py-1 text-xs font-semibold text-amber-300",children:[e.jsx(J,{className:"h-3.5 w-3.5"}),t("updateHealth.needsFix",{defaultValue:"Needs Fix"})]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-sky-500/15 px-2.5 py-1 text-xs font-semibold text-sky-300",children:[e.jsx(A,{className:"h-3.5 w-3.5"}),t("updateHealth.manualMode",{defaultValue:"Manual Mode"})]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-card px-2.5 py-1 text-xs font-semibold text-muted",children:[e.jsx(Q,{className:"h-3.5 w-3.5"}),t("updateHealth.restricted",{defaultValue:"Restricted"})]})]}),N.isLoading||f&&x.isLoading?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(D,{})}):f?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-muted",children:d?m!=null&&m.ready?t("updateHealth.body.ready",{defaultValue:"All required checks passed. You can run canary/full rollout safely."}):l?t("updateHealth.body.locked",{defaultValue:"Xray update lock is active. Resolve lock state before running updates."}):i?t("updateHealth.body.blockingFailure",{defaultValue:"One or more required checks are failing. Apply fixes before rollout."}):t("updateHealth.body.reviewWarnings",{defaultValue:"Review warnings before rollout."}):t("updateHealth.body.scriptedDisabled",{defaultValue:"Runtime mode is {{mode}}. Scripted container update actions are disabled.",mode:r})}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-2",children:[e.jsxs(P,{type:"button",variant:"secondary",onClick:()=>{N.refetch()},loading:N.isFetching,children:[e.jsx($,{className:"mr-2 h-4 w-4"}),t("updateHealth.runPreflight",{defaultValue:"Run Preflight"})]}),e.jsxs(P,{type:"button",variant:"secondary",onClick:()=>{E()},disabled:U.length===0||C.isPending,children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),t("updateHealth.copyFixes",{defaultValue:"Copy Fixes"})]}),e.jsxs(P,{type:"button",variant:"secondary",onClick:()=>{W()},loading:C.isPending,disabled:w.isPending,children:[e.jsx($,{className:"mr-2 h-4 w-4"}),t("updateHealth.runtimeDoctor",{defaultValue:"Runtime Doctor"})]}),e.jsxs(P,{type:"button",variant:"danger",onClick:()=>{h(!0)},loading:w.isPending,disabled:!s,children:[e.jsx(je,{className:"mr-2 h-4 w-4"}),t("updateHealth.forceUnlock",{defaultValue:"Force Unlock"})]}),e.jsxs(P,{type:"button",variant:"ghost",onClick:()=>b("/settings?tab=system&section=xray-updates"),children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),t("updateHealth.openUpdates",{defaultValue:"Open Updates"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-muted",children:t("updateHealth.body.restricted",{defaultValue:"Update tooling is available for ADMIN and SUPER_ADMIN roles."})}),e.jsx("div",{className:"mt-4",children:e.jsxs(P,{type:"button",variant:"ghost",onClick:()=>b("/settings?tab=system&section=xray-updates"),children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),t("updateHealth.openSettings",{defaultValue:"Open Settings"})]})})]}),e.jsx(ue,{open:j,title:t("updateHealth.unlockTitle",{defaultValue:"Force Unlock Update Lock"}),description:X,confirmLabel:t("updateHealth.forceUnlock",{defaultValue:"Force Unlock"}),tone:"danger",loading:w.isPending,onCancel:()=>{w.isPending||h(!1)},onConfirm:()=>{K()}})]})},ve=()=>{var w,C,m;const{t}=q(),{data:b,isLoading:p}=F({queryKey:["system-stats"],queryFn:()=>T.get("/users/stats")}),{data:o}=F({queryKey:["dashboard-session-quality"],queryFn:()=>T.get("/users/sessions",{params:{includeOffline:!0,limit:500}}),refetchInterval:15e3}),f=(b==null?void 0:b.data)||{total:0,active:0,expired:0,totalTraffic:0},g=[{key:"total-users",icon:me,label:t("dashboard.totalUsers"),value:f.total,tone:"from-brand-500/15 to-brand-600/5 text-brand-500"},{key:"active-users",icon:xe,label:t("dashboard.activeUsers"),value:f.active,tone:"from-emerald-500/15 to-emerald-500/5 text-emerald-500"},{key:"total-traffic",icon:pe,label:t("dashboard.totalTraffic"),value:H(f.totalTraffic),tone:"from-violet-500/15 to-violet-500/5 text-violet-500"},{key:"expired-users",icon:he,label:t("dashboard.expiredUsers"),value:f.expired,tone:"from-rose-500/15 to-rose-500/5 text-rose-500"}],x=(((w=o==null?void 0:o.data)==null?void 0:w.sessions)||[]).reduce((r,d)=>{var n,i,l,s;return r.connects+=Number(((n=d==null?void 0:d.quality)==null?void 0:n.connectSuccesses)||0),r.rejects+=Number(((i=d==null?void 0:d.quality)==null?void 0:i.limitRejects)||0),r.reconnects+=Number(((l=d==null?void 0:d.quality)==null?void 0:l.reconnects)||0),r.trafficPerMinute+=Number(((s=d==null?void 0:d.quality)==null?void 0:s.avgTrafficPerMinute)||0),r},{connects:0,rejects:0,reconnects:0,trafficPerMinute:0}),N=M.useMemo(()=>{var n,i;const r=new Map;for(const l of((n=o==null?void 0:o.data)==null?void 0:n.sessions)||[])for(const s of((i=l==null?void 0:l.quality)==null?void 0:i.byProtocol)||[]){const a=String((s==null?void 0:s.protocol)||"UNKNOWN").toUpperCase(),c=r.get(a)||{protocol:a,connects:0,rejects:0,reconnects:0,trafficPerMinute:0};c.connects+=Number((s==null?void 0:s.connectSuccesses)||0),c.rejects+=Number((s==null?void 0:s.limitRejects)||0),c.reconnects+=Number((s==null?void 0:s.reconnects)||0),c.trafficPerMinute+=Number((s==null?void 0:s.avgTrafficPerMinute)||0),r.set(a,c)}const d=l=>{const s=l.connects+l.rejects,a=s>0?l.rejects/s:0,c=l.connects>0?l.reconnects/l.connects:l.reconnects;return Number((l.connects*10-l.rejects*16-l.reconnects*6-a*25-c*10).toFixed(2))};return Array.from(r.values()).map(l=>({...l,score:d(l)})).sort((l,s)=>l.score!==s.score?s.score-l.score:l.connects!==s.connects?s.connects-l.connects:l.protocol.localeCompare(s.protocol)).slice(0,4)},[(C=o==null?void 0:o.data)==null?void 0:C.sessions]),y=M.useMemo(()=>{var n,i;const r=new Map;for(const l of((n=o==null?void 0:o.data)==null?void 0:n.sessions)||[])for(const s of((i=l==null?void 0:l.quality)==null?void 0:i.byProfile)||[]){const a=Number.isInteger(Number(s==null?void 0:s.inboundId))?Number(s.inboundId):null,c=String((s==null?void 0:s.protocol)||"UNKNOWN").toUpperCase(),j=String((s==null?void 0:s.tag)||(a?`inbound-${a}`:"unknown")),h=a?`id:${a}`:`tag:${j}`,V=r.get(h)||{key:h,inboundId:a,tag:j,protocol:c,port:Number((s==null?void 0:s.port)||0),connects:0,rejects:0,reconnects:0,trafficPerMinute:0};V.connects+=Number((s==null?void 0:s.connectSuccesses)||0),V.rejects+=Number((s==null?void 0:s.limitRejects)||0),V.reconnects+=Number((s==null?void 0:s.reconnects)||0),V.trafficPerMinute+=Number((s==null?void 0:s.avgTrafficPerMinute)||0),r.set(h,V)}const d=l=>{const s=l.connects+l.rejects,a=s>0?l.rejects/s:0,c=l.connects>0?l.reconnects/l.connects:l.reconnects;return Number((l.connects*10-l.rejects*16-l.reconnects*6-a*25-c*10).toFixed(2))};return Array.from(r.values()).map(l=>({...l,score:d(l)})).sort((l,s)=>l.score!==s.score?s.score-l.score:l.connects!==s.connects?s.connects-l.connects:l.tag.localeCompare(s.tag)).slice(0,6)},[(m=o==null?void 0:o.data)==null?void 0:m.sessions]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-wrap items-end justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:t("dashboard.title")}),e.jsx("p",{className:"mt-1 text-sm text-muted",children:t("dashboard.tagline",{defaultValue:"Realtime overview of your users, usage, and service status."})})]})}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4",children:p?Array.from({length:4}).map((r,d)=>e.jsx(k,{className:"relative overflow-hidden",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(v,{className:"h-3 w-24"}),e.jsx(v,{className:"h-7 w-16"})]}),e.jsx(v,{className:"h-10 w-10 rounded-xl"})]})},d)):g.map(({key:r,icon:d,label:n,value:i,tone:l})=>e.jsxs(k,{className:"relative overflow-hidden",children:[e.jsx("div",{className:`pointer-events-none absolute inset-0 bg-gradient-to-br ${l} opacity-90`}),e.jsxs("div",{className:"relative flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted",children:n}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-foreground",children:i})]}),e.jsx("div",{className:"rounded-xl border border-line/70 bg-card/70 p-2.5",children:e.jsx(d,{className:"h-5 w-5 text-foreground"})})]})]},r))}),e.jsxs(k,{className:"relative overflow-hidden",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-brand-500/10 via-emerald-500/5 to-transparent"}),e.jsxs("div",{className:"relative grid grid-cols-1 gap-3 text-sm sm:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:t("dashboard.quality.connectSuccess60m",{defaultValue:"Connect Success (60m)"})}),e.jsx("p",{className:"mt-1 text-xl font-semibold text-foreground",children:x.connects})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:t("dashboard.quality.limitRejects60m",{defaultValue:"Limit Rejects (60m)"})}),e.jsx("p",{className:"mt-1 text-xl font-semibold text-rose-400",children:x.rejects})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:t("dashboard.quality.reconnects60m",{defaultValue:"Reconnects (60m)"})}),e.jsx("p",{className:"mt-1 text-xl font-semibold text-amber-300",children:x.reconnects})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:t("dashboard.quality.avgTrafficPerMin",{defaultValue:"Avg Traffic / Min"})}),e.jsx("p",{className:"mt-1 text-xl font-semibold text-emerald-400",children:H(x.trafficPerMinute)})]})]})]}),e.jsxs(k,{className:"relative overflow-hidden",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-violet-500/10 via-brand-500/5 to-transparent"}),e.jsxs("div",{className:"relative",children:[e.jsx("h2",{className:"text-sm font-semibold uppercase tracking-wide text-muted",children:t("dashboard.topProtocolQuality.title",{defaultValue:"Top Protocol Quality (60m)"})}),N.length===0?e.jsx("p",{className:"mt-3 text-sm text-muted",children:t("dashboard.topProtocolQuality.empty",{defaultValue:"No protocol quality data yet."})}):e.jsx("div",{className:"mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2 xl:grid-cols-4",children:N.map(r=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-foreground",children:r.protocol}),e.jsx("span",{className:`rounded-full px-2 py-0.5 font-semibold ${r.score>=0?"bg-emerald-500/15 text-emerald-300":"bg-rose-500/15 text-rose-300"}`,children:r.score})]}),e.jsx("p",{className:"mt-2 text-muted",children:t("dashboard.quality.row",{defaultValue:"Connect {{connects}} • Reject {{rejects}} • Reconnect {{reconnects}}",connects:r.connects,rejects:r.rejects,reconnects:r.reconnects})}),e.jsx("p",{className:"mt-1 text-muted",children:t("dashboard.quality.trafficPerMin",{defaultValue:"Traffic/min {{traffic}}",traffic:H(r.trafficPerMinute)})})]},r.protocol))})]})]}),e.jsxs(k,{className:"relative overflow-hidden",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-cyan-500/10 via-brand-500/5 to-transparent"}),e.jsxs("div",{className:"relative",children:[e.jsx("h2",{className:"text-sm font-semibold uppercase tracking-wide text-muted",children:t("dashboard.topInboundProfiles.title",{defaultValue:"Top Inbound Profiles (60m)"})}),y.length===0?e.jsx("p",{className:"mt-3 text-sm text-muted",children:t("dashboard.topInboundProfiles.empty",{defaultValue:"No inbound profile telemetry yet."})}):e.jsx("div",{className:"mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2 xl:grid-cols-3",children:y.map(r=>e.jsxs("div",{className:"rounded-xl border border-line/70 bg-panel/45 p-3 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("p",{className:"font-semibold text-foreground",children:[r.protocol," • ",r.port||"-"]}),e.jsx("span",{className:`rounded-full px-2 py-0.5 font-semibold ${r.score>=0?"bg-emerald-500/15 text-emerald-300":"bg-rose-500/15 text-rose-300"}`,children:r.score})]}),e.jsx("p",{className:"mt-1 truncate text-muted",title:r.tag,children:r.tag}),e.jsx("p",{className:"mt-2 text-muted",children:t("dashboard.quality.row",{defaultValue:"Connect {{connects}} • Reject {{rejects}} • Reconnect {{reconnects}}",connects:r.connects,rejects:r.rejects,reconnects:r.reconnects})}),e.jsx("p",{className:"mt-1 text-muted",children:t("dashboard.quality.trafficPerMin",{defaultValue:"Traffic/min {{traffic}}",traffic:H(r.trafficPerMinute)})})]},r.key))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 xl:grid-cols-3",children:[e.jsx(ye,{}),p?e.jsxs(k,{children:[e.jsx(v,{className:"mb-4 h-5 w-40"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(v,{className:"h-4 w-full"}),e.jsx(v,{className:"h-4 w-3/4"}),e.jsx(v,{className:"h-4 w-5/6"}),e.jsx(v,{className:"h-32 w-full"})]})]}):e.jsx(Ne,{}),p?e.jsxs(k,{children:[e.jsx(v,{className:"mb-4 h-5 w-32"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(v,{className:"h-4 w-full"}),e.jsx(v,{className:"h-4 w-2/3"}),e.jsx(v,{className:"h-4 w-4/5"}),e.jsx(v,{className:"h-32 w-full"})]})]}):e.jsx(ge,{})]})]})},We=ve;export{ve as Dashboard,We as DashboardPage};
