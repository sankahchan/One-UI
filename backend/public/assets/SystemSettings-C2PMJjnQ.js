import{c as ya,e as fa,d as pa,b as ha,r as c,j as e,C as ba}from"./index-BBbY-zsF.js";import{u as ka}from"./useQuery-BjvbrY8C.js";import{apiClient as ja}from"./client-BZB-O8vt.js";import{d as Na,e as wa,f as va,g as Ca,b as Sa,u as Ra,h as Va,i as Fa,j as Xa,k as La,l as Aa,m as Ma,n as Ea,o as Pa,p as Ta,q as Ua,r as Ga,s as $a,t as Ba,v as Ia,w as Qa,x as za,c as qa}from"./useXray-D6zDe8y8.js";import{u as Wa,C as j}from"./useToast-RuPXIRlr.js";import{B as o}from"./Button-278k26BX.js";import{C as Da}from"./ConfirmDialog-DVU6FWJw.js";import{g as z,a as Qe}from"./xrayUpdatePreflight-D6qaceO-.js";import{u as Oa,R as re}from"./useTranslation-6XXcKgY6.js";import{F as ze}from"./file-code-2-DHCn-SaH.js";import{S as Ja}from"./server-D54Qf5jb.js";import{C as Ka}from"./copy-DD6vOtEo.js";import"./useMutation-Dc8a1YBZ.js";import"./xray-CKoq_v5l.js";import"./cn-BLSKlp9E.js";/**
 * @license lucide-react v0.298.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=ya("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);function Ya(N){if(!N||N<1)return"N/A";const U=Math.floor(N/86400),q=Math.floor(N%86400/3600),s=Math.floor(N%3600/60);return`${U}d ${q}h ${s}m`}const gt=()=>{var Re,Ve,Fe,Xe,Le,Ae,Me,Ee,Pe,Te,Ue,Ge,$e,Be,Ie;const N=fa(a=>{var r;return((r=a.admin)==null?void 0:r.role)==="SUPER_ADMIN"}),U=pa(),q=ha(),s=Wa(),{t}=Oa(),ne=c.useRef(null),S=c.useRef(null),[G,qe]=c.useState(!1),[We,le]=c.useState(!1),[R,oe]=c.useState("stable"),[De,ie]=c.useState(1),[p,W]=c.useState(""),[w,D]=c.useState(""),[de,ce]=c.useState(!1),[u,ue]=c.useState(null),{data:O}=ka({queryKey:["system-stats"],queryFn:async()=>await ja.get("/system/stats"),refetchInterval:5e3}),J=Na(),K=wa(G),_=va(),Y=Ca(),me=Sa(),v=Ra(),l=me.data,n=v.data,g=(l==null?void 0:l.updatesEnabled)!==!1,Oe=me.isSuccess?g:!1,$=Va(De,10),X=Fa(Oe),ge=Xa(g),xe=La(),Z=Aa(!0),ye=Ma(),fe=Ea(),Je=Pa(!0),pe=Ta(),Ke=Ua(!0),he=Ga(),_e=$a(!0),be=Ba(),L=Ia(),V=Qa(),T=za(),ke=qa(),h=O==null?void 0:O.data,y=J.data,B=K.data,i=$.data,m=ge.data,C=c.useMemo(()=>{var a;return((a=Z.data)==null?void 0:a.snapshots)??[]},[(Re=Z.data)==null?void 0:Re.snapshots]),b=Je.data,H=Ke.data,A=_e.data,k=c.useMemo(()=>X.data??[],[X.data]),je=(l==null?void 0:l.mode)||(n==null?void 0:n.mode)||"docker",M=v.isLoading||!(n!=null&&n.ready),ee=((n==null?void 0:n.checks)||[]).filter(a=>!a.ok),Ye=ee.filter(a=>a.blocking),E=((n==null?void 0:n.checks)||[]).find(a=>a.id==="update-lock"&&!a.ok),Ne=!!E,Ze=z(E,"ownerId"),we=z(E,"expiresAt"),ve=n!=null&&n.generatedAt?new Date(n.generatedAt).getTime():Number.NaN,I=we&&Number.isFinite(ve)?new Date(we).getTime()<=ve:!1,ae=c.useMemo(()=>Array.from(new Set(ee.flatMap(a=>Qe(a)).filter(a=>a.trim().length>0))),[ee]),P=de||L.isPending||V.isPending||T.isPending;c.useEffect(()=>{if(!C.length){D("");return}(!w||!C.some(a=>a.id===w))&&D(C[0].id)},[C,w]),c.useEffect(()=>{if(!k.length){p!==""&&W("");return}(!p||!k.includes(p))&&W(k[0])},[k,p]),c.useEffect(()=>{if(new URLSearchParams(U.search).get("section")!=="xray-updates")return;const r=window.setTimeout(()=>{var d;(d=ne.current)==null||d.scrollIntoView({behavior:"smooth",block:"start"})},120);return()=>window.clearTimeout(r)},[U.search]),c.useEffect(()=>()=>{var a;(a=S.current)==null||a.call(S,!1),S.current=null},[]);const F=({title:a,description:r,confirmLabel:d="Confirm",cancelLabel:x="Cancel",tone:f="danger"})=>new Promise(Q=>{S.current=Q,ue({title:a,description:r,confirmLabel:d,cancelLabel:x,tone:f})}),Ce=a=>{const r=S.current;S.current=null,ue(null),r==null||r(a)},He=()=>{q.invalidateQueries({queryKey:["xray-status"]})},ea=async()=>{try{const a=await Y.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),a.message||t("systemSettings.toast.configReloaded",{defaultValue:"Xray config reloaded successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.configReloadFailed",{defaultValue:"Failed to reload Xray config"}))}},aa=async()=>{try{const a=await _.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),a.message||t("systemSettings.toast.restartSuccess",{defaultValue:"Xray restarted successfully!"}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.restartFailed",{defaultValue:"Failed to restart Xray"}))}},ta=async()=>{if(!g){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}try{const a=await L.mutateAsync({channel:R});s.success(t("common.success",{defaultValue:"Success"}),a.summary||t("systemSettings.toast.canaryComplete",{defaultValue:"Canary update completed successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.canaryFailed",{defaultValue:"Failed to run canary update"}))}},Se=async(a=!1)=>{if(!g){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeScriptedDisabled",{defaultValue:"Scripted Xray updates are disabled in manual mode. Use your host update workflow."}));return}if(await F({title:a?"Force full rollout?":"Run full rollout?",description:a?"Run full rollout and bypass canary requirement?":"Run full rollout now? This will restart Xray service.",confirmLabel:a?"Force rollout":"Run rollout",tone:a?"danger":"primary"}))try{const x=await V.mutateAsync({channel:R,force:a});s.success(t("common.success",{defaultValue:"Success"}),x.summary||t("systemSettings.toast.fullRolloutComplete",{defaultValue:"Full rollout completed successfully."}))}catch(x){s.error(t("common.error",{defaultValue:"Error"}),(x==null?void 0:x.message)||t("systemSettings.toast.fullRolloutFailed",{defaultValue:"Failed to run full rollout"}))}},sa=async()=>{var r;if(!g){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeGuidedUnavailable",{defaultValue:"Guided rollout is unavailable in manual mode. Use your host update workflow."}));return}if(await F({title:`Start guided rollout (${R.toUpperCase()})?`,description:"This flow runs Canary first, then prompts Full rollout.",confirmLabel:"Start guided rollout",tone:"primary"})){ce(!0);try{if(!((r=(await v.refetch()).data)!=null&&r.ready)){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.preflightBlocked",{defaultValue:"Resolve preflight checks before guided rollout."}));return}const x=await L.mutateAsync({channel:R});if(!await F({title:"Canary complete",description:`Canary finished successfully.${x.summary?`

${x.summary}`:""}

Continue with Full rollout now?`,confirmLabel:"Continue to full rollout",tone:"primary"})){s.info(t("common.info",{defaultValue:"Info"}),t("systemSettings.toast.guidedPaused",{defaultValue:"Canary complete. Full rollout skipped."}));return}const Q=await V.mutateAsync({channel:R});s.success(t("common.success",{defaultValue:"Success"}),Q.summary||t("systemSettings.toast.guidedComplete",{defaultValue:"Guided rollout completed successfully."}))}catch(d){const x=(d==null?void 0:d.message)||"Guided rollout failed";if(!await F({title:"Guided rollout failed",description:`${x}

Run rollback shortcut now?`,confirmLabel:"Run rollback",tone:"danger"}))return;const te=(await X.refetch()).data||k,se=p||(te==null?void 0:te[0]);if(!se){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.noRollbackTag",{defaultValue:"No rollback backup tag available. Refresh tags and try again."}));return}const xa=await T.mutateAsync({backupTag:se});s.success(t("common.success",{defaultValue:"Success"}),xa.summary||t("systemSettings.toast.rollbackCompleteWithTag",{defaultValue:"Rollback completed using {{tag}}.",tag:se}))}finally{ce(!1)}}},ra=async()=>{if(!g){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.manualModeRollbackDisabled",{defaultValue:"Scripted rollback is disabled in manual mode. Use your host rollback workflow."}));return}const a=p?`Run rollback with ${p}?`:"Run rollback with latest available backup tag?";if(await F({title:"Run rollback?",description:a,confirmLabel:"Run rollback",tone:"danger"}))try{const d=await T.mutateAsync({backupTag:p||void 0});s.success(t("common.success",{defaultValue:"Success"}),d.summary||t("systemSettings.toast.rollbackComplete",{defaultValue:"Rollback completed successfully."}))}catch(d){s.error(t("common.error",{defaultValue:"Error"}),(d==null?void 0:d.message)||t("systemSettings.toast.rollbackFailed",{defaultValue:"Failed to run rollback"}))}},na=async()=>{if(B)try{await navigator.clipboard.writeText(JSON.stringify(B,null,2)),le(!0),window.setTimeout(()=>le(!1),1500)}catch{s.error(t("common.error",{defaultValue:"Error"}),t("systemSettings.toast.copyConfigFailed",{defaultValue:"Failed to copy config to clipboard"}))}},la=async()=>{if(!ae.length)return;const a=["# One-UI Xray Update Preflight Fixes",...ae.map(r=>`- ${r}`)].join(`
`);try{await navigator.clipboard.writeText(a),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.copyPreflightFixesSuccess",{defaultValue:"Preflight fix commands copied."}))}catch{s.error(t("common.error",{defaultValue:"Error"}),t("systemSettings.toast.copyPreflightFixesFailed",{defaultValue:"Failed to copy preflight fix commands."}))}},oa=async()=>{try{await xe.mutateAsync(),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.releaseIntelRefreshed",{defaultValue:"Latest release metadata pulled from upstream."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.releaseIntelRefreshFailed",{defaultValue:"Failed to refresh release intel"}))}},ia=async()=>{try{const a=await ye.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.snapshotCreated",{defaultValue:"Snapshot ID: {{id}}",id:a.id}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.snapshotFailed",{defaultValue:"Failed to create config snapshot"}))}},da=async()=>{if(!w){s.warning(t("common.warning",{defaultValue:"Warning"}),t("systemSettings.toast.selectSnapshot",{defaultValue:"Choose a snapshot before rollback."}));return}if(await F({title:"Rollback config snapshot?",description:`Rollback Xray config using snapshot ${w}?`,confirmLabel:"Rollback snapshot",tone:"danger"}))try{const r=await fe.mutateAsync({snapshotId:w,applyMethod:"restart"});s.success(t("common.success",{defaultValue:"Success"}),r.message||t("systemSettings.toast.configRollbackComplete",{defaultValue:"Config rollback completed."}))}catch(r){s.error(t("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||t("systemSettings.toast.configRollbackFailed",{defaultValue:"Failed to rollback snapshot"}))}},ca=async a=>{try{await pe.mutateAsync({mode:a,apply:!0}),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.routingUpdated",{defaultValue:"Routing profile switched to {{mode}}.",mode:a}))}catch(r){s.error(t("common.error",{defaultValue:"Error"}),(r==null?void 0:r.message)||t("systemSettings.toast.routingUpdateFailed",{defaultValue:"Failed to update routing profile"}))}},ua=async()=>{try{await he.mutateAsync({useCommand:!0,forceDownload:!1,reload:!0}),s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.geodataUpdated",{defaultValue:"Geodata updated successfully."}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.geodataUpdateFailed",{defaultValue:"Failed to update geodata"}))}},ma=async()=>{try{const a=await be.mutateAsync();s.success(t("common.success",{defaultValue:"Success"}),t("systemSettings.toast.confdirSynced",{defaultValue:"{{count}} file(s) synchronized.",count:a.files.length}))}catch(a){s.error(t("common.error",{defaultValue:"Error"}),(a==null?void 0:a.message)||t("systemSettings.toast.confdirSyncFailed",{defaultValue:"Failed to sync confdir"}))}},ga=async()=>{if(!N||!Ne)return;const a=z(E,"ownerId"),r=z(E,"expiresAt"),d=a&&r?`Force unlock active update lock owned by ${a} (expires ${new Date(r).toLocaleString()})?`:"Force unlock the active Xray update lock?";if(await F({title:I?"Unlock stale update lock?":"Force unlock active update lock?",description:d,confirmLabel:I?"Unlock":"Force unlock",tone:"danger"}))try{const f=await ke.mutateAsync({reason:"manual-force-unlock-from-settings",force:!I});s.success(t("common.success",{defaultValue:"Success"}),f.message||(f.unlocked?t("systemSettings.toast.updateLockReleased",{defaultValue:"Update lock released."}):t("systemSettings.toast.updateLockNotReleased",{defaultValue:"Update lock not released."})))}catch(f){s.error(t("common.error",{defaultValue:"Error"}),(f==null?void 0:f.message)||t("systemSettings.toast.unlockFailed",{defaultValue:"Failed to unlock update lock."}))}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"System Information"}),h?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"CPU Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[h.cpu??"N/A",typeof h.cpu=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Memory Usage:"}),e.jsxs("span",{className:"font-medium dark:text-gray-200",children:[h.memory??"N/A",typeof h.memory=="number"?"%":""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:h.users??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Inbounds:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:h.inbounds??0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Uptime:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:h.uptime||Ya(h.uptimeSeconds)})]})]}):null]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Runtime"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Monitor service status and run zero-downtime config reloads."})]}),e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${y!=null&&y.running?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900/35 dark:text-red-300"}`,children:y!=null&&y.running?"Running":"Stopped"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Version:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:(y==null?void 0:y.version)||"unknown"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Status Updated:"}),e.jsx("span",{className:"font-medium dark:text-gray-200",children:J.isFetching?"Refreshing...":"Live"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-3",children:[e.jsxs(o,{variant:"secondary",onClick:He,loading:J.isFetching,children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Refresh Status"]}),e.jsxs(o,{variant:"secondary",onClick:()=>{ea()},loading:Y.isPending,disabled:_.isPending,children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"Reload Config"]}),e.jsxs(o,{variant:"danger",onClick:()=>{aa()},loading:_.isPending,disabled:Y.isPending,children:[e.jsx(Ja,{className:"mr-2 h-4 w-4"}),"Restart Xray"]})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"`Reload Config` validates and reapplies generated config without hard restart. Use `Restart Xray` for binary/runtime issues."})]}),e.jsx("div",{id:"xray-updates",ref:ne,children:e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Core Updates"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Canary-first rollout with audit logging and Telegram notifications."})]}),e.jsxs("span",{className:"inline-flex items-center rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-900/35 dark:text-indigo-300",children:[(l==null?void 0:l.defaultChannel)||"stable"," default"]})]}),g?null:e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-500/35 bg-amber-500/10 px-3 py-2 text-xs text-amber-300",children:["Runtime mode is ",e.jsx("code",{className:"font-mono",children:je}),". Scripted update/rollback actions are disabled. Use your host updater flow for Xray-core lifecycle management."]}),e.jsxs("div",{className:"mb-4 grid grid-cols-1 gap-2 text-xs sm:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Runtime Mode"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:je.toUpperCase()})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Preflight"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:n!=null&&n.ready?"Ready":v.isLoading?"Checking":"Blocked"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Blocking Failures"}),e.jsx("p",{className:"mt-1 font-semibold text-gray-900 dark:text-gray-200",children:Ye.length})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Update Lock"}),e.jsx("p",{className:"mt-1 truncate font-semibold text-gray-900 dark:text-gray-200",children:E?Ze||"Locked":"Unlocked"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-sm sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Canary Policy"}),e.jsx("p",{className:"mt-1 font-medium text-gray-900 dark:text-gray-200",children:l!=null&&l.requireCanaryBeforeFull?"Required before full rollout":"Optional"}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Window: ",(l==null?void 0:l.canaryWindowMinutes)||0," minutes"]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:["Last canary: ",l!=null&&l.lastSuccessfulCanaryAt?new Date(l.lastSuccessfulCanaryAt).toLocaleString():"none"]})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Execution Channel"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(o,{type:"button",size:"sm",variant:R==="stable"?"primary":"secondary",onClick:()=>oe("stable"),disabled:L.isPending||V.isPending,children:"Stable"}),e.jsx(o,{type:"button",size:"sm",variant:R==="latest"?"primary":"secondary",onClick:()=>oe("latest"),disabled:L.isPending||V.isPending,children:"Latest"})]})]})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Preflight Checks"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Validate script, Docker connectivity, and update lock before rollout."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${n!=null&&n.ready?"bg-green-100 text-green-700 dark:bg-green-900/35 dark:text-green-300":"bg-amber-100 text-amber-700 dark:bg-amber-900/35 dark:text-amber-300"}`,children:n!=null&&n.ready?"Ready":v.isLoading?"Checking...":"Blocked"}),e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>{v.refetch()},loading:v.isFetching,children:"Run Preflight"}),e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>{la()},disabled:ae.length===0,children:"Copy Fixes"}),N?e.jsx(o,{type:"button",size:"sm",variant:"danger",onClick:()=>{ga()},loading:ke.isPending,disabled:!Ne||P,children:I?"Unlock Stale":"Force Unlock"}):null]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[((n==null?void 0:n.checks)||[]).map(a=>{const r=Qe(a);return e.jsxs("div",{className:"rounded-md border border-gray-200 px-3 py-2 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-400",children:a.label}),e.jsx("p",{className:"truncate text-sm text-gray-800 dark:text-gray-200",children:a.detail||(a.ok?"OK":"Failed")})]}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-1",children:[a.ok?e.jsx(ba,{className:"h-4 w-4 text-green-500"}):e.jsx(_a,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:`text-xs font-semibold ${a.ok?"text-green-600 dark:text-green-300":"text-red-600 dark:text-red-300"}`,children:a.ok?"PASS":a.blocking?"FAIL":"WARN"})]})]}),!a.ok&&r.length>0?e.jsxs("details",{className:"mt-2 rounded-md border border-gray-200 p-2 dark:border-gray-700",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-semibold text-blue-600 dark:text-blue-300",children:"Show fix commands"}),e.jsx("div",{className:"mt-2 space-y-1",children:r.map(d=>e.jsx("pre",{className:"overflow-x-auto rounded bg-gray-900/95 px-2 py-1 text-[11px] text-gray-100",children:d},`${a.id}-${d}`))})]}):null]},a.id)}),!v.isLoading&&n&&!n.ready?e.jsx("p",{className:"text-xs text-red-600 dark:text-red-300",children:"Resolve blocking preflight checks before running canary/full/rollback update operations."}):null]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(o,{type:"button",variant:"secondary",onClick:()=>{ta()},loading:L.isPending,disabled:!g||P||M,children:"Run Canary"}),e.jsx(o,{type:"button",variant:"secondary",onClick:()=>{sa()},loading:de,disabled:!g||P||M,children:"Guided Rollout"}),e.jsx(o,{type:"button",onClick:()=>{Se(!1)},loading:V.isPending,disabled:!g||P||M||(l==null?void 0:l.requireCanaryBeforeFull)&&!(l!=null&&l.canaryReady),children:"Run Full Rollout"}),e.jsx(o,{type:"button",variant:"danger",onClick:()=>{Se(!0)},loading:V.isPending,disabled:!g||P||M,children:"Force Full Rollout"})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-600 dark:text-gray-400",children:"Force is for emergency recoveries only. Standard rollout should run canary first."}),e.jsxs("div",{className:"mt-4 rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Rollback"}),e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>{X.refetch()},loading:X.isFetching,disabled:!g,children:"Refresh Tags"})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-600 dark:text-gray-400",children:"Select backup tag to roll back immediately to a previous working Xray image."}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]",children:[e.jsx("select",{value:p,onChange:a=>W(a.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",disabled:T.isPending||X.isLoading||k.length===0||M,children:k.length===0?e.jsx("option",{value:"",children:"No backup tags available"}):k.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx(o,{type:"button",variant:"danger",onClick:()=>{ra()},loading:T.isPending,disabled:!g||k.length===0||P||M,children:"Run Rollback"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-gray-200",children:"Update Audit Trail"}),e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>{$.refetch()},loading:$.isFetching,children:"Refresh"})]}),$.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading history..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2",children:((i==null?void 0:i.items)||[]).map(a=>e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 text-xs dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-200",children:a.message}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:new Date(a.timestamp).toLocaleString()})]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["level=",a.level,a.metadata&&typeof a.metadata=="object"&&"actorUsername"in a.metadata?` â€¢ actor=${String(a.metadata.actorUsername||"system")}`:""]})]},a.id))}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Page ",((Ve=i==null?void 0:i.pagination)==null?void 0:Ve.page)||1," / ",((Fe=i==null?void 0:i.pagination)==null?void 0:Fe.totalPages)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>ie(a=>Math.max(1,a-1)),disabled:(((Xe=i==null?void 0:i.pagination)==null?void 0:Xe.page)||1)<=1,children:"Previous"}),e.jsx(o,{type:"button",size:"sm",variant:"secondary",onClick:()=>ie(a=>{var r;return Math.min(((r=i==null?void 0:i.pagination)==null?void 0:r.totalPages)||a+1,a+1)}),disabled:(((Le=i==null?void 0:i.pagination)==null?void 0:Le.page)||1)>=(((Ae=i==null?void 0:i.pagination)==null?void 0:Ae.totalPages)||1),children:"Next"})]})]})]})]})]})}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Xray Release Intelligence"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Live upstream view from XTLS/Xray-core to decide when to run canary/full upgrades."})]}),e.jsxs(o,{type:"button",variant:"secondary",onClick:()=>{oa()},loading:xe.isPending,children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Refresh Release Data"]})]}),ge.isLoading?e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Loading release intel..."}):e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Current Version"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:(m==null?void 0:m.currentVersion)||(y==null?void 0:y.version)||"unknown"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Stable"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:((Ee=(Me=m==null?void 0:m.channels)==null?void 0:Me.stable)==null?void 0:Ee.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(Te=(Pe=m==null?void 0:m.channels)==null?void 0:Pe.stable)!=null&&Te.needsUpdate?"Update available":"Up-to-date"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500 dark:text-gray-400",children:"Latest"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-gray-900 dark:text-white",children:((Ge=(Ue=m==null?void 0:m.channels)==null?void 0:Ue.latest)==null?void 0:Ge.tagName)||"n/a"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:(Be=($e=m==null?void 0:m.channels)==null?void 0:$e.latest)!=null&&Be.publishedAt?new Date(m.channels.latest.publishedAt).toLocaleString():"No release data"})]})]})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Config Snapshots"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Create, list, and rollback generated Xray config snapshots directly from the panel."})]}),e.jsx(o,{type:"button",variant:"secondary",onClick:()=>{ia()},loading:ye.isPending,children:"Create Snapshot"})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-[1fr_auto]",children:[e.jsx("select",{className:"rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100",value:w,onChange:a=>D(a.target.value),disabled:Z.isLoading||C.length===0,children:C.length===0?e.jsx("option",{value:"",children:"No snapshots found"}):C.map(a=>e.jsxs("option",{value:a.id,children:[a.id," ",a.reason?`(${a.reason})`:""]},a.id))}),e.jsx(o,{type:"button",variant:"secondary",onClick:()=>{da()},loading:fe.isPending,disabled:!w||C.length===0,children:"Rollback Snapshot"})]})]}),e.jsxs(j,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Routing Profile"}),e.jsxs("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:["Active mode: ",e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:(b==null?void 0:b.mode)||"smart"})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:["smart","filtered","strict","open"].map(a=>e.jsx(o,{type:"button",variant:(b==null?void 0:b.mode)===a?"primary":"secondary",onClick:()=>{ca(a)},loading:pe.isPending&&(b==null?void 0:b.mode)!==a,children:a},a))})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Generated Xray Config"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Inspect the currently generated config JSON directly from One-UI."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"secondary",onClick:()=>qe(a=>!a),children:G?"Hide Preview":"Show Preview"}),e.jsxs(o,{variant:"secondary",onClick:()=>{na()},disabled:!G||K.isLoading||!B,children:[e.jsx(Ka,{className:"mr-2 h-4 w-4"}),We?"Copied":"Copy JSON"]})]})]}),G?K.isLoading?e.jsx("div",{className:"py-6 text-sm text-gray-600 dark:text-gray-400",children:"Loading config preview..."}):e.jsx("pre",{className:"max-h-[420px] overflow-auto rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200",children:JSON.stringify(B||{},null,2)}):e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Open preview to inspect inbound, outbound, and routing payload before applying runtime changes."})]}),e.jsxs(j,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Geo Files"}),e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:"Update and verify geosite.dat / geoip.dat from configured geodata sources."}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:"Current Geodata"}),e.jsx("div",{className:"mt-2 space-y-1 text-gray-600 dark:text-gray-400",children:((H==null?void 0:H.files)||[]).map(a=>e.jsxs("p",{children:[a.name,": ",a.exists?`${(a.size/(1024*1024)).toFixed(2)} MB`:"missing"]},a.key))})]}),e.jsxs(o,{onClick:()=>{ua()},className:"w-full",variant:"secondary",loading:he.isPending,children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Update Geodata Files"]})]}),e.jsxs(j,{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"Confdir Sync"}),e.jsxs("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:["Export generated config into multi-file ",e.jsx("code",{className:"font-mono",children:"conf.d"})," layout for advanced deployments."]}),e.jsxs("div",{className:"mb-4 rounded-lg border border-gray-200 p-3 text-sm dark:border-gray-700",children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:["Directory: ",(A==null?void 0:A.directory)||"n/a"]}),e.jsxs("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:["Files: ",((Ie=A==null?void 0:A.files)==null?void 0:Ie.length)||0]})]}),e.jsxs(o,{onClick:()=>{ma()},className:"w-full",variant:"secondary",loading:be.isPending,children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"Sync Confdir"]})]}),e.jsx(Da,{open:!!u,title:(u==null?void 0:u.title)||"",description:u==null?void 0:u.description,confirmLabel:u==null?void 0:u.confirmLabel,cancelLabel:u==null?void 0:u.cancelLabel,tone:(u==null?void 0:u.tone)||"danger",onCancel:()=>Ce(!1),onConfirm:()=>Ce(!0)})]})};export{gt as default};
