name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      run_full_e2e:
        description: 'Run full E2E suite in addition to standard jobs'
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend-quality:
    if: github.event_name != 'schedule'
    name: Frontend Lint + Build (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: npm run lint

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  backend-quality:
    if: github.event_name != 'schedule'
    name: Backend Check (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22]
    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/xray_panel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Generate Prisma client
        working-directory: backend
        run: npm run prisma:generate

      - name: Validate backend syntax and Prisma schema
        working-directory: backend
        run: npm run check

  docker-build:
    if: github.event_name != 'schedule'
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs:
      - frontend-quality
      - backend-quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: docker build -f backend/Dockerfile -t one-ui/backend:ci backend

      - name: Build xray image
        run: docker build -f docker/Dockerfile.xray -t one-ui/xray:ci .

  smoke-e2e:
    if: github.event_name != 'schedule'
    name: Smoke E2E (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs:
      - frontend-quality
      - backend-quality
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: xray_panel
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d xray_panel"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      SKIP_DOCKER_DB: "1"
      DATABASE_URL_LOCAL: postgresql://postgres:postgres@127.0.0.1:5432/xray_panel
      PLAYWRIGHT_INSTALL: "1"
      E2E_ADMIN_USERNAME: admin
      E2E_ADMIN_PASSWORD: admin123
      BUDGET_RUNS: "3"
      HEALTH_BUDGET_MS: "1500"
      METRICS_BUDGET_MS: "1800"
      LOGIN_BUDGET_MS: "3000"
      USERS_BUDGET_MS: "3000"
      INBOUNDS_BUDGET_MS: "3000"
      SLO_RUNS: "5"
      HEALTH_P95_MS: "1200"
      HEALTH_P99_MS: "1500"
      METRICS_P95_MS: "1400"
      METRICS_P99_MS: "1800"
      USERS_P95_MS: "2200"
      USERS_P99_MS: "2800"
      INBOUNDS_P95_MS: "2200"
      INBOUNDS_P99_MS: "2800"
      SYSTEM_STATS_P95_MS: "2200"
      SYSTEM_STATS_P99_MS: "2800"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Run smoke tests
        run: ./scripts/e2e-smoke.sh

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke-node-${{ matrix.node-version }}
          path: |
            frontend/playwright-report
            frontend/test-results
          if-no-files-found: ignore

  api-smoke-scripts:
    if: github.event_name != 'schedule'
    name: API Smoke Scripts (Core + Myanmar)
    runs-on: ubuntu-latest
    needs:
      - backend-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: xray_panel
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d xray_panel"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      SKIP_DOCKER_DB: "1"
      DATABASE_URL_LOCAL: postgresql://postgres:postgres@127.0.0.1:5432/xray_panel
      E2E_ADMIN_USERNAME: admin
      E2E_ADMIN_PASSWORD: admin123

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Run API smoke scripts
        run: |
          trap './scripts/dev-down.sh >/dev/null 2>&1 || true' EXIT
          ./scripts/bootstrap-local.sh
          ./scripts/smoke-core-api.sh
          ./scripts/smoke-myanmar-hardening.sh

  nightly-full-e2e:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_e2e == 'true')
    name: Full E2E (Nightly/Manual)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: xray_panel
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d xray_panel"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      SKIP_DOCKER_DB: "1"
      DATABASE_URL_LOCAL: postgresql://postgres:postgres@127.0.0.1:5432/xray_panel
      PLAYWRIGHT_INSTALL: "1"
      E2E_ADMIN_USERNAME: admin
      E2E_ADMIN_PASSWORD: admin123

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Run full E2E suite
        run: ./scripts/e2e-full.sh

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-full-e2e
          path: |
            frontend/playwright-report
            frontend/test-results
          if-no-files-found: ignore
